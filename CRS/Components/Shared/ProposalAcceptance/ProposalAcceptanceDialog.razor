@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop

@inject IProposalAcceptanceService AcceptanceService
@inject IProposalPdfService ProposalPdfService
@inject AuthenticationStateProvider AuthStateProvider
@inject IHttpContextAccessor HttpContextAccessor
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<MudDialog>
    <DialogContent>
        @if (isLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-8">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">Loading terms...</MudText>
            </MudStack>
        }
        else if (termsTemplate == null)
        {
            <MudAlert Severity="Severity.Error">
                Unable to load proposal acceptance terms. Please contact support.
            </MudAlert>
        }
        else
        {
            <MudStack Spacing="4">
                <!-- Proposal Summary -->
                @if (ReserveStudy != null)
                {
                    <MudPaper Elevation="0" Class="pa-4" Style="background: #F3E8FF; border-radius: 8px;">
                        <MudStack Spacing="1">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.subtitle1" Class="fw-bold" Style="color: #6A3D9A;">
                                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Small" Class="mr-1" />
                                    Reserve Study Proposal
                                </MudText>
                                <MudButton Variant="Variant.Text"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.PictureAsPdf"
                                           OnClick="DownloadProposalPdf"
                                           Disabled="@isDownloadingPdf">
                                    @if (isDownloadingPdf) {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                        <span>Downloading...</span>
                                    } else {
                                        <span>Download PDF</span>
                                    }
                                </MudButton>
                            </MudStack>
                            <MudText Typo="Typo.body2">
                                <strong>Community:</strong> @ReserveStudy.Community?.Name
                            </MudText>
                            @if (ReserveStudy.CurrentProposal != null)
                            {
                                <MudText Typo="Typo.body2">
                                    <strong>Estimated Cost:</strong> @ReserveStudy.CurrentProposal.EstimatedCost.ToString("C")
                                </MudText>
                            }
                        </MudStack>
                    </MudPaper>
                }

                <!-- Terms and Conditions -->
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <MudMarkdown Value="@termsTemplate.TermsText" />
                </MudPaper>

                <!-- Acceptance Form -->
                <MudStack Spacing="3">
                    <!-- Typed Signature -->
                    <MudTextField @bind-Value="typedSignature"
                                  Label="Full Legal Name (Typed Signature)"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  Placeholder="Type your full legal name"
                                  HelperText="Your typed name serves as your electronic signature"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Draw" />

                    <!-- Title/Role -->
                    <MudTextField @bind-Value="acceptorTitle"
                                  Label="Your Title/Role"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Badge" />

                    <!-- Organization -->
                    <MudTextField @bind-Value="acceptorOrganization"
                                  Label="Organization Name"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Business" />

                    <!-- Agreement Checkbox -->
                    <MudCheckBox @bind-Value="agreedToTerms" 
                                 Color="Color.Primary"
                                 Dense="true">
                        <MudText Typo="Typo.body2">
                            @termsTemplate.CheckboxText
                        </MudText>
                    </MudCheckBox>

                    <!-- Validation Errors -->
                    @if (validationErrors.Any())
                    {
                        <MudAlert Severity="Severity.Error" Dense="true">
                            <ul class="mb-0 pl-3">
                                @foreach (var error in validationErrors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </MudAlert>
                    }

                    <!-- Legal Notice -->
                    <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                        <MudText Typo="Typo.caption">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                            By clicking "@termsTemplate.AcceptButtonText", you acknowledge that your electronic 
                            acceptance constitutes a valid and binding signature. A record of this acceptance, 
                            including timestamp and IP address, will be maintained.
                        </MudText>
                    </MudAlert>
                </MudStack>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="AcceptProposal" 
                   Variant="Variant.Filled" 
                   Color="Color.Success"
                   Disabled="@(!CanAccept || isSubmitting)"
                   StartIcon="@(isSubmitting ? null : Icons.Material.Filled.CheckCircle)">
            @if (isSubmitting)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>Processing...</span>
            }
            else
            {
                <span>@(termsTemplate?.AcceptButtonText ?? "Accept Proposal")</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ReserveStudy? ReserveStudy { get; set; }

    [Parameter]
    public Guid? ProposalId { get; set; }

    private AcceptanceTermsTemplate? termsTemplate;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool isDownloadingPdf = false;
    
    // Form fields
    private string typedSignature = "";
    private string acceptorTitle = "";
    private string acceptorOrganization = "";
    private bool agreedToTerms = false;
    
    private List<string> validationErrors = new();

    private bool CanAccept => 
        !string.IsNullOrWhiteSpace(typedSignature) && 
        agreedToTerms && 
        termsTemplate != null &&
        !isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Seed default terms if needed
            await AcceptanceService.SeedDefaultTermsIfNeededAsync();
            
            // Load active terms template
            termsTemplate = await AcceptanceService.GetActiveTermsTemplateAsync();
            
            // Pre-populate organization from community name if available
            if (ReserveStudy?.Community != null)
            {
                acceptorOrganization = ReserveStudy.Community.Name;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading terms: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task DownloadProposalPdf()
    {
        if (ReserveStudy?.CurrentProposal == null)
        {
            Snackbar.Add("No proposal available to download.", Severity.Warning);
            return;
        }

        isDownloadingPdf = true;
        StateHasChanged();

        try
        {
            var pdfBytes = await ProposalPdfService.GenerateProposalPdfAsync(ReserveStudy.Id);
            var fileName = $"Proposal_{ReserveStudy.Community?.Name?.Replace(" ", "_") ?? ReserveStudy.Id.ToString()}_{DateTime.Now:yyyyMMdd}.pdf";
            
            // Convert to base64 and trigger download via JavaScript
            var base64 = Convert.ToBase64String(pdfBytes);
            await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64, "application/pdf");
            
            Snackbar.Add("Proposal PDF downloaded successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to generate PDF: {ex.Message}", Severity.Error);
        }
        finally
        {
            isDownloadingPdf = false;
            StateHasChanged();
        }
    }

    private async Task AcceptProposal()
    {
        validationErrors.Clear();

        // Validate
        if (string.IsNullOrWhiteSpace(typedSignature))
            validationErrors.Add("Please type your full legal name as your signature.");

        if (!agreedToTerms)
            validationErrors.Add("You must agree to the terms and conditions.");

        if (ReserveStudy == null)
            validationErrors.Add("Reserve study information is missing.");

        if (termsTemplate == null)
            validationErrors.Add("Terms template is not available.");

        if (validationErrors.Any())
            return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            // Get current user
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            var emailClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.Email);
            
            if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out var userId))
            {
                Snackbar.Add("Unable to identify current user.", Severity.Error);
                return;
            }

            // Get IP address and user agent
            var httpContext = HttpContextAccessor.HttpContext;
            var ipAddress = httpContext?.Connection?.RemoteIpAddress?.ToString();
            var userAgent = httpContext?.Request?.Headers?.UserAgent.ToString();

            // Create acceptance record
            var acceptance = new ProposalAcceptance
            {
                ReserveStudyId = ReserveStudy!.Id,
                ProposalId = ProposalId ?? ReserveStudy.CurrentProposal?.Id,
                AcceptedByUserId = userId,
                TypedSignature = typedSignature.Trim(),
                AcceptorTitle = string.IsNullOrWhiteSpace(acceptorTitle) ? null : acceptorTitle.Trim(),
                AcceptorOrganization = string.IsNullOrWhiteSpace(acceptorOrganization) ? null : acceptorOrganization.Trim(),
                AcceptorEmail = emailClaim?.Value,
                IpAddress = ipAddress,
                UserAgent = userAgent?.Length > 500 ? userAgent[..500] : userAgent,
                TermsVersion = termsTemplate!.Version,
                AcceptanceTermsTemplateId = termsTemplate.Id,
                TermsContentHash = AcceptanceService.ComputeTermsHash(termsTemplate.TermsText),
                CheckboxConfirmed = agreedToTerms
            };

            var result = await AcceptanceService.RecordAcceptanceAsync(acceptance);
            
            Snackbar.Add("Proposal accepted successfully!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error recording acceptance: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
