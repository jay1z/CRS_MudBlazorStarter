@using Horizon.Models
@using Horizon.Services.Interfaces
@using Horizon.Services.Storage
@using Horizon.Data
@using Microsoft.EntityFrameworkCore

@inject ISiteVisitPhotoService PhotoService
@inject IPhotoStorageService PhotoStorage
@inject ISnackbar Snackbar
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudDialog Style="max-width: 95vw;">
    <DialogContent>
        <MudStack Spacing="2">
            <!-- Main Photo Display -->
            <MudPaper Elevation="0" Style="background: #000; border-radius: 8px; position: relative; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                @if (currentPhoto != null)
                {
                    <MudImage Src="@GetPhotoUrl(currentPhoto)"
                              Alt="@(currentPhoto.Caption ?? "Site visit photo")"
                              ObjectFit="ObjectFit.Contain"
                              Style="max-height: 70vh; max-width: 100%; border-radius: 8px;" />
                    
                    <!-- Navigation Arrows -->
                    @if (AllPhotos.Count > 1)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos"
                                       Color="Color.Surface"
                                       OnClick="PreviousPhoto"
                                       Style="position: absolute; left: 8px; background: rgba(0,0,0,0.5);" />
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos"
                                       Color="Color.Surface"
                                       OnClick="NextPhoto"
                                       Style="position: absolute; right: 8px; background: rgba(0,0,0,0.5);" />
                    }
                    
                    <!-- Photo Counter -->
                    <MudChip T="string" Size="Size.Small" 
                             Style="position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white;">
                        @(currentIndex + 1) / @AllPhotos.Count
                    </MudChip>
                }
            </MudPaper>

            <!-- Photo Details -->
            @if (currentPhoto != null)
            {
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius: 8px;">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" md="6">
                            @if (isEditing)
                            {
                                <MudTextField @bind-Value="editCaption" 
                                              Label="Caption" 
                                              Variant="Variant.Outlined"
                                              Margin="Margin.Dense" />
                            }
                            else if (!string.IsNullOrEmpty(currentPhoto.Caption))
                            {
                                <MudText Typo="Typo.h6">@currentPhoto.Caption</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.h6" Style="color: #999; font-style: italic;">No caption</MudText>
                            }
                        </MudItem>
                        
                        <MudItem xs="12" md="6">
                            <MudStack Row="true" Spacing="2" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center">
                                @if (isEditing)
                                {
                                    <MudSelect T="PhotoCategory" @bind-Value="editCategory" Label="Category" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;">
                                        @foreach (PhotoCategory cat in Enum.GetValues<PhotoCategory>())
                                        {
                                            <MudSelectItem T="PhotoCategory" Value="@cat">@GetCategoryDisplayName(cat)</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <MudSelect T="ElementCondition" @bind-Value="editCondition" Label="Condition" Variant="Variant.Outlined" Margin="Margin.Dense" Style="min-width: 150px;">
                                        @foreach (ElementCondition cond in Enum.GetValues<ElementCondition>())
                                        {
                                            <MudSelectItem T="ElementCondition" Value="@cond">@GetConditionDisplayName(cond)</MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                                        @GetCategoryDisplayName(currentPhoto.Category)
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="@GetConditionColor(currentPhoto.Condition)" Variant="Variant.Filled">
                                        @GetConditionDisplayName(currentPhoto.Condition)
                                    </MudChip>
                                }
                            </MudStack>
                        </MudItem>

                        @if (isEditing)
                        {
                            <MudItem xs="12">
                                <MudTextField @bind-Value="editNotes" 
                                              Label="Notes" 
                                              Variant="Variant.Outlined"
                                              Lines="3"
                                              Margin="Margin.Dense" />
                            </MudItem>

                            @* Element linking dropdown *@
                            @if (availableElements.Any())
                            {
                                <MudItem xs="12">
                                    <MudSelect T="ElementSelection" 
                                               @bind-Value="editSelectedElement"
                                               Label="Link to Element"
                                               Variant="Variant.Outlined"
                                               Margin="Margin.Dense"
                                               Clearable="true"
                                               AnchorOrigin="Origin.BottomCenter"
                                               TransformOrigin="Origin.TopCenter"
                                               HelperText="Associate this photo with a specific element">
                                        @foreach (var elementGroup in availableElements.GroupBy(e => e.TypeDisplay))
                                        {
                                            <MudSelectItem T="ElementSelection" Value="@(null)" Disabled="true">
                                                <MudText Typo="Typo.overline" Style="font-weight: 600; color: #666;">@elementGroup.Key</MudText>
                                            </MudSelectItem>
                                            @foreach (var element in elementGroup)
                                            {
                                                <MudSelectItem T="ElementSelection" Value="@element">
                                                    @element.Name
                                                </MudSelectItem>
                                            }
                                        }
                                    </MudSelect>
                                </MudItem>
                            }

                            <MudItem xs="12">
                                <MudStack Row="true" Spacing="2">
                                    <MudCheckBox T="bool" @bind-Value="editIncludeInReport" Label="Include in report" />
                                    <MudCheckBox T="bool" @bind-Value="editIsPrimary" Label="Set as primary photo" />
                                </MudStack>
                            </MudItem>
                        }
                        else if (!string.IsNullOrEmpty(currentPhoto.Notes))
                        {
                            <MudItem xs="12">
                                <MudText Typo="Typo.body2" Style="color: #666;">@currentPhoto.Notes</MudText>
                            </MudItem>
                        }

                        <MudItem xs="12">
                            <MudDivider Class="my-2" />
                            <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Style="color: #999;" />
                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                        @currentPhoto.PhotoTakenAt.ToString("MMMM dd, yyyy h:mm tt")
                                    </MudText>
                                    
                                    @if (currentPhoto.Latitude.HasValue && currentPhoto.Longitude.HasValue)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Size="Size.Small" Style="color: #999;" />
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            @currentPhoto.Latitude.Value.ToString("F4"), @currentPhoto.Longitude.Value.ToString("F4")
                                        </MudText>
                                    }
                                </MudStack>
                                
                                <MudStack Row="true" Spacing="1">
                                    @if (currentPhoto.IsPrimary)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">
                                            <MudIcon Icon="@Icons.Material.Filled.Star" Size="Size.Small" Class="mr-1" />
                                            Primary
                                        </MudChip>
                                    }
                                    @if (currentPhoto.IncludeInReport)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Class="mr-1" />
                                            In Report
                                        </MudChip>
                                    }
                                    @if (currentPhoto.ElementId.HasValue && !string.IsNullOrEmpty(currentPhoto.ElementType))
                                    {
                                        @* Show linked element *@
                                        var linkedElement = availableElements.FirstOrDefault(e => 
                                            e.Id == currentPhoto.ElementId.Value && e.ElementType == currentPhoto.ElementType);
                                        if (linkedElement != null)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Tertiary" Variant="Variant.Outlined">
                                                <MudIcon Icon="@Icons.Material.Filled.Link" Size="Size.Small" Class="mr-1" />
                                                @linkedElement.Name
                                            </MudChip>
                                        }
                                    }
                                </MudStack>
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        @if (CanEdit)
        {
            @if (isEditing)
            {
                <MudButton OnClick="CancelEdit" Color="Color.Default">Cancel</MudButton>
                <MudButton OnClick="SaveChanges" Color="Color.Primary" Variant="Variant.Filled" Disabled="@isSaving">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Save Changes
                </MudButton>
            }
            else
            {
                <MudButton OnClick="@(() => ConfirmDelete())" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete">
                    Delete
                </MudButton>
                <MudButton OnClick="StartEdit" Color="Color.Primary" Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Edit">
                    Edit
                </MudButton>
            }
        }
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public SiteVisitPhoto Photo { get; set; } = null!;

    [Parameter]
    public List<SiteVisitPhoto> AllPhotos { get; set; } = new();

    [Parameter]
    public bool CanEdit { get; set; } = false;

    [Parameter]
    public Guid ReserveStudyId { get; set; }

    private SiteVisitPhoto? currentPhoto;
    private int currentIndex;
    private bool isEditing = false;
    private bool isSaving = false;
    private bool hasChanges = false;

    // Edit fields
    private string editCaption = "";
    private string editNotes = "";
    private PhotoCategory editCategory;
    private ElementCondition editCondition;
    private bool editIncludeInReport;
    private bool editIsPrimary;

    // Element linking
    private List<ElementSelection> availableElements = new();
    private ElementSelection? editSelectedElement = null;
    private bool isLoadingElements = false;

    // Element selection record for the dropdown
    private record ElementSelection(Guid Id, string Name, string ElementType, string TypeDisplay);

    protected override async Task OnInitializedAsync()
    {
        currentPhoto = Photo;
        currentIndex = AllPhotos.FindIndex(p => p.Id == Photo.Id);
        if (currentIndex < 0) currentIndex = 0;

        await LoadAvailableElementsAsync();
    }

    private async Task LoadAvailableElementsAsync()
    {
        if (ReserveStudyId == Guid.Empty) return;

        isLoadingElements = true;
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();

            var study = await context.ReserveStudies
                .AsNoTracking()
                .Include(rs => rs.ReserveStudyBuildingElements!)
                    .ThenInclude(e => e.BuildingElement)
                .Include(rs => rs.ReserveStudyCommonElements!)
                    .ThenInclude(e => e.CommonElement)
                .Include(rs => rs.ReserveStudyAdditionalElements)
                .FirstOrDefaultAsync(rs => rs.Id == ReserveStudyId);

            if (study == null) return;

            var elements = new List<ElementSelection>();

            // Add building elements
            if (study.ReserveStudyBuildingElements != null)
            {
                foreach (var e in study.ReserveStudyBuildingElements.Where(x => x.BuildingElement != null))
                {
                    elements.Add(new ElementSelection(
                        e.Id, 
                        e.BuildingElement!.Name, 
                        "Building", 
                        "ðŸ¢ Building"));
                }
            }

            // Add common elements
            if (study.ReserveStudyCommonElements != null)
            {
                foreach (var e in study.ReserveStudyCommonElements.Where(x => x.CommonElement != null))
                {
                    elements.Add(new ElementSelection(
                        e.Id, 
                        e.CommonElement!.Name, 
                        "Common", 
                        "ðŸ˜ï¸ Common"));
                }
            }

            // Add additional elements (these have Name directly on the element)
            if (study.ReserveStudyAdditionalElements != null)
            {
                foreach (var e in study.ReserveStudyAdditionalElements.Where(x => !string.IsNullOrEmpty(x.Name)))
                {
                    elements.Add(new ElementSelection(
                        e.Id, 
                        e.Name, 
                        "Additional", 
                        "âž• Additional"));
                }
            }

            availableElements = elements.OrderBy(e => e.TypeDisplay).ThenBy(e => e.Name).ToList();
        }
        catch
        {
            // Silently fail - element linking is optional
            availableElements = new List<ElementSelection>();
        }
        finally
        {
            isLoadingElements = false;
        }
    }

    private void PreviousPhoto()
    {
        if (AllPhotos.Count <= 1) return;
        currentIndex = (currentIndex - 1 + AllPhotos.Count) % AllPhotos.Count;
        currentPhoto = AllPhotos[currentIndex];
        isEditing = false;
    }

    private void NextPhoto()
    {
        if (AllPhotos.Count <= 1) return;
        currentIndex = (currentIndex + 1) % AllPhotos.Count;
        currentPhoto = AllPhotos[currentIndex];
        isEditing = false;
    }

    private void StartEdit()
    {
        if (currentPhoto == null) return;

        editCaption = currentPhoto.Caption ?? "";
        editNotes = currentPhoto.Notes ?? "";
        editCategory = currentPhoto.Category;
        editCondition = currentPhoto.Condition;
        editIncludeInReport = currentPhoto.IncludeInReport;
        editIsPrimary = currentPhoto.IsPrimary;

        // Initialize element selection based on current photo
        if (currentPhoto.ElementId.HasValue && !string.IsNullOrEmpty(currentPhoto.ElementType))
        {
            editSelectedElement = availableElements.FirstOrDefault(e => 
                e.Id == currentPhoto.ElementId.Value && e.ElementType == currentPhoto.ElementType);
        }
        else
        {
            editSelectedElement = null;
        }

        isEditing = true;
    }

    private void CancelEdit()
    {
        isEditing = false;
    }

    private async Task SaveChanges()
    {
        if (currentPhoto == null) return;

        isSaving = true;
        try
        {
            currentPhoto.Caption = editCaption;
            currentPhoto.Notes = editNotes;
            currentPhoto.Category = editCategory;
            currentPhoto.Condition = editCondition;
            currentPhoto.IncludeInReport = editIncludeInReport;

            // Update element association
            currentPhoto.ElementId = editSelectedElement?.Id;
            currentPhoto.ElementType = editSelectedElement?.ElementType;

            await PhotoService.UpdateAsync(currentPhoto);

            if (editIsPrimary && !currentPhoto.IsPrimary)
            {
                await PhotoService.SetAsPrimaryAsync(currentPhoto.Id);
                currentPhoto.IsPrimary = true;
            }

            hasChanges = true;
            isEditing = false;
            Snackbar.Add("Photo updated successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating photo: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ConfirmDelete()
    {
        if (currentPhoto == null) return;

        var result = await PhotoService.DeleteAsync(currentPhoto.Id);
        if (result)
        {
            // Also delete from storage
            await PhotoStorage.DeletePhotoAsync(currentPhoto.StorageUrl, currentPhoto.ThumbnailUrl);
            
            hasChanges = true;
            Snackbar.Add("Photo deleted", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            Snackbar.Add("Failed to delete photo", Severity.Error);
        }
    }

    private void Close()
    {
        if (hasChanges)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
        else
        {
            MudDialog.Cancel();
        }
    }

    private string GetPhotoUrl(SiteVisitPhoto photo)
    {
        return PhotoStorage.GetSasUrl(photo.StorageUrl);
    }

    private string GetCategoryDisplayName(PhotoCategory category) => category switch
    {
        PhotoCategory.General => "General",
        PhotoCategory.Exterior => "Exterior",
        PhotoCategory.Interior => "Interior",
        PhotoCategory.Roof => "Roof",
        PhotoCategory.Foundation => "Foundation",
        PhotoCategory.Mechanical => "Mechanical",
        PhotoCategory.Electrical => "Electrical",
        PhotoCategory.Plumbing => "Plumbing",
        PhotoCategory.CommonArea => "Common Area",
        PhotoCategory.Amenity => "Amenity",
        PhotoCategory.Damage => "Damage",
        PhotoCategory.BeforeAfter => "Before/After",
        _ => category.ToString()
    };

    private string GetConditionDisplayName(ElementCondition condition) => condition switch
    {
        ElementCondition.NotAssessed => "Not Assessed",
        ElementCondition.Excellent => "Excellent",
        ElementCondition.Good => "Good",
        ElementCondition.Fair => "Fair",
        ElementCondition.Poor => "Poor",
        ElementCondition.Critical => "Critical",
        ElementCondition.NeedsReplacement => "Needs Replacement",
        _ => condition.ToString()
    };

    private Color GetConditionColor(ElementCondition condition) => condition switch
    {
        ElementCondition.Excellent => Color.Success,
        ElementCondition.Good => Color.Success,
        ElementCondition.Fair => Color.Warning,
        ElementCondition.Poor => Color.Error,
        ElementCondition.Critical => Color.Error,
        ElementCondition.NeedsReplacement => Color.Error,
        _ => Color.Default
    };
}
