@* A reusable component for workflow status buttons *@
@using CRS.Models
@using CRS.Models.Workflow

@foreach (var status in StatusList)
{
    <MudButton Variant="Variant.Filled" 
              Color="@GetButtonColor(status)"
              OnClick="@(() => HandleStatusClick(status))" 
              FullWidth="true" 
              Size="Size.Small"
              Disabled="@IsDisabled(status.Status)">
        @status.Text
    </MudButton>
}

@code {
    [Parameter]
    public List<StatusButtonInfo> StatusList { get; set; } = new();

    [Parameter]
    public StudyStatus? CurrentStatus { get; set; }

    [Parameter]
    public EventCallback<StatusChangeEventArgs> OnStatusChange { get; set; }

    private async Task HandleStatusClick(StatusButtonInfo status)
    {
        var args = new StatusChangeEventArgs
        {
            Status = status.Status,
            HasCustomAction = status.HasCustomAction,
            CustomAction = status.CustomAction ?? (_ => Task.CompletedTask)
        };
        
        await OnStatusChange.InvokeAsync(args);
    }

    private Color GetButtonColor(StatusButtonInfo status)
    {
        // If special color is set, use it
        if (status.SpecialColor.HasValue)
            return status.SpecialColor.Value;
            
        // Current status gets highlighted
        if (CurrentStatus == status.Status)
            return Color.Primary;
            
        return Color.Default;
    }

    private bool IsDisabled(StudyStatus status)
    {
        // Special cases that shouldn't be disabled
        if (status == StudyStatus.RequestCancelled || 
            status == StudyStatus.RequestArchived)
            return false;
            
        // Can't go backward in workflow
        return CurrentStatus > status;
    }

    // Class to hold status button information
    public class StatusButtonInfo
    {
        public StudyStatus Status { get; set; }
        public string Text { get; set; } = string.Empty;
        public bool HasCustomAction { get; set; }
        public Func<Guid, Task>? CustomAction { get; set; }
        public Color? SpecialColor { get; set; }

        public StatusButtonInfo(StudyStatus status, string text, bool hasCustomAction, 
            Func<Guid, Task>? customAction = null, Color? specialColor = null)
        {
            Status = status;
            Text = text;
            HasCustomAction = hasCustomAction;
            CustomAction = customAction;
            SpecialColor = specialColor;
        }
    }

    // Event args for status changes
    public class StatusChangeEventArgs
    {
        public StudyStatus Status { get; set; }
        public bool HasCustomAction { get; set; }
        public Func<Guid, Task> CustomAction { get; set; } = _ => Task.CompletedTask;
    }
}