@using Horizon.Core.ReserveCalculator.Models
@using Horizon.Services.ReserveCalculator
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<MudPaper Elevation="2" Class="pa-4" Style="border-radius: 8px;">
    @if (Result == null)
    {
        <MudStack AlignItems="AlignItems.Center" Spacing="3">
            <MudIcon Icon="@Icons.Material.Filled.Calculate" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.body1" Color="Color.Secondary">
                Click "Calculate" to generate results
            </MudText>
        </MudStack>
    }
    else if (!Result.IsSuccess)
    {
        <MudAlert Severity="Severity.Error">
            <MudText Typo="Typo.body1">@Result.ErrorMessage</MudText>
        </MudAlert>
    }
    else
    {
        <!-- Export Buttons -->
        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-3">
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PictureAsPdf" OnClick="ExportToPdf">
                Export PDF
            </MudButton>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.TableView" OnClick="ExportToExcel">
                Export Excel
            </MudButton>
        </MudStack>

        <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <!-- Summary Tab -->
            <MudTabPanel Text="Summary" Icon="@Icons.Material.Filled.Dashboard">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px; text-align: center;">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Contributions</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Primary">@Result.TotalContributions.ToString("C0")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px; text-align: center;">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Expenditures</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Error">@Result.TotalExpenditures.ToString("C0")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px; text-align: center;">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Interest Earned</MudText>
                            <MudText Typo="Typo.h5" Color="Color.Success">@Result.TotalInterestEarned.ToString("C0")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4" Elevation="1" Style="border-radius: 8px; text-align: center;">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Final Balance</MudText>
                            <MudText Typo="Typo.h5" Color="@(Result.FinalBalance >= 0 ? Color.Success : Color.Error)">
                                @Result.FinalBalance.ToString("C0")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                
                @if (!Result.IsFullyFunded)
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-4">
                        <MudText Typo="Typo.body2">
                            <strong>Warning:</strong> This scenario has @Result.DeficitYearCount deficit year(s).
                            First deficit occurs in @Result.FirstDeficitYear.
                            Minimum balance: @Result.MinimumBalance.ToString("C0") in @Result.MinimumBalanceYear.
                        </MudText>
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Success" Class="mt-4">
                        <MudText Typo="Typo.body2">
                            <strong>Fully Funded:</strong> This scenario maintains a positive balance throughout the projection period.
                        </MudText>
                    </MudAlert>
                }
            </MudTabPanel>
            
            <!-- Chart Tab -->
            <MudTabPanel Text="Chart" Icon="@Icons.Material.Filled.ShowChart">
                <Horizon.Components.ReserveStudy.CashFlowChart Result="@Result" ChartId="results-chart" Height="400" />
            </MudTabPanel>
            
            <!-- Cash Flow Table Tab -->
            <MudTabPanel Text="Cash Flow" Icon="@Icons.Material.Filled.TableChart">
                <MudTable Items="@Result.Years" Dense="true" Hover="true" Striped="true"
                          FixedHeader="true" Height="500px">
                    <HeaderContent>
                        <MudTh>Year</MudTh>
                        <MudTh Style="text-align: right">Beginning Balance</MudTh>
                        <MudTh Style="text-align: right">Contributions</MudTh>
                        <MudTh Style="text-align: right">Interest</MudTh>
                        <MudTh Style="text-align: right">Expenditures</MudTh>
                        <MudTh Style="text-align: right">Ending Balance</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Year">@context.CalendarYear</MudTd>
                        <MudTd DataLabel="Beginning" Style="text-align: right">@context.BeginningBalance.ToString("C0")</MudTd>
                        <MudTd DataLabel="Contributions" Style="text-align: right; color: green;">@context.Contribution.ToString("C0")</MudTd>
                        <MudTd DataLabel="Interest" Style="text-align: right; color: blue;">@context.InterestEarned.ToString("C0")</MudTd>
                        <MudTd DataLabel="Expenditures" Style="text-align: right; color: red;">@context.Expenditures.ToString("C0")</MudTd>
                        <MudTd DataLabel="Ending" Style="@GetEndingBalanceStyle(context.EndingBalance)">
                            @context.EndingBalance.ToString("C0")
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
            
            <!-- Category Allocation Tab -->
            <MudTabPanel Text="Allocation" Icon="@Icons.Material.Filled.PieChart">
                <MudTable Items="@Result.Allocation" Dense="true" Hover="true">
                    <HeaderContent>
                        <MudTh>Category</MudTh>
                        <MudTh>Components</MudTh>
                        <MudTh Style="text-align: right">Total Spend</MudTh>
                        <MudTh Style="text-align: right">% of Total</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Category">@context.Category</MudTd>
                        <MudTd DataLabel="Components">@context.ComponentCount</MudTd>
                        <MudTd DataLabel="Total" Style="text-align: right">@context.TotalSpend.ToString("C0")</MudTd>
                        <MudTd DataLabel="%" Style="text-align: right">
                            <MudProgressLinear Color="Color.Primary" Value="@((double)context.PercentOfTotal)" Class="my-1" />
                            @context.PercentOfTotal.ToString("N1")%
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudTabPanel>
        </MudTabs>
    }
</MudPaper>

@code {
    [Parameter]
    public ReserveStudyResult? Result { get; set; }
    
    [Parameter]
    public string? CommunityName { get; set; }

    private string GetEndingBalanceStyle(decimal endingBalance)
    {
        return $"text-align: right; font-weight: bold; color: {(endingBalance >= 0 ? "inherit" : "red")}";
    }

    private async Task ExportToPdf()
    {
        if (Result == null) return;

        try
        {
            var pdfService = new ReserveStudyPdfService();
            var options = new ReserveStudyReportOptions
            {
                CommunityName = CommunityName,
                PreparedDate = DateTime.Now
            };
            var pdfBytes = pdfService.GenerateReport(Result, options);
            
            var fileName = $"ReserveStudy_{Result.StartYear}_{Result.ProjectionYears}Year.pdf";
            await DownloadFile(pdfBytes, fileName, "application/pdf");
            
            Snackbar.Add("PDF exported successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToExcel()
    {
        if (Result == null) return;

        try
        {
            var excelService = new ReserveStudyExcelService();
            var options = new ReserveStudyReportOptions
            {
                CommunityName = CommunityName,
                PreparedDate = DateTime.Now
            };
            var excelBytes = excelService.ExportResults(Result, options);
            
            var fileName = $"ReserveStudy_{Result.StartYear}_{Result.ProjectionYears}Year.xlsx";
            await DownloadFile(excelBytes, fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            
            Snackbar.Add("Excel exported successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting Excel: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadFile(byte[] bytes, string fileName, string contentType)
    {
        var base64 = Convert.ToBase64String(bytes);
        await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", fileName, base64, contentType);
    }
}
