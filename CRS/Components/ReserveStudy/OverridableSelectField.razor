@typeparam TEnum where TEnum : struct, Enum

<MudStack Spacing="1">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
        <MudText Typo="Typo.caption" Color="Color.Secondary">@Label</MudText>
        @if (!IsOverriding)
        {
            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Default</MudChip>
        }
    </MudStack>
    
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
        <MudSwitch T="bool" Value="IsOverriding" ValueChanged="OnToggleOverride"
                   Color="Color.Primary" Size="Size.Small"
                   Label="@(IsOverriding ? "Override" : "Use Default")"
                   LabelPosition="LabelPosition.Start" />
    </MudStack>
    
    <MudSelect T="TEnum" Value="@CurrentValue" ValueChanged="OnValueChanged"
               Disabled="@(!IsOverriding)"
               Variant="Variant.Outlined"
               HelperText="@HelperText">
        @foreach (var value in Enum.GetValues<TEnum>())
        {
            <MudSelectItem Value="@value">@FormatEnumValue(value)</MudSelectItem>
        }
    </MudSelect>
</MudStack>

@code {
    [Parameter, EditorRequired]
    public string Label { get; set; } = "";
    
    [Parameter]
    public TEnum? OverrideValue { get; set; }
    
    [Parameter]
    public TEnum DefaultValue { get; set; }
    
    [Parameter]
    public EventCallback<TEnum?> OnOverrideValueChanged { get; set; }
    
    [Parameter]
    public string? HelperText { get; set; }
    
    private bool IsOverriding => OverrideValue.HasValue;
    
    private TEnum CurrentValue => OverrideValue ?? DefaultValue;
    
    private async Task OnToggleOverride(bool isOverriding)
    {
        if (isOverriding)
        {
            await OnOverrideValueChanged.InvokeAsync(DefaultValue);
        }
        else
        {
            await OnOverrideValueChanged.InvokeAsync(null);
        }
    }
    
    private async Task OnValueChanged(TEnum value)
    {
        await OnOverrideValueChanged.InvokeAsync(value);
    }
    
    private string FormatEnumValue(TEnum value)
    {
        // Convert PascalCase to spaced words
        var name = value.ToString();
        return System.Text.RegularExpressions.Regex.Replace(name, "(\\B[A-Z])", " $1");
    }
}
