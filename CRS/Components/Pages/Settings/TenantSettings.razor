@page "/Admin/Settings"
@page "/Settings"
@attribute [Authorize(Policy = "RequireTenantOwner")]
@using CRS.Data
@using CRS.Models
@using CRS.Services.Tenant
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ITenantContext TenantContext
@inject ThemeService ThemeService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IWebHostEnvironment Env
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject CRS.Services.Storage.ILogoStorageService LogoStorage
@inject CRS.Services.Interfaces.IProposalAcceptanceService AcceptanceService

<PageTitle>Organization Settings</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <!-- Header Section -->
    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" Style="vertical-align: middle;" />
                    Organization Settings
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                    Configure your organization's branding, theme, and preferences
                </MudText>
            </MudStack>
            @if (hasUnsavedChanges)
            {
                <MudChip T="string" Color="Color.Warning" Style="background: white; color: #FF8C00;">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Class="mr-1" />
                    Unsaved Changes
                </MudChip>
            }
        </MudStack>
    </MudPaper>

    @if (tenant == null)
    {
        <MudPaper Class="pa-8" Elevation="2" Style="border-radius: 12px;">
            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@Icons.Material.Filled.Warning" Style="font-size: 64px; color: #FFA726;" />
                <MudText Typo="Typo.h6">No tenant context available</MudText>
                <MudText Typo="Typo.body2" Style="color: #666;">Please ensure you're logged in with a valid tenant account.</MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudGrid Spacing="4">
            <!-- Left Navigation Panel -->
            <MudItem xs="12" md="3">
                <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; position: sticky; top: 100px;">
                    <MudText Typo="Typo.subtitle2" Class="fw-bold mb-3" Style="color: #666; text-transform: uppercase; letter-spacing: 1px;">
                        Settings
                    </MudText>
                    <MudNavMenu>
                        <MudNavLink Icon="@Icons.Material.Filled.Info" 
                                    IconColor="@(activeTab == 0 ? Color.Primary : Color.Default)"
                                    Class="@(activeTab == 0 ? "mud-nav-link-active" : "")"
                                    OnClick="@(() => activeTab = 0)">
                            General
                        </MudNavLink>
                        <MudNavLink Icon="@Icons.Material.Filled.Palette" 
                                    IconColor="@(activeTab == 1 ? Color.Primary : Color.Default)"
                                    Class="@(activeTab == 1 ? "mud-nav-link-active" : "")"
                                    OnClick="@(() => activeTab = 1)">
                            Branding & Theme
                        </MudNavLink>
                        <MudNavLink Icon="@Icons.Material.Filled.Image" 
                                    IconColor="@(activeTab == 2 ? Color.Primary : Color.Default)"
                                    Class="@(activeTab == 2 ? "mud-nav-link-active" : "")"
                                    OnClick="@(() => activeTab = 2)">
                            Logo
                        </MudNavLink>
                        <MudNavLink Icon="@Icons.Material.Filled.PictureAsPdf" 
                                    IconColor="@(activeTab == 3 ? Color.Primary : Color.Default)"
                                    Class="@(activeTab == 3 ? "mud-nav-link-active" : "")"
                                    OnClick="@(() => activeTab = 3)">
                            PDF Settings
                        </MudNavLink>
                        <MudNavLink Icon="@Icons.Material.Filled.Code" 
                                    IconColor="@(activeTab == 4 ? Color.Primary : Color.Default)"
                                    Class="@(activeTab == 4 ? "mud-nav-link-active" : "")"
                                    OnClick="@(() => activeTab = 4)">
                            Advanced
                        </MudNavLink>
                            <MudNavLink Icon="@Icons.Material.Filled.CompareArrows" 
                                        IconColor="@(activeTab == 5 ? Color.Primary : Color.Default)"
                                        Class="@(activeTab == 5 ? "mud-nav-link-active" : "")"
                                        OnClick="@(() => activeTab = 5)">
                                Scope Changes
                            </MudNavLink>
                            <MudNavLink Icon="@Icons.Material.Filled.Gavel" 
                                        IconColor="@(activeTab == 6 ? Color.Primary : Color.Default)"
                                        Class="@(activeTab == 6 ? "mud-nav-link-active" : "")"
                                        OnClick="@(() => activeTab = 6)">
                                Acceptance Terms
                            </MudNavLink>
                                <MudNavLink Icon="@Icons.Material.Filled.AccountTree" 
                                            IconColor="@(activeTab == 7 ? Color.Primary : Color.Default)"
                                            Class="@(activeTab == 7 ? "mud-nav-link-active" : "")"
                                            OnClick="@(() => activeTab = 7)">
                                    Workflow
                                </MudNavLink>

                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.caption" Class="px-3 py-1" Style="color: #999; text-transform: uppercase; font-size: 0.65rem;">
                                    Additional Settings
                                </MudText>

                                <MudNavLink Icon="@Icons.Material.Filled.Receipt" 
                                            Href="/Settings/Invoices"
                                            IconColor="Color.Default">
                                    Invoice Settings
                                    <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="margin-left: auto; opacity: 0.5;" />
                                </MudNavLink>
                                <MudNavLink Icon="@Icons.Material.Filled.Calculate" 
                                            Href="/Settings/ReserveStudy"
                                            IconColor="Color.Default">
                                    Calculator Defaults
                                    <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="margin-left: auto; opacity: 0.5;" />
                                </MudNavLink>
                            </MudNavMenu>
                </MudPaper>
            </MudItem>

            <!-- Right Content Panel -->
            <MudItem xs="12" md="9">
                <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 12px; min-height: 600px;">
                    @if (activeTab == 0)
                    {
                        <!-- General Settings -->
                        <MudStack Spacing="4">
                            <div>
                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">General Information</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Basic information about your organization
                                </MudText>
                            </div>

                            <MudDivider />

                            <MudGrid Spacing="3">
                                <MudItem xs="12">
                                    <MudPaper Elevation="0" Class="pa-4" Style="background: #F9F9F9; border-radius: 8px;">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Style="color: #FF8C00; font-size: 40px;" />
                                            <MudStack Spacing="0" Style="flex: 1;">
                                                <MudText Typo="Typo.body2" Style="color: #666;">Organization Name</MudText>
                                                <MudText Typo="Typo.h6" Class="fw-bold">@tenant.Name</MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="tenant.Name" 
                                                  Label="Organization Name" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Business"
                                                  HelperText="This name appears in emails and reports"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField Value="@tenant.Subdomain" 
                                                  Label="Subdomain" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Link"
                                                  ReadOnly="true" 
                                                  HelperText="Contact support to change your subdomain" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudPaper Elevation="0" Class="pa-4" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.body1" Class="fw-bold">Organization Status</MudText>
                                                <MudText Typo="Typo.body2" Style="color: #666;">
                                                    @(tenant.IsActive ? "Your organization is currently active and accessible" : "Your organization is currently inactive")
                                                </MudText>
                                            </MudStack>
                                            <MudSwitch T="bool" @bind-Checked="tenant.IsActive" 
                                                       Color="@(tenant.IsActive ? Color.Success : Color.Default)"
                                                       OnChange="MarkAsChanged" />
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                                        <MudText Typo="Typo.body2">
                                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                            <strong>Subdomain:</strong> Your organization's URL is <strong>@(tenant.Subdomain).alxreservecloud.com</strong>
                                        </MudText>
                                    </MudAlert>
                                </MudItem>

                                <!-- Company Contact Information -->
                                <MudItem xs="12">
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.h6" Class="mb-3">Contact Information</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #666;" Class="mb-3">
                                        This information appears in emails, reports, and PDF documents.
                                    </MudText>
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="companyTagline" 
                                                  Label="Company Tagline" 
                                                  Variant="Variant.Outlined"
                                                  HelperText="Optional tagline or slogan"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="companyPhone" 
                                                  Label="Phone" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Phone"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="companyEmail" 
                                                  Label="Email" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Email"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>

                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="companyWebsite" 
                                                  Label="Website" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.Language"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>

                                <MudItem xs="12">
                                    <MudTextField @bind-Value="companyAddress" 
                                                  Label="Address" 
                                                  Variant="Variant.Outlined"
                                                  Adornment="Adornment.Start"
                                                  AdornmentIcon="@Icons.Material.Filled.LocationOn"
                                                  OnBlur="MarkAsChanged" />
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    }
                    else if (activeTab == 1)
                    {
                        <!-- Branding & Theme -->
                        <MudStack Spacing="4">
                            <div>
                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">Branding & Theme</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Customize your organization's colors and appearance
                                </MudText>
                            </div>

                            <MudDivider />

                            <!-- Theme Preset Selection -->
                            <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #F3E8FF 0%, #FFF5E6 100%); border-radius: 12px;">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.ColorLens" Style="color: #6A3D9A; font-size: 40px;" />
                                    <MudStack Style="flex: 1;">
                                        <MudText Typo="Typo.h6" Class="fw-bold">Quick Start: Choose a Preset</MudText>
                                        <MudText Typo="Typo.body2" Style="color: #666;">
                                            Select a pre-configured theme or customize your own
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                                <MudSelect T="string" 
                                           @bind-Value="selectedPreset" 
                                           Label="Theme Preset" 
                                           Variant="Variant.Outlined"
                                           Margin="Margin.Dense"
                                           Class="mt-4">
                                    <MudSelectItem Value='@("")'>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.Tune" Size="Size.Small" />
                                            <span>Custom Theme</span>
                                        </MudStack>
                                    </MudSelectItem>
                                    @foreach (var name in presetNames)
                                    {
                                        <MudSelectItem Value="@name">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Palette" Size="Size.Small" />
                                                <span>@name</span>
                                            </MudStack>
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                                @if (!string.IsNullOrWhiteSpace(selectedPreset))
                                {
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               OnClick="ApplyPreset" 
                                               FullWidth="true"
                                               Class="mt-3"
                                               StartIcon="@Icons.Material.Filled.Check">
                                        Apply @selectedPreset Preset
                                    </MudButton>
                                }
                            </MudPaper>

                            <!-- Color Customization -->
                            <MudGrid Spacing="3">
                                <MudItem xs="12">
                                    <MudText Typo="Typo.h6" Class="fw-bold mb-3">
                                        <MudIcon Icon="@Icons.Material.Filled.WbSunny" Size="Size.Small" Class="mr-2" />
                                        Light Theme Colors
                                    </MudText>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;" Class="mb-2">Primary Color</MudText>
                                        <MudColorPicker @bind-Text="branding.Primary" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;" Class="mb-2">Secondary Color</MudText>
                                        <MudColorPicker @bind-Text="branding.Secondary" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;" Class="mb-2">AppBar Background</MudText>
                                        <MudColorPicker @bind-Text="branding.AppbarBackground" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6" md="3">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudText Typo="Typo.caption" Style="color: #666;" Class="mb-2">Background</MudText>
                                        <MudColorPicker @bind-Text="branding.Background" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudDivider Class="my-2" />
                                    <MudText Typo="Typo.h6" Class="fw-bold mb-3">
                                        <MudIcon Icon="@Icons.Material.Filled.DarkMode" Size="Size.Small" Class="mr-2" />
                                        Dark Theme Colors
                                    </MudText>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px; background: #2C2C2C;">
                                        <MudText Typo="Typo.caption" Style="color: #CCC;" Class="mb-2">Dark Primary</MudText>
                                        <MudColorPicker @bind-Text="branding.DarkPrimary" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12" sm="6">
                                    <MudPaper Elevation="0" Class="pa-3" Style="border: 2px solid #e0e0e0; border-radius: 8px; background: #2C2C2C;">
                                        <MudText Typo="Typo.caption" Style="color: #CCC;" Class="mb-2">Dark Secondary</MudText>
                                        <MudColorPicker @bind-Text="branding.DarkSecondary" 
                                                        Style="width: 100%;"
                                                        ColorPickerView="ColorPickerView.Spectrum"
                                                        DisableAlpha="true"
                                                        OnChange="MarkAsChanged" />
                                    </MudPaper>
                                </MudItem>

                                <MudItem xs="12">
                                    <MudPaper Elevation="0" Class="pa-4" Style="border: 2px solid #e0e0e0; border-radius: 8px;">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Spacing="1">
                                                <MudText Typo="Typo.body1" Class="fw-bold">Default Theme Mode</MudText>
                                                <MudText Typo="Typo.body2" Style="color: #666;">
                                                    Choose which theme mode to use by default
                                                </MudText>
                                            </MudStack>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.WbSunny" Size="Size.Small" Style="@(useDarkMode ? "color: #999;" : "color: #FFA726;")" />
                                                <MudSwitch T="bool" @bind-Checked="useDarkMode" 
                                                           Color="Color.Primary"
                                                           OnChange="MarkAsChanged" />
                                                <MudIcon Icon="@Icons.Material.Filled.DarkMode" Size="Size.Small" Style="@(useDarkMode ? "color: #6A3D9A;" : "color: #999;")" />
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                            </MudGrid>

                            <!-- Theme Actions -->
                            <MudStack Row="true" Spacing="2" Class="mt-4">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           OnClick="PreviewTheme"
                                           StartIcon="@Icons.Material.Filled.Preview">
                                    Preview Theme
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Secondary" 
                                           OnClick="ResetTheme"
                                           StartIcon="@Icons.Material.Filled.RestartAlt">
                                    Reset to Default
                                </MudButton>
                            </MudStack>

                            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                    Changes are previewed immediately. Click <strong>Save Settings</strong> at the bottom to persist your changes.
                                </MudText>
                            </MudAlert>
                        </MudStack>
                    }
                    else if (activeTab == 2)
                    {
                        <!-- Logo Settings -->
                        <MudStack Spacing="4">
                            <div>
                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">Organization Logo</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Upload your organization's logo to personalize your portal
                                </MudText>
                            </div>

                            <MudDivider />

                            @if (!string.IsNullOrWhiteSpace(logoUrl))
                            {
                                <!-- Current Logo -->
                                <MudPaper Elevation="0" Class="pa-6" Style="border: 2px solid #e0e0e0; border-radius: 12px; text-align: center;">
                                    <MudStack AlignItems="AlignItems.Center" Spacing="3">
                                        <MudText Typo="Typo.h6" Class="fw-bold">Current Logo</MudText>
                                        <div style="max-width: 300px; padding: 24px; background: #f9f9f9; border-radius: 8px;">
                                            <MudImage Src="@logoUrl" Alt="Organization Logo" Style="max-width: 100%; height: auto;" />
                                        </div>
                                        <MudButton Variant="Variant.Outlined" 
                                                   Color="Color.Error" 
                                                   OnClick="ConfirmRemoveLogo" 
                                                   StartIcon="@Icons.Material.Filled.Delete">
                                            Remove Logo
                                        </MudButton>
                                    </MudStack>
                                </MudPaper>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                    <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Image" Style="font-size: 48px; color: #666;" />
                                        <MudText Typo="Typo.body1" Class="fw-bold">No logo uploaded yet</MudText>
                                        <MudText Typo="Typo.body2" Style="color: #666;">
                                            Upload your organization's logo to personalize your portal
                                        </MudText>
                                    </MudStack>
                                </MudAlert>
                            }

                            <!-- Upload Section -->
                            <MudPaper Elevation="0" Class="pa-6" Style="border: 2px dashed #6A3D9A; border-radius: 12px; background: #F3E8FF;">
                                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Style="color: #6A3D9A; font-size: 56px;" />
                                    <MudText Typo="Typo.h6" Class="fw-bold">Upload New Logo</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #666;" Align="Align.Center">
                                        Choose a file to upload. For best results, use a square image (400×400px minimum).
                                    </MudText>
                                    
                                    <InputFile @ref="fileInput"
                                               OnChange="HandleLogoUpload" 
                                               accept="image/png,image/jpeg,image/svg+xml,image/webp" 
                                               style="display: none;" />
                                    
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               OnClick="TriggerFileInput"
                                               StartIcon="@Icons.Material.Filled.UploadFile">
                                        Choose File
                                    </MudButton>

                                    <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="color: #28a745;" />
                                            Accepted formats: PNG, JPG, SVG, WebP
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="color: #28a745;" />
                                            Recommended size: 400×400px (square)
                                        </MudText>
                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="color: #28a745;" />
                                            Maximum file size: 2MB
                                        </MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>

                            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.AutoFixHigh" Size="Size.Small" Class="mr-1" />
                                    Images larger than 400px will be automatically resized and optimized for web use.
                                </MudText>
                            </MudAlert>
                        </MudStack>
                    }
                    else if (activeTab == 3)
                    {
                        <!-- PDF Settings -->
                        <MudStack Spacing="4">
                            <div>
                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">PDF Settings</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Customize the appearance of generated PDF documents (proposals, reports, etc.)
                                </MudText>
                            </div>

                            <MudDivider />

                            <!-- Info about shared settings -->
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.body2">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                        <strong>Company contact info</strong> is pulled from your <strong>General Settings</strong>.
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                        Colors can be inherited from your theme or customized below for PDFs only.
                                    </MudText>
                                </MudStack>
                            </MudAlert>

                            <MudExpansionPanels Elevation="1">
                                <!-- Color & Typography Section -->
                                <MudExpansionPanel Text="Colors & Typography">
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.UseThemeColors" 
                                                       Color="Color.Primary"
                                                       Label="Use theme colors (from Branding & Theme settings)" />
                                        </MudItem>
                                        
                                        @if (!pdfSettings.UseThemeColors)
                                        {
                                            <MudItem xs="12" md="4">
                                                <MudTextField @bind-Value="pdfSettings.PrimaryColor" 
                                                              Label="Primary Color" 
                                                              Variant="Variant.Outlined"
                                                              HelperText="Hex color (e.g., #667eea)"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="4">
                                                <MudTextField @bind-Value="pdfSettings.SecondaryColor" 
                                                              Label="Secondary Color" 
                                                              Variant="Variant.Outlined"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="4">
                                                <MudTextField @bind-Value="pdfSettings.AccentColor" 
                                                              Label="Accent Color" 
                                                              Variant="Variant.Outlined"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                                                    <MudPaper Elevation="0" Style="@($"width: 40px; height: 40px; border-radius: 8px; background: {pdfSettings.PrimaryColor};")" />
                                                    <MudPaper Elevation="0" Style="@($"width: 40px; height: 40px; border-radius: 8px; background: {pdfSettings.SecondaryColor};")" />
                                                    <MudPaper Elevation="0" Style="@($"width: 40px; height: 40px; border-radius: 8px; background: {pdfSettings.AccentColor};")" />
                                                    <MudText Typo="Typo.caption" Style="color: #666;">Color Preview</MudText>
                                                </MudStack>
                                            </MudItem>
                                        }
                                        
                                        <MudItem xs="12" md="4">
                                            <MudNumericField T="int" @bind-Value="pdfSettings.BaseFontSize" 
                                                             Label="Base Font Size" 
                                                             Variant="Variant.Outlined"
                                                             Min="8" Max="16"
                                                             OnBlur="MarkAsChanged" />
                                        </MudItem>
                                        <MudItem xs="12" md="4">
                                            <MudNumericField T="int" @bind-Value="pdfSettings.HeaderFontSize" 
                                                             Label="Header Font Size" 
                                                             Variant="Variant.Outlined"
                                                             Min="16" Max="36"
                                                             OnBlur="MarkAsChanged" />
                                        </MudItem>
                                        <MudItem xs="12" md="4">
                                            <MudNumericField T="int" @bind-Value="pdfSettings.SectionHeaderFontSize" 
                                                             Label="Section Header Size" 
                                                             Variant="Variant.Outlined"
                                                             Min="10" Max="20"
                                                             OnBlur="MarkAsChanged" />
                                        </MudItem>
                                    </MudGrid>
                                </MudExpansionPanel>

                                <!-- Header & Footer Options -->
                                <MudExpansionPanel Text="Header & Footer">
                                    <MudGrid Spacing="2">
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowLogoInHeader" 
                                                       Color="Color.Primary"
                                                       Label="Show Logo in Header" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowCompanyNameInHeader" 
                                                       Color="Color.Primary"
                                                       Label="Show Company Name in Header" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowFooter" 
                                                       Color="Color.Primary"
                                                       Label="Show Footer" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowPageNumbers" 
                                                       Color="Color.Primary"
                                                       Label="Show Page Numbers" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowGeneratedDate" 
                                                       Color="Color.Primary"
                                                       Label="Show Generated Date" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSwitch T="bool" @bind-Value="pdfSettings.ShowContactInfoInFooter" 
                                                       Color="Color.Primary"
                                                       Label="Show Contact Info in Footer" />
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudTextField @bind-Value="pdfSettings.FooterText" 
                                                          Label="Custom Footer Text" 
                                                          Variant="Variant.Outlined"
                                                          HelperText="Optional custom footer message"
                                                          OnBlur="MarkAsChanged" />
                                        </MudItem>
                                    </MudGrid>
                                </MudExpansionPanel>

                                <!-- Proposal-Specific Settings -->
                                <MudExpansionPanel>
                                    <TitleContent>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Primary" />
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Proposal PDF Settings</MudText>
                                        </MudStack>
                                    </TitleContent>
                                    <ChildContent>
                                        <MudGrid Spacing="3">
                                            <MudItem xs="12" md="6">
                                                <MudTextField @bind-Value="pdfSettings.Proposal.Title" 
                                                              Label="Proposal Title" 
                                                              Variant="Variant.Outlined"
                                                              HelperText="Title shown at top of proposals"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="6">
                                                <MudTextField @bind-Value="pdfSettings.CompanyNameOverride" 
                                                              Label="Company Name Override (Optional)" 
                                                              Variant="Variant.Outlined"
                                                              HelperText="Leave blank to use organization name"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudTextField @bind-Value="pdfSettings.Proposal.ElectronicAcceptanceText" 
                                                              Label="Electronic Acceptance Notice" 
                                                              Variant="Variant.Outlined"
                                                              Lines="3"
                                                              HelperText="Custom text for the electronic acceptance section"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">Section Visibility</MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowCommunityInfo" Color="Color.Primary" Label="Community Info" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowContactInfo" Color="Color.Primary" Label="Contact Info" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowSpecialistInfo" Color="Color.Primary" Label="Specialist Info" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowScopeOfWork" Color="Color.Primary" Label="Scope of Work" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowEstimatedCost" Color="Color.Primary" Label="Estimated Cost" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowServiceLevel" Color="Color.Primary" Label="Service Level" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowDeliveryTimeframe" Color="Color.Primary" Label="Delivery Timeframe" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowPaymentTerms" Color="Color.Primary" Label="Payment Terms" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowTermsAndConditions" Color="Color.Primary" Label="Terms & Conditions" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Proposal.ShowElectronicAcceptanceNotice" Color="Color.Primary" Label="Acceptance Notice" />
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>
                                        </MudGrid>
                                    </ChildContent>
                                </MudExpansionPanel>

                                <!-- Proposal Terms and Conditions -->
                                <MudExpansionPanel Text="Proposal Terms and Conditions">
                                    <MudStack Spacing="3">
                                        <MudAlert Severity="Severity.Info" Dense="true">
                                            Edit the terms and conditions that appear on your proposals. Each line is a separate term.
                                        </MudAlert>
                                        @for (int i = 0; i < pdfSettings.Proposal.TermsAndConditions.Count; i++)
                                        {
                                            var index = i;
                                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                                <MudText Typo="Typo.body2" Style="min-width: 30px;">@(index + 1).</MudText>
                                                <MudTextField @bind-Value="pdfSettings.Proposal.TermsAndConditions[index]" 
                                                              Variant="Variant.Outlined"
                                                              Margin="Margin.Dense"
                                                              Style="flex: 1;"
                                                              OnBlur="MarkAsChanged" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                               Color="Color.Error" 
                                                               Size="Size.Small"
                                                               OnClick="@(() => RemoveProposalTerm(index))" />
                                            </MudStack>
                                        }
                                        <MudButton Variant="Variant.Outlined" 
                                                   Color="Color.Primary" 
                                                   StartIcon="@Icons.Material.Filled.Add"
                                                   OnClick="AddProposalTerm">
                                            Add Term
                                        </MudButton>
                                    </MudStack>
                                </MudExpansionPanel>

                                <!-- Report-Specific Settings -->
                                <MudExpansionPanel>
                                    <TitleContent>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudIcon Icon="@Icons.Material.Filled.Assessment" Color="Color.Success" />
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Final Report PDF Settings</MudText>
                                        </MudStack>
                                    </TitleContent>
                                    <ChildContent>
                                        <MudGrid Spacing="3">
                                            <MudItem xs="12" md="6">
                                                <MudTextField @bind-Value="pdfSettings.Report.Title" 
                                                              Label="Report Title" 
                                                              Variant="Variant.Outlined"
                                                              HelperText="Title shown on the report cover"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="6">
                                                <MudTextField @bind-Value="pdfSettings.Report.ExecutiveSummaryTitle" 
                                                              Label="Executive Summary Title" 
                                                              Variant="Variant.Outlined"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="6">
                                                <MudNumericField T="int" @bind-Value="pdfSettings.Report.FundingProjectionYears" 
                                                                 Label="Funding Projection Years" 
                                                                 Variant="Variant.Outlined"
                                                                 Min="10" Max="50"
                                                                 HelperText="Number of years for funding projections"
                                                                 OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12" md="6">
                                                <MudTextField @bind-Value="pdfSettings.Report.DraftWatermarkText" 
                                                              Label="Draft Watermark Text" 
                                                              Variant="Variant.Outlined"
                                                              Disabled="@(!pdfSettings.Report.ShowDraftWatermark)"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudTextField @bind-Value="pdfSettings.Report.DisclaimerText" 
                                                              Label="Disclaimer Text" 
                                                              Variant="Variant.Outlined"
                                                              Lines="3"
                                                              HelperText="Legal disclaimer shown at end of report"
                                                              OnBlur="MarkAsChanged" />
                                            </MudItem>
                                            <MudItem xs="12">
                                                <MudText Typo="Typo.subtitle2" Class="mb-2">Report Sections</MudText>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowCoverPage" Color="Color.Success" Label="Cover Page" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowTableOfContents" Color="Color.Success" Label="Table of Contents" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowExecutiveSummary" Color="Color.Success" Label="Executive Summary" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowComponentInventory" Color="Color.Success" Label="Component Inventory" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowFundingPlan" Color="Color.Success" Label="Funding Plan" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowGraphsAndCharts" Color="Color.Success" Label="Graphs & Charts" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowPhotos" Color="Color.Success" Label="Photos" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowAppendices" Color="Color.Success" Label="Appendices" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowDisclaimer" Color="Color.Success" Label="Disclaimer" />
                                                    </MudItem>
                                                    <MudItem xs="6" md="4">
                                                        <MudSwitch T="bool" @bind-Value="pdfSettings.Report.ShowDraftWatermark" Color="Color.Warning" Label="Draft Watermark" />
                                                    </MudItem>
                                                </MudGrid>
                                            </MudItem>
                                        </MudGrid>
                                    </ChildContent>
                                </MudExpansionPanel>
                            </MudExpansionPanels>

                            <MudAlert Severity="Severity.Success" Dense="true" Variant="Variant.Outlined">
                                <MudText Typo="Typo.body2">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" />
                                    Changes will apply to all new PDF documents generated after saving.
                                </MudText>
                            </MudAlert>
                        </MudStack>
                    }
                    else if (activeTab == 4)
                    {
                        <!-- Advanced Settings -->
                        <MudStack Spacing="4">
                            <div>
                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">Advanced Settings</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Edit branding configuration directly as JSON
                                </MudText>
                            </div>

                            <MudDivider />

                            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                                <MudStack Spacing="2">
                                    <MudText Typo="Typo.body1" Class="fw-bold">
                                        <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                        Caution: Advanced Users Only
                                    </MudText>
                                    <MudText Typo="Typo.body2">
                                        Editing the JSON directly can break your theme if not formatted correctly. 
                                        We recommend using the visual theme editor above unless you're familiar with JSON syntax.
                                    </MudText>
                                </MudStack>
                            </MudAlert>

                            <MudTextField @bind-Value="tenant.BrandingJson" 
                                          Lines="12" 
                                          Label="Branding JSON Configuration" 
                                          Variant="Variant.Outlined"
                                          HelperText="Edit the raw JSON branding configuration"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Code"
                                          OnBlur="MarkAsChanged" />

                            @if (!string.IsNullOrWhiteSpace(jsonError))
                            {
                                <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body1" Class="fw-bold">JSON Validation Error</MudText>
                                        <MudText Typo="Typo.body2">@jsonError</MudText>
                                    </MudStack>
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Success" Dense="true" Variant="Variant.Outlined">
                                    <MudText Typo="Typo.body2">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                        JSON is valid and ready to save
                                    </MudText>
                                </MudAlert>
                            }

                            <MudPaper Elevation="0" Class="pa-4" Style="background: #F9F9F9; border-radius: 8px; font-family: monospace;">
                                <MudText Typo="Typo.caption" Style="color: #666;" Class="mb-2">Example JSON Structure:</MudText>
                                <code style="font-size: 12px; color: #333; display: block; white-space: pre-wrap;">
{
  "Primary": "#6A3D9A",
  "Secondary": "#FF8C00",
  "AppbarBackground": "#FFFFFF",
  "Background": "#F5F5F5",
  "DarkPrimary": "#8B5FCF",
  "DarkSecondary": "#FFB84D",
  "UseDarkMode": false,
  "Preset": null
}
                                            </code>
                                        </MudPaper>
                                    </MudStack>
                                }
                                    else if (activeTab == 5)
                                    {
                                        <!-- Scope Change Settings -->
                                        <CRS.Components.Shared.Settings.TenantScopeChangeSettingsPanel @ref="scopeChangeSettingsPanel" OnSettingsChanged="MarkAsChanged" />
                                    }
                                    else if (activeTab == 6)
                                    {
                                        <!-- Acceptance Terms Settings -->
                                        <MudStack Spacing="4">
                                            <div>
                                                <MudText Typo="Typo.h5" Class="fw-bold mb-2">Proposal Acceptance Terms</MudText>
                                                <MudText Typo="Typo.body2" Style="color: #666;">
                                        Configure the legal terms and conditions shown when clients accept proposals or amendments.
                                        These are the formal click-wrap terms that require electronic signature.
                                    </MudText>
                                </div>

                                <MudDivider />

                                @if (isLoadingTerms)
                                {
                                    <MudStack AlignItems="AlignItems.Center" Class="py-8">
                                        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
                                        <MudText Typo="Typo.body2">Loading terms template...</MudText>
                                    </MudStack>
                                }
                                else
                                {
                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="6">
                                            <MudTextField @bind-Value="acceptanceTerms.Name"
                                                          Label="Template Name"
                                                          Variant="Variant.Outlined"
                                                          HelperText="A name to identify this terms template"
                                                          OnBlur="MarkAsChanged" />
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudTextField @bind-Value="acceptanceTerms.Version"
                                                          Label="Version"
                                                          Variant="Variant.Outlined"
                                                          HelperText="e.g., 1.0, 2.0, 2024-01"
                                                          OnBlur="MarkAsChanged" />
                                        </MudItem>
                                    </MudGrid>

                                    <MudTextField @bind-Value="acceptanceTerms.Summary"
                                                  Label="Summary (Optional)"
                                                  Variant="Variant.Outlined"
                                                  Lines="2"
                                                  HelperText="A brief summary shown before the full terms"
                                                  OnBlur="MarkAsChanged" />

                                    <MudTextField @bind-Value="acceptanceTerms.TermsText"
                                                  Label="Terms and Conditions (Markdown supported)"
                                                  Variant="Variant.Outlined"
                                                  Lines="15"
                                                  HelperText="The full legal terms. Supports markdown formatting (## for headers, - for lists, **bold**, etc.)"
                                                  OnBlur="MarkAsChanged" />

                                    <MudGrid Spacing="3">
                                        <MudItem xs="12" md="8">
                                            <MudTextField @bind-Value="acceptanceTerms.CheckboxText"
                                                          Label="Checkbox Agreement Text"
                                                          Variant="Variant.Outlined"
                                                          HelperText="Text shown next to the agreement checkbox"
                                                          OnBlur="MarkAsChanged" />
                                        </MudItem>
                                        <MudItem xs="12" md="4">
                                            <MudTextField @bind-Value="acceptanceTerms.AcceptButtonText"
                                                          Label="Accept Button Text"
                                                          Variant="Variant.Outlined"
                                                          HelperText="Text on the accept button"
                                                          OnBlur="MarkAsChanged" />
                                        </MudItem>
                                    </MudGrid>

                                    @if (acceptanceTerms.Id != Guid.Empty)
                                    {
                                        <MudText Typo="Typo.caption" Style="color: #666;" Class="mt-2">
                                            <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Small" Style="vertical-align: middle;" />
                                            Last modified: @(acceptanceTerms.DateModified?.ToString("g") ?? acceptanceTerms.DateCreated?.ToString("g") ?? "N/A")
                                        </MudText>
                                    }

                                    <MudDivider Class="my-4" />

                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                        <MudText Typo="Typo.body2">
                                            <strong>Where are these terms used?</strong><br />
                                            These terms appear on the Proposal Acceptance page and Amendment Acceptance page 
                                            when clients electronically sign to accept your proposals. They are legally binding 
                                            and include an audit trail with timestamps and IP addresses.
                                        </MudText>
                                    </MudAlert>
                                }
                            </MudStack>
                        }
                        else if (activeTab == 7)
                        {
                            <!-- Workflow Settings -->
                            <MudStack Spacing="4">
                                <div>
                                    <MudText Typo="Typo.h5" Class="fw-bold mb-2">Workflow Settings</MudText>
                                    <MudText Typo="Typo.body2" Style="color: #666;">
                                        Configure how reserve study requests are processed through each phase
                                    </MudText>
                                </div>

                                <MudDivider />

                                <!-- REQUEST PHASE -->
                                <MudText Typo="Typo.h6" Style="color: #6366f1;">
                                    <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Class="mr-2" Style="vertical-align: middle;" />
                                    Request Phase
                                </MudText>

                                <!-- Auto-Accept Study Requests -->
                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Auto-Accept Study Requests</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Automatically approve new requests without manual review
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AutoAcceptStudyRequests" 
                                                   Color="@(tenant.AutoAcceptStudyRequests ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- PROPOSAL PHASE -->
                                <MudText Typo="Typo.h6" Style="color: #8b5cf6;">
                                    <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" Style="vertical-align: middle;" />
                                    Proposal Phase
                                </MudText>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.DefaultProposalExpirationDays"
                                                         Label="Default Proposal Expiration (days)"
                                                         Variant="Variant.Outlined"
                                                         Min="0" Max="365"
                                                         HelperText="0 = no expiration"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.CalendarMonth"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Auto-Send Proposal on Approval</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Automatically send proposals to clients when internally approved
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AutoSendProposalOnApproval" 
                                                   Color="@(tenant.AutoSendProposalOnApproval ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Require Proposal Review</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Require a second reviewer before proposal can be sent
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.RequireProposalReview" 
                                                   Color="@(tenant.RequireProposalReview ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Skip Proposal Step</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                For trusted/repeat clients, skip directly to engagement
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.SkipProposalStep" 
                                                   Color="@(tenant.SkipProposalStep ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- DATA COLLECTION PHASE -->
                                <MudText Typo="Typo.h6" Style="color: #f59e0b;">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Class="mr-2" Style="vertical-align: middle;" />
                                    Data Collection Phase
                                </MudText>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Auto-Request Financial Info</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Automatically request financial info after proposal acceptance
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AutoRequestFinancialInfo" 
                                                   Color="@(tenant.AutoRequestFinancialInfo ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.FinancialInfoDueDays"
                                                         Label="Financial Info Due (days)"
                                                         Variant="Variant.Outlined"
                                                         Min="1" Max="90"
                                                         HelperText="Deadline for clients to submit financial data"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.Schedule"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Require Service Contacts</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Require vendor/service contact collection during data gathering
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.RequireServiceContacts" 
                                                   Color="@(tenant.RequireServiceContacts ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Skip Financial Info Step</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Skip financial data collection for certain study types
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.SkipFinancialInfoStep" 
                                                   Color="@(tenant.SkipFinancialInfoStep ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- SITE VISIT PHASE -->
                                <MudText Typo="Typo.h6" Style="color: #10b981;">
                                    <MudIcon Icon="@Icons.Material.Filled.DirectionsCar" Class="mr-2" Style="vertical-align: middle;" />
                                    Site Visit Phase
                                </MudText>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Require Site Visit</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Site visits are mandatory before completing a study
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.RequireSiteVisit" 
                                                   Color="@(tenant.RequireSiteVisit ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.DefaultSiteVisitDurationMinutes"
                                                         Label="Default Site Visit Duration (minutes)"
                                                         Variant="Variant.Outlined"
                                                         Min="30" Max="480"
                                                         HelperText="Calendar block duration for site visits"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.Timer"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Allow Virtual Site Visit</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Allow video/virtual inspections instead of in-person visits
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AllowVirtualSiteVisit" 
                                                   Color="@(tenant.AllowVirtualSiteVisit ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- NOTIFICATIONS -->
                                <MudText Typo="Typo.h6" Style="color: #3b82f6;">
                                    <MudIcon Icon="@Icons.Material.Filled.Notifications" Class="mr-2" Style="vertical-align: middle;" />
                                    Notifications & Reminders
                                </MudText>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Send Automatic Reminders</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Send reminder emails for pending actions
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.SendAutomaticReminders" 
                                                   Color="@(tenant.SendAutomaticReminders ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.ReminderFrequencyDays"
                                                         Label="Reminder Frequency (days)"
                                                         Variant="Variant.Outlined"
                                                         Min="1" Max="30"
                                                         HelperText="How often to send reminder emails"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.Repeat"
                                                         Disabled="@(!tenant.SendAutomaticReminders)"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Notify Owner on Status Change</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Email tenant owner on major workflow status changes
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.NotifyOwnerOnStatusChange" 
                                                   Color="@(tenant.NotifyOwnerOnStatusChange ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Notify Client on Status Change</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Email HOA client on major workflow status changes
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.NotifyClientOnStatusChange" 
                                                   Color="@(tenant.NotifyClientOnStatusChange ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- INVOICE INTEGRATION -->
                                <MudText Typo="Typo.h6" Style="color: #ef4444;">
                                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" Style="vertical-align: middle;" />
                                    Invoice Integration
                                </MudText>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Auto-Generate Invoice on Acceptance</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Automatically create a draft invoice when a proposal is accepted
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AutoGenerateInvoiceOnAcceptance" 
                                                   Color="@(tenant.AutoGenerateInvoiceOnAcceptance ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.DefaultPaymentTermsDays"
                                                         Label="Default Payment Terms (days)"
                                                         Variant="Variant.Outlined"
                                                         Min="0" Max="90"
                                                         HelperText="e.g., 30 = Net 30"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.CreditCard"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Auto-Send Invoice Reminders</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Send automatic payment reminder emails for overdue invoices
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AutoSendInvoiceReminders" 
                                                   Color="@(tenant.AutoSendInvoiceReminders ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudDivider Class="my-2" />

                                <!-- REPORT & COMPLETION -->
                                <MudText Typo="Typo.h6" Style="color: #06b6d4;">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" Style="vertical-align: middle;" />
                                    Report & Completion
                                </MudText>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Require Narrative Review</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Require owner approval of narrative content before generating reports
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.RequireNarrativeReview" 
                                                   Color="@(tenant.RequireNarrativeReview ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Require Final Review</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Require owner review before marking a study complete
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.RequireFinalReview" 
                                                   Color="@(tenant.RequireFinalReview ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>

                                <MudGrid Spacing="3">
                                    <MudItem xs="12" md="6">
                                        <MudNumericField T="int" @bind-Value="tenant.AutoArchiveAfterDays"
                                                         Label="Auto-Archive After (days)"
                                                         Variant="Variant.Outlined"
                                                         Min="0" Max="365"
                                                         HelperText="0 = disabled"
                                                         Adornment="Adornment.Start"
                                                         AdornmentIcon="@Icons.Material.Filled.Archive"
                                                         @bind-Value:after="MarkAsChanged" />
                                    </MudItem>
                                </MudGrid>

                                <MudPaper Elevation="0" Class="pa-4" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">Allow Amendments After Completion</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Allow scope amendments after a study is completed
                                            </MudText>
                                        </MudStack>
                                        <MudSwitch T="bool" @bind-Value="tenant.AllowAmendmentsAfterCompletion" 
                                                   Color="@(tenant.AllowAmendmentsAfterCompletion ? Color.Success : Color.Default)"
                                                   @bind-Value:after="MarkAsChanged" />
                                    </MudStack>
                                </MudPaper>
                            </MudStack>
                        }
                    </MudPaper>

                <!-- Action Buttons - Fixed at bottom -->
                <MudPaper Elevation="3" Class="pa-4 mt-4" Style="border-radius: 12px; position: sticky; bottom: 20px; background: white; z-index: 100;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @if (hasUnsavedChanges)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Edit" Style="color: #FFA726;" />
                                <MudText Typo="Typo.body2" Style="color: #666;">You have unsaved changes</MudText>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #28a745;" />
                                <MudText Typo="Typo.body2" Style="color: #666;">All changes saved</MudText>
                            }
                        </MudStack>
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Secondary" 
                                       OnClick="CancelChanges"
                                       StartIcon="@Icons.Material.Filled.Close">
                                Cancel
                            </MudButton>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       OnClick="SaveSettings" 
                                       Disabled="@(!string.IsNullOrWhiteSpace(jsonError) || isSaving)"
                                       StartIcon="@(isSaving ? "" : Icons.Material.Filled.Save)">
                                @if (isSaving)
                                {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <span>Save Settings</span>
                                }
                            </MudButton>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
private Tenant? tenant;
private Tenant? originalTenant; // For change tracking
private BrandingModel branding = new();
private PdfSettings pdfSettings = PdfSettings.Default;
private bool useDarkMode;
private string? selectedPreset;
private IReadOnlyList<string> presetNames = Array.Empty<string>();
private string? logoUrl;
private string? jsonError;
private bool hasUnsavedChanges = false;
private bool isSaving = false;
private int activeTab = 0;

// Company contact info (shared across system, stored in BrandingPayload)
private string? companyTagline;
private string? companyPhone;
private string? companyEmail;
private string? companyWebsite;
private string? companyAddress;

// Reference to the InputFile element
private InputFile? fileInput;

// Acceptance Terms
private AcceptanceTermsTemplate acceptanceTerms = new();
private bool isLoadingTerms = false;
private bool isSavingTerms = false;

// Scope Change Settings Panel reference
private CRS.Components.Shared.Settings.TenantScopeChangeSettingsPanel? scopeChangeSettingsPanel;

protected override async Task OnInitializedAsync() {
    presetNames = ThemeService.GetPresetNames();
    await LoadTenant();
    await LoadAcceptanceTermsAsync();
}

    private async Task LoadTenant() {
        if (!TenantContext.TenantId.HasValue) return;
        
        try {
            await using var db = await DbFactory.CreateDbContextAsync();
            tenant = await db.Tenants.FirstOrDefaultAsync(t => t.Id == TenantContext.TenantId.Value);
            
            if (tenant != null) {
                // Create a deep copy for change tracking
                originalTenant = new Tenant
                {
                    Id = tenant.Id,
                    Name = tenant.Name,
                    Subdomain = tenant.Subdomain,
                    IsActive = tenant.IsActive,
                    BrandingJson = tenant.BrandingJson,
                    AutoAcceptStudyRequests = tenant.AutoAcceptStudyRequests
                };
                
                ParseBranding();
                await LoadLogoUrl();
                hasUnsavedChanges = false;
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error loading tenant: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private void MarkAsChanged()
    {
        hasUnsavedChanges = true;
        StateHasChanged();
    }

    private void ParseBranding() {
        if (string.IsNullOrWhiteSpace(tenant?.BrandingJson)) {
            branding = new BrandingModel();
            pdfSettings = PdfSettings.Default;
            useDarkMode = false;
            // Reset company contact info
            companyTagline = null;
            companyPhone = null;
            companyEmail = null;
            companyWebsite = null;
            companyAddress = null;
            return;
        }

        try {
            var payload = JsonSerializer.Deserialize<ThemeService.BrandingPayload>(tenant.BrandingJson);
            if (payload != null) {
                branding.Primary = payload.Primary;
                branding.Secondary = payload.Secondary;
                branding.AppbarBackground = payload.AppbarBackground;
                branding.Background = payload.Background;
                branding.DarkPrimary = payload.DarkPrimary;
                branding.DarkSecondary = payload.DarkSecondary;
                useDarkMode = payload.UseDarkMode ?? false;
                selectedPreset = payload.Preset;

                // Load company contact info (shared)
                companyTagline = payload.CompanyTagline;
                companyPhone = payload.CompanyPhone;
                companyEmail = payload.CompanyEmail;
                companyWebsite = payload.CompanyWebsite;
                companyAddress = payload.CompanyAddress;

                // Load PDF settings
                pdfSettings = payload.PdfSettings ?? PdfSettings.Default;
            }
        } catch (Exception ex) {
            jsonError = $"JSON parsing error: {ex.Message}";
        }
    }

    private void SerializeBranding() {
        if (tenant == null) return;

        var payload = new ThemeService.BrandingPayload(
            branding.Primary,
            branding.Secondary,
            branding.AppbarBackground,
            branding.Background,
            branding.DarkPrimary,
            branding.DarkSecondary,
            null, // Tertiary
            null, // Info
            null, // Success
            null, // Warning
            null, // Error
            null, // TextPrimary
            null, // TextSecondary
            useDarkMode,
            selectedPreset,
            // Company contact info (shared)
            companyTagline,
            companyPhone,
            companyEmail,
            companyWebsite,
            companyAddress,
            null, // CompanyLogoUrl (use tenant logo)
            // PDF settings
            pdfSettings
        );

        try {
            tenant.BrandingJson = JsonSerializer.Serialize(payload);
            jsonError = null;
        } catch (Exception ex) {
            jsonError = $"Serialization error: {ex.Message}";
        }
    }

    private void ApplyPreset() {
        if (string.IsNullOrWhiteSpace(selectedPreset)) return;
        
        var preset = ThemeService.GetPresetByName(selectedPreset);
        if (preset == null) return;

        branding.Primary = preset.PaletteLight.Primary.ToString();
        branding.Secondary = preset.PaletteLight.Secondary.ToString();
        branding.AppbarBackground = preset.PaletteLight.AppbarBackground?.ToString();
        branding.Background = preset.PaletteLight.Background?.ToString();
        branding.DarkPrimary = preset.PaletteDark?.Primary?.ToString();
        branding.DarkSecondary = preset.PaletteDark?.Secondary?.ToString();
        
        SerializeBranding();
        MarkAsChanged();
        Snackbar.Add($"Applied preset: {selectedPreset}", MudBlazor.Severity.Success);
    }

    private void PreviewTheme() {
        SerializeBranding();
        TenantContext.BrandingJson = tenant?.BrandingJson;
        ThemeService.ApplyTenantBrandingIfAvailable();
        Snackbar.Add("Theme preview applied. Save to persist changes.", MudBlazor.Severity.Info);
    }

    private void ResetTheme() {
        branding = new BrandingModel();
        pdfSettings = PdfSettings.Default;
        useDarkMode = false;
        selectedPreset = null;
        if (tenant != null) tenant.BrandingJson = null;
        TenantContext.BrandingJson = null;
        ThemeService.SetTheme(new MudBlazor.MudTheme());
        MarkAsChanged();
        Snackbar.Add("Theme reset to default", MudBlazor.Severity.Info);
    }

    private async Task SaveSettings() {
        if (tenant == null || !TenantContext.TenantId.HasValue) return;

        SerializeBranding();
        
        if (!string.IsNullOrWhiteSpace(jsonError)) {
            Snackbar.Add("Cannot save: Invalid branding JSON", MudBlazor.Severity.Error);
            return;
        }

        isSaving = true;
        try {
            await using var db = await DbFactory.CreateDbContextAsync();
            var existing = await db.Tenants.FirstOrDefaultAsync(t => t.Id == tenant.Id);
            if (existing == null) {
                Snackbar.Add("Tenant not found", MudBlazor.Severity.Error);
                return;
            }

            existing.Name = tenant.Name;
            existing.IsActive = tenant.IsActive;
            existing.BrandingJson = tenant.BrandingJson;
            
            // Workflow Settings - Request Phase
            existing.AutoAcceptStudyRequests = tenant.AutoAcceptStudyRequests;
            
            // Workflow Settings - Proposal Phase
            existing.DefaultProposalExpirationDays = tenant.DefaultProposalExpirationDays;
            existing.AutoSendProposalOnApproval = tenant.AutoSendProposalOnApproval;
            existing.RequireProposalReview = tenant.RequireProposalReview;
            
            // Workflow Settings - Data Collection Phase
            existing.AutoRequestFinancialInfo = tenant.AutoRequestFinancialInfo;
            existing.FinancialInfoDueDays = tenant.FinancialInfoDueDays;
            existing.RequireServiceContacts = tenant.RequireServiceContacts;
            
            // Workflow Settings - Site Visit Phase
            existing.RequireSiteVisit = tenant.RequireSiteVisit;
            existing.DefaultSiteVisitDurationMinutes = tenant.DefaultSiteVisitDurationMinutes;
            
            // Workflow Settings - Notifications
            existing.SendAutomaticReminders = tenant.SendAutomaticReminders;
            existing.ReminderFrequencyDays = tenant.ReminderFrequencyDays;
            existing.NotifyOwnerOnStatusChange = tenant.NotifyOwnerOnStatusChange;
            
            // Workflow Settings - Invoice Integration
            existing.AutoGenerateInvoiceOnAcceptance = tenant.AutoGenerateInvoiceOnAcceptance;
            existing.DefaultPaymentTermsDays = tenant.DefaultPaymentTermsDays;
            existing.AutoSendInvoiceReminders = tenant.AutoSendInvoiceReminders;
            
            // Workflow Settings - Report & Completion
            existing.RequireFinalReview = tenant.RequireFinalReview;
            existing.AutoArchiveAfterDays = tenant.AutoArchiveAfterDays;
            existing.AllowAmendmentsAfterCompletion = tenant.AllowAmendmentsAfterCompletion;
            
            existing.UpdatedAt = DateTime.UtcNow;
            
            await db.SaveChangesAsync();
            
            TenantContext.TenantName = existing.Name;
            TenantContext.BrandingJson = existing.BrandingJson;
                    TenantContext.IsActive = existing.IsActive;
                    ThemeService.ApplyTenantBrandingIfAvailable();

                    originalTenant = new Tenant
                    {
                        Id = tenant.Id,
                        Name = tenant.Name,
                        Subdomain = tenant.Subdomain,
                        IsActive = tenant.IsActive,
                        BrandingJson = tenant.BrandingJson,
                        AutoAcceptStudyRequests = tenant.AutoAcceptStudyRequests
                    };

                    // Save acceptance terms if they have content
                    await SaveAcceptanceTermsAsync();

                    // Save scope change settings
                    if (scopeChangeSettingsPanel != null)
                    {
                        await scopeChangeSettingsPanel.SaveAsync();
                    }

                    hasUnsavedChanges = false;
                    Snackbar.Add("Settings saved successfully!", MudBlazor.Severity.Success);
                } catch (Exception ex) {
                    Snackbar.Add($"Error saving settings: {ex.Message}", MudBlazor.Severity.Error);
                } finally {
                    isSaving = false;
                }
            }

    private async Task CancelChanges()
    {
        if (!hasUnsavedChanges)
        {
            Nav.NavigateTo("/Dashboard");
            return;
        }

        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Discard Changes?",
            "You have unsaved changes. Are you sure you want to discard them?",
            yesText: "Discard", cancelText: "Keep Editing");

        if (confirm == true)
        {
            await LoadTenant();
            Nav.NavigateTo("/Dashboard");
        }
    }

    private async Task ConfirmRemoveLogo()
    {
        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Remove Logo?",
            "Are you sure you want to remove your organization's logo?",
            yesText: "Remove", cancelText: "Cancel");

        if (confirm == true)
        {
            await RemoveLogo();
        }
    }

    private async Task LoadLogoUrl() {
        if (tenant == null || !TenantContext.TenantId.HasValue) return;
        try {
            logoUrl = await LogoStorage.GetLogoUrlAsync(TenantContext.TenantId.Value);
        } catch (Exception ex) {
            Snackbar.Add($"Error loading logo: {ex.Message}", MudBlazor.Severity.Warning);
        }
    }

    private async Task TriggerFileInput()
    {
        if (fileInput?.Element != null)
        {
            await JS.InvokeVoidAsync("clickElement", fileInput.Element);
        }
    }

    private async Task HandleLogoUpload(InputFileChangeEventArgs e) {
        if (tenant == null || !TenantContext.TenantId.HasValue) return;

        var file = e.File;

        var (valid, error) = await LogoStorage.ValidateLogoAsync(file);
        if (!valid) {
            Snackbar.Add(error, MudBlazor.Severity.Warning);
            return;
        }

        if (file.Size > CRS.Services.Storage.LogoUploadConfig.OptimalSizeBytes) {
            Snackbar.Add($"Large file ({file.Size / 1024}KB). Optimizing...", MudBlazor.Severity.Info);
        }

        try {
            logoUrl = await LogoStorage.UploadLogoAsync(TenantContext.TenantId.Value, file);
            Snackbar.Add("Logo uploaded successfully!", MudBlazor.Severity.Success);
        } catch (Exception ex) {
            Snackbar.Add($"Upload failed: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    private async Task RemoveLogo() {
        if (tenant == null || string.IsNullOrWhiteSpace(logoUrl) || !TenantContext.TenantId.HasValue) return;

        try {
            var deleted = await LogoStorage.DeleteLogoAsync(TenantContext.TenantId.Value);
            if (deleted) {
                logoUrl = null;
                Snackbar.Add("Logo removed successfully", MudBlazor.Severity.Info);
            } else {
                Snackbar.Add("Logo not found", MudBlazor.Severity.Warning);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error removing logo: {ex.Message}", MudBlazor.Severity.Error);
        }
    }

    // PDF Terms management - Proposal
    private void AddProposalTerm()
    {
        pdfSettings.Proposal.TermsAndConditions.Add("");
        MarkAsChanged();
    }

    private void RemoveProposalTerm(int index)
    {
        if (index >= 0 && index < pdfSettings.Proposal.TermsAndConditions.Count)
        {
            pdfSettings.Proposal.TermsAndConditions.RemoveAt(index);
            MarkAsChanged();
        }
    }

    private async Task LoadAcceptanceTermsAsync()
    {
        if (!TenantContext.TenantId.HasValue) return;

        try
        {
            isLoadingTerms = true;
            var template = await AcceptanceService.GetActiveTermsTemplateAsync();
            if (template != null)
            {
                acceptanceTerms = template;
            }
            else
            {
                // Create a new template with defaults
                acceptanceTerms = new AcceptanceTermsTemplate
                {
                    Name = "Proposal Acceptance Terms",
                    Version = "1.0",
                    Type = TermsType.ProposalAcceptance,
                    CheckboxText = "I have read and agree to the terms and conditions above.",
                    AcceptButtonText = "Accept Proposal",
                    IsActive = true,
                    IsDefault = true
                };
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading terms: {ex.Message}", MudBlazor.Severity.Error);
        }
        finally
        {
            isLoadingTerms = false;
        }
    }

    private async Task SaveAcceptanceTermsAsync()
    {
        if (!TenantContext.TenantId.HasValue) return;

        // Only save if the terms have meaningful content
        if (string.IsNullOrWhiteSpace(acceptanceTerms.Name) || string.IsNullOrWhiteSpace(acceptanceTerms.TermsText))
        {
            // No terms to save - this is fine, just skip
            return;
        }

        try
        {
            isSavingTerms = true;

            if (acceptanceTerms.Id == Guid.Empty)
            {
                // Create new template
                acceptanceTerms.EffectiveDate = DateTime.UtcNow;
                await AcceptanceService.CreateTermsTemplateAsync(acceptanceTerms);
            }
            else
            {
                // Update existing template
                await AcceptanceService.UpdateTermsTemplateAsync(acceptanceTerms);
            }

            // Reload to get updated data
            await LoadAcceptanceTermsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving acceptance terms: {ex.Message}", MudBlazor.Severity.Warning);
        }
        finally
        {
            isSavingTerms = false;
        }
    }

    private class BrandingModel {
        public string? Primary { get; set; }
        public string? Secondary { get; set; }
        public string? AppbarBackground { get; set; }
        public string? Background { get; set; }
        public string? DarkPrimary { get; set; }
        public string? DarkSecondary { get; set; }
    }
}
