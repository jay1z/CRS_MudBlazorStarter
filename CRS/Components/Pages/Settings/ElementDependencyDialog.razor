@using CRS.Models
@using CRS.Services.Interfaces
@using CRS.Data
@using Microsoft.EntityFrameworkCore
@inject IElementDependencyService DependencyService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Link" Class="mr-2" />
            Manage Element Dependencies
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="4">
            <MudAlert Severity="Severity.Info" Dense="true" Variant="Variant.Text">
                <MudText Typo="Typo.body2">
                    Dependencies define relationships between elements. For example: A <strong>Basin</strong> requires a <strong>Road</strong>.
                    When a dependent element is added without its required element, a warning will be shown.
                </MudText>
            </MudAlert>

            @if (isLoading)
            {
                <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            }
            else
            {
                <!-- Add New Dependency Section -->
                <MudPaper Elevation="1" Class="pa-4" Style="border-radius: 8px;">
                    <MudText Typo="Typo.subtitle1" Class="fw-bold mb-3">Add New Dependency</MudText>
                    
                    <MudGrid Spacing="3">
                        <MudItem xs="12" md="5">
                            <MudText Typo="Typo.caption" Class="mb-2">Dependent Element (requires the other)</MudText>
                            <MudSelect T="ElementType" @bind-Value="newDependentType" 
                                       Label="Element Type" Variant="Variant.Outlined" 
                                       Dense="true" Class="mb-2">
                                <MudSelectItem Value="ElementType.Building">Building</MudSelectItem>
                                <MudSelectItem Value="ElementType.Common">Common</MudSelectItem>
                            </MudSelect>
                            <MudSelect T="Guid?" @bind-Value="newDependentElementId" 
                                       Label="Select Element" Variant="Variant.Outlined" Dense="true">
                                @if (newDependentType == ElementType.Building)
                                {
                                    @foreach (var element in buildingElements)
                                    {
                                        <MudSelectItem Value="@((Guid?)element.Id)">@element.Name</MudSelectItem>
                                    }
                                }
                                else
                                {
                                    @foreach (var element in commonElements)
                                    {
                                        <MudSelectItem Value="@((Guid?)element.Id)">@element.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                        
                        <MudItem xs="12" md="2" Class="d-flex align-center justify-center">
                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Large" Color="Color.Primary" />
                            <MudText Typo="Typo.caption" Class="mx-2">requires</MudText>
                        </MudItem>
                        
                        <MudItem xs="12" md="5">
                            <MudText Typo="Typo.caption" Class="mb-2">Required Element (must be present)</MudText>
                            <MudSelect T="ElementType" @bind-Value="newRequiredType" 
                                       Label="Element Type" Variant="Variant.Outlined" 
                                       Dense="true" Class="mb-2">
                                <MudSelectItem Value="ElementType.Building">Building</MudSelectItem>
                                <MudSelectItem Value="ElementType.Common">Common</MudSelectItem>
                            </MudSelect>
                            <MudSelect T="Guid?" @bind-Value="newRequiredElementId" 
                                       Label="Select Element" Variant="Variant.Outlined" Dense="true">
                                @if (newRequiredType == ElementType.Building)
                                {
                                    @foreach (var element in buildingElements)
                                    {
                                        <MudSelectItem Value="@((Guid?)element.Id)">@element.Name</MudSelectItem>
                                    }
                                }
                                else
                                {
                                    @foreach (var element in commonElements)
                                    {
                                        <MudSelectItem Value="@((Guid?)element.Id)">@element.Name</MudSelectItem>
                                    }
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <MudTextField @bind-Value="newDescription" 
                                  Label="Description (optional)" 
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  Class="mt-3"
                                  HelperText="Explain why this dependency exists" />

                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-3">
                        <MudCheckBox @bind-Value="newIsHardDependency" 
                                     Label="Hard Dependency" 
                                     Color="Color.Warning"
                                     Dense="true" />
                        <MudText Typo="Typo.caption" Style="color: #666;">
                            (Hard = Block adding; Soft = Warning only)
                        </MudText>
                        <MudSpacer />
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="AddDependency"
                                   Disabled="@(!CanAddDependency || isSubmitting)">
                            Add Dependency
                        </MudButton>
                    </MudStack>
                </MudPaper>

                <!-- Existing Dependencies Table -->
                <MudText Typo="Typo.subtitle1" Class="fw-bold mt-4">Existing Dependencies</MudText>
                
                @if (!dependencies.Any())
                {
                    <MudAlert Severity="Severity.Normal" Dense="true" Variant="Variant.Text">
                        No element dependencies have been configured yet.
                    </MudAlert>
                }
                else
                {
                    <MudTable Items="@dependencies" Hover="true" Dense="true" Elevation="1">
                        <HeaderContent>
                            <MudTh>Dependent Element</MudTh>
                            <MudTh Style="width: 80px;"></MudTh>
                            <MudTh>Required Element</MudTh>
                            <MudTh Style="width: 100px;">Type</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh Style="width: 100px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" 
                                         Color="@(context.DependentElementType == ElementType.Building ? Color.Info : Color.Success)"
                                         Variant="Variant.Outlined">
                                    @(context.DependentElementType == ElementType.Building ? "B" : "C")
                                </MudChip>
                                @GetElementName(context.DependentElementId, context.DependentElementType)
                            </MudTd>
                            <MudTd>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            </MudTd>
                            <MudTd>
                                <MudChip T="string" Size="Size.Small" 
                                         Color="@(context.RequiredElementType == ElementType.Building ? Color.Info : Color.Success)"
                                         Variant="Variant.Outlined">
                                    @(context.RequiredElementType == ElementType.Building ? "B" : "C")
                                </MudChip>
                                @GetElementName(context.RequiredElementId, context.RequiredElementType)
                            </MudTd>
                            <MudTd>
                                @if (context.IsHardDependency)
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled">Hard</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">Soft</MudChip>
                                }
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.caption">@(context.Description ?? "-")</MudText>
                            </MudTd>
                            <MudTd>
                                <MudStack Row="true" Spacing="1">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                   Size="Size.Small" 
                                                   Color="Color.Primary"
                                                   OnClick="@(() => EditDependency(context))" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                   Size="Size.Small" 
                                                   Color="Color.Error"
                                                   OnClick="@(() => DeleteDependency(context))" />
                                </MudStack>
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center" Class="py-4">No dependencies configured.</MudText>
                        </NoRecordsContent>
                    </MudTable>
                }
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Variant="Variant.Filled" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = default!;

    private bool isLoading = true;
    private bool isSubmitting = false;

    private List<ElementDependency> dependencies = new();
    private List<BuildingElement> buildingElements = new();
    private List<CommonElement> commonElements = new();
    private Dictionary<(Guid, ElementType), string> elementNames = new();

    // New dependency form
    private ElementType newDependentType = ElementType.Common;
    private Guid? newDependentElementId;
    private ElementType newRequiredType = ElementType.Common;
    private Guid? newRequiredElementId;
    private string? newDescription;
    private bool newIsHardDependency = false;

    private bool CanAddDependency => newDependentElementId.HasValue && 
                                      newRequiredElementId.HasValue && 
                                      newDependentElementId != newRequiredElementId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            await using var context = await DbFactory.CreateDbContextAsync();
            
            // Load all elements for selection
            buildingElements = await context.BuildingElements
                .IgnoreQueryFilters()
                .Where(e => e.IsActive)
                .OrderBy(e => e.ZOrder)
                .ThenBy(e => e.Name)
                .ToListAsync();

            commonElements = await context.CommonElements
                .IgnoreQueryFilters()
                .Where(e => e.IsActive)
                .OrderBy(e => e.ZOrder)
                .ThenBy(e => e.Name)
                .ToListAsync();

            // Build element name lookup
            elementNames.Clear();
            foreach (var be in buildingElements)
            {
                elementNames[(be.Id, ElementType.Building)] = be.Name;
            }
            foreach (var ce in commonElements)
            {
                elementNames[(ce.Id, ElementType.Common)] = ce.Name;
            }

            // Load dependencies
            dependencies = await DependencyService.GetAllDependenciesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetElementName(Guid elementId, ElementType elementType)
    {
        return elementNames.TryGetValue((elementId, elementType), out var name) ? name : "Unknown";
    }

    private async Task AddDependency()
    {
        if (!newDependentElementId.HasValue || !newRequiredElementId.HasValue) return;
        if (newDependentElementId == newRequiredElementId)
        {
            Snackbar.Add("An element cannot depend on itself", Severity.Warning);
            return;
        }

        isSubmitting = true;
        try
        {
            await DependencyService.CreateDependencyAsync(
                newDependentElementId.Value,
                newDependentType,
                newRequiredElementId.Value,
                newRequiredType,
                newDescription,
                newIsHardDependency);

            Snackbar.Add("Dependency added successfully", Severity.Success);
            
            // Reset form
            newDependentElementId = null;
            newRequiredElementId = null;
            newDescription = null;
            newIsHardDependency = false;

            // Reload dependencies
            dependencies = await DependencyService.GetAllDependenciesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding dependency: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task EditDependency(ElementDependency dependency)
    {
        // Toggle hard/soft dependency as a quick edit
        try
        {
            await DependencyService.UpdateDependencyAsync(
                dependency.Id,
                dependency.Description,
                !dependency.IsHardDependency,  // Toggle
                dependency.IsActive);

            Snackbar.Add($"Dependency type changed to {(!dependency.IsHardDependency ? "Hard" : "Soft")}", Severity.Success);
            dependencies = await DependencyService.GetAllDependenciesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating dependency: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteDependency(ElementDependency dependency)
    {
        try
        {
            await DependencyService.DeleteDependencyAsync(dependency.Id);
            Snackbar.Add("Dependency removed", Severity.Success);
            dependencies = await DependencyService.GetAllDependenciesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error removing dependency: {ex.Message}", Severity.Error);
        }
    }

    private void Close() => MudDialog.Close(DialogResult.Ok(true));
}
