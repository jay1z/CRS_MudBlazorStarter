@page "/Communities"
@attribute [Authorize(Policy = "RequireTenantViewer")]

@using CRS.Components.Pages.ReserveStudy.Dialogs
@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject IReserveStudyService ReserveStudyService
@inject ICommunityService CommunityService
@inject IDialogService DialogService

<PageTitle>Communities</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (isLoading) {
        <MudPaper Elevation="0" Class="pa-8">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h5" Class="mt-4">Loading Communities...</MudText>
        </MudPaper>
    }
    else if (communities == null || !communities.Any()) {
        <MudAlert Severity="Severity.Warning">
            <MudText Typo="Typo.body1">No communities found.</MudText>
        </MudAlert>
    }
    else {
        <MudCard Elevation="0" Outlined="false">
            <MudCardHeader>
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.h5" Class="mb-4">My Communities</MudText>
                        <MudText Typo="Typo.h6" Color=Color.Primary Class="mt-1">@communities.Count Active Communities</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" Class="d-flex justify-end align-center gap-2">
                        <MudTextField @bind-Value="searchString" Placeholder="Search..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" Class="mt-0" />
                    </MudItem>
                </MudGrid>
            </MudCardHeader>
            <MudCardContent>
                <MudTable T="Community" Items="@(FilteredCommunities)" Dense="true" Hover="true" Elevation="0" Loading="@isLoading" SortLabel="Sort by">
                    <HeaderContent>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.Name)">NAME</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.Street)">STREET</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.City)">CITY</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.State)">STATE</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.Zip)">ZIP</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Community" SortBy="@(x => x.DateCreated)">Created</MudTableSortLabel></MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="community">
                        <MudTd DataLabel="Name">
                            <MudText Typo="Typo.h5" Class="fw-bold">@community.Name</MudText>
                        </MudTd>
                        <MudTd DataLabel="Street">
                            @community.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.Street
                        </MudTd>
                        <MudTd DataLabel="City">
                            @community.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.City
                        </MudTd>
                        <MudTd DataLabel="State">
                            @community.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.State
                        </MudTd>
                        <MudTd DataLabel="Zip">
                            @community.Addresses?.FirstOrDefault(a => a.AddressType == AddressType.Physical)?.Zip
                        </MudTd>
                        <MudTd DataLabel="Created">
                            @community.DateCreated.ToString()
                        </MudTd>
                        <MudTd>
                            <MudButton Href="@($"/Communities/Details/{community.Id}")" Size="Size.Small" Variant="Variant.Filled">
                                View
                            </MudButton>
                            <AuthorizeView Policy="RequireTenantStaff" Context="authState">
                                <Authorized>
                                    <MudButton OnClick="@(() => OpenDeleteDialog(community))" Size="Size.Small" Variant="Variant.Filled" Color="Color.Error">
                                        Delete
                                    </MudButton>
                                </Authorized>
                            </AuthorizeView>
                        </MudTd>
                    </RowTemplate>
                    <LoadingContent>
                        <MudText>Loading Communities...</MudText>
                    </LoadingContent>
                    <NoRecordsContent>
                        <MudText>No matching records found</MudText>
                    </NoRecordsContent>
                    <PagerContent>
                        <MudTablePager />
                    </PagerContent>
                </MudTable>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private List<Community> communities;
    private bool isLoading = true;
    private string searchString = "";

    protected override async Task OnParametersSetAsync() {
        await LoadData();
    }

    private async Task LoadData() {
        try {
            isLoading = true;

            await UserState.InitializeAsync();
            if (UserState.ClaimsPrincipal.Identity is not null && UserState.ClaimsPrincipal.Identity.IsAuthenticated) {
                await LoadCommunitiesAsync();
            }
            else {
                Snackbar.Add("User not authenticated.", Severity.Warning);
                return;
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            communities = new List<Community>();
        }
        finally {
            isLoading = false;
        }
    }

    private async Task LoadCommunitiesAsync() {
        try {
            // Get communities using the service
            communities = await CommunityService.GetUserCommunitiesAsync(
                UserState.CurrentUser,
                UserState.UserRoles
            );
        }
        catch (DbUpdateConcurrencyException) {
            Snackbar.Add("Data has been modified by another user. Please refresh.", Severity.Warning);
        }
        catch (Exception ex) {
            Snackbar.Add($"Database error: {ex.Message}", Severity.Error);
            communities = new List<Community>();
        }
    }

    private IEnumerable<Community> FilteredCommunities =>
        CommunityService.FilterCommunities(communities, searchString);

    private async Task OpenDeleteDialog(Community community) {
        var parameters = new DialogParameters {
            { "Community", community }
        };

        var dialog = await DialogService.ShowAsync<DeleteCommunityDialog>("Delete Community", parameters);
        var result = await dialog.Result;

        if (!result.Canceled) {
            await DeleteCommunity(community);
        }
    }

    private async Task DeleteCommunity(Community community) {
        try {
            isLoading = true;
            await CommunityService.DeleteCommunityAsync(community.Id);

            // Remove the deleted community from the list
            communities.Remove(community);

            Snackbar.Add($"Community {community?.Name} was successfully deleted.", Severity.Success);
        }
        catch (Exception ex) {
            Snackbar.Add($"Error deleting community: {ex.Message}", Severity.Error);
        }
        finally {
            isLoading = false;
        }
    }
}
