@page "/Communities"
@attribute [Authorize(Policy = "RequireTenantViewer")]

@using CRS.Components.Pages.ReserveStudy.Dialogs
@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using CRS.Services.Tenant
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject IReserveStudyService ReserveStudyService
@inject ICommunityService CommunityService
@inject IDialogService DialogService
@inject ITenantContext TenantContext

<PageTitle>Communities - @(TenantContext.TenantName ?? "ALX Reserve Cloud")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header Section -->
    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.LocationCity" Class="mr-2" Style="vertical-align: middle;" />
                    Communities
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                    Manage your community properties and associations
                </MudText>
            </MudStack>
        </MudStack>
    </MudPaper>

    @if (isLoading) {
        <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <div class="pa-8 text-center">
                <MudText Typo="Typo.h6" Style="color: #666;">Loading communities...</MudText>
            </div>
        </MudPaper>
    }
    else {
        <!-- Stats Cards -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #F3E8FF; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.LocationCity" Style="color: #6A3D9A; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@(communities?.Count ?? 0)</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">Total Communities</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Map" Style="color: #FF8C00; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetUniqueStatesCount()</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">States</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #E3F2FD; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Apartment" Style="color: #1976D2; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetUniqueCitiesCount()</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">Cities</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Search and Filter Section -->
        <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Wrap="Wrap.Wrap">
                <MudTextField @bind-Value="searchString" 
                              Placeholder="Search by name, address, city, state, or zip..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              Immediate="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Style="flex: 1; min-width: 250px; max-width: 400px;" />
                <MudSelect @bind-Value="stateFilter" 
                           Label="Filter by State" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Style="min-width: 180px;">
                    <MudSelectItem Value="@((string?)null)">All States</MudSelectItem>
                    @foreach (var state in GetUniqueStates()) {
                        <MudSelectItem Value="@state">@state</MudSelectItem>
                    }
                </MudSelect>
                @if (!string.IsNullOrEmpty(searchString) || stateFilter != null)
                {
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Secondary" 
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilters">
                        Clear
                    </MudButton>
                }
            </MudStack>
        </MudPaper>

        <!-- Table Section -->
        <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
            @if (communities == null || !communities.Any()) {
                <div class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.LocationOff" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No communities found</MudText>
                    <MudText Typo="Typo.body2" Style="color: #999; margin-bottom: 16px;">
                        Communities are created when you submit a reserve study request
                    </MudText>
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Href="/ReserveStudies/Create">
                                Create Reserve Study
                            </MudButton>
                        </Authorized>
                    </AuthorizeView>
                </div>
            }
            else if (!FilteredCommunities.Any()) {
                <div class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No matching communities found</MudText>
                    <MudText Typo="Typo.body2" Style="color: #999;">
                        Try adjusting your search or filter criteria
                    </MudText>
                </div>
            }
            else {
                <MudTable T="Community" 
                          Items="@FilteredCommunities" 
                          Hover="true" 
                          Elevation="0"
                          Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="Community" SortBy="@(x => x.Name)">Community</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="Community" SortBy="@(x => x.PhysicalAddress?.City)">Location</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="Community" SortBy="@(x => x.PhysicalAddress?.State)">State</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="Community" SortBy="@(x => x.DateCreated)">Created</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600; text-align: right;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="community">
                        <MudTd DataLabel="Community">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="Color.Primary" Size="Size.Small" Style="background: #F3E8FF; color: #6A3D9A;">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" />
                                </MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@community.Name</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #999;">@community.PhysicalAddress?.Street</MudText>
                                </MudStack>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Location">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@community.PhysicalAddress?.City</MudText>
                                <MudText Typo="Typo.caption" Style="color: #999;">@community.PhysicalAddress?.Zip</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="State">
                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                                @community.PhysicalAddress?.State
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Created">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@community.DateCreated?.ToString("MMM dd, yyyy")</MudText>
                                <MudText Typo="Typo.caption" Style="color: #999;">@community.DateCreated?.ToString("h:mm tt")</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: right;">
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                                     Size="Size.Small" 
                                     Dense="true"
                                     AnchorOrigin="Origin.BottomRight"
                                     TransformOrigin="Origin.TopRight">
                                <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                             Href="@($"/Communities/Details/{community.Id}")">
                                    View Details
                                </MudMenuItem>
                                <AuthorizeView Policy="RequireTenantStaff" Context="authEdit">
                                    <Authorized>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                                     Href="@($"/Communities/Update/{community.Id}")">
                                            Edit Community
                                        </MudMenuItem>
                                        <MudDivider />
                                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" 
                                                     OnClick="@(() => OpenDeleteDialog(community))"
                                                     IconColor="Color.Error">
                                            Delete
                                        </MudMenuItem>
                                    </Authorized>
                                </AuthorizeView>
                            </MudMenu>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<Community> communities = new();
    private bool isLoading = true;
    private string searchString = "";
    private string? stateFilter;

    protected override async Task OnParametersSetAsync() {
        await LoadData();
    }

    private async Task LoadData() {
        try {
            isLoading = true;

            await UserState.InitializeAsync();
            if (UserState.ClaimsPrincipal.Identity is not null && UserState.ClaimsPrincipal.Identity.IsAuthenticated) {
                await LoadCommunitiesAsync();
            }
            else {
                Snackbar.Add("User not authenticated.", Severity.Warning);
                return;
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            communities = new List<Community>();
        }
        finally {
            isLoading = false;
        }
    }

    private async Task LoadCommunitiesAsync() {
        try {
            // Get communities using the service
            communities = await CommunityService.GetUserCommunitiesAsync(
                UserState.CurrentUser,
                UserState.UserRoles
            );
        }
        catch (DbUpdateConcurrencyException) {
            Snackbar.Add("Data has been modified by another user. Please refresh.", Severity.Warning);
        }
        catch (Exception ex) {
            Snackbar.Add($"Database error: {ex.Message}", Severity.Error);
            communities = new List<Community>();
        }
    }

    private IEnumerable<Community> FilteredCommunities {
        get {
            var filtered = communities?.AsEnumerable() ?? Enumerable.Empty<Community>();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(searchString)) {
                var search = searchString.Trim().ToLower();
                filtered = filtered.Where(community =>
                    community.Name?.ToLower().Contains(search) == true ||
                    community.PhysicalAddress?.Street?.ToLower().Contains(search) == true ||
                    community.PhysicalAddress?.City?.ToLower().Contains(search) == true ||
                    community.PhysicalAddress?.State?.ToLower().Contains(search) == true ||
                    community.PhysicalAddress?.Zip?.ToLower().Contains(search) == true);
            }

            // Apply state filter
            if (!string.IsNullOrWhiteSpace(stateFilter)) {
                filtered = filtered.Where(c => c.PhysicalAddress?.State == stateFilter);
            }

            return filtered;
        }
    }

    private void ClearFilters() {
        searchString = "";
        stateFilter = null;
    }

    private IEnumerable<string> GetUniqueStates() {
        return communities?
            .Where(c => !string.IsNullOrWhiteSpace(c.PhysicalAddress?.State))
            .Select(c => c.PhysicalAddress!.State!)
            .Distinct()
            .OrderBy(s => s) ?? Enumerable.Empty<string>();
    }

    private int GetUniqueStatesCount() {
        return GetUniqueStates().Count();
    }

    private int GetUniqueCitiesCount() {
        return communities?
            .Where(c => !string.IsNullOrWhiteSpace(c.PhysicalAddress?.City))
            .Select(c => c.PhysicalAddress!.City!)
            .Distinct()
            .Count() ?? 0;
    }

    private async Task OpenDeleteDialog(Community community) {
        var parameters = new DialogParameters {
            { "Community", community }
        };

        var dialog = await DialogService.ShowAsync<DeleteCommunityDialog>("Delete Community", parameters);
        var result = await dialog.Result;

        if (!result.Canceled) {
            await DeleteCommunity(community);
        }
    }

    private async Task DeleteCommunity(Community community) {
        try {
            isLoading = true;
            await CommunityService.DeleteCommunityAsync(community.Id);

            // Remove the deleted community from the list
            communities.Remove(community);

            Snackbar.Add($"Community {community?.Name} was successfully deleted.", Severity.Success);
        }
        catch (Exception ex) {
            Snackbar.Add($"Error deleting community: {ex.Message}", Severity.Error);
        }
        finally {
            isLoading = false;
        }
    }
}
