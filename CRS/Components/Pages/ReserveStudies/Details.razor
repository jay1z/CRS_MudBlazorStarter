@page "/ReserveStudies/{Id:guid}/Details"
@attribute [Authorize(Policy = "RequireTenantViewer")]

@using CRS.Components.Custom
@using CRS.Data
@using CRS.EventsAndListeners
@using CRS.Models.Emails
@using CRS.Services
@using CRS.Services.Email
@using CRS.Services.Interfaces
@using CRS.Models.Workflow
@using CRS.Services.Workflow
@using Coravel.Events.Interfaces
@using Coravel.Mailer.Mail
@using Coravel.Mailer.Mail.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using static CRS.Components.Custom.WorkflowStatusButtons

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IReserveStudyService ReserveStudyService
@inject IReserveStudyWorkflowService WorkflowService
@inject IMailer _mailer
@inject IDispatcher _dispatcher
@inject IDialogService DialogService

<PageTitle>Reserve Study Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (isLoading) {
        <MudPaper Elevation="0" Class="pa-8">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h5" Class="mt-4">Loading Reserve Study...</MudText>
        </MudPaper>
    } else if (reserveStudy == null) {
        NavigationManager.NavigateTo("/ReserveStudies/NotFound");
    } else {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            <MudText Typo="Typo.h4">@reserveStudy.Community?.Name</MudText>
            <MudGrid>
                <!-- Aside Column -->
                <MudItem xs="12" lg="4">
                    <!-- Details Card -->
                    <MudCard Elevation="0" Outlined="true" Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Request ID</MudText>
                            <MudText Typo="Typo.body2">@reserveStudy.Id</MudText>
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.h6">Created</MudText>
                            <MudText Typo="Typo.body2">@reserveStudy.DateCreated?.ToString("MM/dd/yyyy")</MudText>
                        </MudCardContent>
                    </MudCard>

                    <!-- Community Card -->
                    <MudCard Elevation="0" Outlined="true" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@reserveStudy?.Community?.Name</MudText>
                                <MudText Typo="Typo.body1">@reserveStudy?.Community?.Addresses[0].FullAddress</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@($"/Communities/Details/{@reserveStudy?.Community?.Id}")">View Community</MudButton>
                        </MudCardContent>
                    </MudCard>

                    <!-- Specialist Card -->
                    <MudCard Elevation="0" Outlined="true" Class="mb-4">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Reserve Specialist</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body1">@reserveStudy.Specialist?.FullName</MudText>
                            <MudButton Variant="Variant.Text" Disabled="@(reserveStudy?.SpecialistUserId == null)" OnClick="OpenComposeMessage">Message Specialist</MudButton>
                            <MudText Typo="Typo.caption">@(reserveStudy.Specialist?.Email ?? "Not Assigned")</MudText>
                        </MudCardContent>
                    </MudCard>

                    <!-- Actions Card -->
                    <MudCard Elevation="0" Outlined="true" Class="mb-4">
                        <MudCardHeader>
                            <MudText Typo="Typo.h6">Actions</MudText>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack>
                                <AuthorizeView Policy="RequireTenantStaff">
                                    <Authorized>
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@GetUpdateLink()">Update Request</MudButton>
                                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mx-4" OnClick="SendRequestLink">Send Request Link</MudButton>
                                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mx-4" OnClick="SendAccessTokenLink">Send Access Token Link</MudButton>
                                    </Authorized>
                                </AuthorizeView>

                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.subtitle1">Workflow Debugger</MudText>
                                <MudText Typo="Typo.caption" Class="mb-1">Select a valid next state and apply it via the state machine.</MudText>

                                <MudGrid Class="mb-2">
                                    <MudItem xs="12">
                                        <MudSelect T="StudyStatus ?" @bind-Value="selectedNextStudy" Label="Allowed next states (engine)" Dense="true" Variant="Variant.Outlined" Clearable="true">
                                            @foreach (var s in allowedNextStudy) {
                                                <MudSelectItem T="StudyStatus ?" Value="@((StudyStatus?)s)">@s.ToString()</MudSelectItem>
                                            }
                                        </MudSelect>
                                    </MudItem>
                                </MudGrid>
                                <MudStack Row="true" Spacing="2">
                                    <AuthorizeView Policy="RequireTenantStaff">
                                        <Authorized>
                                            <MudButton Variant="Variant.Filled" Color="Color.Info" Disabled="@(selectedNextStudy == null)" OnClick="@ApplySelectedStudyTransition">Apply Transition</MudButton>
                                            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="LoadAllowedTransitions">Refresh</MudButton>
                                        </Authorized>
                                    </AuthorizeView>
                                </MudStack>

                                <MudDivider Class="my-2" />
                                <MudText Typo="Typo.subtitle1">Quick Actions</MudText>
                                <MudGrid>
                                    <AuthorizeView Policy="RequireTenantStaff">
                                        <Authorized>
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => SendProposalAsync(Id))">Send Proposal</MudButton>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => RequestFinancialInfoAsync(Id))">Request Financial Info</MudButton>
                                            </MudItem>
                                        </Authorized>
                                    </AuthorizeView>
                                </MudGrid>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    @if (reserveStudy.DateCreated.HasValue && (DateTime.Now - reserveStudy.DateCreated.Value).TotalDays > 30 && !reserveStudy.IsComplete) {
                        <MudAlert Severity="Severity.Warning" Elevation="25">
                            <MudText Typo="Typo.h6" Class="text-gray-900 fw-bold">Attention!</MudText>
                            <MudText Typo="Typo.body2" Class="text-gray-700">
                                This request has been pending for more than
                                <MudText Color="Color.Primary" Typo="Typo.body2" Class="fw-bold">@((DateTime.Now - reserveStudy.DateCreated.Value).TotalDays.ToString("N0")) days</MudText>
                            </MudText>
                        </MudAlert>
                    }
                </MudItem>

                <!-- Main Column -->
                <MudItem xs="12" lg="8">
                    <MudTabs Elevation="0" Outlined="true" Color="Color.Primary" ActivePanelIndex="activeTabIndex" ActivePanelIndexChanged="HandleTabChange">
                        <!-- Workflow Status Tab -->
                        <MudTabPanel Text="Workflow Status" Icon="@Icons.Material.Filled.DoubleArrow">
                            <MudCard Class="mb-4">
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">Workflow Status</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.History" Href="@($"/ReserveStudies/{Id}/History")">Raw History</MudButton>
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    @if (timelineItems.Any()) {
                                        var currentEngine = reserveStudy?.StudyRequest?.CurrentStatus;
                                        var currentLegacy = currentEngine.HasValue ? StatusMapper.ToLegacy(currentEngine.Value) : reserveStudy?.Status ?? ReserveStudy.WorkflowStatus.RequestCreated;
                                        var currentRank = RankByStatus.TryGetValue(currentLegacy, out var rnk) ? rnk : -1;
                                        var next = DisplayLegacyOrder.FirstOrDefault(s => (RankByStatus.TryGetValue(s, out var rr) ? rr : int.MaxValue) > currentRank);
                                        if (!EqualityComparer<ReserveStudy.WorkflowStatus>.Default.Equals(next, default)) {
                                            <MudPaper Elevation="0" Class="pa-2 mb-1 d-flex align-center">
                                                <MudIcon Icon="@Icons.Material.Filled.DoubleArrow" Color="Color.Primary" Class="mr-2" />
                                                <MudText Typo="Typo.subtitle2">Next: @FormatStatusTitle(next)</MudText>
                                            </MudPaper>
                                            <MudStack Row="true" Spacing="1" Class="mb-2">
                                                @{
                                                    var engineNext = StatusMapper.ToStudyStatus(next); var canAdvance = allowedNextStudy.Contains(engineNext);
                                                }
                                                @if (next == ReserveStudy.WorkflowStatus.ProposalSent) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Send" OnClick="@(() => SendProposalAsync(Id))">Send Proposal</MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                } else if (next == ReserveStudy.WorkflowStatus.FinancialInfoRequested) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Description" OnClick="@(() => RequestFinancialInfoAsync(Id))">Request Financial Info</MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                } else if (next == ReserveStudy.WorkflowStatus.SiteVisitScheduled && allowedNextStudy.Contains(StudyStatus.Scheduled)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Event" OnClick="@(() => ApplyTransition(StudyStatus.Scheduled))">Schedule Visit</MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                } else if (next == ReserveStudy.WorkflowStatus.ReportComplete) {
                                                    <AuthorizeView Policy="RequireTenantOwner">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.CheckCircle" OnClick="@(() => CompleteReserveStudyAsync(Id))">Complete Study</MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                } else if (canAdvance) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowForward" OnClick="@(() => ApplyTransition(engineNext))">Advance</MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                } else {
                                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Awaiting external action</MudText>
                                                }
                                            </MudStack>
                                        }
                                    }
                                    <MudTimeline TimelineAlign="TimelineAlign.Start">
                                        @{
                                            // Determine current engine status and map to legacy for correct coloring order
                                            var currentEngine = reserveStudy?.StudyRequest?.CurrentStatus;
                                            var currentLegacy = currentEngine.HasValue ? StatusMapper.ToLegacy(currentEngine.Value) : reserveStudy?.Status ?? ReserveStudy.WorkflowStatus.RequestCreated;
                                            var currentRank = RankByStatus.TryGetValue(currentLegacy, out var cr) ? cr : -1;
                                        }
                                        @foreach (var item in timelineItems) {
                                            var itemRank = RankByStatus.TryGetValue(item.Status, out var ir) ? ir : int.MaxValue;
                                            var isCompleted = currentRank > itemRank;
                                            var isCurrent = currentRank == itemRank;
                                            <TimelineStatusItem Status="@item.Status"
                                                                DateValue="@item.DateValue"
                                                                Title="@item.Title"
                                                                Actor="@item.Actor"
                                                                IsHidden="@item.IsHidden"
                                                                ReserveStudy="@reserveStudy"
                                                                IsCurrent="@isCurrent"
                                                                IsCompleted="@isCompleted" />
                                        }
                                    </MudTimeline>

                                    @if (reserveStudy?.Proposal != null) {
                                        <MudCard Class="mb-4">
                                            <MudCardHeader>
                                                <MudText Typo="Typo.h6">Proposal</MudText>
                                            </MudCardHeader>
                                            <MudCardContent>
                                                <MudGrid>
                                                    <MudItem xs="12" md="6">
                                                        <LabeledField Label="Proposal Scope" Value="@reserveStudy.Proposal.ProposalScope" />
                                                    </MudItem>
                                                    <MudItem xs="12" md="6">
                                                        @{
                                                            var estimatedCostFormatted = $"${reserveStudy.Proposal.EstimatedCost.ToString("N2")}";
                                                        }
                                                        <LabeledField Label="Estimated Cost" Value="@estimatedCostFormatted" />
                                                    </MudItem>
                                                    @if (!string.IsNullOrEmpty(reserveStudy.Proposal.Comments)) {
                                                        <MudItem xs="12">
                                                            <LabeledField Label="Comments" Value="@reserveStudy.Proposal.Comments" />
                                                        </MudItem>
                                                    }
                                                </MudGrid>
                                            </MudCardContent>
                                        </MudCard>
                                    }

                                    @if (reserveStudy?.FinancialInfo != null) {
                                        <MudCard Class="mb-4">
                                            <MudCardHeader>
                                                <MudText Typo="Typo.h6">Financial Information</MudText>
                                            </MudCardHeader>
                                            <MudCardContent>
                                                <MudGrid>
                                                    <MudItem xs="12" md="6">
                                                        @{
                                                            var reserveBalanceFormatted = $"${reserveStudy.FinancialInfo.CurrentReserveFundBalance.ToString("N2")}";
                                                        }
                                                        <LabeledField Label="Current Reserve Fund Balance" Value="@reserveBalanceFormatted" />
                                                    </MudItem>
                                                    <MudItem xs="12" md="6">
                                                        @{
                                                            var annualContributionFormatted = $"${reserveStudy.FinancialInfo.AnnualContribution.ToString("N2")}";
                                                        }
                                                        <LabeledField Label="Annual Contribution" Value="@annualContributionFormatted" />
                                                    </MudItem>
                                                    @if (reserveStudy.FinancialInfo.ProjectedAnnualExpenses.HasValue) {
                                                        <MudItem xs="12" md="6">
                                                            @{
                                                                var projectedExpensesFormatted = $"${reserveStudy.FinancialInfo.ProjectedAnnualExpenses.Value.ToString("N2")}";
                                                            }
                                                            <LabeledField Label="Projected Annual Expenses" Value="@projectedExpensesFormatted" />
                                                        </MudItem>
                                                    }
                                                    <MudItem xs="12" md="6">
                                                        <LabeledField Label="Fiscal Year Start" Value="@System.Globalization.DateTimeFormatInfo.CurrentInfo.GetMonthName(reserveStudy.FinancialInfo.FiscalYearStartMonth)" />
                                                    </MudItem>
                                                    @if (!string.IsNullOrEmpty(reserveStudy.FinancialInfo.Comments)) {
                                                        <MudItem xs="12">
                                                            <LabeledField Label="Comments" Value="@reserveStudy.FinancialInfo.Comments" />
                                                        </MudItem>
                                                    }
                                                </MudGrid>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Information Tab -->
                        <MudTabPanel Text="Information" Icon="@Icons.Material.Filled.Info">
                            <MudCard Elevation="25">
                                <MudCardContent Class="py-6">
                                    <MudGrid>
                                        <!-- Contact Information -->
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.h6" Color="Color.Primary">Contact</MudText>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <LabeledField Label="Name" Value="@reserveStudy.Contact?.FullNameInverted" />
                                        </MudItem>
                                        <MudItem xs="4">
                                            <LabeledField Label="Phone" Value="@reserveStudy.Contact?.Phone" />
                                            <MudText Typo="Typo.caption">@reserveStudy.Contact?.Extension</MudText>
                                        </MudItem>
                                        <MudItem xs="4">
                                            <MudText Typo="Typo.caption">Email</MudText>
                                            <MudFlexBreak />
                                            <MudLink Href="@($"mailto:{reserveStudy.Contact?.Email}")" Typo="Typo.body1">
                                                @reserveStudy.Contact?.Email
                                            </MudLink>
                                        </MudItem>
                                        <!-- Property Manager Information -->
                                        @if (reserveStudy.PropertyManager != null) {
                                            <MudItem xs="12" Class="mt-4">
                                                <MudText Typo="Typo.h6" Color="Color.Primary">Management Company</MudText>
                                            </MudItem>
                                            <MudItem xs="12">
                                                <LabeledField Label="Company Name" Value="@reserveStudy.PropertyManager.CompanyName" />
                                            </MudItem>
                                            <MudItem xs="4">
                                                <LabeledField Label="Property Manager" Value="@reserveStudy.PropertyManager.FullNameInverted" />
                                            </MudItem>
                                            <MudItem xs="4">
                                                <LabeledField Label="Phone" Value="@reserveStudy.PropertyManager.Phone" />
                                                <MudText Typo="Typo.caption">@reserveStudy.PropertyManager?.Extension</MudText>
                                            </MudItem>
                                            <MudItem xs="4">
                                                <MudText Typo="Typo.caption">Email</MudText>
                                                <MudFlexBreak />
                                                <MudLink Href="@($"mailto:{reserveStudy.PropertyManager?.Email}")" Typo="Typo.body1">
                                                    @reserveStudy.PropertyManager?.Email
                                                </MudLink>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Elements Tab -->
                        <MudTabPanel Text="Elements" Icon="@Icons.Material.Filled.List">
                            @if (isElementsLoading) {
                                <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-4" />
                            } else if (elementsLoaded && GetAllElements().Any()) {
                                <MudCard Elevation="25">
                                    <MudCardContent Class="py-6">
                                        <MudTable Dense="true" Hover="true" Elevation="0" Items="@GetAllElements()"
                                                  GroupBy="@_groupDefinition"
                                                  GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
                                                  GroupFooterClass="mb-4">
                                            <ColGroup>
                                                <col style="width:10%;" />
                                                <col style="width:50%;" />
                                                <col style="width:20%;" />
                                                <col style="width:20%;" />
                                            </ColGroup>
                                            <HeaderContent>
                                                <MudTh></MudTh>
                                                <MudTh>Name</MudTh>
                                                <MudTh>Requires Service Contact</MudTh>
                                                <MudTh class="text-end">Amount</MudTh>
                                            </HeaderContent>
                                            <GroupHeaderTemplate Context="headerContext">
                                                <MudTh colspan="4">@GetGroupName(headerContext)</MudTh>
                                            </GroupHeaderTemplate>
                                            <RowTemplate Context="rowContext">
                                                <MudTd>
                                                    <MudIconButton Icon="@((rowContext.ShowDetails == true) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" OnClick="@(() => ShowElement(rowContext))" />
                                                </MudTd>
                                                <MudTd>
                                                    <MudText Typo="Typo.body1">@rowContext.Name</MudText>
                                                </MudTd>
                                                <MudTd>
                                                    <MudCheckBox T="bool" Value="@rowContext.NeedsService" Color="Color.Success" UncheckedColor="Color.Error" ReadOnly="true" />
                                                </MudTd>
                                                <MudTd class="text-end">
                                                    <MudText Typo="Typo.body1">@rowContext.Count</MudText>
                                                </MudTd>
                                            </RowTemplate>
                                            <ChildRowContent Context="childContext">
                                                @if (childContext.ShowDetails) {
                                                    <MudTd colspan="4">
                                                        <MudGrid>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Measurement Type" Value="@childContext.ElementMeasurementOptions?.DisplayText" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Last Replaced" Value="@(childContext.LastServiced?.ToString("MM/dd/yyyy") ?? "N/A")" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Useful Life" Value="@childContext.ElementUsefulLifeOptions?.DisplayText" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Remaining Life" Value="@childContext.ElementRemainingLifeOptions?.DisplayText" />
                                                            </MudItem>
                                                        </MudGrid>
                                                    </MudTd>
                                                }
                                            </ChildRowContent>
                                            <GroupFooterTemplate Context="footerContext">
                                                <MudTh colspan="4">Total: @footerContext.Items.Count()</MudTh>
                                            </GroupFooterTemplate>
                                        </MudTable>
                                    </MudCardContent>
                                </MudCard>
                            } else if (!elementsLoaded) {
                                <MudText Typo="Typo.body2" Class="mt-4">Elements will load when this tab is selected.</MudText>
                            } else {
                                <MudText Typo="Typo.body1" Class="mt-4">@( "No elements available (" + GetAllElements().Count() + ")" )</MudText>
                            }
                        </MudTabPanel>
                        <!-- Service Contacts Tab -->
                        <MudTabPanel Text="Service Contacts" Icon="@Icons.Material.Filled.ContactPhone">
                            @if (isContactsLoading) {
                                <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-4" />
                            } else if (serviceContactsLoaded && elementsWithServiceContact.Any()) {
                                <MudExpansionPanels>
                                    @foreach (var element in elementsWithServiceContact) {
                                        <MudExpansionPanel>
                                            <TitleContent>
                                                <div class="d-flex">
                                                    @if (element.ServiceContact?.Phone == null || element.ServiceContact?.Email == null) {
                                                        <MudIcon Color="Color.Warning" Icon="@MaterialSymbols.Outlined.Warning"></MudIcon>
                                                    }
                                                    <MudText>@element.Name</MudText>
                                                </div>
                                            </TitleContent>
                                            <ChildContent>
                                                <MudGrid>
                                                    <MudItem xs="12">
                                                        <LabeledField Label="Company Name" Value="@element.ServiceContact?.CompanyName" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12">
                                                        <LabeledField Label="Point Of Contact" Value="@element.ServiceContact?.FullNameInverted" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <LabeledField Label="Phone" Value="@element.ServiceContact?.Phone" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <LabeledField Label="Extension" Value="@element.ServiceContact?.Extension" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12">
                                                        <MudLink Href="@($"mailto:{element.ServiceContact?.Email}")">
                                                            @element.ServiceContact?.Email
                                                        </MudLink>
                                                    </MudItem>
                                                </MudGrid>
                                            </ChildContent>
                                        </MudExpansionPanel>
                                    }
                                </MudExpansionPanels>
                            } else if (!serviceContactsLoaded) {
                                <MudText Typo="Typo.body2" Class="mt-4">Service contacts will load when this tab is selected.</MudText>
                            } else {
                                <MudText Typo="Typo.body1" Class="mt-4">No service contacts available.</MudText>
                            }
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
            </MudGrid>
        </MudContainer>
    }
</MudContainer>
@code {
    [Parameter]
    public Guid Id { get; set; }

    private ReserveStudy? reserveStudy;
    private bool isLoading = true;
    private bool isElementsLoading = false;
    private bool isContactsLoading = false;
    private bool elementsLoaded = false;
    private bool serviceContactsLoaded = false;
    private List<IReserveStudyElement> elementsWithServiceContact = new();
    private int activeTabIndex = 0;

    private List<StudyStatus> allowedNextStudy = new();
    private StudyStatus? selectedNextStudy;

    private List<StudyStatusHistory> statusHistory = new();

    // Timeline items data
    private readonly List<TimelineItemInfo> timelineItems = new();

    // Curated engine status order to match tests, then mapped to legacy UI statuses
    private static readonly StudyStatus[] EngineTimelineOrder = new[] {
        StudyStatus.NewRequest,
        StudyStatus.PendingDetails,
        StudyStatus.ReadyForReview,
        StudyStatus.NeedsInfo,
        StudyStatus.Approved,
        StudyStatus.Assigned,
        StudyStatus.ProposalPendingESign,
        StudyStatus.Accepted,
        StudyStatus.Rejected,
        StudyStatus.Scheduled,
        StudyStatus.InProgress,
        StudyStatus.UnderReview,
        StudyStatus.ReportDrafted,
        StudyStatus.ApprovedReport,
        StudyStatus.Complete,
        StudyStatus.Archived
    };

    // Display order for timeline (includes key milestones and user-action steps)
    private static readonly ReserveStudy.WorkflowStatus[] DisplayLegacyOrder = new[] {
        ReserveStudy.WorkflowStatus.RequestCreated,
        ReserveStudy.WorkflowStatus.ProposalCreated, // Specialist Assigned
        ReserveStudy.WorkflowStatus.ProposalSent,
        ReserveStudy.WorkflowStatus.ProposalAccepted,
        ReserveStudy.WorkflowStatus.FinancialInfoRequested,
        ReserveStudy.WorkflowStatus.FinancialInfoSubmitted,
        ReserveStudy.WorkflowStatus.SiteVisitScheduled,
        ReserveStudy.WorkflowStatus.SiteVisitCompleted,
        ReserveStudy.WorkflowStatus.ReportComplete,
        ReserveStudy.WorkflowStatus.FundingPlanReady,
        ReserveStudy.WorkflowStatus.RequestCompleted
    };

    // Rank map used to compute completed/current/pending independent of enum numeric values
    private static readonly Dictionary<ReserveStudy.WorkflowStatus, int> RankByStatus =
    DisplayLegacyOrder
    .Select((s, idx) => new { s, idx })
    .ToDictionary(x => x.s, x => x.idx);

    protected override async Task OnInitializedAsync() {
        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        // Ensure data loads when tab becomes visible even if the change event didn't trigger in time
        try {
            if (activeTabIndex == 2) {
                await LoadElementsDataIfNeeded();
            } else if (activeTabIndex == 3) {
                await LoadServiceContactsIfNeeded();
            }
        } catch { /* swallow render-time exceptions, surfaced via Snackbar inside loaders */ }
    }

    private void InitializeTimelineItems() {
        timelineItems.Clear();

        // Map history entries (StudyStatus) to legacy ReserveStudy.WorkflowStatus for date/actor
        var historyByLegacy = statusHistory
            .Select(h => new { Legacy = StatusMapper.ToLegacy(h.ToStatus), h.ChangedAt, h.ChangedBy })
            .GroupBy(x => x.Legacy)
            .ToDictionary(g => g.Key, g => new { First = g.OrderBy(x => x.ChangedAt).First(), Last = g.OrderBy(x => x.ChangedAt).Last() });

        // Build curated legacy order from engine order, de-duplicated while preserving order
        var legacyOrder = new List<ReserveStudy.WorkflowStatus>();
        var seen = new HashSet<ReserveStudy.WorkflowStatus>();
        foreach (var st in EngineTimelineOrder) {
            var legacy = StatusMapper.ToLegacy(st);
            if (seen.Add(legacy)) legacyOrder.Add(legacy);
        }

        // Reduce to milestone-only in the order we want
        var milestonesToShow = DisplayLegacyOrder.Where(m => legacyOrder.Contains(m)).ToList();

        // If cancelled/archived occurred, append as terminal markers
        if (legacyOrder.Contains(ReserveStudy.WorkflowStatus.RequestCancelled))
            milestonesToShow.Add(ReserveStudy.WorkflowStatus.RequestCancelled);
        if (legacyOrder.Contains(ReserveStudy.WorkflowStatus.RequestArchived))
            milestonesToShow.Add(ReserveStudy.WorkflowStatus.RequestArchived);

        foreach (var status in milestonesToShow) {
            // Prevent duplicates defensively
            if (timelineItems.Any(t => t.Status == status))
                continue;

            var hasHist = historyByLegacy.TryGetValue(status, out var hist);
            // Choose earliest for "start" type, latest for decision/delivery type
            var useLast = status == ReserveStudy.WorkflowStatus.ProposalSent
                || status == ReserveStudy.WorkflowStatus.ProposalAccepted
                || status == ReserveStudy.WorkflowStatus.FinancialInfoRequested
                || status == ReserveStudy.WorkflowStatus.SiteVisitScheduled
                || status == ReserveStudy.WorkflowStatus.ReportComplete
                || status == ReserveStudy.WorkflowStatus.FundingPlanComplete
                || status == ReserveStudy.WorkflowStatus.RequestArchived
                || status == ReserveStudy.WorkflowStatus.RequestCancelled;
            DateTime? date = hasHist ? (useLast ? hist!.Last.ChangedAt.LocalDateTime : hist!.First.ChangedAt.LocalDateTime) : GetFallbackDate(status);
            var actor = hasHist ? (useLast ? hist!.Last.ChangedBy : hist!.First.ChangedBy) : null;

            timelineItems.Add(new TimelineItemInfo {
                Status = status,
                DateValue = date,
                Title = FormatStatusTitle(status),
                Actor = actor,
                IsHidden = false
            });
        }
    }

    private DateTime? GetFallbackDate(ReserveStudy.WorkflowStatus status) {
        // Fallback dates for key milestones only
        if (status == ReserveStudy.WorkflowStatus.RequestCreated) return reserveStudy?.DateCreated;
        if (status == ReserveStudy.WorkflowStatus.ProposalCreated || status == ReserveStudy.WorkflowStatus.ProposalSent) return reserveStudy?.Proposal?.DateSent;
        if (status == ReserveStudy.WorkflowStatus.ProposalApproved || status == ReserveStudy.WorkflowStatus.ProposalAccepted) return reserveStudy?.Proposal?.DateApproved;
        if (status == ReserveStudy.WorkflowStatus.FinancialInfoRequested) return reserveStudy?.FinancialInfo?.DateCreated;
        if (status == ReserveStudy.WorkflowStatus.FinancialInfoSubmitted) return reserveStudy?.FinancialInfo?.DateSubmitted;
        if (status == ReserveStudy.WorkflowStatus.FinancialInfoReviewed) return reserveStudy?.FinancialInfo?.DateReviewed;
        if (status == ReserveStudy.WorkflowStatus.SiteVisitCompleted) return reserveStudy?.LastModified;
        if (status == ReserveStudy.WorkflowStatus.ReportComplete) return reserveStudy?.LastModified;
        if (status == ReserveStudy.WorkflowStatus.FundingPlanReady) return reserveStudy?.LastModified;
        if (status == ReserveStudy.WorkflowStatus.RequestArchived) return reserveStudy?.LastModified;
        if (status == ReserveStudy.WorkflowStatus.RequestCancelled) return reserveStudy?.LastModified;
        return null;
    }

    private static string FormatStatusTitle(ReserveStudy.WorkflowStatus status) {
        var name = Enum.GetName(typeof(ReserveStudy.WorkflowStatus), status) ?? status.ToString();
        // Insert spaces before capital letters and between letter-number boundaries
        var withSpaces = System.Text.RegularExpressions.Regex.Replace(name, "(?<=[a-z])([A-Z])", " $1");
        withSpaces = System.Text.RegularExpressions.Regex.Replace(withSpaces, "([A-Za-z])(\\d)", "$1 $2");
        return withSpaces.Trim();
    }

    private async Task LoadInitialData() {
        try {
            isLoading = true;
            await UserState.InitializeAsync();

            using var context = await DbFactory.CreateDbContextAsync();
            reserveStudy = await context.ReserveStudies
                .AsNoTracking()
                .Include(rs => rs.Community).ThenInclude(c => c.Addresses)
                .Include(rs => rs.Contact)
                .Include(rs => rs.PropertyManager)
                .Include(rs => rs.Specialist)
                .Include(rs => rs.Proposal)
                .Include(rs => rs.FinancialInfo)
                .AsSplitQuery()
                .FirstOrDefaultAsync(rs => rs.Id == Id);

            // Load workflow history used for timeline
            statusHistory = await context.StudyStatusHistories
                .AsNoTracking()
                .Where(h => h.RequestId == Id)
                .OrderBy(h => h.ChangedAt)
                .ToListAsync();
        } catch (Exception ex) {
            Snackbar.Add($"Error loading reserve study: {ex.Message}", Severity.Error);
        } finally {
            isLoading = false;
        }
    }

    private async Task LoadElementsDataIfNeeded() {
        if (elementsLoaded || isElementsLoading || reserveStudy == null)
            return;

        try {
            isElementsLoading = true;

            using var context = await DbFactory.CreateDbContextAsync();

            // Load each type of element separately with their relationships
            var buildingElements = await context.ReserveStudyBuildingElements
                .AsNoTracking()
                .Where(be => be.ReserveStudyId == Id)
                .Include(be => be.BuildingElement)
                .Include(be => be.ElementMeasurementOptions)
                .Include(be => be.ElementUsefulLifeOptions)
                .Include(be => be.ElementRemainingLifeOptions)
                .ToListAsync();

            var commonElements = await context.ReserveStudyCommonElements
                .AsNoTracking()
                .Where(ce => ce.ReserveStudyId == Id)
                .Include(ce => ce.CommonElement)
                .Include(ce => ce.ElementMeasurementOptions)
                .Include(ce => ce.ElementUsefulLifeOptions)
                .Include(ce => ce.ElementRemainingLifeOptions)
                .ToListAsync();

            var additionalElements = await context.ReserveStudyAdditionalElements
                .AsNoTracking()
                .Where(ae => ae.ReserveStudyId == Id)
                .Include(ae => ae.ElementMeasurementOptions)
                .Include(ae => ae.ElementUsefulLifeOptions)
                .Include(ae => ae.ElementRemainingLifeOptions)
                .ToListAsync();

            if (reserveStudy != null) {
                // Assign loaded data
                reserveStudy.ReserveStudyBuildingElements = buildingElements;
                reserveStudy.ReserveStudyCommonElements = commonElements;
                reserveStudy.ReserveStudyAdditionalElements = additionalElements;
            }

            elementsLoaded = true;
        } catch (Exception ex) {
            Snackbar.Add($"Error loading elements data: {ex.Message}", Severity.Error);
        } finally {
            isElementsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadServiceContactsIfNeeded() {
        if (serviceContactsLoaded || isContactsLoading || reserveStudy == null)
            return;

        try {
            isContactsLoading = true;

            // First load elements data if not already loaded
            if (!elementsLoaded) {
                await LoadElementsDataIfNeeded();
            }

            // Now load service contacts
            using var context = await DbFactory.CreateDbContextAsync();

            // Load building elements with service contacts - moved the NeedsService filter to client side
            var buildingElementContacts = await context.ReserveStudyBuildingElements
                .AsNoTracking()
                .Where(be => be.ReserveStudyId == Id)
                .Include(be => be.ServiceContact)
                .ToListAsync();

            // Load common elements with service contacts - moved the NeedsService filter to client side
            var commonElementContacts = await context.ReserveStudyCommonElements
                .AsNoTracking()
                .Where(ce => ce.ReserveStudyId == Id)
                .Include(ce => ce.ServiceContact)
                .ToListAsync();

            // Load additional elements with service contacts - moved the NeedsService filter to client side
            var additionalElementContacts = await context.ReserveStudyAdditionalElements
                .AsNoTracking()
                .Where(ae => ae.ReserveStudyId == Id)
                .Include(ae => ae.ServiceContact)
                .ToListAsync();

            // Find matching elements in the loaded elements and update their service contacts
            // Only process elements that need service - apply the filter on the client side
            foreach (var element in buildingElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyBuildingElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            foreach (var element in commonElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyCommonElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            foreach (var element in additionalElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyAdditionalElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            // Update the list of elements with service contacts
            elementsWithServiceContact = GetAllElements().Where(e => e.NeedsService).ToList();

            serviceContactsLoaded = true;
        } catch (Exception ex) {
            Snackbar.Add($"Error loading service contacts: {ex.Message}", Severity.Error);
        } finally {
            isContactsLoading = false;
            StateHasChanged();
        }
    }

    private string GetUpdateLink() => $"/ReserveStudies/{reserveStudy?.Id}/Update";

    private void HandleTabChange(int index) {
        activeTabIndex = index;

        // Load data based on selected tab
        switch (index) {
            case 2: // Elements tab
                _ = LoadElementsDataIfNeeded();
                break;
            case 3: // Service Contacts tab
                _ = LoadServiceContactsIfNeeded();
                break;
        }
    }

    private async Task SendRequestLink() {
        await ExecuteActionAsync(
            async () => {
                var createdEvent = new ReserveStudyCreatedEvent(reserveStudy);
                await _dispatcher.Broadcast<ReserveStudyCreatedEvent>(createdEvent);
                return true;
            },
            "Request link sent successfully!",
            "Failed to send request link"
        );
    }

    private async Task SendAccessTokenLink() {
        await ExecuteActionAsync(
            async () => {
                // Email logic would go here
                return true;
            },
            "Request link sent successfully!",
            "Failed to send access token link"
        );
    }

    private void ShowElement(IReserveStudyElement element) {
        element.ShowDetails = !element.ShowDetails;
    }

    private TableGroupDefinition<IReserveStudyElement> _groupDefinition = new() {
        GroupName = "Element Type",
        Indentation = false,
        Expandable = false,
        Selector = (element) => element.ElementType
    };

    private string GetGroupName(TableGroupData<object, IReserveStudyElement> headerContext) => $"{headerContext.GroupName}: {headerContext.Key}";

    private async Task<bool> ExecuteActionAsync(Func<Task<bool>> action, string successMessage, string failureMessage) {
        try {
            var result = await action();
            if (result) {
                Snackbar.Add(successMessage, Severity.Success);
                return true;
            } else {
                Snackbar.Add(failureMessage, Severity.Error);
                return false;
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            return false;
        }
    }

    private async Task ApproveProposalAsync(Guid studyId) {
        if (reserveStudy?.Proposal == null) return;

        var success = await ExecuteActionAsync(
            async () => {
                var currentUser = UserState.CurrentUser?.UserName ?? "system";
                return await WorkflowService.ApproveProposalAsync(reserveStudy.Proposal.Id, currentUser);
            },
            "Proposal approved successfully",
            "Failed to approve proposal"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task RequestFinancialInfoAsync(Guid studyId) {
        var success = await ExecuteActionAsync(
            async () => await WorkflowService.RequestFinancialInfoAsync(studyId),
            "Financial information requested successfully",
            "Failed to request financial information"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task ReviewFinancialInfoAsync(Guid studyId) {
        if (reserveStudy?.FinancialInfo == null) return;

        var success = await ExecuteActionAsync(
            async () => {
                var currentUser = UserState.CurrentUser?.UserName ?? "system";
                return await WorkflowService.ReviewFinancialInfoAsync(reserveStudy.FinancialInfo.Id, currentUser);
            },
            "Financial information reviewed successfully",
            "Failed to review financial information"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task CompleteReserveStudyAsync(Guid studyId) {
        var success = await ExecuteActionAsync(
            async () => await WorkflowService.CompleteReserveStudyAsync(studyId),
            "Reserve study completed successfully",
            "Failed to complete reserve study"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task SendProposalAsync(Guid studyId) {
        if (reserveStudy == null) return;

        try {
            if (reserveStudy.Proposal == null) {
                var proposal = new Models.Proposal {
                    ReserveStudyId = reserveStudy.Id,
                    ProposalScope = "Test Scope",
                    EstimatedCost = 5000.00m,
                    Comments = "Test proposal created automatically",
                    DateSent = DateTime.Now
                };

                var result = await WorkflowService.SendProposalAsync(Id, proposal);
                if (result) {
                    Snackbar.Add("Proposal sent successfully", Severity.Success);
                    await ReloadAfterChange();
                } else {
                    Snackbar.Add("Failed to send proposal", Severity.Error);
                }
            } else {
                await ApplyTransition(StudyStatus.ProposalPendingESign);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task SubmitFinancialInfoAsync(Guid studyId) {
        if (reserveStudy == null) return;

        try {
            if (reserveStudy.FinancialInfo == null) {
                var financialInfo = new Models.FinancialInfo {
                    ReserveStudyId = reserveStudy.Id,
                    CurrentReserveFundBalance = 50000.00m,
                    AnnualContribution = 10000.00m,
                    ProjectedAnnualExpenses = 12000.00m,
                    FiscalYearStartMonth = 1, // January
                    Comments = "Test financial info created automatically",
                    DateSubmitted = DateTime.Now
                };

                var result = await WorkflowService.SubmitFinancialInfoAsync(Id, financialInfo);
                if (result) {
                    Snackbar.Add("Financial information submitted successfully", Severity.Success);
                    await ReloadAfterChange();
                } else {
                    Snackbar.Add("Failed to submit financial information", Severity.Error);
                }
            } else {
                await ApplyTransition(StudyStatus.UnderReview);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAllowedTransitions() {
        try {
            var studyAllowed = await WorkflowService.GetAllowedStudyTransitionsAsync(Id);
            allowedNextStudy = studyAllowed.ToList();
            if (!allowedNextStudy.Contains(selectedNextStudy ?? default)) selectedNextStudy = null;
        } catch {
            allowedNextStudy.Clear();
            selectedNextStudy = null;
        }
        // Rebuild the timeline since history/allowed may influence displayed metadata
        InitializeTimelineItems();
        StateHasChanged();
    }

    private async Task ApplySelectedStudyTransition() {
        if (selectedNextStudy == null) return;
        await ApplyTransition(selectedNextStudy.Value);
    }

    private async Task ApplyTransition(StudyStatus status) {
        var ok = await WorkflowService.TryTransitionStudyAsync(Id, status);
        if (ok) {
            Snackbar.Add($"Transitioned to {status}", Severity.Success);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Transition to {status} not allowed", Severity.Warning);
        }
    }

    private async Task ReloadAfterChange() {
        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
    }

    // Aggregate all element types safely
    private IEnumerable<IReserveStudyElement> GetAllElements() {
        var building = reserveStudy?.ReserveStudyBuildingElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        var common = reserveStudy?.ReserveStudyCommonElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        var additional = reserveStudy?.ReserveStudyAdditionalElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        return building.Concat(common).Concat(additional);
    }

    // Class to hold timeline item information
    private class TimelineItemInfo {
        public ReserveStudy.WorkflowStatus Status { get; set; }
        public DateTime? DateValue { get; set; }
        public string? Title { get; set; }
        public string? Actor { get; set; }
        public bool IsHidden { get; set; } = false;
    }

    private void OpenComposeMessage() {
        if (reserveStudy?.SpecialistUserId == null) return;
        var parameters = new DialogParameters { ["ToUserId"] = reserveStudy.SpecialistUserId.Value, ["ToUserName"] = reserveStudy.Specialist?.Email ?? string.Empty };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        DialogService.ShowAsync<CRS.Components.Pages.Messages.ComposeMessageDialog>("Send Message", parameters, options);
    }
}