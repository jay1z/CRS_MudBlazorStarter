@page "/ReserveStudies/Details/{Id:guid}"
@attribute [Authorize]

@using CRS.Components.Custom
@using CRS.Components.Pages.ReserveStudies.Dialogs
@using CRS.Data
@using CRS.EventsAndListeners
@using CRS.Models.Emails
@using CRS.Services
@using CRS.Services.Email
@using CRS.Services.Interfaces
@using CRS.Models.Workflow
@using CRS.Services.Workflow
@using Coravel.Events.Interfaces
@using Coravel.Mailer.Mail
@using Coravel.Mailer.Mail.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using static CRS.Components.Custom.WorkflowStatusButtons

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IReserveStudyService ReserveStudyService
@inject IReserveStudyWorkflowService WorkflowService
@inject IWorkflowActionService WorkflowActionService
@inject ICalendarService CalendarService
@inject INotificationService NotificationService
@inject IMailer _mailer
@inject IDispatcher _dispatcher
@inject IDialogService DialogService
@inject IProposalAcceptanceService AcceptanceService
@inject IScopeComparisonService ScopeComparisonService
@inject ILogger<Details> Logger

<PageTitle>Reserve Study Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (isLoading) {
        <MudPaper Elevation="0" Class="pa-8">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h5" Class="mt-4">Loading Reserve Study...</MudText>
        </MudPaper>
    } else if (reserveStudy == null) {
        NavigationManager.NavigateTo("/ReserveStudies/NotFound");
    } else {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            <!-- Hero Header Section -->
            <MudPaper Elevation="3" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.LocationCity" Style="color: white; font-size: 40px;" />
                            <div>
                                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600; margin: 0;">
                                    @reserveStudy.Community?.Name
                                </MudText>
                                <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.9);">
                                    @reserveStudy.Community?.PhysicalAddress?.FullAddress
                                </MudText>
                            </div>
                        </MudStack>
                        <MudStack Row="true" Spacing="3" Class="mt-2">
                            <MudChip T="string" Icon="@Icons.Material.Filled.Tag"
                                     Style="background: rgba(255,255,255,0.2); color: white;"
                                     Size="Size.Small">
                                ID: @reserveStudy.Id.ToString().Substring(0, 8)
                            </MudChip>
                            <MudChip T="string" Icon="@Icons.Material.Filled.CalendarToday"
                                     Style="background: rgba(255,255,255,0.2); color: white;"
                                     Size="Size.Small">
                                Created: @reserveStudy.DateCreated?.ToString("MMM dd, yyyy")
                            </MudChip>
                        </MudStack>
                    </MudStack>

                    @if (canEdit || canStaffEdit) {
                        <MudButton Variant="Variant.Filled"
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   Href="@($"/ReserveStudies/Edit/{Id}")"
                                   Style="background: white; color: #667eea; font-weight: 600;">
                            Edit Request
                        </MudButton>
                    }
                </MudStack>
            </MudPaper>

            <MudGrid>
                <!-- Aside Column -->
                <MudItem xs="12" lg="4">
                    <!-- Quick Info Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #667eea;">
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Request ID</MudText>
                                    <MudText Typo="Typo.body1" Style="font-family: 'Courier New', monospace; font-weight: 500;">
                                        @reserveStudy.Id.ToString().Substring(0, 13)...
                                    </MudText>
                                </div>
                                <MudDivider />
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Created Date</MudText>
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @reserveStudy.DateCreated?.ToString("MMMM dd, yyyy")
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: #999;">
                                        @((DateTime.Now - (reserveStudy.DateCreated ?? DateTime.Now)).Days) days ago
                                    </MudText>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>


                    <!-- Specialist Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Size="Size.Large" Style="background: white; color: #667eea;">
                                        @if (reserveStudy.Specialist != null) {
                                            <MudText>@reserveStudy.Specialist.Initials</MudText>
                                        } else {
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                                        }
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase;">
                                            Reserve Specialist
                                        </MudText>
                                        <MudText Typo="Typo.h6" Style="color: white; font-weight: 600;">
                                            @(reserveStudy.Specialist?.FullName ?? "Not Assigned")
                                        </MudText>
                                    </div>
                                </MudStack>
                                <AuthorizeView Policy="RequireTenantOwner">
                                    <Authorized>
                                        <MudButton Variant="Variant.Filled"
                                                   Size="Size.Small"
                                                   Style="background: rgba(255,255,255,0.2); color: white; text-transform: none;"
                                                   StartIcon="@Icons.Material.Filled.Edit"
                                                   OnClick="OpenAssignSpecialistDialog">
                                            @(reserveStudy.Specialist != null ? "Change" : "Assign")
                                        </MudButton>
                                    </Authorized>
                                </AuthorizeView>
                            </MudStack>
                        </div>
                        <MudCardContent>
                            <MudStack Spacing="2">
                                @if (reserveStudy.Specialist != null) {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                        <MudLink Href="@($"mailto:{reserveStudy.Specialist.Email}")" Typo="Typo.body2">
                                            @reserveStudy.Specialist.Email
                                        </MudLink>
                                    </MudStack>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Primary"
                                               FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.Message"
                                               Disabled="@(reserveStudy?.SpecialistUserId == null)"
                                               OnClick="OpenComposeMessage">
                                        Send Message
                                    </MudButton>
                                    <AuthorizeView Policy="RequireTenantOwner">
                                        <Authorized>
                                            <MudButton Variant="Variant.Text"
                                                       Color="Color.Primary"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.SwapHoriz"
                                                       OnClick="OpenAssignSpecialistDialog">
                                                Reassign Specialist
                                            </MudButton>
                                        </Authorized>
                                    </AuthorizeView>
                                } else {
                                    @if (CanAssignSpecialist()) {
                                        <MudAlert Severity="Severity.Success" Dense="true">
                                            Request approved! You can now assign a specialist.
                                        </MudAlert>
                                        <AuthorizeView Policy="RequireTenantOwner">
                                            <Authorized>
                                                <MudButton Variant="Variant.Filled"
                                                           Color="Color.Primary"
                                                           FullWidth="true"
                                                           StartIcon="@Icons.Material.Filled.PersonAdd"
                                                           OnClick="OpenAssignSpecialistDialog">
                                                    Assign Specialist
                                                </MudButton>
                                            </Authorized>
                                        </AuthorizeView>
                                    } else if (NeedsApproval()) {
                                        <MudAlert Severity="Severity.Warning" Dense="true">
                                            Request pending approval before specialist can be assigned.
                                        </MudAlert>
                                    } else {
                                        <MudAlert Severity="Severity.Info" Dense="true">
                                            A specialist will be assigned to your request shortly.
                                        </MudAlert>
                                    }
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>


                    <!-- Status Progress Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; overflow: hidden;">
                        <div style="background: @GetStatusColors().gradient; padding: 16px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@GetStatusIcon()" Style="color: white; font-size: 32px;" />
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase;">
                                        Current Status
                                    </MudText>
                                    <MudText Typo="Typo.h6" Style="color: white; font-weight: 600;">
                                        @FormatStatusTitle(GetCurrentStatus())
                                    </MudText>
                                </div>
                            </MudStack>
                        </div>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <!-- Progress Bar -->
                                <div>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-1">
                                        <MudText Typo="Typo.caption" Style="font-weight: 600;">Progress</MudText>
                                        <MudText Typo="Typo.caption" Style="@($"font-weight: 600; color: {GetStatusColors().progressColor};")">
                                            @GetProgressPercentage()%
                                        </MudText>
                                    </MudStack>
                                    <MudProgressLinear Color="@GetProgressBarColor()"
                                                       Value="@GetProgressPercentage()"
                                                       Size="Size.Medium"
                                                       Style="border-radius: 8px; height: 12px;" />
                                </div>

                                <!-- Key Milestones -->
                                <MudDivider />
                                <MudText Typo="Typo.caption" Style="font-weight: 600; text-transform: uppercase; color: #666;">
                                    Key Milestones
                                </MudText>

                                @foreach (var milestone in GetKeyMilestones()) {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        @if (milestone.IsCompleted) {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle"
                                                     Color="Color.Success"
                                                     Size="Size.Small" />
                                        } else if (milestone.IsCurrent) {
                                            <MudIcon Icon="@Icons.Material.Filled.RadioButtonChecked"
                                                     Color="Color.Primary"
                                                     Size="Size.Small" />
                                        } else {
                                            <MudIcon Icon="@Icons.Material.Outlined.RadioButtonUnchecked"
                                                     Style="color: #ccc;"
                                                     Size="Size.Small" />
                                        }
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.body2"
                                                     Style="@(milestone.IsCompleted ? "color: #666; text-decoration: line-through;" : milestone.IsCurrent ? "font-weight: 600; color: #667eea;" : "color: #999;")">
                                                @milestone.Title
                                            </MudText>
                                            @if (milestone.IsCompleted && milestone.Date.HasValue) {
                                                <MudText Typo="Typo.caption" Style="color: #999;">
                                                    @milestone.Date.Value.ToString("MMM dd, yyyy")
                                                </MudText>
                                            }
                                        </div>
                                    </MudStack>
                                }

                                <!-- Next Action -->
                                @{
                                    var nextStatus = GetNextStatus();
                                    var nextActionInfo = GetNextActionInfo();
                                }
                                @if (nextStatus != null && nextActionInfo != null) {
                                    <MudDivider />
                                    <MudPaper Elevation="0" Class="pa-3" Style="background: #f0f4ff; border-radius: 8px;">
                                        <MudStack Spacing="1">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward"
                                                         Color="Color.Primary"
                                                         Size="Size.Small" />
                                                <MudText Typo="Typo.caption" Style="color: #667eea; font-weight: 600; text-transform: uppercase;">
                                                    Next Step
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                @nextActionInfo.ActionText
                                            </MudText>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@nextActionInfo.ActorIcon"
                                                         Size="Size.Small"
                                                         Style="color: #999;" />
                                                <MudText Typo="Typo.caption" Style="color: #666;">
                                                    @nextActionInfo.ActorText
                                                </MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px;">
                                <MudCardHeader Style="background: #f8f9fa;">
                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mr-2" />
                                        Staff Actions
                                    </MudText>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudStack Spacing="2">
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Secondary"
                                                   FullWidth="true"
                                                   StartIcon="@Icons.Material.Filled.Link"
                                                   OnClick="SendRequestLink">
                                            Send Request Link
                                        </MudButton>
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Secondary"
                                                   FullWidth="true"
                                                   StartIcon="@Icons.Material.Filled.VpnKey"
                                                   OnClick="SendAccessTokenLink">
                                            Send Access Token
                                        </MudButton>
                                        @if (reserveStudy?.CurrentProposal != null && reserveStudy?.CurrentStatus < StudyStatus.ProposalSent) {
                                            <MudDivider Class="my-2" />
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Primary"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                       Href="@($"/ReserveStudies/Proposal/{Id}")">
                                                Edit Proposal
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudCardContent>
                            </MudCard>
                        </Authorized>
                    </AuthorizeView>

                    <!-- Admin Workflow Panel -->
                    <CRS.Components.Custom.AdminWorkflowPanel StudyId="@Id"
                                                              CurrentStatus="@GetCurrentStatus()"
                                                              StatusHistory="@statusHistory"
                                                              OnActionCompleted="@ReloadAfterChange" />

                    @if (reserveStudy.DateCreated.HasValue && (DateTime.Now - reserveStudy.DateCreated.Value).TotalDays > 30 && !reserveStudy.IsComplete) {
                        <MudAlert Severity="Severity.Warning" Elevation="2" Class="mb-4" Style="border-radius: 12px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Large" />
                                <div>
                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Attention Needed</MudText>
                                    <MudText Typo="Typo.body2">
                                        This request has been pending for
                                        <strong>@((DateTime.Now - reserveStudy.DateCreated.Value).TotalDays.ToString("N0")) days</strong>
                                    </MudText>
                                </div>
                            </MudStack>
                        </MudAlert>
                    }
                </MudItem>

                <!-- Main Column -->
                <MudItem xs="12" lg="8">
                    <MudTabs Elevation="2" Rounded="true" Color="Color.Primary" ActivePanelIndex="activeTabIndex" ActivePanelIndexChanged="HandleTabChange" Style="border-radius: 12px; overflow: hidden;" PanelClass="pa-4">
                        <!-- Workflow Status Tab -->
                        <MudTabPanel Text="Workflow Details" Icon="@Icons.Material.Filled.Info">
                            <MudCard Elevation="0">
                                <MudCardContent>
                                    <!-- Current Status Banner -->
                                    <MudPaper Elevation="2" Class="pa-4 mb-4" Style="@($"background: {GetStatusColors().gradient}; border-radius: 12px;")">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@GetStatusIcon()" Style="color: white; font-size: 48px;" />
                                                <div>
                                                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                                        CURRENT STATUS
                                                    </MudText>
                                                    <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;">
                                                        @FormatStatusTitle(GetCurrentStatus())
                                                    </MudText>
                                                </div>
                                            </MudStack>
                                            <MudChip T="string" Style="background: rgba(255,255,255,0.2); color: white; font-weight: 600;" Size="Size.Large">
                                                @GetProgressPercentage()% Complete
                                            </MudChip>
                                        </MudStack>
                                    </MudPaper>

                                    <!-- Current Step Description -->
                                    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #667eea;">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" Size="Size.Small" />
                                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #667eea;">
                                                    Current Step
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.body2" Style="color: #666;">
                                                @GetCurrentStepDescription()
                                            </MudText>
                                        </MudStack>
                                    </MudPaper>

                                    <!-- Next Step Description -->
                                    @{
                                        var nextActionInfo = GetNextActionInfo();
                                    }
                                    @if (nextActionInfo != null) {
                                        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: #f0f4ff; border-radius: 12px; border-left: 4px solid #10b981;">
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Success" Size="Size.Small" />
                                                    <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #10b981;">
                                                        What's Next: @nextActionInfo.ActionText
                                                    </MudText>
                                                </MudStack>
                                                <MudText Typo="Typo.body2" Style="color: #666;">
                                                    @GetNextStepDescription()
                                                </MudText>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-2">
                                                    <MudIcon Icon="@nextActionInfo.ActorIcon" Size="Size.Small" Style="color: #10b981;" />
                                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">
                                                        @nextActionInfo.ActorText
                                                    </MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    }

                                    <!-- Proposal Details -->
                                    <!-- Show proposal details only before initial acceptance, or during amendment workflow -->
                                    @if (reserveStudy?.CurrentProposal != null) {
                                        var proposal = reserveStudy.CurrentProposal;
                                        var proposalSent = proposal.DateSent.HasValue;
                                        var proposalStatus = GetCurrentStatus();
                                        // Show proposal if not yet accepted, OR if it's an amendment awaiting acceptance
                                        var showProposalDetails = proposalStatus < StudyStatus.ProposalAccepted ||
                                        (proposal.IsAmendment && (proposalStatus == StudyStatus.AmendmentPending || proposalStatus == StudyStatus.AmendmentApproved));

                                        @if (showProposalDetails) {
                                            @* Show to staff always, or to HOA users only after proposal is sent *@
                                            <AuthorizeView Policy="RequireTenantStaff">
                                                <Authorized>
                                                    @RenderProposalDetails(proposal)
                                                </Authorized>
                                                <NotAuthorized>
                                                    @if (proposalSent) {
                                                        @RenderProposalDetails(proposal)
                                                    }
                                                </NotAuthorized>
                                            </AuthorizeView>
                                        }
                                    }

                                    <!-- Action Buttons -->
                                    @{
                                        var currentStatus = GetCurrentStatus();
                                        var isAmendmentPending = currentStatus == StudyStatus.AmendmentPending;
                                        var isAmendmentApproved = currentStatus == StudyStatus.AmendmentApproved;

                                        <MudStack Row="true" Spacing="2" Class="mb-4" Style="flex-wrap: wrap;">
                                            @* Amendment Pending - Show alert and admin approval button *@
                                            @if (isAmendmentPending) {
                                                <MudItem xs="12">
                                                    <MudAlert Severity="Severity.Warning" Class="mb-3" Elevation="2" Style="border-radius: 12px;">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                            <MudStack Spacing="1">
                                                                <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                    Amendment Review Required
                                                                </MudText>
                                                                <MudText Typo="Typo.body2">
                                                                    The site visit revealed scope changes that exceed the threshold. An amendment has been created and requires administrative approval before sending to the client.
                                                                </MudText>
                                                            </MudStack>
                                                            <AuthorizeView Policy="RequireTenantOwner">
                                                                <Authorized>
                                                                    <MudButton Variant="Variant.Filled"
                                                                               Color="Color.Success"
                                                                               Size="Size.Large"
                                                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                               OnClick="@(() => ApplyTransition(StudyStatus.AmendmentApproved))">
                                                                        Approve Amendment
                                                                    </MudButton>
                                                                </Authorized>
                                                            </AuthorizeView>
                                                        </MudStack>
                                                    </MudAlert>
                                                </MudItem>
                                            }

                                            @* Amendment Approved - Waiting for HOA acceptance *@
                                            @if (isAmendmentApproved) {
                                                <MudItem xs="12">
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudAlert Severity="Severity.Info" Class="mb-3" Elevation="2" Style="border-radius: 12px;">
                                                                <MudStack Spacing="1">
                                                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                        Awaiting Client Acceptance
                                                                    </MudText>
                                                                    <MudText Typo="Typo.body2">
                                                                        The amendment has been approved and sent to the client. Waiting for the HOA to review and accept the amendment before proceeding.
                                                                    </MudText>
                                                                </MudStack>
                                                            </MudAlert>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                    <AuthorizeView Policy="RequireHOAUser">
                                                        <Authorized>
                                                            <MudAlert Severity="Severity.Warning" Class="mb-3" Elevation="2" Style="border-radius: 12px;">
                                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                    <MudStack Spacing="1">
                                                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                            Amendment Requires Your Approval
                                                                        </MudText>
                                                                        <MudText Typo="Typo.body2">
                                                                            The site visit revealed scope changes that affect the original proposal. Please review and accept the amendment to continue with your reserve study.
                                                                        </MudText>
                                                                    </MudStack>
                                                                    <MudButton Variant="Variant.Filled"
                                                                               Color="Color.Success"
                                                                               Size="Size.Large"
                                                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                               OnClick="OpenAcceptProposalDialog">
                                                                        Review & Accept Amendment
                                                                    </MudButton>
                                                                </MudStack>
                                                            </MudAlert>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                </MudItem>
                                            }


                                            @* Only show other action buttons if NOT in amendment flow *@
                                            @if (!isAmendmentPending && !isAmendmentApproved) {
                                                @* Approve Request - when RequestApproved is allowed *@
                                                @if (allowedNextStudy.Contains(StudyStatus.RequestApproved)) {
                                                    <AuthorizeView Policy="RequireTenantOwner">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="ApproveRequestAsync">
                                                                Approve Request
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }


                                                @* Create Proposal - when no proposal exists and ProposalCreated is allowed *@
                                                @if (allowedNextStudy.Contains(StudyStatus.ProposalCreated) && reserveStudy?.CurrentProposal == null) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Description"
                                                                       Href="@($"/ReserveStudies/Proposal/{Id}")">
                                                                Create Proposal
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Show Send Proposal only when we can actually transition to ProposalSent *@
                                                @if (allowedNextStudy.Contains(StudyStatus.ProposalSent)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Send"
                                                                       OnClick="@(() => SendProposalAsync(Id))">
                                                                Send Proposal
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Proposal workflow steps *@
                                                @if (allowedNextStudy.Contains(StudyStatus.ProposalReviewed)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.RateReview"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.ProposalReviewed))">
                                                                Submit for Review
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (allowedNextStudy.Contains(StudyStatus.ProposalApproved)) {
                                                    <AuthorizeView Policy="RequireTenantOwner">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.ProposalApproved))">
                                                                Approve Proposal
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (allowedNextStudy.Contains(StudyStatus.ProposalUpdated)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Outlined"
                                                                       Color="Color.Warning"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.ProposalUpdated))">
                                                                Request Changes
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Create Revision button for declined proposals *@
                                                @if (currentStatus == StudyStatus.ProposalDeclined) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudItem xs="12">
                                                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mb-3">
                                                                    <MudStack Spacing="1">
                                                                        <MudText Typo="Typo.subtitle2">
                                                                            <strong>Proposal Declined</strong>
                                                                            @if (reserveStudy?.CurrentProposal?.RevisionRequested == true) {
                                                                                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="ml-2">Revision Requested</MudChip>
                                                                            }
                                                                        </MudText>
                                                                        @if (reserveStudy?.CurrentProposal?.DeclineReasonCategory != null) {
                                                                            <MudText Typo="Typo.body2">
                                                                                <strong>Reason:</strong> @GetDeclineReasonText(reserveStudy.CurrentProposal.DeclineReasonCategory)
                                                                            </MudText>
                                                                        }
                                                                        @if (!string.IsNullOrWhiteSpace(reserveStudy?.CurrentProposal?.DeclineComments)) {
                                                                            <MudText Typo="Typo.body2">
                                                                                <strong>Comments:</strong> @reserveStudy.CurrentProposal.DeclineComments
                                                                            </MudText>
                                                                        }
                                                                    </MudStack>
                                                                </MudAlert>
                                                                <MudStack Row="true" Spacing="2">
                                                                    <MudButton Variant="Variant.Filled"
                                                                               Color="Color.Primary"
                                                                               Size="Size.Small"
                                                                               StartIcon="@Icons.Material.Filled.Edit"
                                                                               OnClick="CreateRevisionProposalAsync">
                                                                        Create Revised Proposal
                                                                    </MudButton>
                                                                    <MudButton Variant="Variant.Outlined"
                                                                               Color="Color.Error"
                                                                               Size="Size.Small"
                                                                               StartIcon="@Icons.Material.Filled.Cancel"
                                                                               OnClick="@(() => ApplyTransition(StudyStatus.RequestCancelled))">
                                                                        Cancel Study
                                                                    </MudButton>
                                                                </MudStack>
                                                            </MudItem>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Data collection steps - only show for statuses before ProposalAccepted *@
                                                @* ProposalAccepted triggers automatic financial info request *@
                                                @if ((allowedNextStudy.Contains(StudyStatus.FinancialInfoRequested) ||
                                                                                    allowedNextStudy.Contains(StudyStatus.ServiceContactsRequested)) &&
                                                                                    currentStatus < StudyStatus.ProposalAccepted) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Description"
                                                                       OnClick="@(() => RequestFinancialInfoAsync(Id))">
                                                                Request Financial Info
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Request more financial info (after review) *@
                                                @if (allowedNextStudy.Contains(StudyStatus.FinancialInfoRequested) &&
                                                                                    currentStatus >= StudyStatus.FinancialInfoSubmitted &&
                                                                                    currentStatus < StudyStatus.SiteVisitPending) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Outlined"
                                                                       Color="Color.Warning"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Refresh"
                                                                       OnClick="@(() => RequestFinancialInfoAsync(Id))">
                                                                Request More Info
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Accept financial info *@
                                                @if (allowedNextStudy.Contains(StudyStatus.FinancialInfoReceived)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.FinancialInfoReceived))">
                                                                Accept Financial Info
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* HOA user button to submit financial info when requested *@
                                                @if (currentStatus == StudyStatus.FinancialInfoRequested ||
                                                                                    currentStatus == StudyStatus.FinancialInfoInProgress) {
                                                    <AuthorizeView Policy="RequireHOAUser">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Description"
                                                                       Href="@($"/ReserveStudies/FinancialInfo/{Id}")">
                                                                Submit Financial Information
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Site visit workflow *@
                                                @if (currentStatus == StudyStatus.FinancialInfoReceived &&
                                                                                    allowedNextStudy.Contains(StudyStatus.SiteVisitPending)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Event"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitPending))">
                                                                Begin Site Visit Process
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (currentStatus == StudyStatus.SiteVisitPending &&
                                                                                    allowedNextStudy.Contains(StudyStatus.SiteVisitScheduled)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CalendarMonth"
                                                                       OnClick="OpenScheduleSiteVisitDialog">
                                                                Schedule Site Visit
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (currentStatus == StudyStatus.SiteVisitScheduled &&
                                                                                    allowedNextStudy.Contains(StudyStatus.SiteVisitCompleted)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitCompleted))">
                                                                Mark Site Visit Complete
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (currentStatus == StudyStatus.SiteVisitCompleted &&
                                                                                    allowedNextStudy.Contains(StudyStatus.SiteVisitDataEntered)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Storage"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitDataEntered))">
                                                                Mark Data Entry Complete
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Site Visit Data Entered - Check for scope variance before allowing funding plan *@
                                                @if (currentStatus == StudyStatus.SiteVisitDataEntered) {
                                                    @if (hasUnresolvedScopeVariance) {
                                                        @* Scope variance detected - must be resolved first *@
                                                        <MudItem xs="12">
                                                            <MudAlert Severity="Severity.Warning" Class="mb-3" Elevation="2" Style="border-radius: 12px;">
                                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                                    <MudStack Spacing="1">
                                                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                            Scope Variance Detected
                                                                        </MudText>
                                                                        <MudText Typo="Typo.body2">
                                                                            The site visit revealed a variance of @(scopeComparison?.VarianceCount > 0 ? "+" : "")@scopeComparison?.VarianceCount elements (@scopeComparison?.VariancePercent.ToString("N1")%) from the original proposal scope.
                                                                            This must be resolved before proceeding to the funding plan.
                                                                        </MudText>
                                                                    </MudStack>
                                                                    <MudButton Variant="Variant.Filled"
                                                                               Color="Color.Warning"
                                                                               Size="Size.Large"
                                                                               StartIcon="@Icons.Material.Filled.CompareArrows"
                                                                               OnClick="NavigateToScopeTab">
                                                                        Review Scope Variance
                                                                    </MudButton>
                                                                </MudStack>
                                                            </MudAlert>
                                                        </MudItem>
                                                    } else if (allowedNextStudy.Contains(StudyStatus.FundingPlanReady)) {
                                                        @* No variance or variance resolved - allow funding plan *@
                                                        <AuthorizeView Policy="RequireTenantStaff">
                                                            <Authorized>
                                                                <MudButton Variant="Variant.Filled"
                                                                           Color="Color.Success"
                                                                           Size="Size.Large"
                                                                           StartIcon="@Icons.Material.Filled.PlayArrow"
                                                                           OnClick="@(() => ApplyTransition(StudyStatus.FundingPlanReady))">
                                                                    Begin Funding Plan
                                                                </MudButton>
                                                            </Authorized>
                                                        </AuthorizeView>
                                                    }
                                                }

                                                @* Funding Plan Phase - Link to Reports tab and option to go back *@
                                                @if (currentStatus == StudyStatus.FundingPlanReady ||
                                                                                    currentStatus == StudyStatus.FundingPlanInProcess) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Description"
                                                                       OnClick="NavigateToReportsTab">
                                                                Go to Reports
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @if (currentStatus == StudyStatus.FundingPlanReady &&
                                                                                    allowedNextStudy.Contains(StudyStatus.SiteVisitDataEntered)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Outlined"
                                                                       Color="Color.Secondary"
                                                                       Size="Size.Medium"
                                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitDataEntered))">
                                                                Edit Site Visit Data
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Narrative Phase - Link to Narrative tab *@
                                                @if (currentStatus >= StudyStatus.FundingPlanComplete &&
                                                                                    currentStatus <= StudyStatus.NarrativeSent) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Article"
                                                                       OnClick="NavigateToNarrativeTab">
                                                                Go to Narrative
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Complete study *@
                                                @if (allowedNextStudy.Contains(StudyStatus.RequestCompleted)) {
                                                    <AuthorizeView Policy="RequireTenantOwner">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="@(() => CompleteReserveStudyAsync(Id))">
                                                                Mark as Complete
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Submit for Final Review (when RequireFinalReview is enabled) *@
                                                @if (allowedNextStudy.Contains(StudyStatus.FinalReviewPending)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.RateReview"
                                                                       OnClick="@(() => ApplyTransition(StudyStatus.FinalReviewPending))">
                                                                Submit for Final Review
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Complete Final Review (when in FinalReviewPending status) *@
                                                @if (currentStatus == StudyStatus.FinalReviewPending) {
                                                    <AuthorizeView Policy="RequireTenantOwner">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Verified"
                                                                       OnClick="@(() => CompleteFinalReviewAsync(Id))">
                                                                Complete Final Review
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }

                                                @* Generic advance for other transitions (forward progression) *@
                                                @foreach (var nextAllowed in allowedNextStudy.Where(s =>
                                                                                    s != StudyStatus.RequestCancelled &&
                                                                                    s != StudyStatus.RequestApproved &&
                                                                                    s != StudyStatus.ProposalCreated &&
                                                                                    s != StudyStatus.ProposalSent &&
                                                                                    s != StudyStatus.ProposalReviewed &&
                                                                                    s != StudyStatus.ProposalApproved &&
                                                                                    s != StudyStatus.ProposalUpdated &&
                                                                                    s != StudyStatus.ProposalAccepted &&
                                                                                    s != StudyStatus.ProposalDeclined &&
                                                                                    s != StudyStatus.FinancialInfoRequested &&
                                                                                    s != StudyStatus.FinancialInfoInProgress &&
                                                                                    s != StudyStatus.FinancialInfoReceived &&
                                                                                    s != StudyStatus.ServiceContactsRequested &&
                                                                                    s != StudyStatus.SiteVisitPending &&
                                                                                    s != StudyStatus.SiteVisitScheduled &&
                                                                                    s != StudyStatus.SiteVisitCompleted &&
                                                                                    s != StudyStatus.SiteVisitDataEntered &&
                                                                                    s != StudyStatus.RequestCompleted &&
                                                                                    s != StudyStatus.AmendmentPending &&
                                                                                    s != StudyStatus.AmendmentApproved &&
                                                                                    s != StudyStatus.FundingPlanReady &&
                                                                                    s != StudyStatus.FundingPlanInProcess &&
                                                                                    s != StudyStatus.FundingPlanComplete &&
                                                                                    s != StudyStatus.NarrativeReady &&
                                                                                    s != StudyStatus.NarrativeInProcess &&
                                                                                    s != StudyStatus.NarrativeComplete &&
                                                                                    s != StudyStatus.NarrativePrintReady &&
                                                                                    s != StudyStatus.NarrativePackaged &&
                                                                                    s != StudyStatus.NarrativeSent &&
                                                                                    s != StudyStatus.FinalReviewPending)) {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Primary"
                                                                       Size="Size.Medium"
                                                                       StartIcon="@Icons.Material.Filled.ArrowForward"
                                                                       OnClick="@(() => ApplyTransition(nextAllowed))">
                                                                @FormatStatusTitle(nextAllowed)
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }
                                                @* HOA User: Accept Proposal button *@
                                                @if (currentStatus == StudyStatus.ProposalSent && !hasValidAcceptance) {
                                                    <AuthorizeView Policy="RequireHOAUser">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled"
                                                                       Color="Color.Success"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                       OnClick="OpenAcceptProposalDialog">
                                                                Accept Proposal
                                                            </MudButton>
                                                            <MudButton Variant="Variant.Outlined"
                                                                       Color="Color.Error"
                                                                       Size="Size.Large"
                                                                       StartIcon="@Icons.Material.Filled.Cancel"
                                                                       OnClick="OpenDeclineProposalDialog">
                                                                Decline Proposal
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }
                                            } @* End of !isAmendmentPending && !isAmendmentApproved *@
                                        </MudStack>
                                    }


                                    @* Financial Information - only show until status 13 (FinancialInfoReceived) *@
                                    @* After that, users should use the dedicated FinancialInfo page to view *@
                                    @if (reserveStudy?.FinancialInfo != null && currentStatus <= StudyStatus.FinancialInfoReceived) {
                                        <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #3b82f6;">
                                            <MudCardContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Financial Information</MudText>
                                                    </MudStack>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        @if (reserveStudy.FinancialInfo.DateSubmitted.HasValue) {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                                Submitted @reserveStudy.FinancialInfo.DateSubmitted.Value.ToString("MMM dd, yyyy")
                                                            </MudChip>
                                                        }
                                                        @* HOA users can edit during review period *@
                                                        <AuthorizeView Policy="RequireHOAUser">
                                                            <Authorized>
                                                                @if (currentStatus <= StudyStatus.FinancialInfoReviewed) {
                                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                                                   Color="Color.Primary"
                                                                                   Size="Size.Small"
                                                                                   Href="@($"/ReserveStudies/FinancialInfo/{Id}")"
                                                                                   Title="Edit Financial Information" />
                                                                }
                                                            </Authorized>
                                                        </AuthorizeView>
                                                        @* Staff/Specialists see view-only button *@
                                                        <AuthorizeView Policy="RequireTenantStaff">
                                                            <Authorized>
                                                                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                                                               Color="Color.Default"
                                                                               Size="Size.Small"
                                                                               Href="@($"/ReserveStudies/FinancialInfo/{Id}")"
                                                                               Title="View Financial Information" />
                                                            </Authorized>
                                                        </AuthorizeView>
                                                    </MudStack>
                                                </MudStack>

                                                @* Reserve Balances *@
                                                <MudText Typo="Typo.subtitle2" Class="mb-2 mt-3" Style="color: #666; font-weight: 600;">Reserve Balances</MudText>
                                                <MudGrid Spacing="2">
                                                    @if (reserveStudy.FinancialInfo.JanuaryFirstReserveBalance.HasValue) {
                                                        <MudItem xs="12" md="6">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Jan 1 Reserve Balance</MudText>
                                                            <MudText Typo="Typo.h6" Style="color: #3b82f6; font-weight: 700;">
                                                                $@reserveStudy.FinancialInfo.JanuaryFirstReserveBalance.Value.ToString("N2")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                    @if (reserveStudy.FinancialInfo.DecemberThirtyFirstReserveBalance.HasValue) {
                                                        <MudItem xs="12" md="6">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Expected Dec 31 Balance</MudText>
                                                            <MudText Typo="Typo.h6" Style="color: #3b82f6; font-weight: 700;">
                                                                $@reserveStudy.FinancialInfo.DecemberThirtyFirstReserveBalance.Value.ToString("N2")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                </MudGrid>

                                                @* Budgeted Contributions *@
                                                @if (reserveStudy.FinancialInfo.BudgetedContributionLastYear.HasValue ||
                                                                                        reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.HasValue ||
                                                                                        reserveStudy.FinancialInfo.BudgetedContributionNextYear.HasValue) {
                                                    <MudDivider Class="my-3" />
                                                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Budgeted Reserve Contributions</MudText>
                                                    <MudGrid Spacing="2">
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionLastYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Last Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionLastYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Current Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionNextYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Next Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionNextYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                    </MudGrid>
                                                }

                                                @* Community Details *@
                                                <MudDivider Class="my-3" />
                                                <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Community Details</MudText>
                                                <MudGrid Spacing="2">
                                                    @if (reserveStudy.FinancialInfo.TotalNumberOfUnits.HasValue) {
                                                        <MudItem xs="12" md="4">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Total Units</MudText>
                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                @reserveStudy.FinancialInfo.TotalNumberOfUnits.Value
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                    <MudItem xs="12" md="4">
                                                        <MudText Typo="Typo.caption" Style="color: #888;">Fiscal Year Start</MudText>
                                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                            @System.Globalization.DateTimeFormatInfo.CurrentInfo.GetMonthName(reserveStudy.FinancialInfo.FiscalYearStartMonth)
                                                        </MudText>
                                                    </MudItem>
                                                    @if (reserveStudy.FinancialInfo.AnnualMeetingDate.HasValue) {
                                                        <MudItem xs="12" md="4">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Annual Meeting</MudText>
                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                @reserveStudy.FinancialInfo.AnnualMeetingDate.Value.ToString("MMM dd, yyyy")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                </MudGrid>

                                                @* Staff-only sections *@
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        @* Loans & Special Assessments *@
                                                        @if (reserveStudy.FinancialInfo.LoanAmount.HasValue || reserveStudy.FinancialInfo.SpecialAssessmentAmount.HasValue) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Loans & Assessments</MudText>
                                                            <MudGrid Spacing="2">
                                                                @if (reserveStudy.FinancialInfo.LoanAmount.HasValue) {
                                                                    <MudItem xs="12" md="6">
                                                                        <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px;">
                                                                            <MudText Typo="Typo.caption" Style="color: #888;">Current Loan</MudText>
                                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                                $@reserveStudy.FinancialInfo.LoanAmount.Value.ToString("N2")
                                                                            </MudText>
                                                                            @if (reserveStudy.FinancialInfo.LoanBalanceRemaining.HasValue) {
                                                                                <MudText Typo="Typo.caption">Balance: $@reserveStudy.FinancialInfo.LoanBalanceRemaining.Value.ToString("N2")</MudText>
                                                                            }
                                                                        </MudPaper>
                                                                    </MudItem>
                                                                }
                                                                @if (reserveStudy.FinancialInfo.SpecialAssessmentAmount.HasValue) {
                                                                    <MudItem xs="12" md="6">
                                                                        <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px;">
                                                                            <MudText Typo="Typo.caption" Style="color: #888;">Special Assessment</MudText>
                                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                                $@reserveStudy.FinancialInfo.SpecialAssessmentAmount.Value.ToString("N2")
                                                                            </MudText>
                                                                            @if (reserveStudy.FinancialInfo.SpecialAssessmentBalanceRemaining.HasValue) {
                                                                                <MudText Typo="Typo.caption">Balance: $@reserveStudy.FinancialInfo.SpecialAssessmentBalanceRemaining.Value.ToString("N2")</MudText>
                                                                            }
                                                                        </MudPaper>
                                                                    </MudItem>
                                                                }
                                                            </MudGrid>
                                                        }

                                                        @* Planned Projects *@
                                                        @if (!string.IsNullOrEmpty(reserveStudy.FinancialInfo.PlannedProjects)) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Planned Projects</MudText>
                                                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@reserveStudy.FinancialInfo.PlannedProjects</MudText>
                                                        }

                                                        @* Building Components *@
                                                        @if (!string.IsNullOrEmpty(reserveStudy.FinancialInfo.BuildingRoofSidingInfo)) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Building Components</MudText>
                                                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@reserveStudy.FinancialInfo.BuildingRoofSidingInfo</MudText>
                                                        }
                                                    </Authorized>
                                                </AuthorizeView>
                                            </MudCardContent>
                                        </MudCard>
                                    }

                                    @* Financial Info quick link for staff after status 13 *@
                                    @if (reserveStudy?.FinancialInfo != null && currentStatus > StudyStatus.FinancialInfoReceived) {
                                        <AuthorizeView Policy="RequireTenantStaff">
                                            <Authorized>
                                                <MudPaper Elevation="1" Class="pa-3 mb-4" Style="border-radius: 8px; background: #f0f4ff; border-left: 3px solid #3b82f6;">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" Size="Size.Small" />
                                                            <MudText Typo="Typo.body2" Style="color: #3b82f6;">
                                                                Financial information has been collected
                                                            </MudText>
                                                            @if (reserveStudy.FinancialInfo.DateSubmitted.HasValue) {
                                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                                    @reserveStudy.FinancialInfo.DateSubmitted.Value.ToString("MMM dd, yyyy")
                                                                </MudChip>
                                                            }
                                                        </MudStack>
                                                        <MudButton Variant="Variant.Text"
                                                                   Color="Color.Info"
                                                                   Size="Size.Small"
                                                                   StartIcon="@Icons.Material.Filled.Visibility"
                                                                   Href="@($"/ReserveStudies/FinancialInfo/{Id}")">
                                                            View Details
                                                        </MudButton>
                                                    </MudStack>
                                                </MudPaper>
                                            </Authorized>
                                        </AuthorizeView>
                                    }

                                    @* Site Visit Information - show when scheduled or completed *@
                                    @if (reserveStudy?.SiteVisitDate.HasValue == true ||
                                                                    currentStatus >= StudyStatus.SiteVisitScheduled) {
                                        <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #8b5cf6;">
                                            <MudCardContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.HomeWork" Style="color: #8b5cf6;" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Site Visit</MudText>
                                                    </MudStack>
                                                    @if (currentStatus >= StudyStatus.SiteVisitCompleted) {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                            Completed
                                                        </MudChip>
                                                    } else if (currentStatus == StudyStatus.SiteVisitScheduled) {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Event">
                                                            Scheduled
                                                        </MudChip>
                                                    }
                                                </MudStack>

                                                @if (reserveStudy?.SiteVisitDate.HasValue == true) {
                                                    <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 8px;">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                                            <MudAvatar Size="Size.Large" Style="background: #8b5cf6; color: white;">
                                                                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
                                                            </MudAvatar>
                                                            <div>
                                                                <MudText Typo="Typo.caption" Style="color: #8b5cf6; font-weight: 600; text-transform: uppercase;">
                                                                    Scheduled Date & Time
                                                                </MudText>
                                                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #5b21b6;">
                                                                    @reserveStudy.SiteVisitDate.Value.ToString("dddd, MMMM dd, yyyy")
                                                                </MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600; color: #7c3aed;">
                                                                    @reserveStudy.SiteVisitDate.Value.ToString("h:mm tt")
                                                                </MudText>
                                                            </div>
                                                        </MudStack>
                                                    </MudPaper>

                                                    @* Allow rescheduling if not yet completed *@
                                                    @if (currentStatus < StudyStatus.SiteVisitCompleted) {
                                                        <AuthorizeView Policy="RequireTenantStaff">
                                                            <Authorized>
                                                                <MudButton Variant="Variant.Text"
                                                                           Color="Color.Primary"
                                                                           Size="Size.Small"
                                                                           StartIcon="@Icons.Material.Filled.Edit"
                                                                           OnClick="OpenScheduleSiteVisitDialog"
                                                                           Class="mt-2">
                                                                    Reschedule
                                                                </MudButton>
                                                            </Authorized>
                                                        </AuthorizeView>
                                                    }
                                                } else {
                                                    <MudAlert Severity="Severity.Info" Dense="true">
                                                        Site visit date will be displayed once scheduled.
                                                    </MudAlert>
                                                }
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Information Tab -->
                        <MudTabPanel Text="Contact Information" Icon="@Icons.Material.Filled.Contacts">
                            <MudCard Elevation="0">
                                <MudCardContent>
                                    <MudGrid Spacing="4">
                                        <!-- Contact Information -->
                                        <MudItem xs="12">
                                            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; border-left: 4px solid #667eea;">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Large" />
                                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Primary Contact</MudText>
                                                </MudStack>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Name</MudText>
                                                        <MudText Typo="Typo.body1">@reserveStudy.Contact?.FullNameInverted</MudText>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Phone</MudText>
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Primary" />
                                                            <MudLink Href="@($"tel:{reserveStudy.Contact?.Phone}")" Typo="Typo.body1">
                                                                @reserveStudy.Contact?.Phone
                                                            </MudLink>
                                                        </MudStack>
                                                        @if (!string.IsNullOrEmpty(reserveStudy.Contact?.Extension)) {
                                                            <MudText Typo="Typo.caption">Ext: @reserveStudy.Contact?.Extension</MudText>
                                                        }
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Email</MudText>
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                                            <MudLink Href="@($"mailto:{reserveStudy.Contact?.Email}")" Typo="Typo.body1">
                                                                @reserveStudy.Contact?.Email
                                                            </MudLink>
                                                        </MudStack>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                        </MudItem>
                                        <!-- Property Manager Information -->
                                        @if (reserveStudy.PropertyManager != null) {
                                            <MudItem xs="12">
                                                <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; border-left: 4px solid #10b981;">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                                        <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Success" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Management Company</MudText>
                                                    </MudStack>
                                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Company Name</MudText>
                                                    <MudText Typo="Typo.h6" Class="mb-3">@reserveStudy.PropertyManager.CompanyName</MudText>
                                                    <MudGrid Spacing="2">
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Manager Name</MudText>
                                                            <MudText Typo="Typo.body1">@reserveStudy.PropertyManager.FullNameInverted</MudText>
                                                        </MudItem>
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Phone</MudText>
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Success" />
                                                                <MudLink Href="@($"tel:{reserveStudy.PropertyManager?.Phone}")" Typo="Typo.body1">
                                                                    @reserveStudy.PropertyManager?.Phone
                                                                </MudLink>
                                                            </MudStack>
                                                            @if (!string.IsNullOrEmpty(reserveStudy.PropertyManager?.Extension)) {
                                                                <MudText Typo="Typo.caption">Ext: @reserveStudy.PropertyManager?.Extension</MudText>
                                                            }
                                                        </MudItem>
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Email</MudText>
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Success" />
                                                                <MudLink Href="@($"mailto:{reserveStudy.PropertyManager?.Email}")" Typo="Typo.body1">
                                                                    @reserveStudy.PropertyManager?.Email
                                                                </MudLink>
                                                            </MudStack>
                                                        </MudItem>
                                                    </MudGrid>
                                                </MudPaper>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Elements Tab -->
                        <MudTabPanel Text="Property Elements" Icon="@Icons.Material.Filled.Apartment">
                            @if (isElementsLoading) {
                                <MudStack Spacing="4" Class="pa-4">
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" />
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="300px" />
                                </MudStack>
                            } else if (elementsLoaded && GetAllElements().Any()) {
                                <!-- Summary Cards -->
                                <MudGrid Spacing="3" Class="mb-4">
                                    <MudItem xs="6" sm="3">
                                        <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 12px; text-align: center; border-top: 3px solid #667eea;">
                                            <MudIcon Icon="@Icons.Material.Filled.Apartment" Color="Color.Primary" Size="Size.Large" />
                                            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #667eea;">@GetAllElements().Count()</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">Total Elements</MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 12px; text-align: center; border-top: 3px solid #10b981;">
                                            <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Success" Size="Size.Large" />
                                            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #10b981;">@GetAllElements().Count(e => e.ElementType == IReserveStudyElement.ElementTypeEnum.Building)</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">Building</MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 12px; text-align: center; border-top: 3px solid #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.Park" Color="Color.Info" Size="Size.Large" />
                                            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #3b82f6;">@GetAllElements().Count(e => e.ElementType == IReserveStudyElement.ElementTypeEnum.Common)</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">Common Area</MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudPaper Elevation="2" Class="pa-3" Style="border-radius: 12px; text-align: center; border-top: 3px solid #f59e0b;">
                                            <MudIcon Icon="@Icons.Material.Filled.Engineering" Style="color: #f59e0b;" Size="Size.Large" />
                                            <MudText Typo="Typo.h4" Style="font-weight: 700; color: #f59e0b;">@GetAllElements().Count(e => e.NeedsService)</MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">Need Service Info</MudText>
                                        </MudPaper>
                                    </MudItem>
                                </MudGrid>

                                <!-- Elements by Category -->
                                <MudExpansionPanels MultiExpansion="true" Elevation="2" Style="border-radius: 12px;">
                                    @foreach (var group in GetAllElements().GroupBy(e => e.ElementType).OrderBy(g => g.Key)) {
                                        <MudExpansionPanel @key="group.Key" IsInitiallyExpanded="true">
                                            <TitleContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Style="width: 100%;">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudAvatar Size="Size.Small" Style="@GetElementGroupStyle(group.Key)">
                                                            <MudIcon Icon="@GetElementGroupIcon(group.Key)" Size="Size.Small" />
                                                        </MudAvatar>
                                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                            @group.Key.ToString() Elements
                                                        </MudText>
                                                    </MudStack>
                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                                        @group.Count() items
                                                    </MudChip>
                                                </MudStack>
                                            </TitleContent>
                                            <ChildContent>
                                                <MudSimpleTable Dense="true" Hover="true" Style="background: transparent;">
                                                    <thead>
                                                        <tr style="background: #f8f9fa;">
                                                            <th style="width: 40%; padding: 12px 16px; font-weight: 600; color: #374151;">Element Name</th>
                                                            <th style="width: 15%; padding: 12px 16px; font-weight: 600; color: #374151; text-align: center;">Quantity</th>
                                                            <th style="width: 20%; padding: 12px 16px; font-weight: 600; color: #374151; text-align: center;">Service Contact</th>
                                                            <th style="width: 25%; padding: 12px 16px; font-weight: 600; color: #374151; text-align: center;">Remaining Life</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var element in group.OrderBy(e => e.Name)) {
                                                            <tr @key="element.Name"
                                                                style="cursor: pointer; transition: background 0.2s;"
                                                                @onclick="() => ShowElement(element)">
                                                                <td style="padding: 12px 16px;">
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@(element.ShowDetails? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                                                                 Size="Size.Small"
                                                                                 Style="color: #9ca3af;" />
                                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                            @element.Name
                                                                        </MudText>
                                                                    </MudStack>
                                                                </td>
                                                                <td style="padding: 12px 16px; text-align: center;">
                                                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Default">
                                                                        @element.Count
                                                                    </MudChip>
                                                                </td>
                                                                <td style="padding: 12px 16px; text-align: center;">
                                                                    @if (element.NeedsService) {
                                                                        @if (HasValidServiceContact(element.ServiceContact)) {
                                                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                                                Provided
                                                                            </MudChip>
                                                                        } else {
                                                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">
                                                                                Required
                                                                            </MudChip>
                                                                        }
                                                                    } else {
                                                                        <MudText Typo="Typo.caption" Style="color: #9ca3af;">—</MudText>
                                                                    }
                                                                </td>
                                                                <td style="padding: 12px 16px; text-align: center;">
                                                                    @if (element.RemainingLifeOption != null) {
                                                                        <MudChip T="string" Size="Size.Small"
                                                                                 Color="@GetRemainingLifeColor(element.RemainingLifeOption.DisplayText)"
                                                                                 Variant="Variant.Filled">
                                                                            @element.RemainingLifeOption.DisplayText
                                                                        </MudChip>
                                                                    } else {
                                                                        <MudText Typo="Typo.caption" Style="color: #9ca3af;">Not set</MudText>
                                                                    }
                                                                </td>
                                                            </tr>
                                                            @if (element.ShowDetails) {
                                                                <tr>
                                                                    <td colspan="4" style="padding: 0; background: #f8fafc;">
                                                                        <MudPaper Elevation="0" Class="pa-4 ma-2" Style="background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                                                            <MudGrid Spacing="3">
                                                                                <MudItem xs="12" sm="6" md="3">
                                                                                    <MudStack Spacing="1">
                                                                                        <MudText Typo="Typo.caption" Style="color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                            Measurement Type
                                                                                        </MudText>
                                                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                                            @(element.MeasurementOption?.DisplayText ?? "Not specified")
                                                                                        </MudText>
                                                                                    </MudStack>
                                                                                </MudItem>
                                                                                <MudItem xs="12" sm="6" md="3">
                                                                                    <MudStack Spacing="1">
                                                                                        <MudText Typo="Typo.caption" Style="color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                            Last Replaced
                                                                                        </MudText>
                                                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                                            @(element.LastServiced?.ToString("MMM dd, yyyy") ?? "Unknown")
                                                                                        </MudText>
                                                                                    </MudStack>
                                                                                </MudItem>
                                                                                <MudItem xs="12" sm="6" md="3">
                                                                                    <MudStack Spacing="1">
                                                                                        <MudText Typo="Typo.caption" Style="color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                            Useful Life
                                                                                        </MudText>
                                                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                                            @(element.UsefulLifeOption?.DisplayText ?? "Not specified")
                                                                                        </MudText>
                                                                                    </MudStack>
                                                                                </MudItem>
                                                                                <MudItem xs="12" sm="6" md="3">
                                                                                    <MudStack Spacing="1">
                                                                                        <MudText Typo="Typo.caption" Style="color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                                                                            Remaining Life
                                                                                        </MudText>
                                                                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                                                            @(element.RemainingLifeOption?.DisplayText ?? "Not specified")
                                                                                        </MudText>
                                                                                    </MudStack>
                                                                                </MudItem>
                                                                            </MudGrid>
                                                                        </MudPaper>
                                                                    </td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </MudSimpleTable>
                                            </ChildContent>
                                        </MudExpansionPanel>
                                    }
                                </MudExpansionPanels>
                            } else if (!elementsLoaded) {
                                <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; background: #f8f9fa; border-radius: 12px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Large" Style="color: #9ca3af;" />
                                    <MudText Typo="Typo.body1" Class="mt-2" Style="color: #6b7280;">
                                        Property elements will load when this tab is selected.
                                    </MudText>
                                </MudPaper>
                            } else {
                                <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; background: #fef3c7; border-radius: 12px; border: 1px dashed #f59e0b;">
                                    <MudIcon Icon="@Icons.Material.Outlined.Info" Size="Size.Large" Style="color: #f59e0b;" />
                                    <MudText Typo="Typo.h6" Class="mt-2" Style="color: #92400e; font-weight: 600;">
                                        No Elements Found
                                    </MudText>
                                    <MudText Typo="Typo.body2" Style="color: #a16207;">
                                        Property elements haven't been added to this reserve study yet.
                                    </MudText>
                                </MudPaper>
                            }
                        </MudTabPanel>
                        <!-- Service Contacts Tab -->
                        <MudTabPanel Text="Service Contacts" Icon="@Icons.Material.Filled.ContactPhone">
                            @if (isContactsLoading) {
                                <MudStack Spacing="4" Class="pa-4">
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="80px" />
                                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="200px" />
                                </MudStack>
                            } else if (serviceContactsLoaded && elementsWithServiceContact.Any()) {
                                var providedCount = elementsWithServiceContact.Count(e => HasValidServiceContact(e.ServiceContact));
                                var missingCount = elementsWithServiceContact.Count(e => !HasValidServiceContact(e.ServiceContact));
                                var serviceContactStatus = GetCurrentStatus();
                                // HOA can edit contacts from ProposalAccepted until SiteVisitCompleted
                                var canHOAEditContacts = serviceContactStatus >= StudyStatus.ProposalAccepted &&
                                serviceContactStatus < StudyStatus.SiteVisitCompleted;
                                var canAnyoneEdit = canEdit || canStaffEdit || canHOAEditContacts;

                                <!-- Summary Header -->
                                <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                            <MudAvatar Size="Size.Large" Style="background: rgba(255,255,255,0.2);">
                                                <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Style="color: white;" />
                                            </MudAvatar>
                                            <div>
                                                <MudText Typo="Typo.h5" Style="color: white; font-weight: 700;">
                                                    @elementsWithServiceContact.Count Service Contacts
                                                </MudText>
                                                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.8);">
                                                    @providedCount provided, @missingCount pending
                                                </MudText>
                                            </div>
                                        </MudStack>
                                        <MudStack Row="true" Spacing="2">
                                            <MudChip T="string" Size="Size.Small" Style="background: rgba(255,255,255,0.2); color: white; font-weight: 600;" Variant="Variant.Outlined">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                                @providedCount Complete
                                            </MudChip>
                                            @if (missingCount > 0) {
                                                <MudChip T="string" Size="Size.Small" Style="background: #f59e0b; color: white;">
                                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                                    @missingCount Missing
                                                </MudChip>
                                            }
                                        </MudStack>
                                    </MudStack>
                                </MudPaper>

                                <!-- Action Banner when contacts are missing -->
                                @if (missingCount > 0) {
                                    @if (canHOAEditContacts || canStaffEdit) {
                                        <!-- User can edit - show action required banner -->
                                        <MudAlert Severity="Severity.Warning" Class="mb-4" Elevation="2" Style="border-radius: 12px;">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                <MudStack Spacing="1">
                                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                        Action Required: Provide Service Contact Information
                                                    </MudText>
                                                    <MudText Typo="Typo.body2">
                                                        @missingCount element(s) require service contact details. Please provide vendor/contractor information for maintenance purposes.
                                                    </MudText>
                                                </MudStack>
                                                <MudButton Variant="Variant.Filled"
                                                           Color="Color.Warning"
                                                           StartIcon="@Icons.Material.Filled.Edit"
                                                           Href="@($"/ReserveStudies/Edit/{Id}?tab=3")">
                                                    Add Service Contacts
                                                </MudButton>
                                            </MudStack>
                                        </MudAlert>
                                    } else if (serviceContactStatus < StudyStatus.ProposalAccepted) {
                                        <!-- Before proposal accepted - show info message -->
                                        <MudAlert Severity="Severity.Info" Class="mb-4" Elevation="1" Style="border-radius: 12px;">
                                            <MudText Typo="Typo.body2" Style="color: #6b7280;">
                                                Service contact information will be requested after the proposal is accepted.
                                            </MudText>
                                        </MudAlert>
                                    } else {
                                        <!-- After site visit completed - read only for HOA -->
                                        <MudAlert Severity="Severity.Info" Class="mb-4" Elevation="1" Style="border-radius: 12px;">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                <MudText Typo="Typo.body2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                                                    @missingCount service contact(s) are still pending. Please contact your specialist if you need to make changes.
                                                </MudText>
                                                @if (canStaffEdit) {
                                                    <MudButton Variant="Variant.Text"
                                                               Color="Color.Primary"
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Edit"
                                                               Href="@($"/ReserveStudies/Edit/{Id}?tab=3")">
                                                        Edit Contacts
                                                    </MudButton>
                                                }
                                            </MudStack>
                                        </MudAlert>
                                    }
                                } else {
                                    <!-- All contacts provided -->
                                    <MudAlert Severity="Severity.Success" Class="mb-4" Elevation="1" Style="border-radius: 12px;">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" />
                                                <MudText Typo="Typo.body2">
                                                    All service contact information has been provided.
                                                </MudText>
                                            </MudStack>
                                            @if (canAnyoneEdit) {
                                                <MudButton Variant="Variant.Text"
                                                           Color="Color.Primary"
                                                           Size="Size.Small"
                                                           StartIcon="@Icons.Material.Filled.Edit"
                                                           Href="@($"/ReserveStudies/Edit/{Id}?tab=3")">
                                                    Edit Contacts
                                                </MudButton>
                                            }
                                        </MudStack>
                                    </MudAlert>
                                }

                                <!-- Contact Cards -->
                                <MudGrid Spacing="3">
                                    @foreach (var element in elementsWithServiceContact.OrderBy(e => HasValidServiceContact(e.ServiceContact) ? 1 : 0).ThenBy(e => e.Name)) {
                                        <MudItem xs="12" md="6">
                                            <MudCard Elevation="2" Style="@($"border-radius: 12px; border-left: 4px solid {(HasValidServiceContact(element.ServiceContact) ? "#10b981" : "#f59e0b")}; height: 100%;")">
                                                <MudCardContent>
                                                    <!-- Element Header -->
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                            <MudAvatar Size="Size.Small" Style="@GetElementGroupStyle(element.ElementType)">
                                                                <MudIcon Icon="@GetElementGroupIcon(element.ElementType)" Size="Size.Small" />
                                                            </MudAvatar>
                                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                                @element.Name
                                                            </MudText>
                                                        </MudStack>
                                                        @if (HasValidServiceContact(element.ServiceContact)) {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                                Provided
                                                            </MudChip>
                                                        } else {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">
                                                                Missing
                                                            </MudChip>
                                                        }
                                                    </MudStack>

                                                    @if (HasValidServiceContact(element.ServiceContact)) {
                                                        <!-- Contact Details -->
                                                        <MudPaper Elevation="0" Class="pa-3" Style="background: #f8f9fa; border-radius: 8px;">
                                                            <MudStack Spacing="2">
                                                                @if (!string.IsNullOrWhiteSpace(element.ServiceContact!.CompanyName)) {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Style="color: #6b7280;" />
                                                                        <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                                            @element.ServiceContact.CompanyName
                                                                        </MudText>
                                                                    </MudStack>
                                                                }

                                                                @if (!string.IsNullOrWhiteSpace(element.ServiceContact!.FirstName) || !string.IsNullOrWhiteSpace(element.ServiceContact.LastName)) {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Style="color: #6b7280;" />
                                                                        <MudText Typo="Typo.body2">
                                                                            @element.ServiceContact.FullNameInverted
                                                                        </MudText>
                                                                    </MudStack>
                                                                }

                                                                <MudDivider Class="my-1" />

                                                                @if (!string.IsNullOrWhiteSpace(element.ServiceContact!.Phone)) {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Primary" />
                                                                        <MudLink Href="@($"tel:{element.ServiceContact.Phone}")" Typo="Typo.body2">
                                                                            @element.ServiceContact.Phone
                                                                            @if (!string.IsNullOrWhiteSpace(element.ServiceContact.Extension)) {
                                                                                <span style="color: #9ca3af;"> ext. @element.ServiceContact.Extension</span>
                                                                            }
                                                                        </MudLink>
                                                                    </MudStack>
                                                                } else {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Style="color: #d1d5db;" />
                                                                        <MudText Typo="Typo.body2" Style="color: #9ca3af; font-style: italic;">
                                                                            No phone provided
                                                                        </MudText>
                                                                    </MudStack>
                                                                }

                                                                @if (!string.IsNullOrWhiteSpace(element.ServiceContact!.Email)) {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                                                        <MudLink Href="@($"mailto:{element.ServiceContact.Email}")" Typo="Typo.body2">
                                                                            @element.ServiceContact.Email
                                                                        </MudLink>
                                                                    </MudStack>
                                                                } else {
                                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Style="color: #d1d5db;" />
                                                                        <MudText Typo="Typo.body2" Style="color: #9ca3af; font-style: italic;">
                                                                            No email provided
                                                                        </MudText>
                                                                    </MudStack>
                                                                }
                                                            </MudStack>
                                                        </MudPaper>
                                                    } else {
                                                        <!-- Missing Contact Placeholder with action -->
                                                        <MudPaper Elevation="0" Class="pa-4" Style="background: #fef3c7; border-radius: 8px; text-align: center; border: 1px dashed #f59e0b;">
                                                            <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Large" Style="color: #f59e0b;" />
                                                            <MudText Typo="Typo.body2" Class="mt-2" Style="color: #92400e;">
                                                                Service contact information has not been provided for this element.
                                                            </MudText>
                                                            @if (canHOAEditContacts || canStaffEdit) {
                                                                <MudButton Variant="Variant.Text"
                                                                           Color="Color.Warning"
                                                                           Size="Size.Small"
                                                                           StartIcon="@Icons.Material.Filled.Add"
                                                                           Href="@($"/ReserveStudies/Edit/{Id}?tab=3")"
                                                                           Class="mt-2">
                                                                    Add Contact
                                                                </MudButton>
                                                            }
                                                        </MudPaper>
                                                    }
                                                </MudCardContent>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            } else if (!serviceContactsLoaded) {
                                <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; background: #f8f9fa; border-radius: 12px;">
                                    <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Large" Style="color: #9ca3af;" />
                                    <MudText Typo="Typo.body1" Class="mt-2" Style="color: #6b7280;">
                                        Service contacts will load when this tab is selected.
                                    </MudText>
                                </MudPaper>
                            } else {
                                <MudPaper Elevation="0" Class="pa-8" Style="text-align: center; background: #f0f9ff; border-radius: 12px; border: 1px dashed #3b82f6;">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Style="color: #3b82f6;" />
                                    <MudText Typo="Typo.h6" Class="mt-2" Style="color: #1e40af; font-weight: 600;">
                                        No Service Contacts Required
                                    </MudText>
                                    <MudText Typo="Typo.body2" Style="color: #3b82f6;">
                                        None of the property elements require service contact information.
                                    </MudText>
                                </MudPaper>
                            }
                        </MudTabPanel>
                        <!-- Site Visit Photos Tab -->
                        <MudTabPanel Text="Site Photos" Icon="@Icons.Material.Filled.PhotoCamera">
                            <SiteVisitPhotoGallery ReserveStudyId="@Id" CanEdit="@canEditPhotos" />
                        </MudTabPanel>
                        <!-- Study Notes Tab -->
                        <MudTabPanel Text="Notes" Icon="@Icons.Material.Filled.Notes">
                            <CRS.Components.Shared.StudyNotes.StudyNotesPanel ReserveStudyId="@Id" />
                        </MudTabPanel>
                        <!-- Generated Reports Tab -->
                        <MudTabPanel Text="Reports" Icon="@Icons.Material.Filled.Description">
                            <CRS.Components.Shared.GeneratedReports.GeneratedReportsPanel ReserveStudyId="@Id" />
                        </MudTabPanel>
                        <!-- Invoicing Tab -->
                        <MudTabPanel Text="Invoicing" Icon="@Icons.Material.Filled.Receipt">
                            <AuthorizeView Policy="RequireTenantStaff">
                                <Authorized>
                                    <CRS.Components.Shared.Invoices.InvoicePanel ReserveStudyId="@Id"
                                                                                 CommunityName="@reserveStudy?.Community?.Name" />
                                </Authorized>
                                <NotAuthorized>
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                        <MudText Typo="Typo.body2">
                                            Invoicing is managed by your reserve study specialist. You will receive invoices via email.
                                        </MudText>
                                    </MudAlert>
                                </NotAuthorized>
                            </AuthorizeView>
                        </MudTabPanel>
                        <!-- Narrative Tab -->
                        <MudTabPanel Text="Narrative" Icon="@Icons.Material.Filled.Article">
                            <AuthorizeView Policy="RequireTenantStaff">
                                <Authorized>
                                    <CRS.Components.Shared.Narrative.NarrativeEditorPanel ReserveStudyId="@Id" />
                                </Authorized>
                                <NotAuthorized>
                                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                        <MudText Typo="Typo.body2">
                                            The narrative content is managed by your reserve study specialist.
                                        </MudText>
                                    </MudAlert>
                                </NotAuthorized>
                            </AuthorizeView>
                        </MudTabPanel>
                        <!-- Proposal Acceptance Tab -->
                        <MudTabPanel Text="Acceptance" Icon="@Icons.Material.Filled.Verified">
                            <MudStack Spacing="4">
                                @* Amendment pending/approved notification for this tab *@
                                @if (GetCurrentStatus() == StudyStatus.AmendmentApproved) {
                                    <MudAlert Severity="Severity.Warning" Elevation="2" Style="border-radius: 12px;">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                Amendment Requires Acceptance
                                            </MudText>
                                            <MudText Typo="Typo.body2">
                                                The site visit revealed scope changes that affect the original proposal. Please review the amendment details and accept to continue with your reserve study.
                                            </MudText>
                                        </MudStack>
                                    </MudAlert>
                                }

                                <CRS.Components.Shared.ProposalAcceptance.AcceptanceConfirmationPanel @ref="acceptancePanel"
                                                                                                      ReserveStudyId="@Id" />

                                @* Original proposal acceptance *@
                                @if (reserveStudy?.CurrentStatus >= StudyStatus.ProposalSent &&
                                                            reserveStudy?.CurrentStatus < StudyStatus.ProposalAccepted &&
                                                            !hasValidAcceptance) {
                                    <AuthorizeView Policy="RequireHOAUser">
                                        <Authorized>
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Success"
                                                       Size="Size.Large"
                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                       OnClick="OpenAcceptProposalDialog"
                                                       FullWidth="true">
                                                Accept Proposal
                                            </MudButton>
                                        </Authorized>
                                    </AuthorizeView>
                                }

                                @* Amendment acceptance *@
                                @if (GetCurrentStatus() == StudyStatus.AmendmentApproved) {
                                    <AuthorizeView Policy="RequireHOAUser">
                                        <Authorized>
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Success"
                                                       Size="Size.Large"
                                                       StartIcon="@Icons.Material.Filled.CheckCircle"
                                                       OnClick="OpenAcceptProposalDialog"
                                                       FullWidth="true">
                                                Review & Accept Amendment
                                            </MudButton>
                                        </Authorized>
                                    </AuthorizeView>
                                }
                            </MudStack>
                        </MudTabPanel>
                        <!-- Scope Comparison Tab -->
                        <MudTabPanel Text="Scope" Icon="@Icons.Material.Filled.CompareArrows">
                            <CRS.Components.Shared.ScopeComparison.ScopeVariancePanel @ref="scopeVariancePanel" ReserveStudyId="@Id" TenantId="@(reserveStudy?.TenantId ?? 0)" />
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
            </MudGrid>
        </MudContainer>
    }
</MudContainer>
@code {
    [Parameter]
    public Guid Id { get; set; }

    private ReserveStudy? reserveStudy;
    private bool isLoading = true;
    private bool isElementsLoading = false;
    private bool isContactsLoading = false;
    private bool elementsLoaded = false;
    private bool serviceContactsLoaded = false;
    private bool canEdit = false;
    private bool canStaffEdit = false;
    private bool canEditPhotos = false;
    private List<IReserveStudyElement> elementsWithServiceContact = new();
    private int activeTabIndex = 0;

    private CRS.Components.Shared.ProposalAcceptance.AcceptanceConfirmationPanel? acceptancePanel;
    private CRS.Components.Shared.ScopeComparison.ScopeVariancePanel? scopeVariancePanel;
    private bool hasValidAcceptance = false;
    private ScopeComparison? scopeComparison;
    private bool hasUnresolvedScopeVariance = false;

    private List<StudyStatus> allowedNextStudy = new();
    private List<StudyStatusHistory> statusHistory = new();
    private readonly List<TimelineItemInfo> timelineItems = new();

    private static readonly StudyStatus[] WorkflowStatusOrder = new[] {
        StudyStatus.RequestCreated, StudyStatus.RequestApproved, StudyStatus.ProposalCreated,
        StudyStatus.ProposalReviewed, StudyStatus.ProposalUpdated, StudyStatus.ProposalApproved,
        StudyStatus.ProposalSent, StudyStatus.ProposalDeclined, StudyStatus.ProposalAccepted, StudyStatus.ServiceContactsRequested,
        StudyStatus.FinancialInfoRequested, StudyStatus.FinancialInfoInProgress, StudyStatus.FinancialInfoSubmitted,
        StudyStatus.FinancialInfoReviewed, StudyStatus.FinancialInfoReceived, StudyStatus.SiteVisitPending,
        StudyStatus.SiteVisitScheduled, StudyStatus.SiteVisitCompleted, StudyStatus.SiteVisitDataEntered,
        // Amendment statuses (branched from SiteVisitDataEntered when scope variance detected)
        StudyStatus.AmendmentPending, StudyStatus.AmendmentApproved,
        StudyStatus.FundingPlanReady, StudyStatus.FundingPlanInProcess, StudyStatus.FundingPlanComplete,
        StudyStatus.NarrativeReady, StudyStatus.NarrativeInProcess, StudyStatus.NarrativeComplete,
        StudyStatus.NarrativePrintReady, StudyStatus.NarrativePackaged, StudyStatus.NarrativeSent,
        StudyStatus.ReportReady, StudyStatus.ReportInProcess, StudyStatus.ReportComplete,
        StudyStatus.RequestCompleted, StudyStatus.RequestCancelled, StudyStatus.RequestArchived
    };

    private static readonly StudyStatus[] KeyMilestones = new[] {
        StudyStatus.RequestCreated, StudyStatus.ProposalApproved, StudyStatus.ProposalSent,
        StudyStatus.ProposalAccepted, StudyStatus.FinancialInfoSubmitted, StudyStatus.SiteVisitCompleted,
        StudyStatus.ReportComplete, StudyStatus.RequestCompleted
    };

    private static readonly Dictionary<StudyStatus, int> StatusRank =
        WorkflowStatusOrder.Select((s, idx) => new { s, idx }).ToDictionary(x => x.s, x => x.idx);

    protected override async Task OnInitializedAsync() {
        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
        await CheckAcceptanceStatus();
        await CheckScopeVarianceAsync();
    }

    private async Task CheckAcceptanceStatus() {
        try { hasValidAcceptance = await AcceptanceService.HasValidAcceptanceAsync(Id); } catch { hasValidAcceptance = false; }
    }

    private async Task CheckScopeVarianceAsync() {
        try {
            scopeComparison = await ScopeComparisonService.GetByStudyIdAsync(Id);
            // Has unresolved variance if comparison exists, exceeds threshold, and is not resolved
            hasUnresolvedScopeVariance = scopeComparison != null &&
                scopeComparison.Status == ScopeComparisonStatus.ExceedsThreshold;
        } catch {
            scopeComparison = null;
            hasUnresolvedScopeVariance = false;
        }
    }

    private async Task OpenAcceptProposalDialog() {
        if (reserveStudy == null) return;
        var parameters = new DialogParameters { ["ReserveStudy"] = reserveStudy, ["ProposalId"] = reserveStudy.CurrentProposal?.Id };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CRS.Components.Shared.ProposalAcceptance.ProposalAcceptanceDialog>("Accept Proposal", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled) {
            hasValidAcceptance = true;
            var isAmendment = reserveStudy.CurrentProposal?.IsAmendment ?? false;
            if (allowedNextStudy.Contains(StudyStatus.ProposalAccepted)) {
                if (isAmendment) {
                    var currentUser = UserState.CurrentUser?.UserName ?? "Unknown";
                    var success = await WorkflowService.AcceptProposalAmendmentAsync(Id, currentUser);
                    Snackbar.Add(success ? "Amendment accepted!" : "Amendment accepted, but workflow transition failed.", success ? Severity.Success : Severity.Warning);
                } else {
                    await ApplyTransition(StudyStatus.ProposalAccepted);

                    // Check tenant settings to determine next step
                    await using var db = await DbFactory.CreateDbContextAsync();
                    var tenant = await db.Tenants.AsNoTracking().FirstOrDefaultAsync(t => t.Id == reserveStudy.TenantId);

                    if (tenant?.SkipFinancialInfoStep == true) {
                        // Skip financial info and go directly to site visit
                        Snackbar.Add("Proposal accepted! Financial info step skipped per tenant settings.", Severity.Success);
                    } else if (tenant?.AutoRequestFinancialInfo == true) {
                        // Auto-request financial info (default behavior)
                        await RequestFinancialInfoAsync(Id);
                        Snackbar.Add("Proposal accepted! Financial information request sent.", Severity.Success);
                    } else {
                        // Manual financial info request - just notify acceptance
                        Snackbar.Add("Proposal accepted! Financial information will need to be requested manually.", Severity.Success);
                    }
                }
            } else {
                Snackbar.Add("Proposal accepted successfully!", Severity.Success);
            }
            await ReloadAfterChange();
            if (acceptancePanel != null) await acceptancePanel.RefreshAsync();
            if (scopeVariancePanel != null) await scopeVariancePanel.RefreshAsync();
        }
    }

    private async Task OpenDeclineProposalDialog() {
        if (reserveStudy == null) return;
        var parameters = new DialogParameters { 
            ["ReserveStudy"] = reserveStudy, 
            ["ProposalId"] = reserveStudy.CurrentProposal?.Id 
        };
        var options = new DialogOptions { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };
        var dialog = await DialogService.ShowAsync<CRS.Components.Shared.ProposalAcceptance.ProposalDeclineDialog>(
            "Decline Proposal", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled) {
            Snackbar.Add("Proposal declined. The specialist has been notified.", Severity.Info);
            await ReloadAfterChange();
        }
    }

    private async Task CreateRevisionProposalAsync() {
        if (reserveStudy?.CurrentProposal == null) return;

        try {
            var currentUser = UserState.CurrentUser?.UserName ?? "System";
            var revision = await WorkflowService.CreateRevisionProposalAsync(reserveStudy.CurrentProposalId!.Value, currentUser);

            if (revision != null) {
                Snackbar.Add("Revised proposal created. You can now edit the proposal details.", Severity.Success);
                await ReloadAfterChange();
            } else {
                Snackbar.Add("Failed to create revised proposal. Please try again.", Severity.Error);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error creating revision: {ex.Message}", Severity.Error);
        }
    }

    private static string GetDeclineReasonText(ProposalDeclineReason? reason) {
        return reason switch {
            ProposalDeclineReason.PriceTooHigh => "Price is above budget",
            ProposalDeclineReason.ScopeInadequate => "Scope doesn't meet requirements",
            ProposalDeclineReason.TimelineUnacceptable => "Timeline doesn't work",
            ProposalDeclineReason.PaymentTermsUnacceptable => "Payment terms not acceptable",
            ProposalDeclineReason.ChoseCompetitor => "Chose a different company",
            ProposalDeclineReason.ProjectCancelled => "Project cancelled or no longer needed",
            ProposalDeclineReason.BudgetConstraints => "Budget constraints / funding issues",
            ProposalDeclineReason.Other => "Other reason (see comments)",
            _ => "Not specified"
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        try {
            if (activeTabIndex == 2) await LoadElementsDataIfNeeded();
            else if (activeTabIndex == 3) await LoadServiceContactsIfNeeded();
        } catch { }
    }

    private void InitializeTimelineItems() {
        timelineItems.Clear();
        var historyByStatus = statusHistory.GroupBy(h => h.ToStatus)
            .ToDictionary(g => g.Key, g => new { First = g.OrderBy(x => x.ChangedAt).First(), Last = g.OrderBy(x => x.ChangedAt).Last() });
        foreach (var status in KeyMilestones) {
            if (timelineItems.Any(t => t.Status == status)) continue;
            var hasHist = historyByStatus.TryGetValue(status, out var hist);
            DateTime? date = hasHist ? hist!.First.ChangedAt.LocalDateTime : GetFallbackDate(status);
            timelineItems.Add(new TimelineItemInfo { Status = status, DateValue = date, Title = FormatStatusTitle(status) });
        }
    }

    private DateTime? GetFallbackDate(StudyStatus status) => status switch {
        StudyStatus.RequestCreated => reserveStudy?.DateCreated,
        StudyStatus.ProposalSent => reserveStudy?.CurrentProposal?.DateSent,
        StudyStatus.FinancialInfoSubmitted => reserveStudy?.FinancialInfo?.DateSubmitted,
        _ => null
    };

    private static string FormatStatusTitle(StudyStatus status) {
        var name = Enum.GetName(typeof(StudyStatus), status) ?? status.ToString();
        return System.Text.RegularExpressions.Regex.Replace(name, "(?<=[a-z])([A-Z])", " $1").Trim();
    }

    private async Task LoadInitialData() {
        try {
            isLoading = true;
            await UserState.InitializeAsync();
            using var context = await DbFactory.CreateDbContextAsync();
            reserveStudy = await context.ReserveStudies.AsNoTracking()
                .Include(rs => rs.Community).ThenInclude(c => c.PhysicalAddress)
                .Include(rs => rs.Contact).Include(rs => rs.PropertyManager).Include(rs => rs.Specialist)
                .Include(rs => rs.CurrentProposal).Include(rs => rs.FinancialInfo).Include(rs => rs.StudyRequest)
                .AsSplitQuery().FirstOrDefaultAsync(rs => rs.Id == Id);
            if (reserveStudy == null) return;

            var isHOAUser = UserState.UserRoles?.Any(r => r == "HOAUser" || r == "HOAAuditor") ?? false;
            var isStaff = UserState.UserRoles?.Any(r => r == "TenantOwner" || r == "TenantSpecialist" || r == "TenantViewer" || r == "PlatformAdmin") ?? false;
            var isOwnerOrRequested = reserveStudy.ApplicationUserId == UserState.CurrentUser?.Id || reserveStudy.RequestedByUserId == UserState.CurrentUser?.Id;
            if (isHOAUser && !isStaff && !isOwnerOrRequested) {
                Snackbar.Add("You don't have permission to view this reserve study.", Severity.Error);
                reserveStudy = null; return;
            }

            statusHistory = await context.StudyStatusHistories.AsNoTracking().Where(h => h.RequestId == Id).OrderBy(h => h.ChangedAt).ToListAsync();
            canEdit = ReserveStudyService.CanUpdateReserveStudy(reserveStudy) && isOwnerOrRequested;
            canStaffEdit = isStaff && ReserveStudyService.CanStaffUpdateReserveStudy(reserveStudy);
            canEditPhotos = isStaff;
        } catch (Exception ex) { Snackbar.Add($"Error loading: {ex.Message}", Severity.Error); } finally { isLoading = false; }
    }

    private async Task LoadElementsDataIfNeeded() {
        if (elementsLoaded || isElementsLoading || reserveStudy == null) return;
        try {
            isElementsLoading = true;
            using var context = await DbFactory.CreateDbContextAsync();
            var building = await context.ReserveStudyBuildingElements.AsNoTracking().Where(be => be.ReserveStudyId == Id)
                .Include(be => be.BuildingElement).Include(be => be.MeasurementOption).Include(be => be.UsefulLifeOption).Include(be => be.RemainingLifeOption).Include(be => be.ServiceContact).ToListAsync();
            var common = await context.ReserveStudyCommonElements.AsNoTracking().Where(ce => ce.ReserveStudyId == Id)
                .Include(ce => ce.CommonElement).Include(ce => ce.MeasurementOption).Include(ce => ce.UsefulLifeOption).Include(ce => ce.RemainingLifeOption).Include(ce => ce.ServiceContact).ToListAsync();
            var additional = await context.ReserveStudyAdditionalElements.AsNoTracking().Where(ae => ae.ReserveStudyId == Id)
                .Include(ae => ae.MeasurementOption).Include(ae => ae.UsefulLifeOption).Include(ae => ae.RemainingLifeOption).Include(ae => ae.ServiceContact).ToListAsync();
            reserveStudy.ReserveStudyBuildingElements = building;
            reserveStudy.ReserveStudyCommonElements = common;
            reserveStudy.ReserveStudyAdditionalElements = additional;
            elementsLoaded = true;
        } catch (Exception ex) { Snackbar.Add($"Error loading elements: {ex.Message}", Severity.Error); } finally { isElementsLoading = false; StateHasChanged(); }
    }

    private async Task LoadServiceContactsIfNeeded() {
        if (serviceContactsLoaded || isContactsLoading || reserveStudy == null) return;
        try {
            isContactsLoading = true;
            if (!elementsLoaded) await LoadElementsDataIfNeeded();
            using var context = await DbFactory.CreateDbContextAsync();
            var buildingContacts = await context.ReserveStudyBuildingElements.AsNoTracking().Where(be => be.ReserveStudyId == Id).Include(be => be.BuildingElement).Include(be => be.ServiceContact).ToListAsync();
            var commonContacts = await context.ReserveStudyCommonElements.AsNoTracking().Where(ce => ce.ReserveStudyId == Id).Include(ce => ce.CommonElement).Include(ce => ce.ServiceContact).ToListAsync();
            var additionalContacts = await context.ReserveStudyAdditionalElements.AsNoTracking().Where(ae => ae.ReserveStudyId == Id).Include(ae => ae.ServiceContact).ToListAsync();
            foreach (var e in buildingContacts.Where(e => e.NeedsService)) { var m = reserveStudy.ReserveStudyBuildingElements?.FirstOrDefault(x => x.Id == e.Id); if (m != null) m.ServiceContact = e.ServiceContact; }
            foreach (var e in commonContacts.Where(e => e.NeedsService)) { var m = reserveStudy.ReserveStudyCommonElements?.FirstOrDefault(x => x.Id == e.Id); if (m != null) m.ServiceContact = e.ServiceContact; }
            foreach (var e in additionalContacts.Where(e => e.NeedsService)) { var m = reserveStudy.ReserveStudyAdditionalElements?.FirstOrDefault(x => x.Id == e.Id); if (m != null) m.ServiceContact = e.ServiceContact; }
            elementsWithServiceContact = GetAllElements().Where(e => e.NeedsService).ToList();
            serviceContactsLoaded = true;
        } catch (Exception ex) { Snackbar.Add($"Error loading service contacts: {ex.Message}", Severity.Error); } finally { isContactsLoading = false; StateHasChanged(); }
    }

    private void HandleTabChange(int index) {
        activeTabIndex = index;
        if (index == 2) _ = LoadElementsDataIfNeeded();
        else if (index == 3) _ = LoadServiceContactsIfNeeded();
    }

    private void NavigateToReportsTab() {
        activeTabIndex = 6; // Reports tab index
        StateHasChanged();
    }

    private void NavigateToNarrativeTab() {
        activeTabIndex = 8; // Narrative tab index
        StateHasChanged();
    }

    private void NavigateToScopeTab() {
        activeTabIndex = 10; // Scope comparison tab index
        StateHasChanged();
    }

    private async Task SendRequestLink() => await ExecuteActionAsync(async () => { await _dispatcher.Broadcast(new ReserveStudyCreatedEvent(reserveStudy)); return true; }, "Request link sent!", "Failed");
    private async Task SendAccessTokenLink() => await ExecuteActionAsync(async () => true, "Request link sent!", "Failed");
    private void ShowElement(IReserveStudyElement element) => element.ShowDetails = !element.ShowDetails;
    private IEnumerable<IReserveStudyElement> GetAllElements() => (reserveStudy?.ReserveStudyBuildingElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>())
        .Concat(reserveStudy?.ReserveStudyCommonElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>())
        .Concat(reserveStudy?.ReserveStudyAdditionalElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>());

    private async Task<bool> ExecuteActionAsync(Func<Task<bool>> action, string successMessage, string failureMessage) {
        try { var result = await action(); Snackbar.Add(result ? successMessage : failureMessage, result ? Severity.Success : Severity.Error); return result; } catch (Exception ex) { Snackbar.Add($"Error: {ex.Message}", Severity.Error); return false; }
    }

    private async Task RequestFinancialInfoAsync(Guid studyId) => await ExecuteActionAsync(async () => await WorkflowService.RequestFinancialInfoAsync(studyId), "Financial info requested", "Failed");

    private async Task RequestMoreFinancialInfoAsync() {
        var confirmed = await DialogService.ShowMessageBox("Request More Financial Information",
            "This will request additional financial information from the client.", yesText: "Yes, Request More Info", cancelText: "Cancel");
        if (confirmed != true) return;
        var success = await ExecuteActionAsync(async () => await WorkflowService.RequestFinancialInfoAsync(Id), "Financial info request sent.", "Failed");
        if (success) await ReloadAfterChange();
    }

    private async Task CompleteReserveStudyAsync(Guid studyId) { var success = await ExecuteActionAsync(async () => await WorkflowService.CompleteReserveStudyAsync(studyId), "Study completed", "Failed"); if (success) await ReloadAfterChange(); }

    private async Task CompleteFinalReviewAsync(Guid studyId) {
        var confirmed = await DialogService.ShowMessageBox("Complete Final Review",
            "This will mark the final review as complete and finalize the study.", yesText: "Complete Review", cancelText: "Cancel");
        if (confirmed != true) return;
        var currentUser = UserState.CurrentUser?.UserName ?? "Unknown";
        var success = await ExecuteActionAsync(async () => await WorkflowService.CompleteFinalReviewAsync(studyId, currentUser), "Final review completed. Study is now complete!", "Failed");
        if (success) await ReloadAfterChange();
    }

    private async Task SendProposalAsync(Guid studyId) {
        if (reserveStudy?.CurrentProposal == null) NavigationManager.NavigateTo($"/ReserveStudies/Proposal/{studyId}");
        else await ApplyTransition(StudyStatus.ProposalSent);
    }

    private async Task LoadAllowedTransitions() {
        try { allowedNextStudy = (await WorkflowService.GetAllowedStudyTransitionsAsync(Id)).ToList(); } catch { allowedNextStudy.Clear(); }
        InitializeTimelineItems(); StateHasChanged();
    }

    private async Task ApplyTransition(StudyStatus status) {
        var ok = await WorkflowService.TryTransitionStudyAsync(Id, status);
        Snackbar.Add(ok ? $"Transitioned to {FormatStatusTitle(status)}" : $"Transition to {FormatStatusTitle(status)} not allowed", ok ? Severity.Success : Severity.Warning);
        if (ok) await ReloadAfterChange();
    }

    private async Task ReloadAfterChange() {
        // Reset elements loading flags so they reload on next tab access
        elementsLoaded = false;
        serviceContactsLoaded = false;
        elementsWithServiceContact.Clear();

        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
        await CheckScopeVarianceAsync();
        StateHasChanged();
    }

    private void OpenComposeMessage() {
        if (reserveStudy?.SpecialistUserId == null) return;
        var parameters = new DialogParameters { ["ToUserId"] = reserveStudy.SpecialistUserId.Value, ["ToUserName"] = reserveStudy.Specialist?.Email ?? "" };
        DialogService.ShowAsync<CRS.Components.Pages.Messages.ComposeMessageDialog>("Send Message", parameters, new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small });
    }

    private async Task OpenAssignSpecialistDialog() {
        var specialists = new List<ApplicationUser>();
        foreach (var user in await UserManager.Users.ToListAsync()) {
            var roles = await UserManager.GetRolesAsync(user);
            if (roles.Contains("TenantSpecialist") || roles.Contains("TenantOwner")) specialists.Add(user);
        }
        if (!specialists.Any()) { Snackbar.Add("No specialists available.", Severity.Warning); return; }
        var dialog = await DialogService.ShowAsync<AssignSpecialistDialog>("Assign Specialist", new DialogParameters { ["specialists"] = specialists }, new DialogOptions { MaxWidth = MaxWidth.Small });
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is ApplicationUser selected) await AssignSpecialistAsync(selected);
    }

    private async Task AssignSpecialistAsync(ApplicationUser specialist) {
        if (reserveStudy == null) return;
        using var context = await DbFactory.CreateDbContextAsync();
        var study = await context.ReserveStudies.FindAsync(reserveStudy.Id);
        if (study != null) { study.SpecialistUserId = specialist.Id; study.DateModified = DateTime.UtcNow; await context.SaveChangesAsync(); Snackbar.Add($"Specialist {specialist.FullName} assigned!", Severity.Success); await ReloadAfterChange(); }
    }

    private async Task OpenScheduleSiteVisitDialog() {
        var dialog = await DialogService.ShowAsync<ScheduleSiteVisitDialog>("Schedule Site Visit", new DialogParameters { ["CurrentDate"] = reserveStudy?.SiteVisitDate }, new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (!result.Canceled && result.Data is ScheduleSiteVisitDialog.SiteVisitScheduleResult scheduleResult) {
            await ScheduleSiteVisitAsync(scheduleResult.ScheduledDateTime, scheduleResult.DurationMinutes, scheduleResult.VisitType.ToString(), scheduleResult.VideoConferenceLink);
        }
        // Legacy support for old tuple result
        else if (!result.Canceled && result.Data is (DateTime date, int duration)) {
            await ScheduleSiteVisitAsync(date, duration, "InPerson", null);
        }
    }

    private async Task ScheduleSiteVisitAsync(DateTime siteVisitDate, int durationMinutes = 120, string visitType = "InPerson", string? videoConferenceLink = null) {
        if (reserveStudy == null) return;
        using var context = await DbFactory.CreateDbContextAsync();
        var study = await context.ReserveStudies.Include(s => s.StudyRequest).FirstOrDefaultAsync(s => s.Id == reserveStudy.Id);
        if (study != null) {
            study.SiteVisitDate = siteVisitDate;
            study.DateModified = DateTime.UtcNow;
            // Store visit type and video link if we have those fields on the model
            // TODO: Add SiteVisitType and VideoConferenceLink fields to ReserveStudy model
            await context.SaveChangesAsync();

            var eventTitle = visitType == "Virtual"
                ? $"Virtual Site Visit - {reserveStudy.Community?.Name}"
                : visitType == "Hybrid"
                    ? $"Hybrid Site Visit - {reserveStudy.Community?.Name}"
                    : $"Site Visit - {reserveStudy.Community?.Name}";

            await CalendarService.AddEventAsync(new Models.CalendarEvent {
                Title = eventTitle,
                Start = siteVisitDate,
                End = siteVisitDate.AddMinutes(durationMinutes),
                EventType = Models.CalendarEventType.SiteVisit,
                ReserveStudyId = Id
            });
            await _dispatcher.Broadcast(new SiteVisitScheduledEvent(reserveStudy, siteVisitDate));
            var currentStatus = study.StudyRequest?.CurrentStatus ?? study.CurrentStatus;
            bool ok = currentStatus == StudyStatus.SiteVisitPending ? await WorkflowService.TryTransitionStudyAsync(Id, StudyStatus.SiteVisitScheduled) : currentStatus == StudyStatus.SiteVisitScheduled;

            var visitTypeText = visitType == "Virtual" ? "virtual " : visitType == "Hybrid" ? "hybrid " : "";
            Snackbar.Add($"Site {visitTypeText}visit scheduled for {siteVisitDate:MMMM dd, yyyy}!", ok ? Severity.Success : Severity.Warning);
            await ReloadAfterChange();
        }
    }

    private bool NeedsApproval() => GetCurrentStatus() == StudyStatus.RequestCreated;
    private bool CanAssignSpecialist() => (GetCurrentStatus() == StudyStatus.RequestApproved || GetCurrentStatus() == StudyStatus.ProposalCreated) && reserveStudy?.SpecialistUserId == null;

    private async Task ApproveRequestAsync() {
        var result = await WorkflowActionService.AdvanceAsync(Id, "Request approved");

        if (result.Success) {
            // Check if we should skip the proposal step
            await using var db = await DbFactory.CreateDbContextAsync();
            var tenant = await db.Tenants.AsNoTracking().FirstOrDefaultAsync(t => t.Id == reserveStudy!.TenantId);

            if (tenant?.SkipProposalStep == true) {
                // Skip proposal and go directly to ProposalAccepted - then handle financial info
                var skipResult = await WorkflowService.TryTransitionStudyAsync(Id, StudyStatus.ProposalAccepted);
                if (skipResult) {
                    // Check if we should also skip financial info
                    if (tenant.SkipFinancialInfoStep) {
                        Snackbar.Add("Request approved! Proposal and financial info steps skipped per tenant settings.", Severity.Success);
                    } else {
                        await RequestFinancialInfoAsync(Id);
                        Snackbar.Add("Request approved! Proposal step skipped. Financial information request sent.", Severity.Success);
                    }
                } else {
                    Snackbar.Add("Request approved! Proposal skip failed - please proceed manually.", Severity.Warning);
                }
            } else {
                Snackbar.Add("Request approved!", Severity.Success);
            }
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Failed: {result.Message}", Severity.Error);
        }
    }

    private StudyStatus GetCurrentStatus() => reserveStudy?.StudyRequest?.CurrentStatus ?? reserveStudy?.CurrentStatus ?? StudyStatus.RequestCreated;
    private StudyStatus? GetNextStatus() { var cr = StatusRank.TryGetValue(GetCurrentStatus(), out var r) ? r : -1; return KeyMilestones.FirstOrDefault(s => (StatusRank.TryGetValue(s, out var rr) ? rr : int.MaxValue) > cr); }
    private int GetProgressPercentage() {
        var status = GetCurrentStatus();
        // Special cases for non-linear statuses
        if (status == StudyStatus.ProposalDeclined) return 20; // About 20% through when proposal is declined
        if (status == StudyStatus.RequestCancelled) return 0;
        var cr = StatusRank.TryGetValue(status, out var r) ? r : 0;
        return Math.Min(100, (int)Math.Round((double)(cr + 1) / (WorkflowStatusOrder.Length - 3) * 100));
    }

    /// <summary>
    /// Gets the status banner gradient colors based on the current status urgency
    /// </summary>
    private (string gradient, string progressColor) GetStatusColors() {
        var status = GetCurrentStatus();
        return status switch {
            // Error/Declined statuses - Red
            StudyStatus.ProposalDeclined => ("linear-gradient(135deg, #ef4444 0%, #dc2626 100%)", "#ef4444"),
            StudyStatus.RequestCancelled => ("linear-gradient(135deg, #6b7280 0%, #4b5563 100%)", "#6b7280"),

            // Warning/Action needed - Amber/Orange
            StudyStatus.AmendmentPending => ("linear-gradient(135deg, #f59e0b 0%, #d97706 100%)", "#f59e0b"),
            StudyStatus.AmendmentApproved => ("linear-gradient(135deg, #f59e0b 0%, #d97706 100%)", "#f59e0b"),

            // Awaiting client action - Blue
            StudyStatus.ProposalSent => ("linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)", "#3b82f6"),
            StudyStatus.FinancialInfoRequested => ("linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)", "#3b82f6"),
            StudyStatus.FinancialInfoInProgress => ("linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)", "#3b82f6"),
            StudyStatus.ServiceContactsRequested => ("linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)", "#3b82f6"),

            // Completed - Purple
            StudyStatus.RequestCompleted => ("linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)", "#8b5cf6"),
            StudyStatus.RequestArchived => ("linear-gradient(135deg, #6b7280 0%, #4b5563 100%)", "#6b7280"),

            // Default - Green (in progress, on track)
            _ => ("linear-gradient(135deg, #10b981 0%, #059669 100%)", "#10b981")
        };
    }

    /// <summary>
    /// Gets the icon for the current status
    /// </summary>
    private string GetStatusIcon() {
        var status = GetCurrentStatus();
        return status switch {
            StudyStatus.ProposalDeclined => Icons.Material.Filled.Cancel,
            StudyStatus.RequestCancelled => Icons.Material.Filled.Cancel,
            StudyStatus.AmendmentPending => Icons.Material.Filled.Warning,
            StudyStatus.AmendmentApproved => Icons.Material.Filled.PendingActions,
            StudyStatus.RequestCompleted => Icons.Material.Filled.CheckCircle,
            StudyStatus.RequestArchived => Icons.Material.Filled.Archive,
            _ => Icons.Material.Filled.Insights
        };
    }

    /// <summary>
    /// Gets the MudBlazor Color for the progress bar based on status
    /// </summary>
    private Color GetProgressBarColor() {
        var status = GetCurrentStatus();
        return status switch {
            StudyStatus.ProposalDeclined => Color.Error,
            StudyStatus.RequestCancelled => Color.Dark,
            StudyStatus.AmendmentPending => Color.Warning,
            StudyStatus.AmendmentApproved => Color.Warning,
            StudyStatus.ProposalSent => Color.Info,
            StudyStatus.FinancialInfoRequested => Color.Info,
            StudyStatus.FinancialInfoInProgress => Color.Info,
            StudyStatus.ServiceContactsRequested => Color.Info,
            StudyStatus.RequestCompleted => Color.Secondary,
            StudyStatus.RequestArchived => Color.Dark,
            _ => Color.Success
        };
    }

    private List<MilestoneInfo> GetKeyMilestones() {
        var milestones = new List<MilestoneInfo>();
        var cr = StatusRank.TryGetValue(GetCurrentStatus(), out var crr) ? crr : -1;
        foreach (var status in KeyMilestones) {
            var ir = StatusRank.TryGetValue(status, out var irr) ? irr : int.MaxValue;
            milestones.Add(new MilestoneInfo { Status = status, Title = FormatStatusTitle(status), IsCompleted = cr >= ir, IsCurrent = cr == ir });
        }
        return milestones;
    }

    private NextActionInfo? GetNextActionInfo() => GetCurrentStatus() switch {
        // Request Phase
        StudyStatus.RequestCreated => new NextActionInfo { ActionText = "Approve Request", ActorText = "Awaiting staff review", ActorIcon = Icons.Material.Filled.RateReview },
        StudyStatus.RequestApproved => new NextActionInfo { ActionText = reserveStudy?.SpecialistUserId == null ? "Assign Specialist" : "Create Proposal", ActorText = "Awaiting staff action", ActorIcon = Icons.Material.Filled.PersonAdd },

        // Proposal Phase
        StudyStatus.ProposalCreated => new NextActionInfo { ActionText = "Review Proposal", ActorText = "Awaiting internal review", ActorIcon = Icons.Material.Filled.RateReview },
        StudyStatus.ProposalReviewed => new NextActionInfo { ActionText = "Approve Proposal", ActorText = "Awaiting approval", ActorIcon = Icons.Material.Filled.Approval },
        StudyStatus.ProposalUpdated => new NextActionInfo { ActionText = "Re-review Proposal", ActorText = "Awaiting internal review", ActorIcon = Icons.Material.Filled.RateReview },
        StudyStatus.ProposalApproved => new NextActionInfo { ActionText = "Send Proposal", ActorText = "Ready to send to client", ActorIcon = Icons.Material.Filled.Send },
        StudyStatus.ProposalSent => new NextActionInfo { ActionText = "Accept Proposal", ActorText = "Awaiting client response", ActorIcon = Icons.Material.Filled.Business },
        StudyStatus.ProposalDeclined => new NextActionInfo { ActionText = "Create Revised Proposal", ActorText = "Action required by specialist", ActorIcon = Icons.Material.Filled.Edit },
        StudyStatus.ProposalAccepted => new NextActionInfo { ActionText = "Request Financial Info", ActorText = "Awaiting staff action", ActorIcon = Icons.Material.Filled.RequestQuote },

        // Data Collection Phase
        StudyStatus.ServiceContactsRequested => new NextActionInfo { ActionText = "Provide Service Contacts", ActorText = "Awaiting client response", ActorIcon = Icons.Material.Filled.Contacts },
        StudyStatus.FinancialInfoRequested => new NextActionInfo { ActionText = "Submit Financial Info", ActorText = "Awaiting client response", ActorIcon = Icons.Material.Filled.AccountBalance },
        StudyStatus.FinancialInfoInProgress => new NextActionInfo { ActionText = "Complete Financial Info", ActorText = "Client is entering data", ActorIcon = Icons.Material.Filled.Edit },
        StudyStatus.FinancialInfoSubmitted => new NextActionInfo { ActionText = "Review Financial Info", ActorText = "Awaiting staff review", ActorIcon = Icons.Material.Filled.FactCheck },
        StudyStatus.FinancialInfoReviewed => new NextActionInfo { ActionText = "Approve Financial Info", ActorText = "Awaiting staff approval", ActorIcon = Icons.Material.Filled.Approval },
        StudyStatus.FinancialInfoReceived => new NextActionInfo { ActionText = "Schedule Site Visit", ActorText = "Ready to schedule", ActorIcon = Icons.Material.Filled.CalendarMonth },

        // Site Visit Phase
        StudyStatus.SiteVisitPending => new NextActionInfo { ActionText = "Schedule Site Visit", ActorText = "Action required by specialist", ActorIcon = Icons.Material.Filled.CalendarMonth },
        StudyStatus.SiteVisitScheduled => new NextActionInfo { ActionText = "Complete Site Visit", ActorText = "Awaiting site visit date", ActorIcon = Icons.Material.Filled.LocationOn },
        StudyStatus.SiteVisitCompleted => new NextActionInfo { ActionText = "Enter Site Visit Data", ActorText = "Awaiting data entry", ActorIcon = Icons.Material.Filled.Storage },
        StudyStatus.SiteVisitDataEntered => new NextActionInfo { ActionText = "Begin Funding Plan", ActorText = "Ready to proceed", ActorIcon = Icons.Material.Filled.PlayArrow },

        // Amendment Phase
        StudyStatus.AmendmentPending => new NextActionInfo { ActionText = "Approve Amendment", ActorText = "Awaiting admin approval", ActorIcon = Icons.Material.Filled.RateReview },
        StudyStatus.AmendmentApproved => new NextActionInfo { ActionText = "Accept Amendment", ActorText = "Awaiting client acceptance", ActorIcon = Icons.Material.Filled.Business },

        // Funding Plan Phase
        StudyStatus.FundingPlanReady => new NextActionInfo { ActionText = "Create Funding Plan", ActorText = "Ready to begin", ActorIcon = Icons.Material.Filled.Assessment },
        StudyStatus.FundingPlanInProcess => new NextActionInfo { ActionText = "Complete Funding Plan", ActorText = "Work in progress", ActorIcon = Icons.Material.Filled.TrendingUp },
        StudyStatus.FundingPlanComplete => new NextActionInfo { ActionText = "Begin Narrative", ActorText = "Ready for narrative phase", ActorIcon = Icons.Material.Filled.Article },

        // Narrative Phase
        StudyStatus.NarrativeReady => new NextActionInfo { ActionText = "Write Narrative", ActorText = "Ready to begin", ActorIcon = Icons.Material.Filled.EditNote },
        StudyStatus.NarrativeInProcess => new NextActionInfo { ActionText = "Complete Narrative", ActorText = "Work in progress", ActorIcon = Icons.Material.Filled.Create },
        StudyStatus.NarrativeComplete => new NextActionInfo { ActionText = "Prepare for Print", ActorText = "Ready for print preparation", ActorIcon = Icons.Material.Filled.Print },
        StudyStatus.NarrativePrintReady => new NextActionInfo { ActionText = "Package Report", ActorText = "Ready for packaging", ActorIcon = Icons.Material.Filled.Inventory2 },
        StudyStatus.NarrativePackaged => new NextActionInfo { ActionText = "Send to Client", ActorText = "Ready to send", ActorIcon = Icons.Material.Filled.Send },
        StudyStatus.NarrativeSent => new NextActionInfo { ActionText = "Finalize Report", ActorText = "Narrative delivered", ActorIcon = Icons.Material.Filled.MarkEmailRead },

        // Final Report Phase
        StudyStatus.ReportReady => new NextActionInfo { ActionText = "Finalize Report", ActorText = "Ready for final review", ActorIcon = Icons.Material.Filled.Summarize },
        StudyStatus.ReportInProcess => new NextActionInfo { ActionText = "Complete Report", ActorText = "Finalizing report", ActorIcon = Icons.Material.Filled.AutoStories },
        StudyStatus.ReportComplete => new NextActionInfo { ActionText = "Mark Complete", ActorText = "Ready to close", ActorIcon = Icons.Material.Filled.CheckCircle },

        // Terminal States
        StudyStatus.RequestCompleted => null,
        StudyStatus.RequestCancelled => null,
        StudyStatus.RequestArchived => null,

        _ => new NextActionInfo { ActionText = "Processing...", ActorText = "In progress", ActorIcon = Icons.Material.Filled.HourglassEmpty }
    };

    private string GetCurrentStepDescription() => GetCurrentStatus() switch {
        // Request Phase
        StudyStatus.RequestCreated => "Your reserve study request has been received and is being reviewed by our team.",
        StudyStatus.RequestApproved => "Your request has been approved. A specialist will be assigned and a proposal will be prepared for you.",

        // Proposal Phase
        StudyStatus.ProposalCreated => "A proposal is being prepared for your reserve study.",
        StudyStatus.ProposalReviewed => "The proposal is undergoing internal review to ensure accuracy.",
        StudyStatus.ProposalUpdated => "The proposal has been updated and is being reviewed again.",
        StudyStatus.ProposalApproved => "The proposal has been approved and will be sent to you shortly.",
        StudyStatus.ProposalSent => "We've sent you a proposal. Please review the details and accept it to proceed with your reserve study.",
        StudyStatus.ProposalDeclined => "The proposal was declined. Our specialist will review your feedback and prepare a revised proposal.",
        StudyStatus.ProposalAccepted => "Thank you for accepting the proposal! We'll now request some financial information to proceed.",

        // Data Collection Phase
        StudyStatus.ServiceContactsRequested => "Please provide contact information for your service providers (maintenance companies, contractors, etc.).",
        StudyStatus.FinancialInfoRequested => "Please submit your community's financial information to help us prepare an accurate reserve study.",
        StudyStatus.FinancialInfoInProgress => "We see you've started entering financial information. Please complete and submit when ready.",
        StudyStatus.FinancialInfoSubmitted => "Thank you for submitting your financial information. Our team is reviewing it now.",
        StudyStatus.FinancialInfoReviewed => "Your financial information has been reviewed and is being processed.",
        StudyStatus.FinancialInfoReceived => "All required information has been received. We're ready to schedule your site visit.",

        // Site Visit Phase
        StudyStatus.SiteVisitPending => "We're ready to schedule a site visit. Our specialist will coordinate a convenient time with you.",
        StudyStatus.SiteVisitScheduled => $"Your site visit has been scheduled{(reserveStudy?.SiteVisitDate.HasValue == true ? $" for {reserveStudy.SiteVisitDate.Value:MMMM dd, yyyy}" : "")}. Our specialist will inspect the property.",
        StudyStatus.SiteVisitCompleted => "The site visit has been completed. Our specialist is now documenting the findings.",
        StudyStatus.SiteVisitDataEntered => "Site visit data has been recorded. We're preparing to create your funding plan.",

        // Amendment Phase
        StudyStatus.AmendmentPending => "The site visit revealed scope changes that require an amendment to the original proposal. This is awaiting administrative approval.",
        StudyStatus.AmendmentApproved => "An amendment has been prepared based on site visit findings and sent for your review and acceptance.",

        // Funding Plan Phase
        StudyStatus.FundingPlanReady => "We're ready to create your funding plan. This will outline recommended reserve contributions over the study period.",
        StudyStatus.FundingPlanInProcess => "Your funding plan is being developed. This includes analysis of all property components and their replacement costs.",
        StudyStatus.FundingPlanComplete => "Your funding plan has been completed! We're now preparing the narrative section of your report.",

        // Narrative Phase
        StudyStatus.NarrativeReady => "We're ready to write the narrative portion of your reserve study report.",
        StudyStatus.NarrativeInProcess => "The narrative section is being written. This includes detailed explanations of our findings and recommendations.",
        StudyStatus.NarrativeComplete => "The narrative has been completed and is being prepared for final formatting.",
        StudyStatus.NarrativePrintReady => "Your report is ready for printing and final assembly.",
        StudyStatus.NarrativePackaged => "Your report has been packaged and is ready to be delivered.",
        StudyStatus.NarrativeSent => "The narrative portion of your report has been sent. Final report preparation is underway.",

        // Final Report Phase
        StudyStatus.ReportReady => "Your final report is being prepared for delivery.",
        StudyStatus.ReportInProcess => "We're putting the finishing touches on your complete reserve study report.",
        StudyStatus.ReportComplete => "Your reserve study report is complete and has been delivered.",

        // Terminal States
        StudyStatus.RequestCompleted => "Congratulations! Your reserve study has been completed. You can access your reports and documents anytime.",
        StudyStatus.RequestCancelled => "This reserve study request has been cancelled.",
        StudyStatus.RequestArchived => "This reserve study has been archived for your records.",

        _ => "Your reserve study is in progress. Check back soon for updates."
    };

    private string GetNextStepDescription() => GetNextStatus() switch {
        // Request Phase
        StudyStatus.RequestApproved => "Once approved, a specialist will be assigned to your project.",

        // Proposal Phase
        StudyStatus.ProposalCreated => "A detailed proposal will be prepared outlining the scope and cost of your reserve study.",
        StudyStatus.ProposalReviewed => "The proposal will be reviewed for accuracy before being sent to you.",
        StudyStatus.ProposalApproved => "After internal approval, the proposal will be sent to you for review.",
        StudyStatus.ProposalSent => "You'll receive a proposal to review and accept.",
        StudyStatus.ProposalAccepted => "Once you accept the proposal, we'll begin gathering information for your study.",

        // Data Collection Phase
        StudyStatus.ServiceContactsRequested => "You'll be asked to provide contact information for service providers.",
        StudyStatus.FinancialInfoRequested => "You'll need to provide financial information about your community's reserves.",
        StudyStatus.FinancialInfoSubmitted => "After you submit, our team will review your financial information.",
        StudyStatus.FinancialInfoReceived => "Once reviewed, we'll schedule a site visit to inspect the property.",

        // Site Visit Phase
        StudyStatus.SiteVisitPending => "A site visit will be scheduled to inspect your property.",
        StudyStatus.SiteVisitScheduled => "Our specialist will conduct an on-site inspection of all common elements.",
        StudyStatus.SiteVisitCompleted => "After the visit, all findings will be documented and analyzed.",
        StudyStatus.SiteVisitDataEntered => "Site data will be entered into our system for analysis.",

        // Funding Plan Phase
        StudyStatus.FundingPlanReady => "We'll begin creating your customized funding plan.",
        StudyStatus.FundingPlanInProcess => "Your funding plan will be developed based on component analysis.",
        StudyStatus.FundingPlanComplete => "Once complete, the narrative report will be prepared.",

        // Narrative Phase
        StudyStatus.NarrativeReady => "The narrative section of your report will be written.",
        StudyStatus.NarrativeComplete => "Your report will be formatted and prepared for delivery.",
        StudyStatus.NarrativeSent => "You'll receive the narrative portion of your report.",

        // Final Report Phase
        StudyStatus.ReportComplete => "Your complete reserve study will be finalized and delivered.",
        StudyStatus.RequestCompleted => "Your reserve study will be marked complete and available for download.",

        _ => "The next phase of your reserve study will begin soon."
    };

    private static Color GetRemainingLifeColor(string? remainingLife) {
        if (string.IsNullOrEmpty(remainingLife)) return Color.Default;
        var match = System.Text.RegularExpressions.Regex.Match(remainingLife, @"\d+");
        if (match.Success && int.TryParse(match.Value, out var years)) return years switch { <= 2 => Color.Error, <= 5 => Color.Warning, <= 10 => Color.Info, _ => Color.Success };
        return Color.Default;
    }

    private static string GetElementGroupIcon(IReserveStudyElement.ElementTypeEnum type) => type switch {
        IReserveStudyElement.ElementTypeEnum.Building => Icons.Material.Filled.Business,
        IReserveStudyElement.ElementTypeEnum.Common => Icons.Material.Filled.Park,
        _ => Icons.Material.Filled.Category
    };

    private static string GetElementGroupStyle(IReserveStudyElement.ElementTypeEnum type) {
        var color = type switch { IReserveStudyElement.ElementTypeEnum.Building => "#10b981", IReserveStudyElement.ElementTypeEnum.Common => "#3b82f6", _ => "#8b5cf6" };
        return $"background: {color}; color: white;";
    }

    /// <summary>
    /// Checks if a service contact has meaningful data (not just an empty object)
    /// </summary>
    private static bool HasValidServiceContact(ServiceContact? contact) {
        if (contact == null) return false;

        // Check if at least one meaningful field is populated
        return !string.IsNullOrWhiteSpace(contact.CompanyName) ||
               !string.IsNullOrWhiteSpace(contact.FirstName) ||
               !string.IsNullOrWhiteSpace(contact.LastName) ||
               !string.IsNullOrWhiteSpace(contact.Phone) ||
               !string.IsNullOrWhiteSpace(contact.Email);
    }

    private RenderFragment RenderProposalDetails(CRS.Models.Proposal proposal) => __builder => {
        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: #fff; border-radius: 12px; border-left: 4px solid #10b981;">
            <MudStack Spacing="3">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Description" Style="color: #10b981;" Size="Size.Small" />
                    <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #10b981;">
                        @(proposal.IsAmendment ? $"Amendment #{proposal.AmendmentNumber} Details" : "Proposal Details")
                    </MudText>
                    @if (proposal.IsApproved) {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">Accepted</MudChip>
                    } else if (proposal.DateSent.HasValue) {
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">Sent</MudChip>
                    } else if (proposal.DateApproved.HasValue) {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled">Approved</MudChip>
                    } else {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Draft</MudChip>
                    }
                </MudStack>

                <MudGrid Spacing="3">
                    <MudItem xs="12" md="8">
                        <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Scope</MudText>
                        <MudText Typo="Typo.body2" Style="color: #333; white-space: pre-wrap;">
                            @(string.IsNullOrEmpty(proposal.ProposalScope) ? "No scope defined" : proposal.ProposalScope)
                        </MudText>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Estimated Cost</MudText>
                        <MudText Typo="Typo.h5" Style="color: #10b981; font-weight: 700;">
                            @proposal.EstimatedCost.ToString("C")
                        </MudText>
                    </MudItem>
                </MudGrid>

                @if (!string.IsNullOrEmpty(proposal.ServiceLevel) || !string.IsNullOrEmpty(proposal.DeliveryTimeframe)) {
                    <MudDivider Class="my-2" />
                    <MudGrid Spacing="2">
                        @if (!string.IsNullOrEmpty(proposal.ServiceLevel)) {
                            <MudItem xs="12" sm="6" md="4">
                                <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Service Level</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.ServiceLevel</MudText>
                            </MudItem>
                        }
                        @if (!string.IsNullOrEmpty(proposal.DeliveryTimeframe)) {
                            <MudItem xs="12" sm="6" md="4">
                                <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Delivery Timeframe</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.DeliveryTimeframe</MudText>
                            </MudItem>
                        }
                        @if (!string.IsNullOrEmpty(proposal.PaymentTerms)) {
                            <MudItem xs="12" sm="6" md="4">
                                <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Payment Terms</MudText>
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.PaymentTerms</MudText>
                            </MudItem>
                        }
                    </MudGrid>
                }

                @if (proposal.IncludePrepaymentDiscount || proposal.IncludeDigitalDelivery || proposal.IncludeComponentInventory || proposal.IncludeFundingPlans) {
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Included Services</MudText>
                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                        @if (proposal.IncludePrepaymentDiscount) {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Discount">Prepayment Discount</MudChip>
                        }
                        @if (proposal.IncludeDigitalDelivery) {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.CloudDownload">Digital Delivery</MudChip>
                        }
                        @if (proposal.IncludeComponentInventory) {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Inventory">Component Inventory</MudChip>
                        }
                        @if (proposal.IncludeFundingPlans) {
                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.TrendingUp">Funding Plans</MudChip>
                        }
                    </MudStack>
                }

                @if (!string.IsNullOrEmpty(proposal.Comments)) {
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.caption" Style="color: #888; font-weight: 600; text-transform: uppercase;">Comments</MudText>
                    <MudText Typo="Typo.body2" Style="color: #666; white-space: pre-wrap;">@proposal.Comments</MudText>
                }

                @if (proposal.IsAmendment && !string.IsNullOrEmpty(proposal.AmendmentReason)) {
                    <MudDivider Class="my-2" />
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                        <MudText Typo="Typo.caption" Style="font-weight: 600;">Amendment Reason</MudText>
                        <MudText Typo="Typo.body2">@proposal.AmendmentReason</MudText>
                    </MudAlert>
                }

                <!-- Proposal Timeline -->
                <MudDivider Class="my-2" />
                <MudStack Row="true" Spacing="4" Style="flex-wrap: wrap;">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Style="color: #888;">Created</MudText>
                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.ProposalDate.ToString("MMM dd, yyyy")</MudText>
                    </MudStack>
                    @if (proposal.DateSent.HasValue) {
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Style="color: #888;">Sent</MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.DateSent.Value.ToString("MMM dd, yyyy")</MudText>
                        </MudStack>
                    }
                    @if (proposal.IsApproved && proposal.DateApproved.HasValue) {
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.caption" Style="color: #888;">Accepted</MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@proposal.DateApproved.Value.ToString("MMM dd, yyyy")</MudText>
                        </MudStack>
                    }
                </MudStack>

                <!-- Edit Proposal Button for Staff -->
                @if (GetCurrentStatus() < StudyStatus.ProposalSent) {
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudDivider Class="my-2" />
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Edit"
                                       Href="@($"/ReserveStudies/Proposal/{Id}")">
                                Edit Proposal
                            </MudButton>
                        </Authorized>
                    </AuthorizeView>
                }
            </MudStack>
        </MudPaper>
    };

    private class TimelineItemInfo { public StudyStatus Status { get; set; } public DateTime? DateValue { get; set; } public string? Title { get; set; } }
    private class MilestoneInfo { public StudyStatus Status { get; set; } public string Title { get; set; } = ""; public DateTime? Date { get; set; } public bool IsCompleted { get; set; } public bool IsCurrent { get; set; } }
    private class NextActionInfo { public string ActionText { get; set; } = ""; public string ActorText { get; set; } = ""; public string ActorIcon { get; set; } = Icons.Material.Filled.Person; }
}
