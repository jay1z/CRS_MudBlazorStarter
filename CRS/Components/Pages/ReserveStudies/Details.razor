@page "/ReserveStudies/{Id:guid}/Details"
@attribute [Authorize]

@using CRS.Components.Custom
@using CRS.Components.Pages.ReserveStudies.Dialogs
@using CRS.Data
@using CRS.EventsAndListeners
@using CRS.Models.Emails
@using CRS.Services
@using CRS.Services.Email
@using CRS.Services.Interfaces
@using CRS.Models.Workflow
@using CRS.Services.Workflow
@using Coravel.Events.Interfaces
@using Coravel.Mailer.Mail
@using Coravel.Mailer.Mail.Interfaces
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using static CRS.Components.Custom.WorkflowStatusButtons

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IReserveStudyService ReserveStudyService
@inject IReserveStudyWorkflowService WorkflowService
@inject IWorkflowActionService WorkflowActionService
@inject ICalendarService CalendarService
@inject INotificationService NotificationService
@inject IMailer _mailer
@inject IDispatcher _dispatcher
@inject IDialogService DialogService
@inject IProposalAcceptanceService AcceptanceService
@inject ILogger<Details> Logger

<PageTitle>Reserve Study Details</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    @if (isLoading) {
        <MudPaper Elevation="0" Class="pa-8">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h5" Class="mt-4">Loading Reserve Study...</MudText>
        </MudPaper>
    } else if (reserveStudy == null) {
        NavigationManager.NavigateTo("/ReserveStudies/NotFound");
    } else {
        <MudContainer MaxWidth="MaxWidth.ExtraLarge">
            <!-- Hero Header Section -->
            <MudPaper Elevation="3" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px;">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="3">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.LocationCity" Style="color: white; font-size: 40px;" />
                            <div>
                                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600; margin: 0;">
                                    @reserveStudy.Community?.Name
                                </MudText>
                                <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.9);">
                                    @reserveStudy.Community?.PhysicalAddress?.FullAddress
                                </MudText>
                            </div>
                        </MudStack>
                        <MudStack Row="true" Spacing="3" Class="mt-2">
                            <MudChip T="string" Icon="@Icons.Material.Filled.Tag" 
                                     Style="background: rgba(255,255,255,0.2); color: white;" 
                                     Size="Size.Small">
                                ID: @reserveStudy.Id.ToString().Substring(0, 8)
                            </MudChip>
                            <MudChip T="string" Icon="@Icons.Material.Filled.CalendarToday" 
                                     Style="background: rgba(255,255,255,0.2); color: white;" 
                                     Size="Size.Small">
                                Created: @reserveStudy.DateCreated?.ToString("MMM dd, yyyy")
                            </MudChip>
                        </MudStack>
                    </MudStack>
                    
                    @if (canEdit || canStaffEdit) {
                        <MudButton Variant="Variant.Filled" 
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   Href="@($"/ReserveStudies/{Id}/Edit")"
                                   Style="background: white; color: #667eea; font-weight: 600;">
                            Edit Request
                        </MudButton>
                    }
                </MudStack>
            </MudPaper>

            <MudGrid>
                <!-- Aside Column -->
                <MudItem xs="12" lg="4">
                    <!-- Quick Info Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #667eea;">
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Request ID</MudText>
                                    <MudText Typo="Typo.body1" Style="font-family: 'Courier New', monospace; font-weight: 500;">
                                        @reserveStudy.Id.ToString().Substring(0, 13)...
                                    </MudText>
                                </div>
                                <MudDivider />
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Created Date</MudText>
                                    <MudText Typo="Typo.body1" Style="font-weight: 500;">
                                        @reserveStudy.DateCreated?.ToString("MMMM dd, yyyy")
                                    </MudText>
                                    <MudText Typo="Typo.caption" Style="color: #999;">
                                        @((DateTime.Now - (reserveStudy.DateCreated ?? DateTime.Now)).Days) days ago
                                    </MudText>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>


                    <!-- Specialist Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="2">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Size="Size.Large" Style="background: white; color: #667eea;">
                                        @if (reserveStudy.Specialist != null) {
                                            <MudText>@reserveStudy.Specialist.Initials</MudText>
                                        } else {
                                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                                        }
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase;">
                                            Reserve Specialist
                                        </MudText>
                                        <MudText Typo="Typo.h6" Style="color: white; font-weight: 600;">
                                            @(reserveStudy.Specialist?.FullName ?? "Not Assigned")
                                        </MudText>
                                    </div>
                                </MudStack>
                                <AuthorizeView Policy="RequireTenantOwner">
                                    <Authorized>
                                        <MudButton Variant="Variant.Filled" 
                                                   Size="Size.Small" 
                                                   Style="background: rgba(255,255,255,0.2); color: white; text-transform: none;"
                                                   StartIcon="@Icons.Material.Filled.Edit"
                                                   OnClick="OpenAssignSpecialistDialog">
                                            @(reserveStudy.Specialist != null ? "Change" : "Assign")
                                        </MudButton>
                                    </Authorized>
                                </AuthorizeView>
                            </MudStack>
                        </div>
                        <MudCardContent>
                            <MudStack Spacing="2">
                                @if (reserveStudy.Specialist != null) {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                        <MudLink Href="@($"mailto:{reserveStudy.Specialist.Email}")" Typo="Typo.body2">
                                            @reserveStudy.Specialist.Email
                                        </MudLink>
                                    </MudStack>
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Primary" 
                                               FullWidth="true"
                                               StartIcon="@Icons.Material.Filled.Message"
                                               Disabled="@(reserveStudy?.SpecialistUserId == null)" 
                                               OnClick="OpenComposeMessage">
                                        Send Message
                                    </MudButton>
                                    <AuthorizeView Policy="RequireTenantOwner">
                                        <Authorized>
                                            <MudButton Variant="Variant.Text" 
                                                       Color="Color.Primary" 
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.SwapHoriz"
                                                       OnClick="OpenAssignSpecialistDialog">
                                                Reassign Specialist
                                            </MudButton>
                                        </Authorized>
                                    </AuthorizeView>
                } else {
                                    @if (CanAssignSpecialist()) {
                                        <MudAlert Severity="Severity.Success" Dense="true">
                                            Request approved! You can now assign a specialist.
                                        </MudAlert>
                                        <AuthorizeView Policy="RequireTenantOwner">
                                            <Authorized>
                                                <MudButton Variant="Variant.Filled" 
                                                           Color="Color.Primary" 
                                                           FullWidth="true"
                                                           StartIcon="@Icons.Material.Filled.PersonAdd"
                                                           OnClick="OpenAssignSpecialistDialog">
                                                    Assign Specialist
                                                </MudButton>
                                            </Authorized>
                                        </AuthorizeView>
                                    } else if (NeedsApproval()) {
                                        <MudAlert Severity="Severity.Warning" Dense="true">
                                            Request pending approval before specialist can be assigned.
                                        </MudAlert>
                                    } else {
                                        <MudAlert Severity="Severity.Info" Dense="true">
                                            A specialist will be assigned to your request shortly.
                                        </MudAlert>
                                    }
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>


                    <!-- Status Progress Card -->
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 16px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Insights" Style="color: white; font-size: 32px;" />
                                <div>
                                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600; text-transform: uppercase;">
                                        Current Status
                                    </MudText>
                                    <MudText Typo="Typo.h6" Style="color: white; font-weight: 600;">
                                        @FormatStatusTitle(GetCurrentStatus())
                                    </MudText>
                                </div>
                            </MudStack>
                        </div>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <!-- Progress Bar -->
                                <div>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-1">
                                        <MudText Typo="Typo.caption" Style="font-weight: 600;">Progress</MudText>
                                        <MudText Typo="Typo.caption" Style="font-weight: 600; color: #10b981;">
                                            @GetProgressPercentage()%
                                        </MudText>
                                    </MudStack>
                                    <MudProgressLinear Color="Color.Success" 
                                                       Value="@GetProgressPercentage()" 
                                                       Size="Size.Medium" 
                                                       Style="border-radius: 8px; height: 12px;" />
                                </div>

                                <!-- Key Milestones -->
                                <MudDivider />
                                <MudText Typo="Typo.caption" Style="font-weight: 600; text-transform: uppercase; color: #666;">
                                    Key Milestones
                                </MudText>
                                
                                @foreach (var milestone in GetKeyMilestones()) {
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        @if (milestone.IsCompleted) {
                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" 
                                                     Color="Color.Success" 
                                                     Size="Size.Small" />
                                        } else if (milestone.IsCurrent) {
                                            <MudIcon Icon="@Icons.Material.Filled.RadioButtonChecked" 
                                                     Color="Color.Primary" 
                                                     Size="Size.Small" />
                                        } else {
                                            <MudIcon Icon="@Icons.Material.Outlined.RadioButtonUnchecked" 
                                                     Style="color: #ccc;" 
                                                     Size="Size.Small" />
                                        }
                                        <div style="flex: 1;">
                                            <MudText Typo="Typo.body2" 
                                                     Style="@(milestone.IsCompleted ? "color: #666; text-decoration: line-through;" : milestone.IsCurrent ? "font-weight: 600; color: #667eea;" : "color: #999;")">
                                                @milestone.Title
                                            </MudText>
                                            @if (milestone.IsCompleted && milestone.Date.HasValue) {
                                                <MudText Typo="Typo.caption" Style="color: #999;">
                                                    @milestone.Date.Value.ToString("MMM dd, yyyy")
                                                </MudText>
                                            }
                                        </div>
                                    </MudStack>
                                }

                                <!-- Next Action -->
                                @{
                                    var nextStatus = GetNextStatus();
                                    var nextActionInfo = GetNextActionInfo();
                                }
                                @if (nextStatus != null && nextActionInfo != null) {
                                    <MudDivider />
                                    <MudPaper Elevation="0" Class="pa-3" Style="background: #f0f4ff; border-radius: 8px;">
                                        <MudStack Spacing="1">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" 
                                                         Color="Color.Primary" 
                                                         Size="Size.Small" />
                                                <MudText Typo="Typo.caption" Style="color: #667eea; font-weight: 600; text-transform: uppercase;">
                                                    Next Step
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                @nextActionInfo.ActionText
                                            </MudText>
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@nextActionInfo.ActorIcon" 
                                                         Size="Size.Small" 
                                                         Style="color: #999;" />
                                                <MudText Typo="Typo.caption" Style="color: #666;">
                                                    @nextActionInfo.ActorText
                                                </MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px;">
                                <MudCardHeader Style="background: #f8f9fa;">
                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                        <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Class="mr-2" />
                                        Staff Actions
                                    </MudText>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudStack Spacing="2">
                                        <MudButton Variant="Variant.Outlined" 
                                                   Color="Color.Secondary" 
                                                   FullWidth="true"
                                                   StartIcon="@Icons.Material.Filled.Link"
                                                   OnClick="SendRequestLink">
                                            Send Request Link
                                        </MudButton>
                                        <MudButton Variant="Variant.Outlined" 
                                                   Color="Color.Secondary" 
                                                   FullWidth="true"
                                                   StartIcon="@Icons.Material.Filled.VpnKey"
                                                   OnClick="SendAccessTokenLink">
                                            Send Access Token
                                        </MudButton>
                                        @if (reserveStudy?.Proposal != null && reserveStudy?.CurrentStatus < StudyStatus.ProposalSent) {
                                            <MudDivider Class="my-2" />
                                            <MudButton Variant="Variant.Filled" 
                                                       Color="Color.Primary" 
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.Edit"
                                                       Href="@($"/ReserveStudies/{Id}/Proposal")">
                                                Edit Proposal
                                            </MudButton>
                                        }
                                    </MudStack>
                                </MudCardContent>
                            </MudCard>
                        </Authorized>
                    </AuthorizeView>

                    <!-- Admin Workflow Panel -->
                    <CRS.Components.Custom.AdminWorkflowPanel 
                        StudyId="@Id"
                        CurrentStatus="@GetCurrentStatus()"
                        StatusHistory="@statusHistory"
                        OnActionCompleted="@ReloadAfterChange" />

                    @if (reserveStudy.DateCreated.HasValue && (DateTime.Now - reserveStudy.DateCreated.Value).TotalDays > 30 && !reserveStudy.IsComplete) {
                        <MudAlert Severity="Severity.Warning" Elevation="2" Class="mb-4" Style="border-radius: 12px;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Large" />
                                <div>
                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Attention Needed</MudText>
                                    <MudText Typo="Typo.body2">
                                        This request has been pending for 
                                        <strong>@((DateTime.Now - reserveStudy.DateCreated.Value).TotalDays.ToString("N0")) days</strong>
                                    </MudText>
                                </div>
                            </MudStack>
                        </MudAlert>
                    }
                </MudItem>

                <!-- Main Column -->
                <MudItem xs="12" lg="8">
                    <MudTabs Elevation="2" 
                             Rounded="true" 
                             Color="Color.Primary" 
                             ActivePanelIndex="activeTabIndex" 
                             ActivePanelIndexChanged="HandleTabChange"
                             Style="border-radius: 12px; overflow: hidden;"
                             PanelClass="pa-4">
                        <!-- Workflow Status Tab -->
                        <MudTabPanel Text="Workflow Details" Icon="@Icons.Material.Filled.Info">
                            <MudCard Elevation="0">
                                <MudCardContent>
                                    <!-- Current Status Banner -->
                                    <MudPaper Elevation="2" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px;">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Verified" Style="color: white; font-size: 48px;" />
                                                <div>
                                                    <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.9); font-weight: 600;">
                                                        CURRENT STATUS
                                                    </MudText>
                                                    <MudText Typo="Typo.h4" Style="color: white; font-weight: 700;">
                                                        @FormatStatusTitle(GetCurrentStatus())
                                                    </MudText>
                                                </div>
                                            </MudStack>
                                            <MudChip T="string" Style="background: rgba(255,255,255,0.2); color: white; font-weight: 600;" Size="Size.Large">
                                                @GetProgressPercentage()% Complete
                                            </MudChip>
                                        </MudStack>
                                    </MudPaper>

                                    <!-- Current Step Description -->
                                    <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: #f8f9fa; border-radius: 12px; border-left: 4px solid #667eea;">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" Size="Size.Small" />
                                                <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #667eea;">
                                                    Current Step
                                                </MudText>
                                            </MudStack>
                                            <MudText Typo="Typo.body2" Style="color: #666;">
                                                @GetCurrentStepDescription()
                                            </MudText>
                                        </MudStack>
                                    </MudPaper>

                                    <!-- Next Step Description -->
                                    @{
                                        var nextActionInfo = GetNextActionInfo();
                                    }
                                    @if (nextActionInfo != null) {
                                        <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: #f0f4ff; border-radius: 12px; border-left: 4px solid #10b981;">
                                            <MudStack Spacing="2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Color="Color.Success" Size="Size.Small" />
                                                    <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #10b981;">
                                                        What's Next: @nextActionInfo.ActionText
                                                    </MudText>
                                                </MudStack>
                                                <MudText Typo="Typo.body2" Style="color: #666;">
                                                    @GetNextStepDescription()
                                                </MudText>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mt-2">
                                                    <MudIcon Icon="@nextActionInfo.ActorIcon" Size="Size.Small" Style="color: #10b981;" />
                                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">
                                                        @nextActionInfo.ActorText
                                                    </MudText>
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    }

                                    <!-- Action Buttons -->
                                    @{
                                        var currentStatus = GetCurrentStatus();
                                        
                                        <MudStack Row="true" Spacing="2" Class="mb-4" Style="flex-wrap: wrap;">
                                            @* Approve Request - when RequestApproved is allowed *@
                                            @if (allowedNextStudy.Contains(StudyStatus.RequestApproved)) {
                                                <AuthorizeView Policy="RequireTenantOwner">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="ApproveRequestAsync">
                                                            Approve Request
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            

                                            @* Create Proposal - when no proposal exists and ProposalCreated is allowed *@
                                            @if (allowedNextStudy.Contains(StudyStatus.ProposalCreated) && reserveStudy?.Proposal == null) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Description" 
                                                                   Href="@($"/ReserveStudies/{Id}/Proposal")">
                                                            Create Proposal
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @* Show Send Proposal only when we can actually transition to ProposalSent *@
                                            @if (allowedNextStudy.Contains(StudyStatus.ProposalSent)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Send" 
                                                                   OnClick="@(() => SendProposalAsync(Id))">
                                                            Send Proposal
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @* Proposal workflow steps *@
                                            @if (allowedNextStudy.Contains(StudyStatus.ProposalReviewed)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.RateReview" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.ProposalReviewed))">
                                                            Submit for Review
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @if (allowedNextStudy.Contains(StudyStatus.ProposalApproved)) {
                                                <AuthorizeView Policy="RequireTenantOwner">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.ProposalApproved))">
                                                            Approve Proposal
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @if (allowedNextStudy.Contains(StudyStatus.ProposalUpdated)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Warning" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Edit" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.ProposalUpdated))">
                                                            Request Changes
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @* Data collection steps - only show for statuses before ProposalAccepted *@
                                            @* ProposalAccepted triggers automatic financial info request *@
                                            @if ((allowedNextStudy.Contains(StudyStatus.FinancialInfoRequested) || 
                                                  allowedNextStudy.Contains(StudyStatus.ServiceContactsRequested)) &&
                                                  currentStatus < StudyStatus.ProposalAccepted) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Description" 
                                                                   OnClick="@(() => RequestFinancialInfoAsync(Id))">
                                                            Request Financial Info
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @* Request more financial info (after review) *@
                                            @if (allowedNextStudy.Contains(StudyStatus.FinancialInfoRequested) &&
                                                 currentStatus >= StudyStatus.FinancialInfoSubmitted) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Warning" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Refresh" 
                                                                   OnClick="@(() => RequestFinancialInfoAsync(Id))">
                                                            Request More Info
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @* Accept financial info *@
                                            @if (allowedNextStudy.Contains(StudyStatus.FinancialInfoReceived)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.FinancialInfoReceived))">
                                                            Accept Financial Info
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @* HOA user button to submit financial info when requested *@
                                            @if (currentStatus == StudyStatus.FinancialInfoRequested || 
                                                 currentStatus == StudyStatus.FinancialInfoInProgress) {
                                                <MudButton Variant="Variant.Filled"
                                                           Color="Color.Success"
                                                           Size="Size.Large"
                                                           StartIcon="@Icons.Material.Filled.Description"
                                                           Href="@($"/ReserveStudies/{Id}/FinancialInfo")">
                                                    Submit Financial Information
                                                </MudButton>
                                            }
                                            
                                            @* Site visit workflow *@
                                            @if (currentStatus == StudyStatus.FinancialInfoReceived && 
                                                 allowedNextStudy.Contains(StudyStatus.SiteVisitPending)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Event" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitPending))">
                                                            Begin Site Visit Process
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @if (currentStatus == StudyStatus.SiteVisitPending && 
                                                 allowedNextStudy.Contains(StudyStatus.SiteVisitScheduled)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CalendarMonth" 
                                                                   OnClick="OpenScheduleSiteVisitDialog">
                                                            Confirm Site Visit Scheduled
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @if (currentStatus == StudyStatus.SiteVisitScheduled && 
                                                 allowedNextStudy.Contains(StudyStatus.SiteVisitCompleted)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitCompleted))">
                                                            Mark Site Visit Complete
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @if (currentStatus == StudyStatus.SiteVisitCompleted && 
                                                 allowedNextStudy.Contains(StudyStatus.SiteVisitDataEntered)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Storage" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitDataEntered))">
                                                            Mark Data Entry Complete
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @* Funding Plan Phase - Request more financial info if data is incomplete *@
                                            @if ((currentStatus == StudyStatus.FundingPlanReady || 
                                                  currentStatus == StudyStatus.FundingPlanInProcess ||
                                                  currentStatus == StudyStatus.FundingPlanComplete) &&
                                                 allowedNextStudy.Contains(StudyStatus.FinancialInfoRequested)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Warning" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.Refresh" 
                                                                   OnClick="@(() => RequestMoreFinancialInfoAsync())">
                                                            Request More Financial Info
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }

                                            @* Funding Plan Phase - Go back to site data entry *@
                                            @if (currentStatus == StudyStatus.FundingPlanReady &&
                                                 allowedNextStudy.Contains(StudyStatus.SiteVisitDataEntered)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Secondary" 
                                                                   Size="Size.Medium"
                                                                   StartIcon="@Icons.Material.Filled.Edit" 
                                                                   OnClick="@(() => ApplyTransition(StudyStatus.SiteVisitDataEntered))">
                                                            Edit Site Visit Data
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @* Complete study *@
                                            @if (allowedNextStudy.Contains(StudyStatus.RequestCompleted)) {
                                                <AuthorizeView Policy="RequireTenantOwner">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="@(() => CompleteReserveStudyAsync(Id))">
                                                            Mark as Complete
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            
                                            @* Generic advance for other transitions *@
                                            @foreach (var nextAllowed in allowedNextStudy.Where(s => 
                                                s != StudyStatus.RequestCancelled &&
                                                s != StudyStatus.RequestApproved &&
                                                s != StudyStatus.ProposalCreated &&
                                                s != StudyStatus.ProposalSent &&
                                                s != StudyStatus.ProposalReviewed &&
                                                s != StudyStatus.ProposalApproved &&
                                                s != StudyStatus.ProposalUpdated &&
                                                s != StudyStatus.ProposalAccepted &&
                                                s != StudyStatus.FinancialInfoRequested &&
                                                s != StudyStatus.FinancialInfoReceived &&
                                                s != StudyStatus.ServiceContactsRequested &&
                                                s != StudyStatus.SiteVisitPending &&
                                                s != StudyStatus.SiteVisitScheduled &&
                                                s != StudyStatus.SiteVisitCompleted &&
                                                s != StudyStatus.SiteVisitDataEntered &&
                                                s != StudyStatus.RequestCompleted)) {
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Medium"
                                                                   StartIcon="@Icons.Material.Filled.ArrowForward" 
                                                                   OnClick="@(() => ApplyTransition(nextAllowed))">
                                                            @FormatStatusTitle(nextAllowed)
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                            @* HOA User: Accept Proposal button *@
                                            @if (currentStatus == StudyStatus.ProposalSent && !hasValidAcceptance) {
                                                <AuthorizeView Policy="RequireHOAUser">
                                                    <Authorized>
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Large"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle" 
                                                                   OnClick="OpenAcceptProposalDialog">
                                                            Accept Proposal
                                                        </MudButton>
                                                    </Authorized>
                                                </AuthorizeView>
                                            }
                                        </MudStack>
                                    }


                                    @* Proposal Details - only show before financial info stage *@
                                    @if (reserveStudy?.Proposal != null && currentStatus < StudyStatus.FinancialInfoRequested) {
                                        <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #10b981;">
                                            <MudCardContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                                    <MudIcon Icon="@Icons.Material.Filled.Description" Color="Color.Success" Size="Size.Large" />
                                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Proposal Details</MudText>
                                                </MudStack>
                                                <MudGrid Spacing="3">
                                                    <MudItem xs="12" md="6">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Scope</MudText>
                                                        <MudText Typo="Typo.body1">@reserveStudy.Proposal.ProposalScope</MudText>
                                                    </MudItem>
                                                    <MudItem xs="12" md="6">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Estimated Cost</MudText>
                                                        <MudText Typo="Typo.h5" Style="color: #10b981; font-weight: 700;">
                                                            $@reserveStudy.Proposal.EstimatedCost.ToString("N2")
                                                        </MudText>
                                                    </MudItem>
                                                    @if (!string.IsNullOrEmpty(reserveStudy.Proposal.Comments)) {
                                                        <MudItem xs="12">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Comments</MudText>
                                                            <MudText Typo="Typo.body2">@reserveStudy.Proposal.Comments</MudText>
                                                        </MudItem>
                                                    }
                                                </MudGrid>
                                            </MudCardContent>
                                        </MudCard>
                                    }

                                    @if (reserveStudy?.FinancialInfo != null) {
                                        <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #3b82f6;">
                                            <MudCardContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Info" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Financial Information</MudText>
                                                    </MudStack>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        @if (reserveStudy.FinancialInfo.DateSubmitted.HasValue) {
                                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                                Submitted @reserveStudy.FinancialInfo.DateSubmitted.Value.ToString("MMM dd, yyyy")
                                                            </MudChip>
                                                        }
                                                        @* HOA users can edit during review period *@
                                                        <AuthorizeView Policy="RequireHOAUser">
                                                            <Authorized>
                                                                @if (currentStatus <= StudyStatus.FinancialInfoReviewed) {
                                                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                                                   Color="Color.Primary" 
                                                                                   Size="Size.Small"
                                                                                   Href="@($"/ReserveStudies/{Id}/FinancialInfo")"
                                                                                   Title="Edit Financial Information" />
                                                                }
                                                            </Authorized>
                                                        </AuthorizeView>
                                                        @* Staff/Specialists see view-only button *@
                                                        <AuthorizeView Policy="RequireTenantStaff">
                                                            <Authorized>
                                                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                                               Color="Color.Default" 
                                                                               Size="Size.Small"
                                                                               Href="@($"/ReserveStudies/{Id}/FinancialInfo")"
                                                                               Title="View Financial Information" />
                                                            </Authorized>
                                                        </AuthorizeView>
                                                    </MudStack>
                                                </MudStack>

                                                @* Reserve Balances *@
                                                <MudText Typo="Typo.subtitle2" Class="mb-2 mt-3" Style="color: #666; font-weight: 600;">Reserve Balances</MudText>
                                                <MudGrid Spacing="2">
                                                    @if (reserveStudy.FinancialInfo.JanuaryFirstReserveBalance.HasValue) {
                                                        <MudItem xs="12" md="6">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Jan 1 Reserve Balance</MudText>
                                                            <MudText Typo="Typo.h6" Style="color: #3b82f6; font-weight: 700;">
                                                                $@reserveStudy.FinancialInfo.JanuaryFirstReserveBalance.Value.ToString("N2")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                    @if (reserveStudy.FinancialInfo.DecemberThirtyFirstReserveBalance.HasValue) {
                                                        <MudItem xs="12" md="6">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Expected Dec 31 Balance</MudText>
                                                            <MudText Typo="Typo.h6" Style="color: #3b82f6; font-weight: 700;">
                                                                $@reserveStudy.FinancialInfo.DecemberThirtyFirstReserveBalance.Value.ToString("N2")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                </MudGrid>

                                                @* Budgeted Contributions *@
                                                @if (reserveStudy.FinancialInfo.BudgetedContributionLastYear.HasValue || 
                                                     reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.HasValue ||
                                                     reserveStudy.FinancialInfo.BudgetedContributionNextYear.HasValue) {
                                                    <MudDivider Class="my-3" />
                                                    <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Budgeted Reserve Contributions</MudText>
                                                    <MudGrid Spacing="2">
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionLastYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Last Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionLastYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Current Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionCurrentYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                        @if (reserveStudy.FinancialInfo.BudgetedContributionNextYear.HasValue) {
                                                            <MudItem xs="12" md="4">
                                                                <MudText Typo="Typo.caption" Style="color: #888;">Next Year</MudText>
                                                                <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                    $@reserveStudy.FinancialInfo.BudgetedContributionNextYear.Value.ToString("N2")
                                                                </MudText>
                                                            </MudItem>
                                                        }
                                                    </MudGrid>
                                                }

                                                @* Community Details *@
                                                <MudDivider Class="my-3" />
                                                <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Community Details</MudText>
                                                <MudGrid Spacing="2">
                                                    @if (reserveStudy.FinancialInfo.TotalNumberOfUnits.HasValue) {
                                                        <MudItem xs="12" md="4">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Total Units</MudText>
                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                @reserveStudy.FinancialInfo.TotalNumberOfUnits.Value
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                    <MudItem xs="12" md="4">
                                                        <MudText Typo="Typo.caption" Style="color: #888;">Fiscal Year Start</MudText>
                                                        <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                            @System.Globalization.DateTimeFormatInfo.CurrentInfo.GetMonthName(reserveStudy.FinancialInfo.FiscalYearStartMonth)
                                                        </MudText>
                                                    </MudItem>
                                                    @if (reserveStudy.FinancialInfo.AnnualMeetingDate.HasValue) {
                                                        <MudItem xs="12" md="4">
                                                            <MudText Typo="Typo.caption" Style="color: #888;">Annual Meeting</MudText>
                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                @reserveStudy.FinancialInfo.AnnualMeetingDate.Value.ToString("MMM dd, yyyy")
                                                            </MudText>
                                                        </MudItem>
                                                    }
                                                </MudGrid>

                                                @* Staff-only sections *@
                                                <AuthorizeView Policy="RequireTenantStaff">
                                                    <Authorized>
                                                        @* Loans & Special Assessments *@
                                                        @if (reserveStudy.FinancialInfo.LoanAmount.HasValue || reserveStudy.FinancialInfo.SpecialAssessmentAmount.HasValue) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Loans & Assessments</MudText>
                                                            <MudGrid Spacing="2">
                                                                @if (reserveStudy.FinancialInfo.LoanAmount.HasValue) {
                                                                    <MudItem xs="12" md="6">
                                                                        <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px;">
                                                                            <MudText Typo="Typo.caption" Style="color: #888;">Current Loan</MudText>
                                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                                $@reserveStudy.FinancialInfo.LoanAmount.Value.ToString("N2")
                                                                            </MudText>
                                                                            @if (reserveStudy.FinancialInfo.LoanBalanceRemaining.HasValue) {
                                                                                <MudText Typo="Typo.caption">Balance: $@reserveStudy.FinancialInfo.LoanBalanceRemaining.Value.ToString("N2")</MudText>
                                                                            }
                                                                        </MudPaper>
                                                                    </MudItem>
                                                                }
                                                                @if (reserveStudy.FinancialInfo.SpecialAssessmentAmount.HasValue) {
                                                                    <MudItem xs="12" md="6">
                                                                        <MudPaper Elevation="1" Class="pa-3" Style="border-radius: 8px;">
                                                                            <MudText Typo="Typo.caption" Style="color: #888;">Special Assessment</MudText>
                                                                            <MudText Typo="Typo.body1" Style="font-weight: 600;">
                                                                                $@reserveStudy.FinancialInfo.SpecialAssessmentAmount.Value.ToString("N2")
                                                                            </MudText>
                                                                            @if (reserveStudy.FinancialInfo.SpecialAssessmentBalanceRemaining.HasValue) {
                                                                                <MudText Typo="Typo.caption">Balance: $@reserveStudy.FinancialInfo.SpecialAssessmentBalanceRemaining.Value.ToString("N2")</MudText>
                                                                            }
                                                                        </MudPaper>
                                                                    </MudItem>
                                                                }
                                                            </MudGrid>
                                                        }

                                                        @* Planned Projects *@
                                                        @if (!string.IsNullOrEmpty(reserveStudy.FinancialInfo.PlannedProjects)) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Planned Projects</MudText>
                                                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@reserveStudy.FinancialInfo.PlannedProjects</MudText>
                                                        }

                                                        @* Building Components *@
                                                        @if (!string.IsNullOrEmpty(reserveStudy.FinancialInfo.BuildingRoofSidingInfo)) {
                                                            <MudDivider Class="my-3" />
                                                            <MudText Typo="Typo.subtitle2" Class="mb-2" Style="color: #666; font-weight: 600;">Building Components</MudText>
                                                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@reserveStudy.FinancialInfo.BuildingRoofSidingInfo</MudText>
                                                        }
                                                    </Authorized>
                                                </AuthorizeView>
                                            </MudCardContent>
                                        </MudCard>
                                    }

                                    @* Site Visit Information - show when scheduled or completed *@
                                    @if (reserveStudy?.SiteVisitDate.HasValue == true || 
                                         currentStatus >= StudyStatus.SiteVisitScheduled) {
                                        <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #8b5cf6;">
                                            <MudCardContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.HomeWork" Style="color: #8b5cf6;" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Site Visit</MudText>
                                                    </MudStack>
                                                    @if (currentStatus >= StudyStatus.SiteVisitCompleted) {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                                            Completed
                                                        </MudChip>
                                                    } else if (currentStatus == StudyStatus.SiteVisitScheduled) {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Icon="@Icons.Material.Filled.Event">
                                                            Scheduled
                                                        </MudChip>
                                                    }
                                                </MudStack>
                                                
                                                @if (reserveStudy?.SiteVisitDate.HasValue == true) {
                                                    <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-radius: 8px;">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                                            <MudAvatar Size="Size.Large" Style="background: #8b5cf6; color: white;">
                                                                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
                                                            </MudAvatar>
                                                            <div>
                                                                <MudText Typo="Typo.caption" Style="color: #8b5cf6; font-weight: 600; text-transform: uppercase;">
                                                                    Scheduled Date
                                                                </MudText>
                                                                <MudText Typo="Typo.h5" Style="font-weight: 700; color: #5b21b6;">
                                                                    @reserveStudy.SiteVisitDate.Value.ToString("dddd, MMMM dd, yyyy")
                                                                </MudText>
                                                            </div>
                                                        </MudStack>
                                                    </MudPaper>
                                                    
                                                    @* Allow rescheduling if not yet completed *@
                                                    @if (currentStatus < StudyStatus.SiteVisitCompleted) {
                                                        <AuthorizeView Policy="RequireTenantStaff">
                                                            <Authorized>
                                                                <MudButton Variant="Variant.Text" 
                                                                           Color="Color.Primary" 
                                                                           Size="Size.Small"
                                                                           StartIcon="@Icons.Material.Filled.Edit"
                                                                           OnClick="OpenScheduleSiteVisitDialog"
                                                                           Class="mt-2">
                                                                    Reschedule
                                                                </MudButton>
                                                            </Authorized>
                                                        </AuthorizeView>
                                                    }
                                                } else {
                                                    <MudAlert Severity="Severity.Info" Dense="true">
                                                        Site visit date will be displayed once scheduled.
                                                    </MudAlert>
                                                }
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Information Tab -->
                        <MudTabPanel Text="Contact Information" Icon="@Icons.Material.Filled.Contacts">
                            <MudCard Elevation="0">
                                <MudCardContent>
                                    <MudGrid Spacing="4">
                                        <!-- Contact Information -->
                                        <MudItem xs="12">
                                            <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; border-left: 4px solid #667eea;">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                                    <MudIcon Icon="@Icons.Material.Filled.Person" Color="Color.Primary" Size="Size.Large" />
                                                    <MudText Typo="Typo.h6" Style="font-weight: 600;">Primary Contact</MudText>
                                                </MudStack>
                                                <MudGrid Spacing="2">
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Name</MudText>
                                                        <MudText Typo="Typo.body1">@reserveStudy.Contact?.FullNameInverted</MudText>
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Phone</MudText>
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Primary" />
                                                            <MudLink Href="@($"tel:{reserveStudy.Contact?.Phone}")" Typo="Typo.body1">
                                                                @reserveStudy.Contact?.Phone
                                                            </MudLink>
                                                        </MudStack>
                                                        @if (!string.IsNullOrEmpty(reserveStudy.Contact?.Extension)) {
                                                            <MudText Typo="Typo.caption">Ext: @reserveStudy.Contact?.Extension</MudText>
                                                        }
                                                    </MudItem>
                                                    <MudItem xs="12" sm="4">
                                                        <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Email</MudText>
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Primary" />
                                                            <MudLink Href="@($"mailto:{reserveStudy.Contact?.Email}")" Typo="Typo.body1">
                                                                @reserveStudy.Contact?.Email
                                                            </MudLink>
                                                        </MudStack>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudPaper>
                                        </MudItem>
                                        <!-- Property Manager Information -->
                                        @if (reserveStudy.PropertyManager != null) {
                                            <MudItem xs="12">
                                                <MudPaper Elevation="2" Class="pa-4" Style="border-radius: 12px; border-left: 4px solid #10b981;">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                                                        <MudIcon Icon="@Icons.Material.Filled.Business" Color="Color.Success" Size="Size.Large" />
                                                        <MudText Typo="Typo.h6" Style="font-weight: 600;">Management Company</MudText>
                                                    </MudStack>
                                                    <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Company Name</MudText>
                                                    <MudText Typo="Typo.h6" Class="mb-3">@reserveStudy.PropertyManager.CompanyName</MudText>
                                                    <MudGrid Spacing="2">
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Manager Name</MudText>
                                                            <MudText Typo="Typo.body1">@reserveStudy.PropertyManager.FullNameInverted</MudText>
                                                        </MudItem>
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Phone</MudText>
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Success" />
                                                                <MudLink Href="@($"tel:{reserveStudy.PropertyManager?.Phone}")" Typo="Typo.body1">
                                                                    @reserveStudy.PropertyManager?.Phone
                                                                </MudLink>
                                                            </MudStack>
                                                            @if (!string.IsNullOrEmpty(reserveStudy.PropertyManager?.Extension)) {
                                                                <MudText Typo="Typo.caption">Ext: @reserveStudy.PropertyManager?.Extension</MudText>
                                                            }
                                                        </MudItem>
                                                        <MudItem xs="12" sm="4">
                                                            <MudText Typo="Typo.caption" Style="color: #666; font-weight: 600;">Email</MudText>
                                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                                <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Success" />
                                                                <MudLink Href="@($"mailto:{reserveStudy.PropertyManager?.Email}")" Typo="Typo.body1">
                                                                    @reserveStudy.PropertyManager?.Email
                                                                </MudLink>
                                                            </MudStack>
                                                        </MudItem>
                                                    </MudGrid>
                                                </MudPaper>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudTabPanel>
                        <!-- Elements Tab -->
                        <MudTabPanel Text="Property Elements" Icon="@Icons.Material.Filled.Apartment">
                            @if (isElementsLoading) {
                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
                                <MudText Typo="Typo.body2" Align="Align.Center" Style="color: #666;">
                                    Loading property elements...
                                </MudText>
                            } else if (elementsLoaded && GetAllElements().Any()) {
                                <MudCard Elevation="0">
                                    <MudCardContent>
                                        <MudTable Dense="true" Hover="true" Elevation="0" Items="@GetAllElements()"
                                                  GroupBy="@_groupDefinition"
                                                  GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
                                                  GroupFooterClass="mb-4">
                                            <ColGroup>
                                                <col style="width:10%;" />
                                                <col style="width:50%;" />
                                                <col style="width:20%;" />
                                                <col style="width:20%;" />
                                            </ColGroup>
                                            <HeaderContent>
                                                <MudTh></MudTh>
                                                <MudTh>Name</MudTh>
                                                <MudTh>Requires Service Contact</MudTh>
                                                <MudTh class="text-end">Amount</MudTh>
                                            </HeaderContent>
                                            <GroupHeaderTemplate Context="headerContext">
                                                <MudTh colspan="4">@GetGroupName(headerContext)</MudTh>
                                            </GroupHeaderTemplate>
                                            <RowTemplate Context="rowContext">
                                                <MudTd>
                                                    <MudIconButton Icon="@((rowContext.ShowDetails == true) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" OnClick="@(() => ShowElement(rowContext))" />
                                                </MudTd>
                                                <MudTd>
                                                    <MudText Typo="Typo.body1">@rowContext.Name</MudText>
                                                </MudTd>
                                                <MudTd>
                                                    <MudCheckBox T="bool" Value="@rowContext.NeedsService" Color="Color.Success" UncheckedColor="Color.Error" ReadOnly="true" />
                                                </MudTd>
                                                <MudTd class="text-end">
                                                    <MudText Typo="Typo.body1">@rowContext.Count</MudText>
                                                </MudTd>
                                            </RowTemplate>
                                            <ChildRowContent Context="childContext">
                                                @if (childContext.ShowDetails) {
                                                    <MudTd colspan="4">
                                                        <MudGrid>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Measurement Type" Value="@childContext.MeasurementOption?.DisplayText" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Last Replaced" Value="@(childContext.LastServiced?.ToString("MM/dd/yyyy") ?? "N/A")" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Useful Life" Value="@childContext.UsefulLifeOption?.DisplayText" />
                                                            </MudItem>
                                                            <MudItem xs="3">
                                                                <LabeledField Label="Remaining Life" Value="@childContext.RemainingLifeOption?.DisplayText" />
                                                            </MudItem>
                                                        </MudGrid>
                                                    </MudTd>
                                                }
                                            </ChildRowContent>
                                            <GroupFooterTemplate Context="footerContext">
                                                <MudTh colspan="4">Total: @footerContext.Items.Count()</MudTh>
                                            </GroupFooterTemplate>
                                        </MudTable>
                                    </MudCardContent>
                                </MudCard>
                            } else if (!elementsLoaded) {
                                <MudText Typo="Typo.body2" Class="mt-4">Elements will load when this tab is selected.</MudText>
                            } else {
                                <MudText Typo="Typo.body1" Class="mt-4">@( "No elements available (" + GetAllElements().Count() + ")" )</MudText>
                            }
                        </MudTabPanel>
                        <!-- Service Contacts Tab -->
                        <MudTabPanel Text="Service Contacts" Icon="@Icons.Material.Filled.ContactPhone">
                            @if (isContactsLoading) {
                                <MudProgressLinear Color="Color.Secondary" Indeterminate="true" Class="my-4" />
                            } else if (serviceContactsLoaded && elementsWithServiceContact.Any()) {
                                <MudExpansionPanels>
                                    @foreach (var element in elementsWithServiceContact) {
                                        <MudExpansionPanel>
                                            <TitleContent>
                                                <div class="d-flex">
                                                    @if (element.ServiceContact?.Phone == null || element.ServiceContact?.Email == null) {
                                                        <MudIcon Color="Color.Warning" Icon="@MaterialSymbols.Outlined.Warning"></MudIcon>
                                                    }
                                                    <MudText>@element.Name</MudText>
                                                </div>
                                            </TitleContent>
                                            <ChildContent>
                                                <MudGrid>
                                                    <MudItem xs="12">
                                                        <LabeledField Label="Company Name" Value="@element.ServiceContact?.CompanyName" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12">
                                                        <LabeledField Label="Point Of Contact" Value="@element.ServiceContact?.FullNameInverted" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <LabeledField Label="Phone" Value="@element.ServiceContact?.Phone" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12" sm="6">
                                                        <LabeledField Label="Extension" Value="@element.ServiceContact?.Extension" CustomClass="border-b-2 border-solid mud-border-primary" />
                                                    </MudItem>
                                                    <MudItem xs="12">
                                                        <MudLink Href="@($"mailto:{element.ServiceContact?.Email}")">
                                                            @element.ServiceContact?.Email
                                                        </MudLink>
                                                    </MudItem>
                                                </MudGrid>
                                            </ChildContent>
                                        </MudExpansionPanel>
                                    }
                                </MudExpansionPanels>
                            } else if (!serviceContactsLoaded) {
                                <MudText Typo="Typo.body2" Class="mt-4">Service contacts will load when this tab is selected.</MudText>
                            } else {
                                <MudText Typo="Typo.body1" Class="mt-4">No service contacts available.</MudText>
                            }
                        </MudTabPanel>
                        <!-- Site Visit Photos Tab -->
                            <MudTabPanel Text="Site Photos" Icon="@Icons.Material.Filled.PhotoCamera">
                                <SiteVisitPhotoGallery ReserveStudyId="@Id" CanEdit="@canEditPhotos" />
                            </MudTabPanel>
                            <!-- Study Notes Tab -->
                            <MudTabPanel Text="Notes" Icon="@Icons.Material.Filled.Notes">
                                <CRS.Components.Shared.StudyNotes.StudyNotesPanel ReserveStudyId="@Id" />
                            </MudTabPanel>
                            <!-- Generated Reports Tab -->
                                <MudTabPanel Text="Reports" Icon="@Icons.Material.Filled.Description">
                                    <CRS.Components.Shared.GeneratedReports.GeneratedReportsPanel ReserveStudyId="@Id" />
                                </MudTabPanel>
                                <!-- Proposal Acceptance Tab -->
                                <MudTabPanel Text="Acceptance" Icon="@Icons.Material.Filled.Verified">
                                    <MudStack Spacing="4">
                                        <CRS.Components.Shared.ProposalAcceptance.AcceptanceConfirmationPanel 
                                            @ref="acceptancePanel" 
                                            ReserveStudyId="@Id" />
                                    
                                        @if (reserveStudy?.CurrentStatus >= StudyStatus.ProposalSent && 
                                             reserveStudy?.CurrentStatus < StudyStatus.ProposalAccepted &&
                                             !hasValidAcceptance)
                                        {
                                            <AuthorizeView Policy="RequireHOAUser">
                                                <Authorized>
                                                    <MudButton Variant="Variant.Filled"
                                                               Color="Color.Success"
                                                               Size="Size.Large"
                                                               StartIcon="@Icons.Material.Filled.CheckCircle"
                                                               OnClick="OpenAcceptProposalDialog"
                                                               FullWidth="true">
                                                        Accept Proposal
                                                    </MudButton>
                                                </Authorized>
                                            </AuthorizeView>
                                        }
                                    </MudStack>
                                </MudTabPanel>
                                <!-- Scope Comparison Tab -->
                                <MudTabPanel Text="Scope" Icon="@Icons.Material.Filled.CompareArrows">
                                    <CRS.Components.Shared.ScopeComparison.ScopeVariancePanel 
                                        ReserveStudyId="@Id" 
                                        TenantId="@(reserveStudy?.TenantId ?? 0)" />
                                </MudTabPanel>
                            </MudTabs>
                </MudItem>
            </MudGrid>
        </MudContainer>
    }
</MudContainer>
@code {
[Parameter]
public Guid Id { get; set; }

private ReserveStudy? reserveStudy;
private bool isLoading = true;
private bool isElementsLoading = false;
private bool isContactsLoading = false;
private bool elementsLoaded = false;
private bool serviceContactsLoaded = false;
private bool canEdit = false;
private bool canStaffEdit = false;
private bool canEditPhotos = false;
private List<IReserveStudyElement> elementsWithServiceContact = new();
private int activeTabIndex = 0;

private CRS.Components.Shared.ProposalAcceptance.AcceptanceConfirmationPanel? acceptancePanel;
private bool hasValidAcceptance = false;

    private List<StudyStatus> allowedNextStudy = new();

    private List<StudyStatusHistory> statusHistory = new();

    // Timeline items data
    private readonly List<TimelineItemInfo> timelineItems = new();

    // Complete workflow status order matching the 32-stage workflow
    private static readonly StudyStatus[] WorkflowStatusOrder = new[] {
        StudyStatus.RequestCreated,
        StudyStatus.RequestApproved,
        StudyStatus.ProposalCreated,
        StudyStatus.ProposalReviewed,
        StudyStatus.ProposalUpdated,
        StudyStatus.ProposalApproved,
        StudyStatus.ProposalSent,
        StudyStatus.ProposalAccepted,
        StudyStatus.ServiceContactsRequested,
        StudyStatus.FinancialInfoRequested,
        StudyStatus.FinancialInfoInProgress,
        StudyStatus.FinancialInfoSubmitted,
        StudyStatus.FinancialInfoReviewed,
        StudyStatus.FinancialInfoReceived,
        StudyStatus.SiteVisitPending,
        StudyStatus.SiteVisitScheduled,
        StudyStatus.SiteVisitCompleted,
        StudyStatus.SiteVisitDataEntered,
        StudyStatus.FundingPlanReady,
        StudyStatus.FundingPlanInProcess,
        StudyStatus.FundingPlanComplete,
        StudyStatus.NarrativeReady,
        StudyStatus.NarrativeInProcess,
        StudyStatus.NarrativeComplete,
        StudyStatus.NarrativePrintReady,
        StudyStatus.NarrativePackaged,
        StudyStatus.NarrativeSent,
        StudyStatus.ReportReady,
        StudyStatus.ReportInProcess,
        StudyStatus.ReportComplete,
        StudyStatus.RequestCompleted,
        StudyStatus.RequestCancelled,
        StudyStatus.RequestArchived
    };

    // Key milestones shown to users (subset of full workflow)
    private static readonly StudyStatus[] KeyMilestones = new[] {
        StudyStatus.RequestCreated,
        StudyStatus.ProposalApproved,
        StudyStatus.ProposalSent,
        StudyStatus.ProposalAccepted,
        StudyStatus.FinancialInfoSubmitted,
        StudyStatus.SiteVisitCompleted,
        StudyStatus.ReportComplete,
        StudyStatus.RequestCompleted
    };

    // Rank map for status ordering
    private static readonly Dictionary<StudyStatus, int> StatusRank =
        WorkflowStatusOrder
        .Select((s, idx) => new { s, idx })
        .ToDictionary(x => x.s, x => x.idx);

    protected override async Task OnInitializedAsync() {
        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
        await CheckAcceptanceStatus();
    }

    private async Task CheckAcceptanceStatus() {
        try {
            hasValidAcceptance = await AcceptanceService.HasValidAcceptanceAsync(Id);
        } catch {
            hasValidAcceptance = false;
        }
    }

    private async Task OpenAcceptProposalDialog() {
        if (reserveStudy == null) return;

        var parameters = new DialogParameters {
            ["ReserveStudy"] = reserveStudy,
            ["ProposalId"] = reserveStudy.Proposal?.Id
        };

        var options = new DialogOptions {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<CRS.Components.Shared.ProposalAcceptance.ProposalAcceptanceDialog>(
            "Accept Proposal", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled) {
            hasValidAcceptance = true;
    
            // Advance workflow to ProposalAccepted if applicable
            if (allowedNextStudy.Contains(StudyStatus.ProposalAccepted)) {
                await ApplyTransition(StudyStatus.ProposalAccepted);
                
                // Automatically request financial information after proposal acceptance
                await RequestFinancialInfoAsync(Id);
                Snackbar.Add("Proposal accepted! Financial information request sent to client.", Severity.Success);
                
                // Reload to reflect the new FinancialInfoRequested status
                await ReloadAfterChange();
            } else {
                // Still reload the page to show updated acceptance status
                await ReloadAfterChange();
                Snackbar.Add("Proposal accepted successfully!", Severity.Success);
            }
    
            // Refresh acceptance panel only if it has been rendered
            if (acceptancePanel != null) {
                await acceptancePanel.RefreshAsync();
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        // Ensure data loads when tab becomes visible even if the change event didn't trigger in time
        try {
            if (activeTabIndex == 2) {
                await LoadElementsDataIfNeeded();
            } else if (activeTabIndex == 3) {
                await LoadServiceContactsIfNeeded();
            }
        } catch { /* swallow render-time exceptions, surfaced via Snackbar inside loaders */ }
    }

    private void InitializeTimelineItems() {
        timelineItems.Clear();

        // Map history entries by status for date/actor
        var historyByStatus = statusHistory
            .GroupBy(h => h.ToStatus)
            .ToDictionary(g => g.Key, g => new { First = g.OrderBy(x => x.ChangedAt).First(), Last = g.OrderBy(x => x.ChangedAt).Last() });

        // Build status order from timeline order, de-duplicated while preserving order
        var statusOrder = new List<StudyStatus>();
        var seen = new HashSet<StudyStatus>();
        foreach (var st in WorkflowStatusOrder) {
            if (seen.Add(st)) statusOrder.Add(st);
        }

        // Reduce to milestone-only in the order we want
        var milestonesToShow = KeyMilestones.Where(m => statusOrder.Contains(m)).ToList();

        // If cancelled/archived occurred, append as terminal markers
        if (statusOrder.Contains(StudyStatus.RequestCancelled))
            milestonesToShow.Add(StudyStatus.RequestCancelled);
        if (statusOrder.Contains(StudyStatus.RequestArchived))
            milestonesToShow.Add(StudyStatus.RequestArchived);

        foreach (var status in milestonesToShow) {
            // Prevent duplicates defensively
            if (timelineItems.Any(t => t.Status == status))
                continue;

            var hasHist = historyByStatus.TryGetValue(status, out var hist);
            // Choose earliest for "start" type, latest for decision/delivery type
            var useLast = status == StudyStatus.ProposalSent
                || status == StudyStatus.ProposalAccepted
                || status == StudyStatus.FinancialInfoRequested
                || status == StudyStatus.SiteVisitScheduled
                || status == StudyStatus.ReportComplete
                || status == StudyStatus.FundingPlanComplete
                || status == StudyStatus.NarrativeSent
                || status == StudyStatus.RequestArchived
                || status == StudyStatus.RequestCancelled;
            DateTime? date = hasHist ? (useLast ? hist!.Last.ChangedAt.LocalDateTime : hist!.First.ChangedAt.LocalDateTime) : GetFallbackDate(status);
            var actor = hasHist ? (useLast ? hist!.Last.ChangedBy : hist!.First.ChangedBy) : null;

            timelineItems.Add(new TimelineItemInfo {
                Status = status,
                DateValue = date,
                Title = FormatStatusTitle(status),
                Actor = actor,
                IsHidden = false
            });
        }
    }

    private DateTime? GetFallbackDate(StudyStatus status) {
        // Fallback dates for key milestones only
        if (status == StudyStatus.RequestCreated) return reserveStudy?.DateCreated;
        if (status == StudyStatus.ProposalCreated || status == StudyStatus.ProposalSent) return reserveStudy?.Proposal?.DateSent;
        if (status == StudyStatus.ProposalApproved || status == StudyStatus.ProposalAccepted) return reserveStudy?.Proposal?.DateApproved;
        if (status == StudyStatus.FinancialInfoRequested) return reserveStudy?.FinancialInfo?.DateCreated;
        if (status == StudyStatus.FinancialInfoSubmitted) return reserveStudy?.FinancialInfo?.DateSubmitted;
        if (status == StudyStatus.FinancialInfoReviewed) return reserveStudy?.FinancialInfo?.DateReviewed;
        if (status == StudyStatus.SiteVisitCompleted) return reserveStudy?.DateModified;
        if (status == StudyStatus.ReportComplete) return reserveStudy?.DateModified;
        if (status == StudyStatus.FundingPlanReady) return reserveStudy?.DateModified;
        if (status == StudyStatus.RequestArchived) return reserveStudy?.DateModified;
        if (status == StudyStatus.RequestCancelled) return reserveStudy?.DateModified;
        return null;
    }

    private static string FormatStatusTitle(StudyStatus status) {
        var name = Enum.GetName(typeof(StudyStatus), status) ?? status.ToString();
        // Insert spaces before capital letters and between letter-number boundaries
        var withSpaces = System.Text.RegularExpressions.Regex.Replace(name, "(?<=[a-z])([A-Z])", " $1");
        withSpaces = System.Text.RegularExpressions.Regex.Replace(withSpaces, "([A-Za-z])(\\d)", "$1 $2");
        return withSpaces.Trim();
    }

    private async Task LoadInitialData() {
        try {
            isLoading = true;
            await UserState.InitializeAsync();

            using var context = await DbFactory.CreateDbContextAsync();
            reserveStudy = await context.ReserveStudies
                .AsNoTracking()
                .Include(rs => rs.Community).ThenInclude(c => c.PhysicalAddress)
                .Include(rs => rs.Contact)
                .Include(rs => rs.PropertyManager)
                .Include(rs => rs.Specialist)
                .Include(rs => rs.Proposal)
                .Include(rs => rs.FinancialInfo)
                .Include(rs => rs.StudyRequest)
                .AsSplitQuery()
                .FirstOrDefaultAsync(rs => rs.Id == Id);

            if (reserveStudy == null) {
                return; // Will show not found message
            }

            // Authorization check: HOA users can only see their own studies
            var isHOAUser = UserState.UserRoles?.Any(r => r == "HOAUser" || r == "HOAAuditor") ?? false;
            var isStaff = UserState.UserRoles?.Any(r => r == "TenantOwner" || r == "TenantSpecialist" || r == "TenantViewer" || r == "PlatformAdmin") ?? false;
            var currentUserId = UserState.CurrentUser?.Id;

            if (isHOAUser && !isStaff) {
                // HOA users can only view their own studies
                if (reserveStudy.ApplicationUserId != currentUserId) {
                    Snackbar.Add("You don't have permission to view this reserve study.", Severity.Error);
                    reserveStudy = null;
                    return;
                }
            }

            // Load workflow history used for timeline
            statusHistory = await context.StudyStatusHistories
                .AsNoTracking()
                .Where(h => h.RequestId == Id)
                .OrderBy(h => h.ChangedAt)
                .ToListAsync();

            // Check if HOA user can edit this study
            if (reserveStudy != null) {
                canEdit = ReserveStudyService.CanUpdateReserveStudy(reserveStudy) && 
                          UserState.CurrentUser?.Id == reserveStudy.ApplicationUserId;
                
                // Staff can edit at any time before completion
                canStaffEdit = isStaff && ReserveStudyService.CanStaffUpdateReserveStudy(reserveStudy);
                
                // Photos can be edited by staff (specialists, owners, admins) only
                canEditPhotos = isStaff;
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error loading reserve study: {ex.Message}", Severity.Error);
        } finally {
            isLoading = false;
        }
    }

    private async Task LoadElementsDataIfNeeded() {
        if (elementsLoaded || isElementsLoading || reserveStudy == null)
            return;

        try {
            isElementsLoading = true;

            using var context = await DbFactory.CreateDbContextAsync();

            // Load each type of element separately with their relationships
            var buildingElements = await context.ReserveStudyBuildingElements
                .AsNoTracking()
                .Where(be => be.ReserveStudyId == Id)
                .Include(be => be.BuildingElement)
                .Include(be => be.MeasurementOption)
                .Include(be => be.UsefulLifeOption)
                .Include(be => be.RemainingLifeOption)
                .ToListAsync();

            var commonElements = await context.ReserveStudyCommonElements
                .AsNoTracking()
                .Where(ce => ce.ReserveStudyId == Id)
                .Include(ce => ce.CommonElement)
                .Include(ce => ce.MeasurementOption)
                .Include(ce => ce.UsefulLifeOption)
                .Include(ce => ce.RemainingLifeOption)
                .ToListAsync();

            var additionalElements = await context.ReserveStudyAdditionalElements
                .AsNoTracking()
                .Where(ae => ae.ReserveStudyId == Id)
                .Include(ae => ae.MeasurementOption)
                .Include(ae => ae.UsefulLifeOption)
                .Include(ae => ae.RemainingLifeOption)
                .ToListAsync();

            if (reserveStudy != null) {
                // Assign loaded data
                reserveStudy.ReserveStudyBuildingElements = buildingElements;
                reserveStudy.ReserveStudyCommonElements = commonElements;
                reserveStudy.ReserveStudyAdditionalElements = additionalElements;
            }

            elementsLoaded = true;
        } catch (Exception ex) {
            Snackbar.Add($"Error loading elements data: {ex.Message}", Severity.Error);
        } finally {
            isElementsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadServiceContactsIfNeeded() {
        if (serviceContactsLoaded || isContactsLoading || reserveStudy == null)
            return;

        try {
            isContactsLoading = true;

            // First load elements data if not already loaded
            if (!elementsLoaded) {
                await LoadElementsDataIfNeeded();
            }

            // Now load service contacts
            using var context = await DbFactory.CreateDbContextAsync();

            // Load building elements with service contacts and BuildingElement for NeedsService check
            var buildingElementContacts = await context.ReserveStudyBuildingElements
                .AsNoTracking()
                .Where(be => be.ReserveStudyId == Id)
                .Include(be => be.BuildingElement)
                .Include(be => be.ServiceContact)
                .ToListAsync();

            // Load common elements with service contacts and CommonElement for NeedsService check
            var commonElementContacts = await context.ReserveStudyCommonElements
                .AsNoTracking()
                .Where(ce => ce.ReserveStudyId == Id)
                .Include(ce => ce.CommonElement)
                .Include(ce => ce.ServiceContact)
                .ToListAsync();

            // Load additional elements with service contacts (NeedsService is stored directly)
            var additionalElementContacts = await context.ReserveStudyAdditionalElements
                .AsNoTracking()
                .Where(ae => ae.ReserveStudyId == Id)
                .Include(ae => ae.ServiceContact)
                .ToListAsync();

            // Find matching elements in the loaded elements and update their service contacts
            // NeedsService filter now works because BuildingElement/CommonElement are loaded
            foreach (var element in buildingElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyBuildingElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            foreach (var element in commonElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyCommonElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            foreach (var element in additionalElementContacts.Where(e => e.NeedsService)) {
                var match = reserveStudy.ReserveStudyAdditionalElements?.FirstOrDefault(e => e.Id == element.Id);
                if (match != null) {
                    match.ServiceContact = element.ServiceContact;
                }
            }

            // Update the list of elements with service contacts
            elementsWithServiceContact = GetAllElements().Where(e => e.NeedsService).ToList();

            serviceContactsLoaded = true;
        } catch (Exception ex) {
            Snackbar.Add($"Error loading service contacts: {ex.Message}", Severity.Error);
        } finally {
            isContactsLoading = false;
            StateHasChanged();
        }
    }

    private string GetUpdateLink() => $"/ReserveStudies/{reserveStudy?.Id}/Update";

    private void HandleTabChange(int index) {
        activeTabIndex = index;

        // Load data based on selected tab
        switch (index) {
            case 2: // Elements tab
                _ = LoadElementsDataIfNeeded();
                break;
            case 3: // Service Contacts tab
                _ = LoadServiceContactsIfNeeded();
                break;
        }
    }

    private async Task SendRequestLink() {
        await ExecuteActionAsync(
            async () => {
                var createdEvent = new ReserveStudyCreatedEvent(reserveStudy);
                await _dispatcher.Broadcast<ReserveStudyCreatedEvent>(createdEvent);
                return true;
            },
            "Request link sent successfully!",
            "Failed to send request link"
        );
    }

    private async Task SendAccessTokenLink() {
        await ExecuteActionAsync(
            async () => {
                // Email logic would go here
                return true;
            },
            "Request link sent successfully!",
            "Failed to send access token link"
        );
    }

    private void ShowElement(IReserveStudyElement element) {
        element.ShowDetails = !element.ShowDetails;
    }

    private TableGroupDefinition<IReserveStudyElement> _groupDefinition = new() {
        GroupName = "Element Type",
        Indentation = false,
        Expandable = false,
        Selector = (element) => element.ElementType
    };

    private string GetGroupName(TableGroupData<object, IReserveStudyElement> headerContext) => $"{headerContext.GroupName}: {headerContext.Key}";

    private async Task<bool> ExecuteActionAsync(Func<Task<bool>> action, string successMessage, string failureMessage) {
        try {
            var result = await action();
            if (result) {
                Snackbar.Add(successMessage, Severity.Success);
                return true;
            } else {
                Snackbar.Add(failureMessage, Severity.Error);
                return false;
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            return false;
        }
    }

    private async Task ApproveProposalAsync(Guid studyId) {
        if (reserveStudy?.Proposal == null) return;

        var success = await ExecuteActionAsync(
            async () => {
                var currentUser = UserState.CurrentUser?.UserName ?? "system";
                return await WorkflowService.ApproveProposalAsync(reserveStudy.Proposal.Id, currentUser);
            },
            "Proposal approved successfully",
            "Failed to approve proposal"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task RequestFinancialInfoAsync(Guid studyId) {
        await ExecuteActionAsync(
            async () => await WorkflowService.RequestFinancialInfoAsync(studyId),
            "Financial information requested successfully",
            "Failed to request financial information"
        );
    }

    /// <summary>
    /// Request more financial info when data is incomplete during funding plan phase.
    /// Shows a confirmation dialog explaining this will move the study back to data collection.
    /// </summary>
    private async Task RequestMoreFinancialInfoAsync() {
        var confirmed = await DialogService.ShowMessageBox(
            "Request More Financial Information",
            new MarkupString(@"
                <p>This will move the study back to the <strong>Data Collection</strong> phase to request additional financial information from the client.</p>
                <p>The client will receive an email notification with a link to update their financial information.</p>
                <p><strong>Current progress in the Funding Plan phase will be preserved.</strong></p>
            "),
            yesText: "Yes, Request More Info",
            cancelText: "Cancel");

        if (confirmed != true) return;

        var success = await ExecuteActionAsync(
            async () => await WorkflowService.RequestFinancialInfoAsync(Id),
            "Financial information request sent to client. Study moved back to Data Collection phase.",
            "Failed to request additional financial information"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task ReviewFinancialInfoAsync(Guid studyId) {
        if (reserveStudy?.FinancialInfo == null) return;

        var success = await ExecuteActionAsync(
            async () => {
                var currentUser = UserState.CurrentUser?.UserName ?? "system";
                return await WorkflowService.ReviewFinancialInfoAsync(reserveStudy.FinancialInfo.Id, currentUser);
            },
            "Financial information reviewed successfully",
            "Failed to review financial information"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task CompleteReserveStudyAsync(Guid studyId) {
        var success = await ExecuteActionAsync(
            async () => await WorkflowService.CompleteReserveStudyAsync(studyId),
            "Reserve study completed successfully",
            "Failed to complete reserve study"
        );

        if (success) await ReloadAfterChange();
    }

    private async Task SendProposalAsync(Guid studyId) {
        if (reserveStudy == null) return;

        // If no proposal exists yet, navigate to the proposal creation page
        if (reserveStudy.Proposal == null) {
            NavigationManager.NavigateTo($"/ReserveStudies/{studyId}/Proposal");
        } else {
            // If proposal already exists, try to transition to ProposalPendingESign
            try {
                await ApplyTransition(StudyStatus.ProposalSent);
            } catch (Exception ex) {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task SubmitFinancialInfoAsync(Guid studyId) {
        if (reserveStudy == null) return;

        try {
            if (reserveStudy.FinancialInfo == null) {
                var financialInfo = new Models.FinancialInfo {
                    ReserveStudyId = reserveStudy.Id,
                    CurrentReserveFundBalance = 50000.00m,
                    AnnualContribution = 10000.00m,
                    ProjectedAnnualExpenses = 12000.00m,
                    FiscalYearStartMonth = 1, // January
                    Comments = "Test financial info created automatically",
                    DateSubmitted = DateTime.Now
                };

                var result = await WorkflowService.SubmitFinancialInfoAsync(Id, financialInfo);
                if (result) {
                    Snackbar.Add("Financial information submitted successfully", Severity.Success);
                    await ReloadAfterChange();
                } else {
                    Snackbar.Add("Failed to submit financial information", Severity.Error);
                }
            } else {
                await ApplyTransition(StudyStatus.FinancialInfoSubmitted);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAllowedTransitions() {
        try {
            var studyAllowed = await WorkflowService.GetAllowedStudyTransitionsAsync(Id);
            allowedNextStudy = studyAllowed.ToList();
        } catch {
            allowedNextStudy.Clear();
        }
        // Rebuild the timeline since history/allowed may influence displayed metadata
        InitializeTimelineItems();
        StateHasChanged();
    }

    private async Task ApplyTransition(StudyStatus status) {
        var ok = await WorkflowService.TryTransitionStudyAsync(Id, status);
        if (ok) {
            Snackbar.Add($"Transitioned to {status}", Severity.Success);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Transition to {status} not allowed", Severity.Warning);
        }
    }

    private async Task ReloadAfterChange() {
        await LoadInitialData();
        InitializeTimelineItems();
        await LoadAllowedTransitions();
        StateHasChanged();
    }

    // Aggregate all element types safely
    private IEnumerable<IReserveStudyElement> GetAllElements() {
        var building = reserveStudy?.ReserveStudyBuildingElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        var common = reserveStudy?.ReserveStudyCommonElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        var additional = reserveStudy?.ReserveStudyAdditionalElements?.Cast<IReserveStudyElement>() ?? Enumerable.Empty<IReserveStudyElement>();
        return building.Concat(common).Concat(additional);
    }

    // Class to hold timeline item information
    private class TimelineItemInfo {
        public StudyStatus Status { get; set; }
        public DateTime? DateValue { get; set; }
        public string? Title { get; set; }
        public string? Actor { get; set; }
        public bool IsHidden { get; set; } = false;
    }

    private void OpenComposeMessage() {
        if (reserveStudy?.SpecialistUserId == null) return;
        var parameters = new DialogParameters { ["ToUserId"] = reserveStudy.SpecialistUserId.Value, ["ToUserName"] = reserveStudy.Specialist?.Email ?? string.Empty };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        DialogService.ShowAsync<CRS.Components.Pages.Messages.ComposeMessageDialog>("Send Message", parameters, options);
    }

    private async Task OpenAssignSpecialistDialog() {
        try {
            // Load specialists (users with TenantSpecialist role)
            var specialists = new List<ApplicationUser>();
            var allUsers = await UserManager.Users.ToListAsync();
            
            foreach (var user in allUsers) {
                var roles = await UserManager.GetRolesAsync(user);
                if (roles.Contains("TenantSpecialist") || roles.Contains("TenantOwner")) {
                    specialists.Add(user);
                }
            }

            if (!specialists.Any()) {
                Snackbar.Add("No specialists available to assign.", Severity.Warning);
                return;
            }

            var parameters = new DialogParameters { ["specialists"] = specialists };
            var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
            var dialog = await DialogService.ShowAsync<AssignSpecialistDialog>("Assign Specialist", parameters, options);
            var result = await dialog.Result;

            if (!result.Canceled && result.Data is ApplicationUser selectedSpecialist) {
                await AssignSpecialistAsync(selectedSpecialist);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error loading specialists: {ex.Message}", Severity.Error);
        }
    }

    private async Task AssignSpecialistAsync(ApplicationUser specialist) {
        if (reserveStudy == null) return;

        try {
            using var context = await DbFactory.CreateDbContextAsync();
            var study = await context.ReserveStudies.FindAsync(reserveStudy.Id);
            
            if (study != null) {
                study.SpecialistUserId = specialist.Id;
                study.DateModified = DateTime.UtcNow;
                await context.SaveChangesAsync();

                // Note: Assigning a specialist does NOT automatically advance the workflow.
                // The specialist must create a proposal to advance to ProposalCreated status.

                Snackbar.Add($"Specialist {specialist.FullName} assigned successfully!", Severity.Success);
                await ReloadAfterChange();
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "Error assigning specialist to study {StudyId}", reserveStudy?.Id);
            Snackbar.Add($"Error assigning specialist: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenScheduleSiteVisitDialog() {
        var parameters = new DialogParameters {
            ["CurrentDate"] = reserveStudy?.SiteVisitDate
        };

        var options = new DialogOptions {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ScheduleSiteVisitDialog>(
            "Schedule Site Visit", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is DateTime selectedDate) {
            await ScheduleSiteVisitAsync(selectedDate);
        }
    }

    private async Task ScheduleSiteVisitAsync(DateTime siteVisitDate) {
        if (reserveStudy == null) return;

        try {
            using var context = await DbFactory.CreateDbContextAsync();
            var study = await context.ReserveStudies
                .Include(s => s.StudyRequest)
                .FirstOrDefaultAsync(s => s.Id == reserveStudy.Id);
            
            if (study != null) {
                study.SiteVisitDate = siteVisitDate;
                study.DateModified = DateTime.UtcNow;
                await context.SaveChangesAsync();

                // Create calendar event for site visit
                var calendarEvent = new Models.CalendarEvent {
                    Title = $"Site Visit - {reserveStudy.Community?.Name}",
                    Description = $"Reserve study site visit for {reserveStudy.Community?.Name} at {reserveStudy.Community?.PhysicalAddress?.FullAddress}",
                    Start = siteVisitDate,
                    End = siteVisitDate.AddHours(4),
                    EventType = Models.CalendarEventType.SiteVisit,
                    ReserveStudyId = Id,
                    ApplicationUserId = reserveStudy.ApplicationUserId,
                    SpecialistUserId = reserveStudy.SpecialistUserId,
                    IsPublic = false
                };
                await CalendarService.AddEventAsync(calendarEvent);

                // Send email notification to HOA user via event dispatcher
                var siteVisitEvent = new SiteVisitScheduledEvent(reserveStudy, siteVisitDate);
                await _dispatcher.Broadcast(siteVisitEvent);

                // Determine current status and transition appropriately
                var currentStatus = study.StudyRequest?.CurrentStatus ?? study.CurrentStatus;
                bool ok = false;
                
                // If we're in SiteVisitPending, transition to SiteVisitScheduled
                if (currentStatus == StudyStatus.SiteVisitPending) {
                    ok = await WorkflowService.TryTransitionStudyAsync(Id, StudyStatus.SiteVisitScheduled);
                }
                // If we're in FinancialInfoReceived, first go to SiteVisitPending, then to SiteVisitScheduled
                else if (currentStatus == StudyStatus.FinancialInfoReceived) {
                    var pendingOk = await WorkflowService.TryTransitionStudyAsync(Id, StudyStatus.SiteVisitPending);
                    if (pendingOk) {
                        ok = await WorkflowService.TryTransitionStudyAsync(Id, StudyStatus.SiteVisitScheduled);
                    }
                }
                // Already scheduled or completed - just update the date
                else if (currentStatus == StudyStatus.SiteVisitScheduled) {
                    ok = true; // Date already saved, no transition needed
                }
                
                if (ok) {
                    Snackbar.Add($"Site visit scheduled for {siteVisitDate:MMMM dd, yyyy 'at' h:mm tt}! Notification sent to client.", Severity.Success);
                    await ReloadAfterChange();
                } else {
                    Snackbar.Add($"Site visit date saved, but workflow transition failed. Current status: {currentStatus}", Severity.Warning);
                    await ReloadAfterChange();
                }
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "Error scheduling site visit for study {StudyId}", reserveStudy?.Id);
            Snackbar.Add($"Error scheduling site visit: {ex.Message}", Severity.Error);
        }
    }

    // Workflow helper methods
    private bool NeedsApproval() {
        var currentStatus = GetCurrentStatus();
        // Only RequestApproved needs initial approval
        return currentStatus == StudyStatus.RequestApproved;
    }

    private bool CanAssignSpecialist() {
        var currentStatus = GetCurrentStatus();
        // After approval (RequestApproved or later proposal stages) and no specialist assigned yet
        return (currentStatus == StudyStatus.RequestApproved ||
                currentStatus == StudyStatus.ProposalCreated || 
                currentStatus == StudyStatus.ProposalReviewed ||
                currentStatus == StudyStatus.ProposalUpdated ||
                currentStatus == StudyStatus.ProposalApproved) && 
               reserveStudy?.SpecialistUserId == null;
    }

    private async Task ApproveRequestAsync() {
        var result = await WorkflowActionService.AdvanceAsync(Id, "Request approved");
        if (result.Success) {
            Snackbar.Add("Request approved successfully! You can now assign a specialist.", Severity.Success);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Failed to approve request: {result.Message}", Severity.Error);
        }
    }

    private async Task RequestMoreInfoAsync() {
        var result = await WorkflowActionService.RequestChangesAsync(Id, "More information needed");
        if (result.Success) {
            Snackbar.Add("Request returned for more information.", Severity.Info);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Failed to request more info: {result.Message}", Severity.Error);
        }
    }

    private async Task RequestRevisionAsync() {
        var result = await WorkflowActionService.RequestChangesAsync(Id, "Revision requested");
        if (result.Success) {
            Snackbar.Add("Revision requested successfully.", Severity.Success);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Failed to request revision: {result.Message}", Severity.Error);
        }
    }

    private async Task CancelRequestAsync() {
        var result = await WorkflowActionService.CancelAsync(Id, "Request cancelled");
        if (result.Success) {
            Snackbar.Add("Request cancelled successfully.", Severity.Success);
            await ReloadAfterChange();
        } else {
            Snackbar.Add($"Failed to cancel request: {result.Message}", Severity.Error);
        }
    }

    private StudyStatus GetCurrentStatus() {
        var currentEngine = reserveStudy?.StudyRequest?.CurrentStatus;
        return currentEngine ?? reserveStudy?.CurrentStatus ?? StudyStatus.RequestCreated;
    }

    private StudyStatus? GetNextStatus() {
        var currentStatus = GetCurrentStatus();
        var currentRank = StatusRank.TryGetValue(currentStatus, out var rnk) ? rnk : -1;
        var next = KeyMilestones.FirstOrDefault(s => (StatusRank.TryGetValue(s, out var rr) ? rr : int.MaxValue) > currentRank);
        return EqualityComparer<StudyStatus>.Default.Equals(next, default) ? null : next;
    }

    private int GetProgressPercentage() {
        var currentStatus = GetCurrentStatus();
        var currentRank = StatusRank.TryGetValue(currentStatus, out var rnk) ? rnk : 0;
        var totalSteps = WorkflowStatusOrder.Length - 2;
        return Math.Min(100, (int)Math.Round((double)(currentRank + 1) / totalSteps * 100));
    }

    private List<MilestoneInfo> GetKeyMilestones() {
        var milestones = new List<MilestoneInfo>();
        var currentStatus = GetCurrentStatus();
        var currentRank = StatusRank.TryGetValue(currentStatus, out var cr) ? cr : -1;

        foreach (var status in KeyMilestones) {
            var itemRank = StatusRank.TryGetValue(status, out var ir) ? ir : int.MaxValue;
            
            // A milestone is completed if current rank is greater than OR EQUAL to its rank
            var isCompleted = currentRank >= itemRank && itemRank != int.MaxValue;
            var isCurrent = currentRank == itemRank || 
                            // If current status is between milestones, highlight the next upcoming one
                            (!isCompleted && milestones.All(m => m.IsCompleted || m.IsCurrent));
            
            // Get date from timeline items or fallback
            var timelineItem = timelineItems.FirstOrDefault(t => t.Status == status);
            
            milestones.Add(new MilestoneInfo {
                Status = status,
                Title = FormatStatusTitle(status),
                Date = timelineItem?.DateValue ?? GetFallbackDate(status),
                IsCompleted = isCompleted,
                IsCurrent = isCurrent && !isCompleted
            });
        }

        return milestones;
    }

    private NextActionInfo? GetNextActionInfo() {
        var currentStatus = GetCurrentStatus();
        var hasSpecialist = reserveStudy?.SpecialistUserId != null;
        
        // Show action based on current status (what's the immediate next step)
        return currentStatus switch {
            StudyStatus.RequestCreated => new NextActionInfo {
                ActionText = "Approve Request",
                ActorText = "Awaiting staff review",
                ActorIcon = Icons.Material.Filled.RateReview
            },
            StudyStatus.RequestApproved when !hasSpecialist => new NextActionInfo {
                ActionText = "Assign Specialist",
                ActorText = "Awaiting manager assignment",
                ActorIcon = Icons.Material.Filled.PersonAdd
            },
            StudyStatus.RequestApproved when hasSpecialist => new NextActionInfo {
                ActionText = "Create Proposal",
                ActorText = $"Action required by {reserveStudy?.Specialist?.FullName ?? "specialist"}",
                ActorIcon = Icons.Material.Filled.Description
            },
            StudyStatus.ProposalCreated => new NextActionInfo {
                ActionText = "Submit for Review",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.RateReview
            },
            StudyStatus.ProposalReviewed => new NextActionInfo {
                ActionText = "Approve Proposal",
                ActorText = "Awaiting manager approval",
                ActorIcon = Icons.Material.Filled.Approval
            },
            StudyStatus.ProposalApproved => new NextActionInfo {
                ActionText = "Send Proposal",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.Send
            },
            StudyStatus.ProposalSent => new NextActionInfo {
                ActionText = "Accept Proposal",
                ActorText = $"Action required by {reserveStudy?.Contact?.FullName ?? "client"}",
                ActorIcon = Icons.Material.Filled.Business
            },
            StudyStatus.ProposalAccepted => new NextActionInfo {
                ActionText = "Submit Financial Information",
                ActorText = $"Action required by {reserveStudy?.Contact?.FullName ?? "client"}",
                ActorIcon = Icons.Material.Filled.Business
            },
            StudyStatus.FinancialInfoRequested or StudyStatus.FinancialInfoInProgress => new NextActionInfo {
                ActionText = "Submit Financial Information",
                ActorText = $"Action required by {reserveStudy?.Contact?.FullName ?? "client"}",
                ActorIcon = Icons.Material.Filled.Business
            },
            StudyStatus.FinancialInfoReceived => new NextActionInfo {
                ActionText = "Schedule Site Visit",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.Event
            },
            StudyStatus.SiteVisitPending => new NextActionInfo {
                ActionText = "Confirm Site Visit Scheduled",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.CalendarMonth
            },
            StudyStatus.SiteVisitScheduled => new NextActionInfo {
                ActionText = "Complete Site Visit",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.CheckCircle
            },
            StudyStatus.SiteVisitCompleted => new NextActionInfo {
                ActionText = "Enter Site Visit Data",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.Storage
            },
            StudyStatus.SiteVisitDataEntered => new NextActionInfo {
                ActionText = "Create Funding Plan",
                ActorText = reserveStudy?.Specialist != null 
                    ? $"Action required by {reserveStudy.Specialist.FullName}" 
                    : "Action required by staff",
                ActorIcon = Icons.Material.Filled.Calculate
            },
            StudyStatus.ReportComplete => new NextActionInfo {
                ActionText = "Complete Study",
                ActorText = "Ready for final delivery",
                ActorIcon = Icons.Material.Filled.TaskAlt
            },
            StudyStatus.RequestCompleted => null, // No next action
            _ => new NextActionInfo {
                ActionText = "Processing...",
                ActorText = "In progress",
                ActorIcon = Icons.Material.Filled.HourglassEmpty
            }
        };
    }

    private string GetCurrentStepDescription() {
        var currentStatus = GetCurrentStatus();
        
        return currentStatus switch {
            StudyStatus.RequestCreated => 
                "Your reserve study request has been received and is being reviewed by our team. We'll assign a qualified specialist to your project shortly.",
            
            StudyStatus.ProposalCreated => 
                "A reserve specialist has been assigned to your project. They are preparing a detailed proposal that outlines the scope of work and estimated costs for your reserve study.",
            
            StudyStatus.ProposalSent => 
                "We've sent you a proposal outlining the scope and cost of your reserve study. Please review the proposal and let us know if you have any questions or if you'd like to proceed.",
            
            StudyStatus.ProposalAccepted => 
                "Thank you for accepting the proposal! Your specialist will now request the financial information needed to begin the comprehensive analysis of your reserve fund.",
            
            StudyStatus.FinancialInfoRequested => 
                "We've requested financial information about your reserve fund, including current balance, annual contributions, and projected expenses. This data is essential for conducting an accurate reserve study.",
            
            StudyStatus.FinancialInfoSubmitted => 
                "Thank you for providing your financial information. Our specialist is now reviewing this data and preparing for the site visit to assess your property's physical components.",
            
            StudyStatus.SiteVisitScheduled => 
                "Your site visit has been scheduled. During this visit, our specialist will conduct a thorough inspection of your property's common elements and major components to assess their condition and remaining useful life.",
            
            StudyStatus.SiteVisitCompleted => 
                "The site visit has been completed. Our specialist is now analyzing the collected data, including component conditions, life expectancy, and replacement costs, to prepare your comprehensive reserve study report.",
            
            StudyStatus.ReportComplete => 
                "Your reserve study report has been completed and is ready for review. The report includes a detailed analysis of your property's components, funding plan, and recommendations for maintaining adequate reserves.",
            
            StudyStatus.FundingPlanReady => 
                "Your funding plan is ready. This plan provides a roadmap for maintaining adequate reserve funds and scheduling future capital improvements based on the reserve study findings.",
            
            StudyStatus.RequestCompleted => 
                "Your reserve study has been successfully completed. All deliverables have been provided, including the comprehensive report and funding plan. You can now use this information for budgeting and planning purposes.",
            
            StudyStatus.RequestCancelled => 
                "This reserve study request has been cancelled. If you have any questions or would like to restart the process, please contact our team.",
            
            StudyStatus.RequestArchived => 
                "This reserve study request has been archived. The project has been completed and stored for your records.",
            
            _ => "Your reserve study is in progress. We'll keep you updated as we move through each phase of the process."
        };
    }

    private string GetNextStepDescription() {
        var nextStatus = GetNextStatus();
        if (nextStatus == null) return string.Empty;
        
        return nextStatus.Value switch {
            StudyStatus.ProposalCreated => 
                "Our team will review your request details and assign a qualified reserve specialist who has experience with properties similar to yours. You'll be notified once a specialist is assigned.",
            
            StudyStatus.ProposalSent => 
                "Your assigned specialist will prepare a detailed proposal that outlines the scope of work, timeline, and costs for your reserve study. You'll receive the proposal via email and can review it in your dashboard.",
            
            StudyStatus.ProposalAccepted => 
                "Please review the proposal we've sent you. It includes details about the reserve study process, what will be inspected, and the deliverables you'll receive. You can accept the proposal through your dashboard or via the email link.",
            
            StudyStatus.FinancialInfoRequested => 
                "Your specialist will send a request for financial information about your reserve fund. This helps us understand your current funding situation and create an accurate funding plan.",
            
            StudyStatus.FinancialInfoSubmitted => 
                "Please provide information about your reserve fund, including current balance, annual contributions, and any projected expenses. You can submit this information through your dashboard or via the email form.",
            
            StudyStatus.SiteVisitScheduled => 
                "Your specialist will contact you to schedule a convenient time for the site visit. During this visit, they'll inspect your property's common elements, building components, and other major assets.",
            
            StudyStatus.SiteVisitCompleted => 
                "The specialist will conduct a thorough on-site inspection of your property. They'll assess the condition of all major components, take measurements and photos, and gather data needed for the reserve analysis.",
            
            StudyStatus.ReportComplete => 
                "Your specialist will analyze all collected data and prepare a comprehensive reserve study report. This includes component inventory, condition assessments, life expectancy calculations, and a 30-year funding plan.",
            
            StudyStatus.FundingPlanReady => 
                "The funding plan will be finalized based on the reserve study findings. This plan will show recommended annual contributions and a schedule for major repairs and replacements over the next 30 years.",
            
            StudyStatus.RequestCompleted => 
                "The final step is to mark the study as complete once all deliverables have been provided and reviewed. This will close out the project and archive it for your records.",
            
            StudyStatus.RequestCancelled => 
                "This reserve study request has been cancelled. If you have any questions or would like to restart the process, please contact our team.",
            
            StudyStatus.RequestArchived => 
                "This reserve study request has been archived. The project has been completed and stored for your records.",
            
            _ => "We'll notify you when the next action is required. You can check back here anytime for updates on your reserve study progress."
        };
    }

    private class MilestoneInfo {
        public StudyStatus Status { get; set; }
        public string Title { get; set; } = string.Empty;
        public DateTime? Date { get; set; }
        public bool IsCompleted { get; set; }
        public bool IsCurrent { get; set; }
    }

    private class NextActionInfo {
        public string ActionText { get; set; } = string.Empty;
        public string ActorText { get; set; } = string.Empty;
        public string ActorIcon { get; set; } = Icons.Material.Filled.Person;
    }
}