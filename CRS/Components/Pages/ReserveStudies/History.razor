@page "/ReserveStudies/{Id:guid}/History"
@attribute [Authorize]

@using CRS.Data
@using CRS.Models.Workflow
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Reserve Study History</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
 <MudCard Elevation="0" Outlined="true">
 <MudCardHeader>
 <CardHeaderContent>
 <MudText Typo="Typo.h6">Raw Workflow History</MudText>
 <MudText Typo="Typo.caption">Request @Id</MudText>
 </CardHeaderContent>
 <CardHeaderActions>
 <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="GoBack" StartIcon="@Icons.Material.Filled.ArrowBack">Back to Details</MudButton>
 </CardHeaderActions>
 </MudCardHeader>
 <MudCardContent>
 @if (_isLoading)
 {
 <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
 }
 else if (history.Count ==0)
 {
 <MudAlert Severity="Severity.Info">No history entries yet.</MudAlert>
 }
 else
 {
 <MudTable Items="@history" Dense="true" Hover="true" Elevation="0">
 <HeaderContent>
 <MudTh style="width:22%">Changed At</MudTh>
 <MudTh style="width:22%">From</MudTh>
 <MudTh style="width:22%">To</MudTh>
 <MudTh>Changed By</MudTh>
 </HeaderContent>
 <RowTemplate>
 <MudTd>@context.ChangedAt.ToLocalTime().ToString("MMM d, yyyy h:mm tt")</MudTd>
 <MudTd>@context.FromStatus</MudTd>
 <MudTd>@context.ToStatus</MudTd>
 <MudTd>@context.ChangedBy</MudTd>
 </RowTemplate>
 </MudTable>
 }
 </MudCardContent>
 </MudCard>
</MudContainer>

@code {
 [Parameter]
 public Guid Id { get; set; }

 private bool _isLoading = true;
 private List<StudyStatusHistory> history = new();

 protected override async Task OnInitializedAsync()
 {
 try
 {
 using var ctx = await DbFactory.CreateDbContextAsync();
 history = await ctx.StudyStatusHistories
 .AsNoTracking()
 .Where(h => h.RequestId == Id)
 .OrderBy(h => h.ChangedAt)
 .ToListAsync();
 }
 catch (Exception ex)
 {
 Snackbar.Add($"Failed to load history: {ex.Message}", Severity.Error);
 }
 finally
 {
 _isLoading = false;
 }
 }

 private void GoBack() => NavigationManager.NavigateTo($"/ReserveStudies/{Id}/Details");
}