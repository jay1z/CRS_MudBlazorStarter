@page "/ReserveStudies/Create"
@attribute [Authorize(Policy = "RequireTenantStaff")]

@using System.Security.Claims
@using CRS.Components.Layout
@using CRS.Components.Pages.ReserveStudyPages.Steps.Create
@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using CRS.Services.Tenant
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable
@inject ILogger<Create> Logger
@inject UserStateService UserState
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IReserveStudyService ReserveStudyService
@inject IReserveStudyWorkflowService WorkflowService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ITenantContext TenantContext

<PageTitle>Create Reserve Study</PageTitle>

@if (isLoading) {
    <MudPaper Elevation="0" Class="pa-8">
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.h5" Class="mt-4">Loading Reserve Studies...</MudText>
    </MudPaper>
} else {
    <MudText Typo="Typo.h4" Class="mb-4">Create New Reserve Study</MudText>
    <MudContainer MaxWidth="MaxWidth.Medium">
        <MudCard Elevation="25">
            <MudCardContent>
                <MudStepper @bind-ActiveStep="activeStep" Linear="true" CenterLabels="true"
                            CompletedStepColor="Color.Success" CurrentStepColor="Color.Primary"
                            Class="mb-4" @ref="stepper">
                    <ChildContent>
                        @foreach (var step in steps) {
                            <MudStep Title="@step.Title"
                                     Icon="@(stepValidationState.GetValueOrDefault(step.Index) ? Icons.Material.Filled.CheckCircle : null)"
                                     IconColor="@(stepValidationState.GetValueOrDefault(step.Index) ? Color.Success : Color.Default)">
                                @step.Content
                            </MudStep>
                        }
                    </ChildContent>
                    <CompletedContent>
                        <Step5 />
                    </CompletedContent>
                    <ActionContent>
                        @if (!_completed) {
                            <MudGrid Justify="Justify.SpaceBetween" Class="mt-4">
                                <MudItem>
                                    <MudButton Variant="Variant.Filled" Color="Color.Secondary"
                                               Disabled="activeStep <=0 || isSubmitting" OnClick="PreviousStep">
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Class="mr-2" />
                                        Back
                                    </MudButton>
                                </MudItem>
                                <MudItem>
                                    @if (activeStep < steps.Count - 1) {
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="isSubmitting" OnClick="NextStep">
                                            Continue
                                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Class="ml-2" />
                                        </MudButton>
                                    } else if (AcceptTerms) {
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                                   OnClick="SubmitForm" Disabled="isSubmitting || !IsFormValid()">
                                            @if (isSubmitting) {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <span>Submitting...</span>
                                            } else {
                                                <span>Submit</span>
                                            }
                                        </MudButton>
                                    } else {
                                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="true">
                                            <MudTooltip Text="You must accept the terms to proceed">
                                                Submit
                                            </MudTooltip>
                                        </MudButton>
                                    }
                                </MudItem>
                            </MudGrid>
                        }
                    </ActionContent>
                </MudStepper>
            </MudCardContent>
        </MudCard>
    </MudContainer>
}

@code {
    private record StepDefinition(int Index, string Title, RenderFragment Content);

    [CascadingParameter] public Routes? Routes { get; set; }
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private ReserveStudy? Model { get; set; }
    private readonly Dictionary<int, bool> stepValidationState = new();

    private MudStepper? stepper;
    private bool isLoading = true;
    private bool isSubmitting;
    private bool AcceptTerms;
    private bool _completed;
    private bool isExistingCommunity;
    private int activeStep;

    private Step1Create? step1;
    private Step2Create? step2;
    private Step3Create? step3;
    private Step4Create? step4;

    private List<StepDefinition> steps = new();

    protected override async Task OnInitializedAsync() {
        try {
            await UserState.InitializeAsync();
            if (!UserState.ClaimsPrincipal.Identity?.IsAuthenticated ?? true) {
                NavigationManager.NavigateTo("/login", true);
                return;
            }

            InitializeModel();
            InitializeSteps();
        } catch (Exception ex) {
            LogAndDisplayError("Error initializing", ex);
        } finally {
            isLoading = false;
        }
    }

    private void InitializeSteps() {
        steps = new List<StepDefinition> {
            new(0, "Community Information", @<Step1Create @ref="step1" Model="Model" StepValidated="OnStepValidated" OnExistingCommunityChanged="@((bool isExisting) => isExistingCommunity = isExisting)" />),
            new(1, "Property Manager", @<Step2Create @ref="step2" Model="Model" StepValidated="OnStepValidated" />),
            new(2, "Property Elements", @<Step3Create @ref="step3" Model="Model" StepValidated="OnStepValidated" />),
            new(3, "Acknowledgement", @<Step4Create @ref="step4" Model="Model" StepValidated="OnStepValidated" AcceptTerms="@AcceptTerms" AcceptTermsChanged="@OnAcceptTermsChanged" />)
        };
    }

    private void InitializeModel() {
        // Start with empty placeholders; steps will collect actual data
        Model = new ReserveStudy {
            ApplicationUserId = GetCurrentUserId(UserState.ClaimsPrincipal),
            Community = new Community {
                Name = string.Empty,
                PhysicalAddress = new Address { Street = string.Empty, City = string.Empty, State = string.Empty, Zip = string.Empty }
            },
            Contact = new Contact { FirstName = string.Empty, LastName = string.Empty, Email = string.Empty, Phone = string.Empty },
            PropertyManager = new PropertyManager { FirstName = string.Empty, LastName = string.Empty, CompanyName = string.Empty, Email = string.Empty, Phone = string.Empty },
            ReserveStudyBuildingElements = new List<ReserveStudyBuildingElement>(),
            ReserveStudyCommonElements = new List<ReserveStudyCommonElement>(),
            ReserveStudyAdditionalElements = new List<ReserveStudyAdditionalElement>(),
            IsActive = true
        };
    }

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;

    private async Task NextStep() {
        try {
            bool isValid = await ValidateCurrentStep();
            if (isValid) {
                activeStep++;
                await stepper!.NextStepAsync();
            }
        } catch (Exception ex) {
            LogAndDisplayError("Error validating step", ex);
        }
    }

    private async Task<bool> ValidateCurrentStep() {
        bool isValid = activeStep switch {
            0 => step1 != null && await step1.ValidateAsync(),
            1 => step2 != null && await step2.ValidateAsync(),
            2 => step3 != null && await step3.ValidateAsync(),
            3 => step4 != null && await step4.ValidateAsync(),
            _ => false
        };

        if (!isValid) {
            Snackbar.Add(activeStep == 3
            ? "You must accept the terms to proceed."
            : "Please correct the errors before proceeding.",
            Severity.Warning);
        }

        return isValid;
    }

    private async Task PreviousStep() {
        if (activeStep > 0) {
            activeStep--;
            await stepper!.PreviousStepAsync();
        }
    }

    private bool IsFormValid() =>
    steps.All(step => stepValidationState.GetValueOrDefault(step.Index)) && AcceptTerms;

    private async Task SubmitForm() {
        if (isSubmitting) return; // guard double submit
        if (!IsFormValid()) {
            Snackbar.Add("Please complete all required fields.", Severity.Warning);
            return;
        }

        isSubmitting = true;
        try {
            Logger.LogInformation("SubmitForm: Starting. Model.CommunityId={CommunityId}, Model.Community is {State}, isExistingCommunity={IsExisting}",
                Model?.CommunityId, 
                Model?.Community == null ? "null" : $"not null (Id={Model.Community.Id})",
                isExistingCommunity);
            
            // Handle new community save - use nullable-aware checks
            bool needsCommunitySave = Model != null 
                && (Model.CommunityId == null || Model.CommunityId == Guid.Empty)
                && Model.Community != null 
                && !isExistingCommunity;
            
            Logger.LogInformation("SubmitForm: needsCommunitySave={NeedsSave}, Community.Id={CommunityObjId}",
                needsCommunitySave, Model?.Community?.Id);
            
            if (needsCommunitySave) {
                Logger.LogInformation("SubmitForm: ENTERING community save block");
                
                await using var db = await DbFactory.CreateDbContextAsync();
                
                if (TenantContext.TenantId.HasValue) {
                    Model!.Community!.TenantId = TenantContext.TenantId.Value;
                }
                
                // Only generate a new ID if the community doesn't have one yet
                if (Model!.Community!.Id == Guid.Empty) {
                    Model.Community.Id = Guid.CreateVersion7();
                }
                
                // Ensure physical address has an ID
                if (Model.Community.PhysicalAddress != null) {
                    if (Model.Community.PhysicalAddress.Id == Guid.Empty) {
                        Model.Community.PhysicalAddress.Id = Guid.CreateVersion7();
                    }
                    Model.Community.PhysicalAddressId = Model.Community.PhysicalAddress.Id;
                }
                
                // Ensure mailing address has an ID if provided
                if (Model.Community.MailingAddress != null) {
                    if (Model.Community.MailingAddress.Id == Guid.Empty) {
                        Model.Community.MailingAddress.Id = Guid.CreateVersion7();
                    }
                    Model.Community.MailingAddressId = Model.Community.MailingAddress.Id;
                }
                
                // Check if community already exists in DB (might have been created elsewhere)
                var existsInDb = await db.Communities.AnyAsync(c => c.Id == Model.Community.Id);
                if (!existsInDb) {
                    db.Communities.Add(Model.Community);
                    await db.SaveChangesAsync();
                    Logger.LogInformation("SubmitForm: Community saved to database with Id={CommunityId}", Model.Community.Id);
                } else {
                    Logger.LogInformation("SubmitForm: Community already exists in database with Id={CommunityId}", Model.Community.Id);
                }
                
                Model.CommunityId = Model.Community.Id;
                
                Logger.LogInformation("SubmitForm: Set Model.CommunityId={CommunityId}", Model.CommunityId);
            } else {
                // If we have a community object with an ID but CommunityId is not set, copy it
                if (Model != null && Model.Community != null && Model.Community.Id != Guid.Empty && (Model.CommunityId == null || Model.CommunityId == Guid.Empty)) {
                    Model.CommunityId = Model.Community.Id;
                    Logger.LogInformation("SubmitForm: Copied Community.Id to CommunityId={CommunityId}", Model.CommunityId);
                }
            }
            
            Logger.LogInformation("SubmitForm: After community handling. Model.CommunityId={CommunityId}, Model.Community is {State}",
                Model?.CommunityId, Model?.Community == null ? "null" : $"not null (Id={Model.Community.Id})");

            // Log the current state of elements before submission
            Logger.LogInformation("SubmitForm: step3 is {Null}, BuildingElements: {Building}, CommonElements: {Common}", 
                step3 == null ? "NULL" : "not null",
                Model?.ReserveStudyBuildingElements?.Count ?? 0,
                Model?.ReserveStudyCommonElements?.Count ?? 0);

            // Validate step 3 to sync building/common elements to the Model (if component is available)
            if (step3 != null) {
                await step3.ValidateAsync();
            }

            PrepareModelForSubmission();
            
            Logger.LogInformation("SubmitForm: After PrepareModelForSubmission. Model.CommunityId={CommunityId}, Model.Community is {State}",
                Model?.CommunityId, Model?.Community == null ? "null" : "not null");

            // Use workflow service so the StudyRequest is created and state machine is initialized
            var created = await WorkflowService.CreateReserveStudyRequestAsync(Model!);

            Snackbar.Add("Reserve Study submitted successfully!", Severity.Success);
            _completed = true;
            await stepper!.NextStepAsync();

            // Navigate to details for immediate verification and further actions
            NavigationManager.NavigateTo($"/ReserveStudies/Details/{created.Id}");
        } catch (Exception ex) {
            LogAndDisplayError("Error submitting form", ex);
        } finally {
            isSubmitting = false;
        }
    }

    private void PrepareModelForSubmission() {
        if (Model == null) return;
        
        // Ensure CommunityId is set from the Community object if not already set
        if ((Model.CommunityId == null || Model.CommunityId == Guid.Empty) && Model.Community != null && Model.Community.Id != Guid.Empty) {
            Model.CommunityId = Model.Community.Id;
            Logger.LogInformation("PrepareModelForSubmission: Copied Community.Id to CommunityId={CommunityId}", Model.CommunityId);
        }
        
        // Now null out the Community object to prevent tracking conflicts (CommunityId is set)
        if (Model.CommunityId != null && Model.CommunityId != Guid.Empty) {
            Model.Community = null;
            Logger.LogInformation("PrepareModelForSubmission: Set Model.Community to null, CommunityId={CommunityId}", Model.CommunityId);
        }
    }

    private void LogAndDisplayError(string message, Exception ex) {
        Logger.LogError($"{message}: {ex}");
        Snackbar.Add($"{message}: {ex.Message}", Severity.Error);

        if (ex.InnerException != null) {
            Snackbar.Add($"Additional details: {ex.InnerException.Message}", Severity.Error);
        }
    }

    private Task OnAcceptTermsChanged(bool value) {
        AcceptTerms = value;
        stepValidationState[3] = value;
        return Task.CompletedTask;
    }

    private void OnStepValidated(bool isValid) {
        stepValidationState[activeStep] = isValid;
        StateHasChanged();
    }

    private Guid? GetCurrentUserId(ClaimsPrincipal user) {
        var userIdString = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (string.IsNullOrEmpty(userIdString) || !Guid.TryParse(userIdString, out Guid userId)) {
            throw new InvalidOperationException("User ID not found or invalid");
        }
        return userId;
    }
}
