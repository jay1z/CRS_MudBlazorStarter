@page "/ReserveStudies/Proposal/{studyId:guid}"
@attribute [Authorize(Policy = "RequireTenantStaff")]

@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserStateService UserState
@inject IReserveStudyWorkflowService WorkflowService
@inject IReserveStudyService ReserveStudyService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Proposal> Logger

<PageTitle>@(isAmendment ? "Proposal Amendment" : "Reserve Study Proposal")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (isLoading) {
        <MudPaper Elevation="0" Class="pa-8">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.h5" Class="mt-4">Loading Reserve Study...</MudText>
        </MudPaper>
    } else if (reserveStudy == null) {
        <MudAlert Severity="Severity.Error">Reserve study not found</MudAlert>
    } else {
        <MudCard Elevation="3" Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    @if (isAmendment) {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.Edit">
                                Amendment
                            </MudChip>
                            <MudText Typo="Typo.h4">Proposal Amendment</MudText>
                        </MudStack>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">@reserveStudy.Community?.Name</MudText>
                    } else {
                        <MudText Typo="Typo.h4">Create Proposal</MudText>
                        <MudText Typo="Typo.subtitle1" Color="Color.Primary">@reserveStudy.Community?.Name</MudText>
                    }
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudTooltip Text="Return to Study Details">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default" Href="@($"/ReserveStudies/Details/{studyId}")" />
                    </MudTooltip>
                </CardHeaderActions>
            </MudCardHeader>

            <MudCardContent>
                @if (isAmendment) {
                    <MudAlert Severity="Severity.Warning" Class="mb-4" Variant="Variant.Outlined">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                Creating Proposal Amendment
                            </MudText>
                            <MudText Typo="Typo.body2">
                                This amendment will replace the original proposal. The scope has changed based on the site visit findings.
                                Please update the estimated cost and scope to reflect the actual work required.
                            </MudText>
                            @if (originalProposal != null) {
                                <MudText Typo="Typo.caption" Style="color: #666;">
                                    Original proposal cost: $@originalProposal.EstimatedCost.ToString("N2") | 
                                    Amendment #@proposal.AmendmentNumber
                                </MudText>
                            }
                        </MudStack>
                    </MudAlert>
                }

                <EditForm Model="@proposal" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <MudPaper Elevation="0" Class="pa-4 mud-theme-primary" Style="background-color: var(--mud-palette-primary-lighten);">
                        <MudText Typo="Typo.h6">Proposal Information</MudText>
                        <MudText Typo="Typo.body2" Class="mb-4">
                            @if (isAmendment) {
                                <span>This amended proposal will be sent to the point of contact for review and approval.</span>
                            } else {
                                <span>This proposal will be sent to the point of contact for review and approval.</span>
                            }
                        </MudText>
                    </MudPaper>

                    @if (isAmendment) {
                        <MudGrid Class="mt-4">
                            <MudItem xs="12">
                                <MudTextField T="string"
                                              Label="Reason for Amendment"
                                              @bind-Value="proposal.AmendmentReason"
                                              Required="true"
                                              Variant="Variant.Outlined"
                                              Lines="2"
                                              Placeholder="e.g., Scope increased after site visit revealed additional elements requiring assessment" />
                                <ValidationMessage For="@(() => proposal.AmendmentReason)" />
                            </MudItem>
                        </MudGrid>
                    }

                    <MudGrid Class="mt-4">
                        <MudItem xs="12" md="6">
                            <MudDatePicker Label="Proposal Date" @bind-Date="proposal.ProposalDate" Variant="Variant.Outlined" Editable="true" Required="true" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudNumericField Label="Estimated Cost ($)" @bind-Value="proposal.EstimatedCost" Format="N2" Variant="Variant.Outlined" Min="0" Required="true" />
                            <ValidationMessage For="@(() => proposal.EstimatedCost)" />
                            @if (isAmendment && originalProposal != null) {
                                <MudText Typo="Typo.caption" Style="@GetCostDiffStyle()">
                                    @GetCostDiffText()
                                </MudText>
                            }
                        </MudItem>

                        <MudItem xs="12">
                            <MudTextField Label="Proposal Scope"
                                          @bind-Value="proposal.ProposalScope"
                                          Required="true"
                                          Variant="Variant.Outlined"
                                          Lines="3" />
                            <ValidationMessage For="@(() => proposal.ProposalScope)" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudText Typo="Typo.h6" Class="mb-3">Reserve Study Services</MudText>

                    <MudGrid>
                        <MudItem xs="12">
                            <MudRadioGroup T="string" @bind-Value="@proposal.ServiceLevel">
                                <MudRadio T="string" Value="@("Level1")" Color="Color.Primary" Class="mb-2">
                                    Level I: Full Service - Includes site inspection and financial analysis
                                </MudRadio>
                                <MudRadio T="string" Value="@("Level2")" Color="Color.Primary" Class="mb-2">
                                    Level II: Update with Site Visit - Includes site inspection and update of previous reserve study
                                </MudRadio>
                                <MudRadio T="string" Value="@("Level3")" Color="Color.Primary" Class="mb-2">
                                    Level III: Update without Site Visit - Update of previous reserve study without new inspection
                                </MudRadio>
                            </MudRadioGroup>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudText Typo="Typo.h6" Class="mb-3">Delivery Timeframe</MudText>

                    <MudGrid>
                        <MudItem xs="12">
                            <MudRadioGroup T="string" @bind-Value="@proposal.DeliveryTimeframe">
                                <MudRadio Value="@("Standard")" Color="Color.Primary">Standard (4-6 weeks)</MudRadio>
                                <MudRadio Value="@("Expedited")" Color="Color.Primary">Expedited (2-3 weeks, additional fee applies)</MudRadio>
                                <MudRadio Value="@("Rush")" Color="Color.Primary">Rush (7-10 days, premium fee applies)</MudRadio>
                            </MudRadioGroup>
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudText Typo="Typo.h6" Class="mb-3">Additional Services</MudText>

                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudCheckBox @bind-Value="@proposal.IncludePrepaymentDiscount"
                                         Label="Prepayment Discount (5%)"
                                         Color="Color.Secondary" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudCheckBox @bind-Value="@proposal.IncludeDigitalDelivery"
                                         Label="Digital Delivery Only"
                                         Color="Color.Secondary" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudCheckBox @bind-Value="@proposal.IncludeComponentInventory"
                                         Label="Detailed Component Inventory"
                                         Color="Color.Secondary" />
                        </MudItem>
                        <MudItem xs="12" md="6">
                            <MudCheckBox @bind-Value="@proposal.IncludeFundingPlans"
                                         Label="Alternative Funding Plans"
                                         Color="Color.Secondary" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudText Typo="Typo.h6" Class="mb-3">Terms and Comments</MudText>

                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField T="string"
                                          Label="Payment Terms"
                                          @bind-Value="proposal.PaymentTerms"
                                          Variant="Variant.Outlined"
                                          Lines="2"
                                          Placeholder="e.g., 50% due upon acceptance, 50% due upon completion" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField T="string"
                                          Label="Comments"
                                          @bind-Value="proposal.Comments"
                                          Variant="Variant.Outlined"
                                          Lines="5"
                                          Placeholder="Additional comments or notes for the proposal" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-6" />

                    <MudItem xs="12" Class="d-flex justify-end">
                        <MudButton ButtonType="ButtonType.Button"
                                   Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Class="mr-2"
                                   OnClick="@(() => Navigation.NavigateTo($"/ReserveStudies/Details/{studyId}"))">
                            Cancel
                        </MudButton>
                        <MudButton ButtonType="ButtonType.Submit"
                                   Variant="Variant.Filled"
                                   Color="@(isAmendment ? Color.Warning : Color.Primary)"
                                   Disabled="@isSaving">
                            @if (isSaving) {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Saving...</span>
                            } else {
                                <span>@(isAmendment ? "Save Amendment" : "Save Proposal")</span>
                            }
                        </MudButton>
                    </MudItem>
                </EditForm>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid studyId { get; set; }
    
    [SupplyParameterFromQuery(Name = "amendment")]
    public bool? AmendmentQueryParam { get; set; }

    private ReserveStudy? reserveStudy;
    private ProposalViewModel proposal = new();
    private Models.Proposal? originalProposal;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isAmendment => AmendmentQueryParam == true || proposal.AmendmentNumber > 0;

    protected override async Task OnInitializedAsync() {
        await LoadReserveStudy();
    }

    private async Task LoadReserveStudy() {
        isLoading = true;
        try {
            await UserState.InitializeAsync();

            using var context = await DbFactory.CreateDbContextAsync();
            reserveStudy = await context.ReserveStudies
                .AsNoTracking()
                .Include(rs => rs.Community)
                .Include(rs => rs.Contact)
                .Include(rs => rs.PropertyManager)
                .Include(rs => rs.Specialist)
                .Include(rs => rs.CurrentProposal)
                .FirstOrDefaultAsync(rs => rs.Id == studyId);

            if (reserveStudy != null) {
                // Pre-populate proposal with default values
                proposal.ReserveStudyId = studyId;
                proposal.ProposalDate = DateTime.Now;
                proposal.DeliveryTimeframe = "Standard";
                proposal.IncludeDigitalDelivery = true;
                proposal.PaymentTerms = "50% due upon acceptance, remainder due upon completion of the study";

                // Check if we're creating an amendment
                if (AmendmentQueryParam == true && reserveStudy.CurrentProposal != null) {
                    originalProposal = reserveStudy.CurrentProposal;
                    
                    // Calculate next amendment number
                    var existingAmendmentCount = await context.Proposals
                        .CountAsync(p => p.ReserveStudyId == studyId && p.IsAmendment);
                    
                    // Pre-populate from original proposal
                    proposal.ProposalScope = originalProposal.ProposalScope + "\n\n[AMENDMENT: Scope updated based on site visit findings]";
                    proposal.EstimatedCost = originalProposal.EstimatedCost;
                    proposal.ServiceLevel = originalProposal.ServiceLevel ?? "Level1";
                    proposal.DeliveryTimeframe = originalProposal.DeliveryTimeframe ?? "Standard";
                    proposal.PaymentTerms = originalProposal.PaymentTerms;
                    proposal.IncludePrepaymentDiscount = originalProposal.IncludePrepaymentDiscount;
                    proposal.IncludeDigitalDelivery = originalProposal.IncludeDigitalDelivery;
                    proposal.IncludeComponentInventory = originalProposal.IncludeComponentInventory;
                    proposal.IncludeFundingPlans = originalProposal.IncludeFundingPlans;
                    proposal.AmendmentNumber = existingAmendmentCount + 1;
                    proposal.AmendmentReason = "Scope changed after site visit - actual element count differs from original estimate.";
                } else if (reserveStudy.CurrentProposal != null) {
                    // Editing existing proposal (not amendment)
                    var existing = reserveStudy.CurrentProposal;
                    proposal.ProposalDate = existing.ProposalDate;
                    proposal.ProposalScope = existing.ProposalScope;
                    proposal.EstimatedCost = existing.EstimatedCost;
                    proposal.Comments = existing.Comments;
                    proposal.ServiceLevel = existing.ServiceLevel ?? "Level1";
                    proposal.DeliveryTimeframe = existing.DeliveryTimeframe ?? "Standard";
                    proposal.PaymentTerms = existing.PaymentTerms;
                    proposal.IncludePrepaymentDiscount = existing.IncludePrepaymentDiscount;
                    proposal.IncludeDigitalDelivery = existing.IncludeDigitalDelivery;
                    proposal.IncludeComponentInventory = existing.IncludeComponentInventory;
                    proposal.IncludeFundingPlans = existing.IncludeFundingPlans;
                }
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error loading reserve study: {ex.Message}", Severity.Error);
        } finally {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit() {
        isSaving = true;
        try {
            // Map from view model to entity model
            var proposalEntity = new Models.Proposal {
                ReserveStudyId = proposal.ReserveStudyId,
                ProposalDate = proposal.ProposalDate.GetValueOrDefault(),
                ProposalScope = proposal.ProposalScope,
                EstimatedCost = proposal.EstimatedCost,
                Comments = proposal.Comments,
                ServiceLevel = proposal.ServiceLevel,
                DeliveryTimeframe = proposal.DeliveryTimeframe,
                PaymentTerms = proposal.PaymentTerms,
                IncludePrepaymentDiscount = proposal.IncludePrepaymentDiscount,
                IncludeDigitalDelivery = proposal.IncludeDigitalDelivery,
                IncludeComponentInventory = proposal.IncludeComponentInventory,
                IncludeFundingPlans = proposal.IncludeFundingPlans,
                // Amendment tracking
                IsAmendment = isAmendment,
                OriginalProposalId = isAmendment ? originalProposal?.Id : null,
                AmendmentNumber = isAmendment ? proposal.AmendmentNumber : 0,
                AmendmentReason = isAmendment ? proposal.AmendmentReason : null
            };

            var result = await WorkflowService.SendProposalAsync(studyId, proposalEntity);
            if (result) {
                var message = isAmendment ? "Amendment saved successfully" : "Proposal saved successfully";
                Snackbar.Add(message, Severity.Success);
                Navigation.NavigateTo($"/ReserveStudies/Details/{studyId}");
            } else {
                Snackbar.Add("Failed to save proposal. Please check the workflow status.", Severity.Error);
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "Error saving proposal for study {StudyId}, IsAmendment: {IsAmendment}", studyId, isAmendment);
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        } finally {
            isSaving = false;
        }
    }

    private string GetCostDiffStyle() {
        if (originalProposal == null) return "";
        var costDiff = proposal.EstimatedCost - originalProposal.EstimatedCost;
        return costDiff >= 0 ? "color: #d32f2f;" : "color: #388e3c;";
    }

    private string GetCostDiffText() {
        if (originalProposal == null) return "";
        var costDiff = proposal.EstimatedCost - originalProposal.EstimatedCost;
        var diffPercent = originalProposal.EstimatedCost > 0 
            ? (costDiff / originalProposal.EstimatedCost) * 100m 
            : 0m;
        var sign = costDiff >= 0 ? "+" : "";
        return $"{sign}${costDiff:N2} ({sign}{diffPercent:F1}%) from original";
    }

    public class ProposalViewModel {
        public Guid ReserveStudyId { get; set; }

        [Required(ErrorMessage = "Proposal date is required")]
        public DateTime? ProposalDate { get; set; }

        [Required(ErrorMessage = "Proposal scope is required")]
        public string ProposalScope { get; set; } = string.Empty;

        [Required(ErrorMessage = "Estimated cost is required")]
        [Range(0.01, double.MaxValue, ErrorMessage = "Estimated cost must be greater than 0")]
        public decimal EstimatedCost { get; set; }

        // Service level - only one can be selected
        [Required(ErrorMessage = "Please select a service level")]
        public string ServiceLevel { get; set; } = "Level1";

        // Delivery timeframe
        public string DeliveryTimeframe { get; set; } = "Standard";

        // Additional services
        public bool IncludePrepaymentDiscount { get; set; }
        public bool IncludeDigitalDelivery { get; set; }
        public bool IncludeComponentInventory { get; set; }
        public bool IncludeFundingPlans { get; set; }

        // Terms and comments
        public string? PaymentTerms { get; set; }
        public string? Comments { get; set; }

        // Amendment properties
        public int AmendmentNumber { get; set; } = 0;
        public string? AmendmentReason { get; set; }
    }
}
