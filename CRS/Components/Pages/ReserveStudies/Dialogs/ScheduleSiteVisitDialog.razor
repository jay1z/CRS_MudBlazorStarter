@using CRS.Data

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudAvatar Color="Color.Primary" Size="Size.Medium">
                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" />
            </MudAvatar>
            <div>
                <MudText Typo="Typo.h6" Style="font-weight: 600;">Schedule Site Visit</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Select a date and time for the site visit</MudText>
            </div>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                Select the date and time when the specialist will visit the property to assess the common elements and building components.
            </MudAlert>
            
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="7">
                    <MudDatePicker @bind-Date="selectedDate"
                                   Label="Site Visit Date"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Please select a date for the site visit"
                                   MinDate="DateTime.Today"
                                   PickerVariant="PickerVariant.Dialog"
                                   Editable="true"
                                   DateFormat="MMMM dd, yyyy"
                                   Placeholder="Select date..." />
                </MudItem>
                <MudItem xs="12" sm="5">
                    <MudTimePicker @bind-Time="selectedTime"
                                   Label="Start Time"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Please select a time"
                                   PickerVariant="PickerVariant.Dialog"
                                   Editable="true"
                                   AmPm="true"
                                   Placeholder="Select time..." />
                </MudItem>
            </MudGrid>

            @if (selectedDate.HasValue && selectedTime.HasValue) {
                <MudPaper Elevation="0" Class="pa-4" Style="background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%); border-radius: 8px;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <MudAvatar Size="Size.Large" Style="background: #667eea; color: white;">
                            <MudIcon Icon="@Icons.Material.Filled.Event" />
                        </MudAvatar>
                        <div>
                            <MudText Typo="Typo.caption" Style="color: #667eea; font-weight: 600; text-transform: uppercase;">
                                SCHEDULED DATE & TIME
                            </MudText>
                            <MudText Typo="Typo.h6" Style="font-weight: 700; color: #5b21b6;">
                                @GetScheduledDateTime().ToString("dddd, MMMM dd, yyyy")
                            </MudText>
                            <MudText Typo="Typo.body1" Style="font-weight: 600; color: #667eea;">
                                @GetScheduledDateTime().ToString("h:mm tt")
                            </MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" 
                   Variant="Variant.Text" 
                   Color="Color.Default">
            Cancel
        </MudButton>
        <MudButton OnClick="Submit" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary"
                   Disabled="@(!selectedDate.HasValue || !selectedTime.HasValue)"
                   StartIcon="@Icons.Material.Filled.Check">
            Confirm Schedule
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public DateTime? CurrentDate { get; set; }

    private DateTime? selectedDate;
    private TimeSpan? selectedTime;

    protected override void OnInitialized() {
        if (CurrentDate.HasValue) {
            selectedDate = CurrentDate.Value.Date;
            selectedTime = CurrentDate.Value.TimeOfDay;
        } else {
            selectedDate = DateTime.Today.AddDays(7);
            selectedTime = new TimeSpan(9, 0, 0); // Default to 9:00 AM
        }
    }

    private DateTime GetScheduledDateTime() {
        if (selectedDate.HasValue && selectedTime.HasValue) {
            return selectedDate.Value.Date.Add(selectedTime.Value);
        }
        return DateTime.Now;
    }

    private void Cancel() => MudDialog.Cancel();

    private void Submit() {
        if (selectedDate.HasValue && selectedTime.HasValue) {
            var scheduledDateTime = GetScheduledDateTime();
            MudDialog.Close(DialogResult.Ok(scheduledDateTime));
        }
    }
}
