@namespace CRS.Components.Pages.ReserveStudyPages.Steps

@using CRS.Data
@using CRS.Models
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudForm Model="Model" @ref="form">
    <MudGrid>
        <!-- Service Contacts Header -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Service Contacts</MudText>
            <MudText Typo="Typo.body2" Class="mb-4" Style="color: #666;">
                Provide service contact information for elements that require ongoing maintenance or service contracts.
            </MudText>
        </MudItem>

        @if (!elementsNeedingService.Any()) {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">
                    No elements requiring service contacts have been selected yet. 
                    Please add elements in the Property Elements tab and check "Needs Service" for those requiring service contacts.
                </MudAlert>
            </MudItem>
        }
        else {
            @foreach (var element in elementsNeedingService) {
                <MudItem xs="12">
                    <MudCard Elevation="2" Class="mb-4" Style="border-radius: 12px; border-left: 4px solid #667eea;">
                        <MudCardHeader Style="background: #f8f9fa;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Build" Color="Color.Primary" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">@GetElementName(element)</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Info">@GetElementType(element)</MudChip>
                            </MudStack>
                        </MudCardHeader>
                        <MudCardContent>
                            @{
                                var serviceContact = GetServiceContact(element);
                            }
                            <MudGrid Spacing="3">
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="serviceContact.CompanyName" 
                                                  Label="Company Name" 
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="3">
                                    <MudTextField @bind-Value="serviceContact.FirstName" 
                                                  Label="First Name" 
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="3">
                                    <MudTextField @bind-Value="serviceContact.LastName" 
                                                  Label="Last Name" 
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="serviceContact.Email" 
                                                  Label="Email" 
                                                  Variant="Variant.Outlined"
                                                  InputType="InputType.Email"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="4">
                                    <MudTextField @bind-Value="serviceContact.Phone" 
                                                  Label="Phone" 
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudItem>
                                <MudItem xs="12" md="2">
                                    <MudTextField @bind-Value="serviceContact.Extension" 
                                                  Label="Extension" 
                                                  Variant="Variant.Outlined"
                                                  Immediate="true" />
                                </MudItem>
                            </MudGrid>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        }
    </MudGrid>
</MudForm>

@code {
    [Parameter]
    public ReserveStudy? Model { get; set; }

    [Parameter]
    public bool IsEdit { get; set; } = false;

    [Parameter]
    public EventCallback<bool> StepValidated { get; set; }

    private MudForm? form;
    private List<IReserveStudyElement> elementsNeedingService = new();

    protected override void OnParametersSet() {
        LoadElementsNeedingService();
    }

    private void LoadElementsNeedingService() {
        elementsNeedingService.Clear();

        if (Model == null) return;

        // Get all elements that need service
        if (Model.ReserveStudyBuildingElements != null) {
            elementsNeedingService.AddRange(
                Model.ReserveStudyBuildingElements.Where(e => e.NeedsService)
            );
        }

        if (Model.ReserveStudyCommonElements != null) {
            elementsNeedingService.AddRange(
                Model.ReserveStudyCommonElements.Where(e => e.NeedsService)
            );
        }

        if (Model.ReserveStudyAdditionalElements != null) {
            elementsNeedingService.AddRange(
                Model.ReserveStudyAdditionalElements.Where(e => e.NeedsService)
            );
        }
    }

    private string GetElementName(IReserveStudyElement element) {
        return element switch {
            ReserveStudyBuildingElement be => be.BuildingElement?.Name ?? "Building Element",
            ReserveStudyCommonElement ce => ce.CommonElement?.Name ?? "Common Element",
            ReserveStudyAdditionalElement ae => ae.Name ?? "Additional Element",
            _ => "Unknown Element"
        };
    }

    private string GetElementType(IReserveStudyElement element) {
        return element switch {
            ReserveStudyBuildingElement => "Building",
            ReserveStudyCommonElement => "Common",
            ReserveStudyAdditionalElement => "Additional",
            _ => "Unknown"
        };
    }

    private ServiceContact GetServiceContact(IReserveStudyElement element) {
        if (element.ServiceContact == null) {
            element.ServiceContact = new ServiceContact();
        }
        return element.ServiceContact;
    }

    public async Task<bool> ValidateAsync() {
        if (form == null) return true; // No validation needed if no form
        
        await form.Validate();
        bool valid = form.IsValid;
        await StepValidated.InvokeAsync(valid);
        return valid;
    }
}
