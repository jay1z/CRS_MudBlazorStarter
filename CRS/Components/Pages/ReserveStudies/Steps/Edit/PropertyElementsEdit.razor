@namespace CRS.Components.Pages.ReserveStudyPages.Steps.Edit

@using CRS.Data
@using CRS.Services.Interfaces
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IElementService ElementService
@inject ILogger<PropertyElementsEdit> Logger

<MudForm Model="Model" @ref="form">
    <MudGrid>
        <!-- Property Elements Header -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Property Elements</MudText>
        </MudItem>

        <!-- Building Elements Section -->
        <MudItem xs="6">
            <MudText Typo="Typo.h6" Class="mb-4">Building Elements</MudText>
            @if (buildingElements != null && buildingElements.Any()) {
                @foreach (var element in buildingElements) {
                    var capturedElement = element; // Capture for closure
                    <MudCheckBox T="bool" 
                                 Value="@buildingElementSelections.GetValueOrDefault(capturedElement.Id, false)" 
                                 ValueChanged="@((bool val) => OnBuildingElementChanged(val, capturedElement))">
                        <MudText Typo="Typo.body2">
                            @capturedElement.Name@(capturedElement.NeedsService ? " *" : "")
                        </MudText>
                    </MudCheckBox>
                }
            }
            else {
                <MudText>No Building Elements available.</MudText>
            }
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: #666;">
                * = Requires service contact
            </MudText>
        </MudItem>

        <!-- Common Elements Section -->
        <MudItem xs="6">
            <MudText Typo="Typo.h6" Class="mb-4">Common Elements</MudText>
            @if (commonElements != null && commonElements.Any()) {
                @foreach (var element in commonElements) {
                    var capturedElement = element; // Capture for closure
                    <MudCheckBox T="bool" 
                                 Value="@commonElementSelections.GetValueOrDefault(capturedElement.Id, false)" 
                                 ValueChanged="@((bool val) => OnCommonElementChanged(val, capturedElement))">
                        <MudText Typo="Typo.body2">
                            @capturedElement.Name@(capturedElement.NeedsService ? " *" : "")
                        </MudText>
                    </MudCheckBox>
                }
            }
            else {
                <MudText>No Common Elements available.</MudText>
            }
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: #666;">
                * = Requires service contact
            </MudText>
        </MudItem>

        <!-- Additional Elements Section -->
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-4">Additional Elements</MudText>
            <MudList T="ReserveStudyAdditionalElement">
                @foreach (var additionalElement in Model.ReserveStudyAdditionalElements.OrderBy(ae => ae.DateCreated)) {
                    <MudListItem>
                        <MudGrid>
                            <MudItem xs="7">
                                <MudTextField T="string" @bind-Value="additionalElement.Name" Placeholder="Enter element name" />
                            </MudItem>
                            <MudItem xs="3">
                                <MudCheckBox T="bool" @bind-Value="additionalElement.NeedsService" Label="Needs Service" />
                            </MudItem>
                            <MudItem xs="2">
                                <MudButton Variant="Variant.Text" Color="Color.Error"
                                           OnClick="() => RemoveAdditionalElement(additionalElement)">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" />
                                    Delete
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudListItem>
                }
            </MudList>
            <MudButton Variant="Variant.Filled" Color="Color.Tertiary" OnClick="AddAdditionalElement">
                <MudIcon Icon="@Icons.Material.Filled.Add" />
                Add Additional Element
            </MudButton>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
private ApplicationDbContext? context;

[Parameter]
public ReserveStudy? Model { get; set; }

[Parameter]
public bool IsEdit { get; set; } = false;

private List<BuildingElement>? buildingElements;
private List<CommonElement>? commonElements;

    private Dictionary<Guid, bool> buildingElementSelections = new();
    private Dictionary<Guid, bool> commonElementSelections = new();
    private MudForm? form;
    private Guid? lastModelId; // Track the last model ID to avoid re-initializing on every render

    protected override async Task OnInitializedAsync() {
        context = await DbFactory.CreateDbContextAsync();

        // Use ElementService for tenant-aware element loading with proper ordering
        buildingElements = await ElementService.GetBuildingElementsAsync();
        commonElements = await ElementService.GetCommonElementsAsync();
        
        // Initialize all checkboxes to false
        foreach (var element in buildingElements) {
            buildingElementSelections[element.Id] = false;
        }
        foreach (var element in commonElements) {
            commonElementSelections[element.Id] = false;
        }

        // Initialize collections if null
        if (Model != null) {
            Model.ReserveStudyBuildingElements ??= new List<ReserveStudyBuildingElement>();
            Model.ReserveStudyCommonElements ??= new List<ReserveStudyCommonElement>();
            Model.ReserveStudyAdditionalElements ??= new List<ReserveStudyAdditionalElement>();
            
            // Only update selections from Model if the Model has actual data
            if (Model.ReserveStudyBuildingElements.Any() || Model.ReserveStudyCommonElements.Any()) {
                UpdateSelectionsFromModel();
            }
            lastModelId = Model.Id;
        }
    }

    protected override void OnParametersSet() {
        // Only re-evaluate selections when the Model ID changes (new model loaded)
        // NOT on every parameter set (which happens during normal rendering)
        if (Model != null && buildingElements != null && commonElements != null) {
            if (lastModelId != Model.Id) {
                lastModelId = Model.Id;
                UpdateSelectionsFromModel();
            }
        }
    }
    
    private void UpdateSelectionsFromModel() {
        // Update selections based on Model's current elements
        // Only set to true for elements that exist in the Model
        foreach (var element in buildingElements ?? Enumerable.Empty<BuildingElement>()) {
            buildingElementSelections[element.Id] = Model.ReserveStudyBuildingElements?.Any(e => e.BuildingElementId == element.Id) ?? false;
        }

        foreach (var element in commonElements ?? Enumerable.Empty<CommonElement>()) {
            commonElementSelections[element.Id] = Model.ReserveStudyCommonElements?.Any(e => e.CommonElementId == element.Id) ?? false;
        }
    }

    private void AddAdditionalElement() {
        Model.ReserveStudyAdditionalElements ??= new List<ReserveStudyAdditionalElement>();
        Model.ReserveStudyAdditionalElements.Add(new ReserveStudyAdditionalElement { Name = string.Empty });
    }

    private void RemoveAdditionalElement(ReserveStudyAdditionalElement element) {
        Model.ReserveStudyAdditionalElements?.Remove(element);
    }

    private void OnBuildingElementChanged(bool isSelected, BuildingElement element) {
        Logger.LogInformation("OnBuildingElementChanged: {Name} -> {Selected}, Dict count before: {Count}", 
            element.Name, isSelected, buildingElementSelections.Count);
        
        buildingElementSelections[element.Id] = isSelected;
        
        if (isSelected) {
            Model.ReserveStudyBuildingElements ??= new List<ReserveStudyBuildingElement>();
            if (!Model.ReserveStudyBuildingElements.Any(e => e.BuildingElementId == element.Id)) {
                Model.ReserveStudyBuildingElements.Add(new ReserveStudyBuildingElement { 
                    BuildingElementId = element.Id, 
                    ReserveStudyId = Model.Id 
                });
            }
        }
        else {
            var itemToRemove = Model.ReserveStudyBuildingElements?.FirstOrDefault(e => e.BuildingElementId == element.Id);
            if (itemToRemove != null) {
                Model.ReserveStudyBuildingElements.Remove(itemToRemove);
            }
        }
        
        Logger.LogInformation("OnBuildingElementChanged: After update, true count: {TrueCount}", 
            buildingElementSelections.Count(x => x.Value));
    }

    private void OnCommonElementChanged(bool isSelected, CommonElement element) {
        commonElementSelections[element.Id] = isSelected;
        
        if (isSelected) {
            Model.ReserveStudyCommonElements ??= new List<ReserveStudyCommonElement>();
            if (!Model.ReserveStudyCommonElements.Any(e => e.CommonElementId == element.Id)) {
                Model.ReserveStudyCommonElements.Add(new ReserveStudyCommonElement { 
                    CommonElementId = element.Id, 
                    ReserveStudyId = Model.Id 
                });
            }
        }
        else {
            var itemToRemove = Model.ReserveStudyCommonElements?.FirstOrDefault(e => e.CommonElementId == element.Id);
            if (itemToRemove != null) {
                Model.ReserveStudyCommonElements.Remove(itemToRemove);
            }
        }
    }

    public async ValueTask DisposeAsync() {
        if (context != null) {
            await context.DisposeAsync();
        }
    }

    [Parameter]
    public EventCallback<bool> StepValidated { get; set; }

    public async Task<bool> ValidateAsync() {
        await form.Validate();
        bool valid = form.IsValid;
        
        // IMPORTANT: Sync selections back to Model before saving
        // This ensures any checkbox changes are reflected in the Model's collections
        SyncSelectionsToModel();
        
        // Log the current state of collections for debugging
        System.Diagnostics.Debug.WriteLine($"PropertyElementsEdit.ValidateAsync: BuildingElements count: {Model?.ReserveStudyBuildingElements?.Count ?? 0}");
        System.Diagnostics.Debug.WriteLine($"PropertyElementsEdit.ValidateAsync: CommonElements count: {Model?.ReserveStudyCommonElements?.Count ?? 0}");
        System.Diagnostics.Debug.WriteLine($"PropertyElementsEdit.ValidateAsync: AdditionalElements count: {Model?.ReserveStudyAdditionalElements?.Count ?? 0}");
        
        await StepValidated.InvokeAsync(valid);
        return valid;
    }

    /// <summary>
    /// Syncs the checkbox selections back to the Model's collections.
    /// </summary>
    private void SyncSelectionsToModel() {
        if (Model == null) return;
        
        // Rebuild BuildingElements collection from selections
        Model.ReserveStudyBuildingElements ??= new List<ReserveStudyBuildingElement>();
        var currentBuildingElementIds = Model.ReserveStudyBuildingElements.Select(e => e.BuildingElementId).ToHashSet();
        
        foreach (var kvp in buildingElementSelections) {
            if (kvp.Value && !currentBuildingElementIds.Contains(kvp.Key)) {
                Model.ReserveStudyBuildingElements.Add(new ReserveStudyBuildingElement {
                    BuildingElementId = kvp.Key,
                    ReserveStudyId = Model.Id
                });
            } else if (!kvp.Value && currentBuildingElementIds.Contains(kvp.Key)) {
                var toRemove = Model.ReserveStudyBuildingElements.FirstOrDefault(e => e.BuildingElementId == kvp.Key);
                if (toRemove != null) {
                    Model.ReserveStudyBuildingElements.Remove(toRemove);
                }
            }
        }
        
        // Rebuild CommonElements collection from selections
        Model.ReserveStudyCommonElements ??= new List<ReserveStudyCommonElement>();
        var currentCommonElementIds = Model.ReserveStudyCommonElements.Select(e => e.CommonElementId).ToHashSet();
        
        foreach (var kvp in commonElementSelections) {
            if (kvp.Value && !currentCommonElementIds.Contains(kvp.Key)) {
                Model.ReserveStudyCommonElements.Add(new ReserveStudyCommonElement {
                    CommonElementId = kvp.Key,
                    ReserveStudyId = Model.Id
                });
            } else if (!kvp.Value && currentCommonElementIds.Contains(kvp.Key)) {
                var toRemove = Model.ReserveStudyCommonElements.FirstOrDefault(e => e.CommonElementId == kvp.Key);
                if (toRemove != null) {
                    Model.ReserveStudyCommonElements.Remove(toRemove);
                }
            }
        }
        
        Logger.LogInformation("SyncSelectionsToModel: BuildingElements: {Building}, CommonElements: {Common}", 
            Model.ReserveStudyBuildingElements.Count, Model.ReserveStudyCommonElements.Count);
    }

    /// <summary>
    /// Call this method after Model is fully loaded to refresh checkbox states
    /// </summary>
    public void RefreshSelections() {
        if (Model != null && buildingElements != null && commonElements != null) {
            UpdateSelectionsFromModel();
            StateHasChanged();
        }
    }
}
