@namespace CRS.Components.Pages.ReserveStudyPages.Steps.Create

@using MudBlazor
@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IContactService ContactService
@inject UserStateService UserState
@inject ISnackbar Snackbar

<MudForm Model="Model" @ref="form">
    <MudGrid>
        <!-- Board Member Contact Section -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Board Member Contact</MudText>
        </MudItem>

        <!-- Contact Selection Type -->
        <MudItem xs="12">
            <MudRadioGroup ValueChanged="@((bool val) => OnContactTypeChanged(val))">
                <MudRadio Value="false" Color="Color.Primary">Enter New Contact</MudRadio>
                <MudRadio Value="true" Color="Color.Primary">Select Existing Contact</MudRadio>
            </MudRadioGroup>
        </MudItem>

        @if (useExistingContact) {
            <!-- Existing Contact Selector -->
            <MudItem xs="12">
                <MudSelect T="Contact" Label="Select Contact" @bind-Value="selectedContact" Required="true" AdornmentIcon="@Icons.Material.TwoTone.ContactPhone"
                           For="@(() => selectedContact)" SelectedValuesChanged="@OnExistingContactSelected">
                    @foreach (var contact in existingContacts) {
                        <MudSelectItem Value="@contact">
                            @($"{contact.FirstName} {contact.LastName} - {contact.Email}")
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        }
        else {
            <!-- First Name and Last Name -->
            <MudItem xs="12">
                <MudGrid>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="Model.Contact.FirstName" Label="First Name" Required="true" Immediate="true" />
                    </MudItem>
                    <MudItem xs="6">
                        <MudTextField @bind-Value="Model.Contact.LastName" Label="Last Name" Required="true" Immediate="true" />
                    </MudItem>
                </MudGrid>
            </MudItem>

            <!-- Email -->
            <MudItem xs="12">
                <MudTextField @bind-Value="Model.Contact.Email" Label="Email" Required="true" Immediate="true" />
            </MudItem>

            <!-- Phone and Extension -->
            <MudItem xs="12">
                <MudGrid>
                    <MudItem xs="5">
                        <MudTextField @bind-Value="Model.Contact.Phone" Label="Phone" Required="true" Immediate="true" />
                    </MudItem>
                    <MudItem xs="3">
                        <MudTextField @bind-Value="Model.Contact.Extension" Label="Extension" Immediate="true" />
                    </MudItem>
                </MudGrid>
            </MudItem>
        }

        <!-- Property Manager Section -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Property Manager Contact</MudText>
        </MudItem>

        <!-- Property Manager Optional Checkbox -->
        <MudItem xs="12">
            <MudCheckBox T="bool"
                         @bind-Value="includePropertyManager"
                         Label="Include Property Manager Contact (Optional)"
                         Color="Color.Primary" />
        </MudItem>

        @if (includePropertyManager && Model != null) {
            <!-- Property Manager Selection Type -->
            <MudItem xs="12">
                <MudRadioGroup @bind-Value="propertyManagerMode">
                    <MudRadio T="PropertyManagerModeEnum" Value="PropertyManagerModeEnum.UseMyAccount" Color="Color.Primary" Disabled="@(!CanUseMyAccount)">
                        Use My Account Info
                        @if (!CanUseMyAccount)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-2">(Profile incomplete)</MudText>
                        }
                    </MudRadio>
                    <MudRadio T="PropertyManagerModeEnum" Value="PropertyManagerModeEnum.SelectExisting" Color="Color.Primary">Select Existing Property Manager</MudRadio>
                    <MudRadio T="PropertyManagerModeEnum" Value="PropertyManagerModeEnum.EnterNew" Color="Color.Primary">Enter New Property Manager</MudRadio>
                </MudRadioGroup>
            </MudItem>

            @if (propertyManagerMode == PropertyManagerModeEnum.UseMyAccount && CanUseMyAccount)
            {
                <!-- Show current user's info with editable fields for missing data -->
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                        Using your account information as the Property Manager contact.
                        @if (string.IsNullOrWhiteSpace(CurrentUserCompanyName) || string.IsNullOrWhiteSpace(CurrentUserPhone))
                        {
                            <MudText Typo="Typo.caption"> Please fill in any missing fields below.</MudText>
                        }
                    </MudAlert>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudTextField Value="@UserState.CurrentUser?.FullName" 
                                          Label="Name" 
                                          ReadOnly="true" 
                                          Variant="Variant.Filled" />
                        </MudItem>
                        <MudItem xs="6">
                            @if (string.IsNullOrWhiteSpace(CurrentUserCompanyName))
                            {
                                <MudTextField @bind-Value="Model.PropertyManager.CompanyName" 
                                              Label="Company Name" 
                                              Required="true"
                                              Immediate="true"
                                              Placeholder="Enter your company name" />
                            }
                            else
                            {
                                <MudTextField Value="@CurrentUserCompanyName" 
                                              Label="Company" 
                                              ReadOnly="true" 
                                              Variant="Variant.Filled" />
                            }
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Value="@UserState.CurrentUser?.Email" 
                                          Label="Email" 
                                          ReadOnly="true" 
                                          Variant="Variant.Filled" />
                        </MudItem>
                        <MudItem xs="6">
                            @if (string.IsNullOrWhiteSpace(CurrentUserPhone))
                            {
                                <MudTextField @bind-Value="Model.PropertyManager.Phone" 
                                              Label="Phone" 
                                              Required="true"
                                              Immediate="true"
                                              Placeholder="Enter your phone number" />
                            }
                            else
                            {
                                <MudTextField Value="@CurrentUserPhone" 
                                              Label="Phone" 
                                              ReadOnly="true" 
                                              Variant="Variant.Filled" />
                            }
                        </MudItem>
                    </MudGrid>
                </MudItem>
            }
            else if (propertyManagerMode == PropertyManagerModeEnum.SelectExisting) {
                <!-- Existing Property Manager Selector -->
                <MudItem xs="12">
                    <MudSelect T="PropertyManager" Label="Select Property Manager" @bind-Value="selectedPropertyManager" Required="true" AdornmentIcon="@Icons.Material.TwoTone.Business"
                               For="@(() => selectedPropertyManager)" SelectedValuesChanged="@OnExistingPropertyManagerSelected">
                        @foreach (var propertyManager in existingPropertyManagers) {
                            <MudSelectItem Value="@propertyManager">
                                @($"{propertyManager.CompanyName} - {propertyManager.FirstName} {propertyManager.LastName}")
                            </MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }
            else if (propertyManagerMode == PropertyManagerModeEnum.EnterNew) {
                <!-- First Name and Last Name -->
                <MudItem xs="12">
                    <MudGrid>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="Model.PropertyManager.FirstName" Label="First Name" Required="true" Immediate="true" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="Model.PropertyManager.LastName" Label="Last Name" Required="true" Immediate="true" />
                        </MudItem>
                    </MudGrid>
                </MudItem>

                <!-- Company Name -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="Model.PropertyManager.CompanyName" Label="Company Name" Required="true" Immediate="true" />
                </MudItem>

                <!-- Email -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="Model.PropertyManager.Email" Label="Email" Required="true" Immediate="true" />
                </MudItem>

                <!-- Phone and Extension -->
                <MudItem xs="12">
                    <MudGrid>
                        <MudItem xs="5">
                            <MudTextField @bind-Value="Model.PropertyManager.Phone" Label="Phone" Required="true" Immediate="true" />
                        </MudItem>
                        <MudItem xs="3">
                            <MudTextField @bind-Value="Model.PropertyManager.Extension" Label="Extension" Immediate="true" />
                        </MudItem>
                    </MudGrid>
                </MudItem>
            }
        }

        <!-- Preferred Point of Contact -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Preferred Point of Contact</MudText>
            <MudRadioGroup @bind-Value="Model.PointOfContactType">
                <MudRadio Value="ReserveStudy.PointOfContactTypeEnum.Contact" Label="Contact" />
                @if (includePropertyManager) {
                    <MudRadio Value="ReserveStudy.PointOfContactTypeEnum.PropertyManager" Label="Property Manager" />
                }
            </MudRadioGroup>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    [Parameter]
    public ReserveStudy Model { get; set; }

    [Parameter]
    public EventCallback<bool> StepValidated { get; set; }

    [Parameter]
    public EventCallback<bool> OnExistingContactChanged { get; set; }

    private MudForm form;
    private bool useExistingContact;
    private PropertyManagerModeEnum _propertyManagerMode = PropertyManagerModeEnum.EnterNew;
    private bool _includePropertyManager = false;
    private Contact selectedContact;
    private PropertyManager selectedPropertyManager;
    private List<Contact> existingContacts = new();
    private List<PropertyManager> existingPropertyManagers = new();
    private CustomerAccount? _customerAccount; // Customer account for company info

    // Enum for Property Manager selection mode
    private enum PropertyManagerModeEnum
    {
        UseMyAccount,
        SelectExisting,
        EnterNew
    }

    // Property to track mode and auto-populate when "Use My Account" is selected
    private PropertyManagerModeEnum propertyManagerMode
    {
        get => _propertyManagerMode;
        set
        {
            if (_propertyManagerMode == value) return;
            _propertyManagerMode = value;

            if (value == PropertyManagerModeEnum.UseMyAccount && CanUseMyAccount)
            {
                PopulatePropertyManagerFromCurrentUser();
            }
            else if (value == PropertyManagerModeEnum.EnterNew)
            {
                // Clear and start fresh for manual entry
                selectedPropertyManager = null;
                if (Model != null)
                {
                    Model.PropertyManager = new PropertyManager();
                    Model.PropertyManagerId = null;
                }
            }

            StateHasChanged();
        }
    }

    // Check if current user has enough info to use as Property Manager
    private bool CanUseMyAccount => 
        UserState.CurrentUser != null &&
        !string.IsNullOrWhiteSpace(UserState.CurrentUser.FirstName) &&
        !string.IsNullOrWhiteSpace(UserState.CurrentUser.LastName) &&
        !string.IsNullOrWhiteSpace(UserState.CurrentUser.Email);

    // Get company name from CustomerAccount or ApplicationUser
    private string? CurrentUserCompanyName => 
        _customerAccount?.Name ?? UserState.CurrentUser?.CompanyName;

    // Get phone from CustomerAccount or ApplicationUser
    private string? CurrentUserPhone => 
        _customerAccount?.Phone ?? UserState.CurrentUser?.PhoneNumber;

    // Populate Property Manager fields from current user's account
    private void PopulatePropertyManagerFromCurrentUser()
    {
        if (UserState.CurrentUser == null || Model == null) return;

        Model.PropertyManager = new PropertyManager
        {
            FirstName = UserState.CurrentUser.FirstName,
            LastName = UserState.CurrentUser.LastName,
            CompanyName = CurrentUserCompanyName, // Use CustomerAccount name first
            Email = UserState.CurrentUser.Email,
            Phone = CurrentUserPhone // Use CustomerAccount phone first
        };
        Model.PropertyManagerId = null; // New PM, not linked to existing
        selectedPropertyManager = null;
    }

    // Simplified property - just manages checkbox state
    private bool includePropertyManager
    {
        get => _includePropertyManager;
        set
        {
            if (_includePropertyManager == value) return;

            _includePropertyManager = value;

            if (value)
            {
                // Default to "Use My Account" if available, otherwise "Enter New"
                _propertyManagerMode = CanUseMyAccount ? PropertyManagerModeEnum.UseMyAccount : PropertyManagerModeEnum.EnterNew;

                if (_propertyManagerMode == PropertyManagerModeEnum.UseMyAccount)
                {
                    PopulatePropertyManagerFromCurrentUser();
                }
                else if (Model != null && Model.PropertyManager == null)
                {
                    Model.PropertyManager = new PropertyManager();
                }
            }
            
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync() {
        await LoadUserContacts();
        await LoadUserPropertyManagers();
        await LoadCustomerAccountAsync();

        // For CREATE mode: Check if PropertyManager has any meaningful data
        // This handles navigation back to this step after filling in data
        if (Model?.PropertyManager != null) {
            var hasData = !string.IsNullOrWhiteSpace(Model.PropertyManager.FirstName) ||
                         !string.IsNullOrWhiteSpace(Model.PropertyManager.LastName) ||
                         !string.IsNullOrWhiteSpace(Model.PropertyManager.CompanyName) ||
                         !string.IsNullOrWhiteSpace(Model.PropertyManager.Email) ||
                         !string.IsNullOrWhiteSpace(Model.PropertyManager.Phone);

            if (hasData) {
                _includePropertyManager = true;
            }
        }

        // Ensure PropertyManager is initialized if checkbox is checked
        if (_includePropertyManager && Model?.PropertyManager == null) {
            Model.PropertyManager = new PropertyManager();
        }
    }

    private async Task LoadCustomerAccountAsync() {
        try {
            if (UserState.CurrentUser == null) return;

            await using var context = await DbFactory.CreateDbContextAsync();
            _customerAccount = await context.CustomerAccountUsers
                .AsNoTracking()
                .Where(cau => cau.UserId == UserState.CurrentUser.Id && cau.IsActive)
                .Select(cau => cau.CustomerAccount)
                .FirstOrDefaultAsync();
        }
        catch (Exception) {
            _customerAccount = null;
        }
    }

    private async Task LoadUserContacts() {
        try {
            await UserState.InitializeAsync();
            var userId = UserState.CurrentUser?.Id.ToString();

            if (!string.IsNullOrEmpty(userId)) {
                existingContacts = await ContactService.GetUserContactsAsync(userId);
            }
        }
        catch (Exception) {
            existingContacts = new List<Contact>();
        }
    }

    private async Task LoadUserPropertyManagers() {
        try {
            using var context = await DbFactory.CreateDbContextAsync();
            var allPropertyManagers = await context.PropertyManagers
                .AsNoTracking()
                .Where(pm => !pm.DateDeleted.HasValue)
                // Filter out empty property managers
                .Where(pm => !string.IsNullOrWhiteSpace(pm.FirstName) || 
                            !string.IsNullOrWhiteSpace(pm.LastName) || 
                            !string.IsNullOrWhiteSpace(pm.CompanyName) ||
                            !string.IsNullOrWhiteSpace(pm.Email))
                .ToListAsync();

            // Deduplicate by name/company/email
            existingPropertyManagers = allPropertyManagers
                .GroupBy(pm => new { 
                    FirstName = pm.FirstName?.ToLowerInvariant()?.Trim(),
                    LastName = pm.LastName?.ToLowerInvariant()?.Trim(),
                    CompanyName = pm.CompanyName?.ToLowerInvariant()?.Trim(),
                    Email = pm.Email?.ToLowerInvariant()?.Trim()
                })
                .Select(g => g.First())
                .OrderBy(pm => pm.CompanyName)
                .ThenBy(pm => pm.LastName)
                .ToList();
        }
        catch (Exception) {
            existingPropertyManagers = new List<PropertyManager>();
        }
    }

    private async Task OnContactTypeChanged(bool useExisting) {
        useExistingContact = useExisting;
        if (!useExisting) {
            selectedContact = null;
            Model.Contact = new Contact();
        }
        await OnExistingContactChanged.InvokeAsync(useExistingContact);
    }

    private void OnExistingContactSelected() {
        if (selectedContact != null) {
            Model.Contact = selectedContact;
            Model.ContactId = selectedContact.Id;
        }
    }

    private void OnExistingPropertyManagerSelected() {
        if (selectedPropertyManager != null) {
            Model.PropertyManager = selectedPropertyManager;
            Model.PropertyManagerId = selectedPropertyManager.Id;
        }
    }

    public async Task<bool> ValidateAsync() {
        // Simple validation for CREATE mode
        if (!includePropertyManager) {
            // Only clear if PropertyManager is truly empty
            if (Model.PropertyManager != null && 
                string.IsNullOrWhiteSpace(Model.PropertyManager.FirstName) &&
                string.IsNullOrWhiteSpace(Model.PropertyManager.LastName) &&
                string.IsNullOrWhiteSpace(Model.PropertyManager.CompanyName)) {
                Model.PropertyManager = null;
                Model.PropertyManagerId = null;
            }
            else if (Model.PropertyManager != null) {
                // Has data but checkbox unchecked - preserve data and re-check
                _includePropertyManager = true;
            }
            
            Model.PointOfContactType = ReserveStudy.PointOfContactTypeEnum.Contact;
        }
        
        await form.Validate();
        bool valid = form.IsValid;
        await StepValidated.InvokeAsync(valid);
        return valid;
    }
}
