@namespace CRS.Components.Pages.ReserveStudyPages.Steps.Create

@using CRS.Data
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@inject IDbContextFactory<ApplicationDbContext> DbFactory

<MudForm Model="Model" @ref="form">
    <MudGrid>
        <!-- Property Elements Header -->
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">Property Elements</MudText>
        </MudItem>

        <!-- Building Elements Section -->
        <MudItem xs="6">
            <MudText Typo="Typo.h6" Class="mb-4">Building Elements</MudText>
            @if (buildingElements != null && buildingElements.Any()) {
                @foreach (var element in buildingElements) {
                    var elementId = element.Id;
                    var isChecked = buildingElementSelections.GetValueOrDefault(elementId, false);
                    var studyElement = Model.ReserveStudyBuildingElements?.FirstOrDefault(e => e.BuildingElementId == elementId);
                    var needsService = element.NeedsService;
                    
                    <MudCheckBox T="bool" 
                                 Checked="@isChecked" 
                                 CheckedChanged="@((bool val) => OnBuildingElementChanged(val, element))">
                        <MudText Typo="Typo.body2">
                            @element.Name@(needsService ? " *" : "")
                        </MudText>
                    </MudCheckBox>
                }
            }
            else {
                <MudText>No Building Elements available.</MudText>
            }
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: #666;">
                * = Requires service contact
            </MudText>
        </MudItem>

        <!-- Common Elements Section -->
        <MudItem xs="6">
            <MudText Typo="Typo.h6" Class="mb-4">Common Elements</MudText>
            @if (commonElements != null && commonElements.Any()) {
                @foreach (var element in commonElements) {
                    var elementId = element.Id;
                    var isChecked = commonElementSelections.GetValueOrDefault(elementId, false);
                    var studyElement = Model.ReserveStudyCommonElements?.FirstOrDefault(e => e.CommonElementId == elementId);
                    var needsService = element.NeedsService;
                    
                    <MudCheckBox T="bool" 
                                 Checked="@isChecked" 
                                 CheckedChanged="@((bool val) => OnCommonElementChanged(val, element))">
                        <MudText Typo="Typo.body2">
                            @element.Name@(needsService ? " *" : "")
                        </MudText>
                    </MudCheckBox>
                }
            }
            else {
                <MudText>No Common Elements available.</MudText>
            }
            <MudText Typo="Typo.caption" Class="mt-2" Style="color: #666;">
                * = Requires service contact
            </MudText>
        </MudItem>

        <!-- Additional Elements Section -->
        <MudItem xs="12">
            <MudText Typo="Typo.h6" Class="mb-4">Additional Elements</MudText>
            <MudList T="ReserveStudyAdditionalElement">
                @foreach (var additionalElement in Model.ReserveStudyAdditionalElements) {
                    <MudListItem>
                        <MudGrid>
                            <MudItem xs="7">
                                <MudTextField T="string" @bind-Value="additionalElement.Name" Placeholder="Enter element name" />
                            </MudItem>
                            <MudItem xs="3">
                                <MudCheckBox T="bool" @bind-Value="additionalElement.NeedsService" Label="Needs Service" />
                            </MudItem>
                            <MudItem xs="2">
                                <MudButton Variant="Variant.Text" Color="Color.Error"
                                           OnClick="() => RemoveAdditionalElement(additionalElement)">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" />
                                    Delete
                                </MudButton>
                            </MudItem>
                        </MudGrid>
                    </MudListItem>
                }
            </MudList>
            <MudButton Variant="Variant.Filled" Color="Color.Tertiary" OnClick="AddAdditionalElement">
                <MudIcon Icon="@Icons.Material.Filled.Add" />
                Add Additional Element
            </MudButton>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
private ApplicationDbContext? context;

[Parameter]
public ReserveStudy? Model { get; set; }

[Parameter]
public bool IsEdit { get; set; } = false;

private List<BuildingElement>? buildingElements;
private List<CommonElement>? commonElements;

    private Dictionary<Guid, bool> buildingElementSelections = new();
    private Dictionary<Guid, bool> commonElementSelections = new();
    private MudForm? form;

    protected override async Task OnInitializedAsync() {
        context = await DbFactory.CreateDbContextAsync();

        buildingElements = await context.BuildingElements.OrderBy(be => be.ZOrder).ToListAsync();
        commonElements = await context.CommonElements.ToListAsync();

        // Initialize collections if null
        if (Model != null) {
            Model.ReserveStudyBuildingElements ??= new List<ReserveStudyBuildingElement>();
            Model.ReserveStudyCommonElements ??= new List<ReserveStudyCommonElement>();
            Model.ReserveStudyAdditionalElements ??= new List<ReserveStudyAdditionalElement>();
        }
    }

    protected override void OnParametersSet() {
        // Re-evaluate selections whenever parameters change (Model populated/updated)
        if (Model != null && buildingElements != null && commonElements != null) {
            UpdateSelections();
        }
    }

    private void UpdateSelections() {
        // Clear and rebuild selections
        buildingElementSelections.Clear();
        commonElementSelections.Clear();

        // Initialize selections based on Model's current elements
        foreach (var element in buildingElements ?? Enumerable.Empty<BuildingElement>()) {
            buildingElementSelections[element.Id] = Model.ReserveStudyBuildingElements?.Any(e => e.BuildingElementId == element.Id) ?? false;
        }

        foreach (var element in commonElements ?? Enumerable.Empty<CommonElement>()) {
            commonElementSelections[element.Id] = Model.ReserveStudyCommonElements?.Any(e => e.CommonElementId == element.Id) ?? false;
        }
    }

    private void AddAdditionalElement() {
        Model.ReserveStudyAdditionalElements ??= new List<ReserveStudyAdditionalElement>();
        Model.ReserveStudyAdditionalElements.Add(new ReserveStudyAdditionalElement { Name = string.Empty });
    }

    private void RemoveAdditionalElement(ReserveStudyAdditionalElement element) {
        Model.ReserveStudyAdditionalElements?.Remove(element);
    }

    private void OnBuildingElementChanged(bool isSelected, BuildingElement element) {
        buildingElementSelections[element.Id] = isSelected;
        
        if (isSelected) {
            Model.ReserveStudyBuildingElements ??= new List<ReserveStudyBuildingElement>();
            if (!Model.ReserveStudyBuildingElements.Any(e => e.BuildingElementId == element.Id)) {
                Model.ReserveStudyBuildingElements.Add(new ReserveStudyBuildingElement { 
                    BuildingElementId = element.Id, 
                    BuildingElement = element,
                    ReserveStudyId = Model.Id 
                });
            }
        }
        else {
            var itemToRemove = Model.ReserveStudyBuildingElements?.FirstOrDefault(e => e.BuildingElementId == element.Id);
            if (itemToRemove != null) {
                Model.ReserveStudyBuildingElements.Remove(itemToRemove);
            }
        }
    }

    private void OnCommonElementChanged(bool isSelected, CommonElement element) {
        commonElementSelections[element.Id] = isSelected;
        
        if (isSelected) {
            Model.ReserveStudyCommonElements ??= new List<ReserveStudyCommonElement>();
            if (!Model.ReserveStudyCommonElements.Any(e => e.CommonElementId == element.Id)) {
                Model.ReserveStudyCommonElements.Add(new ReserveStudyCommonElement { 
                    CommonElementId = element.Id, 
                    CommonElement = element,
                    ReserveStudyId = Model.Id 
                });
            }
        }
        else {
            var itemToRemove = Model.ReserveStudyCommonElements?.FirstOrDefault(e => e.CommonElementId == element.Id);
            if (itemToRemove != null) {
                Model.ReserveStudyCommonElements.Remove(itemToRemove);
            }
        }
    }

    public async ValueTask DisposeAsync() {
        if (context != null) {
            await context.DisposeAsync();
        }
    }

    [Parameter]
    public EventCallback<bool> StepValidated { get; set; }

    public async Task<bool> ValidateAsync() {
        await form.Validate();
        bool valid = form.IsValid;
        await StepValidated.InvokeAsync(valid);
        return valid;
    }

    /// <summary>
    /// Call this method after Model is fully loaded to refresh checkbox states
    /// </summary>
    public void RefreshSelections() {
        if (Model != null && buildingElements != null && commonElements != null) {
            UpdateSelections();
            StateHasChanged();
        }
    }
}
