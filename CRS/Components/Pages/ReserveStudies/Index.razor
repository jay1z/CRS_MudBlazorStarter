@page "/ReserveStudies"
@attribute [Authorize(Policy = "RequireTenantViewer")]

@using Horizon.Components.Pages.ReserveStudy.Dialogs
@using Horizon.Data
@using Horizon.Models.Workflow
@using Horizon.Services
@using Horizon.Services.Interfaces
@using Horizon.Services.Tenant
@using Horizon.Services.Workflow
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<Horizon.Data.ApplicationDbContext> DbFactory
@inject UserStateService UserState
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject IReserveStudyService ReserveStudyService
@inject IDialogService DialogService
@inject ITenantContext TenantContext

<PageTitle>Reserve Studies - @(TenantContext.TenantName ?? "ALX Reserve Cloud")</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <!-- Header Section -->
    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="mr-2" Style="vertical-align: middle;" />
                    Reserve Studies
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                    Manage and track all reserve study requests
                </MudText>
            </MudStack>
            <AuthorizeView Policy="RequireHOAUser">
                    <Authorized>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Surface" 
                                   Size="Size.Large"
                                   StartIcon="@Icons.Material.Filled.RequestQuote"
                                   Href="/ReserveStudies/Request"
                                   Style="color: #FF8C00; font-weight: 600;">
                            Request Study
                        </MudButton>
                    </Authorized>
                </AuthorizeView>
        </MudStack>
    </MudPaper>

    @if (isLoading) {
        <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <div class="pa-8 text-center">
                <MudText Typo="Typo.h6" Style="color: #666;">Loading reserve studies...</MudText>
            </div>
        </MudPaper>
    }
    else {
        <!-- Stats Cards -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #F3E8FF; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Assignment" Style="color: #6A3D9A; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@(reserveStudies?.Count ?? 0)</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">Total Studies</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Pending" Style="color: #FF8C00; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetStatusCount(StudyStatus.RequestCreated)</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">New Requests</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #E3F2FD; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Engineering" Style="color: #1976D2; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetInProgressCount()</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">In Progress</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="2" Style="border-radius: 12px;">
                    <MudCardContent>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 48px; height: 48px; background: #E8F5E9; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #28a745; font-size: 28px;" />
                            </div>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetStatusCount(StudyStatus.RequestCompleted)</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">Completed</MudText>
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Search and Filter Section -->
        <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3" Wrap="Wrap.Wrap">
                <MudTextField @bind-Value="searchString" 
                              Placeholder="Search by community, contact, or specialist..." 
                              Adornment="Adornment.Start" 
                              AdornmentIcon="@Icons.Material.Filled.Search" 
                              Immediate="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Style="flex: 1; min-width: 250px; max-width: 400px;" />
                <MudSelect T="string" 
                           Value="statusFilter" 
                           Label="Filter by Status" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Style="min-width: 200px;"
                           ValueChanged="OnStatusFilterChanged">
                    <MudSelectItem T="string" Value="@("")">All Statuses</MudSelectItem>
                    <MudSelectItem T="string" Value="@("RequestCreated")">New Request</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ProposalCreated")">Proposal Created</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ProposalSent")">Proposal Sent</MudSelectItem>
                    <MudSelectItem T="string" Value="@("ProposalAccepted")">Proposal Accepted</MudSelectItem>
                    <MudSelectItem T="string" Value="@("RequestCompleted")">Completed</MudSelectItem>
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudDivider />
                            <MudSelectItem T="string" Value="@("Deleted")" Style="color: #DC3545;">Deleted</MudSelectItem>
                        </Authorized>
                    </AuthorizeView>
                </MudSelect>
                @if (!string.IsNullOrEmpty(searchString) || !string.IsNullOrEmpty(statusFilter))
                {
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Secondary" 
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilters">
                        Clear
                    </MudButton>
                }
            </MudStack>
        </MudPaper>

        <!-- Table Section -->
        <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
            @if (reserveStudies == null || !reserveStudies.Any()) {
                <div class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.FolderOff" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No reserve studies found</MudText>
                    <MudText Typo="Typo.body2" Style="color: #999; margin-bottom: 16px;">
                        Get started by creating your first reserve study request
                    </MudText>
                    <AuthorizeView Policy="RequireTenantStaff">
                        <Authorized>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Href="/ReserveStudies/Create">
                                Create New Study
                            </MudButton>
                        </Authorized>
                    </AuthorizeView>
                </div>
            }
            else if (!FilteredStudies.Any()) {
                <div class="pa-8 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.SearchOff" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                    <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No matching studies found</MudText>
                    <MudText Typo="Typo.body2" Style="color: #999;">
                        Try adjusting your search or filter criteria
                    </MudText>
                </div>
            }
            else {
                <MudTable Items="@FilteredStudies"
                          Hover="true"
                          Elevation="0"
                          Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.Community?.Name)">Community</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.CurrentStatus)">Status</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.PointOfContact?.FullName)">Contact</MudTableSortLabel></MudTh>
                        <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.Specialist?.FullName)">Specialist</MudTableSortLabel></MudTh>
                        @if (isShowingDeleted) {
                            <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.DateDeleted)">Deleted</MudTableSortLabel></MudTh>
                        } else {
                            <MudTh Style="font-weight: 600;"><MudTableSortLabel T="ReserveStudy" SortBy="@(x => x.DateCreated)">Created</MudTableSortLabel></MudTh>
                        }
                        <MudTh Style="font-weight: 600; text-align: right;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="study">
                        <MudTd DataLabel="Community">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudAvatar Color="Color.Primary" Size="Size.Small" Style="background: #F3E8FF; color: #6A3D9A;">
                                    <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" />
                                </MudAvatar>
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@study.Community?.Name</MudText>
                                    @{
                                        var city = study.Community?.PhysicalAddress?.City;
                                        var state = study.Community?.PhysicalAddress?.State;
                                        var location = string.Join(", ", new[] { city, state }.Where(s => !string.IsNullOrWhiteSpace(s)));
                                    }
                                    @if (!string.IsNullOrWhiteSpace(location))
                                    {
                                        <MudText Typo="Typo.caption" Style="color: #999;">@location</MudText>
                                    }
                                </MudStack>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" 
                                     Size="Size.Small" 
                                     Color="@GetStatusColor(study.CurrentStatus)"
                                     Variant="Variant.Filled">
                                @GetStatusDisplayName(study.CurrentStatus)
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="Contact">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@study.PointOfContact?.FullName</MudText>
                                <MudLink Typo="Typo.caption" Href="@($"mailto:{study.PointOfContact?.Email}")" Style="color: #999;">
                                    @study.PointOfContact?.Email
                                </MudLink>
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Specialist">
                            @if (study.Specialist != null) {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Secondary" Size="Size.Small">
                                        @study.Specialist.Initials
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2">@study.Specialist.FullName</MudText>
                                </MudStack>
                            } else {
                                <MudText Typo="Typo.body2" Style="color: #999; font-style: italic;">Unassigned</MudText>
                            }
                        </MudTd>
                        <MudTd DataLabel="@(isShowingDeleted ? "Deleted" : "Created")">
                            <MudStack Spacing="0">
                                @if (isShowingDeleted) {
                                    <MudText Typo="Typo.body2">@study.DateDeleted?.ToString("MMM dd, yyyy")</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #999;">@study.DateDeleted?.ToString("h:mm tt")</MudText>
                                } else {
                                    <MudText Typo="Typo.body2">@study.DateCreated?.ToString("MMM dd, yyyy")</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #999;">@study.DateCreated?.ToString("h:mm tt")</MudText>
                                }
                            </MudStack>
                        </MudTd>
                        <MudTd DataLabel="Actions" Style="text-align: right;">
                            @if (isShowingDeleted) {
                                <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Success"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.RestoreFromTrash"
                                               OnClick="@(() => RestoreStudy(study))">
                                        Restore
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.DeleteForever"
                                               OnClick="@(() => OpenPermanentDeleteDialog(study))">
                                        Delete Forever
                                    </MudButton>
                                </MudStack>
                            } else {
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                                         Size="Size.Small" 
                                         Dense="true"
                                         AnchorOrigin="Origin.BottomRight"
                                         TransformOrigin="Origin.TopRight">
                                    <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                                 Href="@($"/ReserveStudies/Details/{study.Id}")">
                                        View Details
                                    </MudMenuItem>
                                    <AuthorizeView Policy="RequireTenantStaff" Context="authEdit">
                                        <Authorized>
                                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                                         Href="@($"/ReserveStudies/Edit/{study.Id}")">
                                                Edit Study
                                            </MudMenuItem>
                                            <MudDivider />
                                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" 
                                                         OnClick="@(() => OpenDeleteDialog(study))"
                                                         IconColor="Color.Error">
                                                Delete
                                            </MudMenuItem>
                                        </Authorized>
                                    </AuthorizeView>
                                </MudMenu>
                            }
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private List<ReserveStudy> reserveStudies = new();
    private bool isLoading = true;
    private bool isShowingDeleted = false;
    private string searchString = "";
    private string statusFilter = "";

    protected override async Task OnParametersSetAsync() {
        await LoadData();
    }

    private async Task LoadData() {
        try {
            isLoading = true;

            await UserState.InitializeAsync();
            if (UserState.ClaimsPrincipal.Identity is not null && UserState.ClaimsPrincipal.Identity.IsAuthenticated) {
                await LoadReserveStudies();
            }
            else {
                Snackbar.Add("User not authenticated.", Severity.Warning);
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            reserveStudies = new List<ReserveStudy>();
        }
        finally {
            isLoading = false;
        }
    }

    private async Task LoadReserveStudies() {
        try {
            await UserState.InitializeAsync();
            if (UserState.UserRoles != null) {
                // PlatformAdmin or TenantOwner can see all reserve studies
                if (UserState.UserRoles.Contains("PlatformAdmin") || UserState.UserRoles.Contains("TenantOwner")) {
                    reserveStudies = await ReserveStudyService.GetAllReserveStudiesAsync();
                }
                // TenantSpecialist sees assigned studies
                else if (UserState.UserRoles.Contains("TenantSpecialist")) {
                    reserveStudies = await ReserveStudyService.GetAssignedReserveStudiesAsync(UserState.CurrentUser.Id);
                }
                // TenantViewer, HOAUser, or other authenticated users see their owned studies
                else if (UserState.UserRoles.Contains("TenantViewer") || UserState.UserRoles.Contains("HOAUser") || UserState.UserRoles.Contains("HOAAuditor")) {
                    reserveStudies = await ReserveStudyService.GetOwnedReserveStudiesAsync(UserState.CurrentUser.Id);
                }
                else {
                    // Fallback: try to load owned studies for any authenticated user
                    reserveStudies = await ReserveStudyService.GetOwnedReserveStudiesAsync(UserState.CurrentUser.Id);
                }
            }
            else {
                Snackbar.Add("Unable to determine user permissions. Please log out and log back in.", Severity.Warning);
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            reserveStudies = new List<ReserveStudy>();
        }
    }

    private IEnumerable<ReserveStudy> FilteredStudies {
        get {
            var filtered = reserveStudies.AsEnumerable();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(searchString)) {
                var search = searchString.Trim().ToLower();
                filtered = filtered.Where(study =>
                    study.Community?.Name?.ToLower().Contains(search) == true ||
                    study.PointOfContact?.FullName?.ToLower().Contains(search) == true ||
                    study.PointOfContact?.Email?.ToLower().Contains(search) == true ||
                    study.Specialist?.FullName?.ToLower().Contains(search) == true);
            }

            // Apply status filter (not for deleted view - that's handled separately)
            if (!isShowingDeleted && !string.IsNullOrEmpty(statusFilter) && Enum.TryParse<StudyStatus>(statusFilter, out var status)) {
                filtered = filtered.Where(study => study.CurrentStatus == status);
            }

            return filtered;
        }
    }

    private async Task ClearFilters() {
        searchString = "";
        if (isShowingDeleted) {
            statusFilter = "";
            await OnStatusFilterChanged("");
        } else {
            statusFilter = "";
        }
    }

    private async Task OnStatusFilterChanged(string value) {
        statusFilter = value;

        if (value == "Deleted") {
            isShowingDeleted = true;
            isLoading = true;
            try {
                reserveStudies = await ReserveStudyService.GetDeletedReserveStudiesAsync();
            }
            catch (Exception ex) {
                Snackbar.Add($"Error loading deleted studies: {ex.Message}", Severity.Error);
                reserveStudies = new List<ReserveStudy>();
            }
            finally {
                isLoading = false;
            }
        }
        else if (isShowingDeleted) {
            // Switching back from deleted view to active studies
            isShowingDeleted = false;
            await LoadData();
        }
    }

    private async Task RestoreStudy(ReserveStudy study) {
        try {
            var result = await ReserveStudyService.RestoreReserveStudyAsync(study.Id);
            if (result) {
                reserveStudies.Remove(study);
                Snackbar.Add($"Reserve study for {study.Community?.Name} has been restored.", Severity.Success);
            }
            else {
                Snackbar.Add("Failed to restore the reserve study.", Severity.Error);
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error restoring study: {ex.Message}", Severity.Error);
        }
    }

    private int GetStatusCount(StudyStatus status) {
        return reserveStudies?.Count(s => s.CurrentStatus == status) ?? 0;
    }

    private int GetInProgressCount() {
        return reserveStudies?.Count(s => 
            s.CurrentStatus != StudyStatus.RequestCreated && 
            s.CurrentStatus != StudyStatus.RequestCompleted &&
            s.CurrentStatus != StudyStatus.RequestCancelled &&
            s.CurrentStatus != StudyStatus.RequestArchived) ?? 0;
    }

    private Color GetStatusColor(StudyStatus status) {
        return status switch {
            StudyStatus.RequestCreated => Color.Warning,
            StudyStatus.RequestApproved => Color.Warning,
            StudyStatus.ProposalCreated => Color.Info,
            StudyStatus.ProposalReviewed => Color.Info,
            StudyStatus.ProposalUpdated => Color.Info,
            StudyStatus.ProposalApproved => Color.Info,
            StudyStatus.ProposalSent => Color.Primary,
            StudyStatus.ProposalAccepted => Color.Success,
            StudyStatus.ServiceContactsRequested => Color.Tertiary,
            StudyStatus.FinancialInfoRequested => Color.Tertiary,
            StudyStatus.FinancialInfoInProgress => Color.Tertiary,
            StudyStatus.FinancialInfoSubmitted => Color.Tertiary,
            StudyStatus.FinancialInfoReviewed => Color.Tertiary,
            StudyStatus.FinancialInfoReceived => Color.Tertiary,
            StudyStatus.SiteVisitPending => Color.Primary,
            StudyStatus.SiteVisitScheduled => Color.Primary,
            StudyStatus.SiteVisitCompleted => Color.Primary,
            StudyStatus.SiteVisitDataEntered => Color.Primary,
            StudyStatus.FundingPlanReady => Color.Secondary,
            StudyStatus.FundingPlanInProcess => Color.Secondary,
            StudyStatus.FundingPlanComplete => Color.Secondary,
            StudyStatus.NarrativeReady => Color.Secondary,
            StudyStatus.NarrativeInProcess => Color.Secondary,
            StudyStatus.NarrativeComplete => Color.Secondary,
            StudyStatus.NarrativePrintReady => Color.Secondary,
            StudyStatus.NarrativePackaged => Color.Secondary,
            StudyStatus.NarrativeSent => Color.Secondary,
            StudyStatus.ReportReady => Color.Success,
            StudyStatus.ReportInProcess => Color.Success,
            StudyStatus.ReportComplete => Color.Success,
            StudyStatus.RequestCompleted => Color.Success,
            StudyStatus.RequestCancelled => Color.Error,
            StudyStatus.RequestArchived => Color.Default,
            _ => Color.Secondary
        };
    }

    private string GetStatusDisplayName(StudyStatus status) {
        return status switch {
            StudyStatus.RequestCreated => "New Request",
            StudyStatus.RequestApproved => "Request Approved",
            StudyStatus.ProposalCreated => "Proposal Created",
            StudyStatus.ProposalReviewed => "Under Review",
            StudyStatus.ProposalUpdated => "Proposal Updated",
            StudyStatus.ProposalApproved => "Proposal Approved",
            StudyStatus.ProposalSent => "Proposal Sent",
            StudyStatus.ProposalAccepted => "Accepted",
            StudyStatus.ServiceContactsRequested => "Contacts Requested",
            StudyStatus.FinancialInfoRequested => "Financial Info Requested",
            StudyStatus.FinancialInfoInProgress => "Financial Info In Progress",
            StudyStatus.FinancialInfoSubmitted => "Financial Info Submitted",
            StudyStatus.FinancialInfoReviewed => "Financial Info Reviewed",
            StudyStatus.FinancialInfoReceived => "Financial Info Received",
            StudyStatus.SiteVisitPending => "Site Visit Pending",
            StudyStatus.SiteVisitScheduled => "Site Visit Scheduled",
            StudyStatus.SiteVisitCompleted => "Site Visit Completed",
            StudyStatus.SiteVisitDataEntered => "Site Data Entered",
            StudyStatus.FundingPlanReady => "Funding Plan Ready",
            StudyStatus.FundingPlanInProcess => "Funding Plan In Progress",
            StudyStatus.FundingPlanComplete => "Funding Plan Complete",
            StudyStatus.NarrativeReady => "Narrative Ready",
            StudyStatus.NarrativeInProcess => "Writing Narrative",
            StudyStatus.NarrativeComplete => "Narrative Complete",
            StudyStatus.NarrativePrintReady => "Print Ready",
            StudyStatus.NarrativePackaged => "Report Packaged",
            StudyStatus.NarrativeSent => "Report Sent",
            StudyStatus.ReportReady => "Report Ready",
            StudyStatus.ReportInProcess => "Finalizing Report",
            StudyStatus.ReportComplete => "Report Complete",
            StudyStatus.RequestCompleted => "Completed",
            StudyStatus.RequestCancelled => "Cancelled",
            StudyStatus.RequestArchived => "Archived",
            _ => status.ToString()
        };
    }

    private async Task OpenDeleteDialog(ReserveStudy study) {
        var parameters = new DialogParameters {
            { "Study", study }
        };

        var dialog = await DialogService.ShowAsync<DeleteReserveStudyDialog>("Delete Reserve Study", parameters);
        var result = await dialog.Result;

        if (!result.Canceled) {
            await DeleteReserveStudy(study);
        }
    }

    private async Task DeleteReserveStudy(ReserveStudy study) {
        try {
            isLoading = true;
            await ReserveStudyService.DeleteReserveStudyAsync(study.Id);

            // Remove the deleted study from the list
            reserveStudies.Remove(study);

            Snackbar.Add($"Reserve study for {study.Community?.Name} was successfully deleted.", Severity.Success);
        }
        catch (Exception ex) {
            Snackbar.Add($"Error deleting reserve study: {ex.Message}", Severity.Error);
        }
        finally {
            isLoading = false;
        }
    }

    private async Task OpenPermanentDeleteDialog(ReserveStudy study) {
        var parameters = new DialogParameters {
            { "Study", study }
        };

        var dialog = await DialogService.ShowAsync<PermanentDeleteReserveStudyDialog>("Permanently Delete Reserve Study", parameters);
        var result = await dialog.Result;

        if (!result.Canceled) {
            await PermanentlyDeleteReserveStudy(study);
        }
    }

    private async Task PermanentlyDeleteReserveStudy(ReserveStudy study) {
        try {
            var result = await ReserveStudyService.PermanentlyDeleteReserveStudyAsync(study.Id);
            if (result) {
                reserveStudies.Remove(study);
                Snackbar.Add($"Reserve study for {study.Community?.Name} was permanently deleted.", Severity.Success);
            }
            else {
                Snackbar.Add("Failed to permanently delete the reserve study.", Severity.Error);
            }
        }
        catch (Exception ex) {
            Snackbar.Add($"Error permanently deleting reserve study: {ex.Message}", Severity.Error);
        }
    }
}
