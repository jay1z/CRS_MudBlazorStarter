@page "/ReserveStudies/{Id:guid}/Edit"
@attribute [Authorize]

@using System.Security.Claims
@using CRS.Components.Layout
@using CRS.Components.Pages.ReserveStudyPages.Steps.Edit
@using CRS.Components.Pages.ReserveStudyPages.Steps
@using CRS.Data
@using CRS.Models
@using CRS.Services
@using CRS.Services.Interfaces
@using CRS.Services.Tenant
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@implements IAsyncDisposable
@inject ILogger<EditRequest> Logger
@inject UserStateService UserState
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IReserveStudyService ReserveStudyService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ITenantContext TenantContext

<PageTitle>Edit Reserve Study Request - @(TenantContext.TenantName ?? "ALX Reserve Cloud")</PageTitle>

@if (isLoading) {
    <MudPaper Elevation="0" Class="pa-8">
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        <MudText Typo="Typo.h5" Class="mt-4">Loading...</MudText>
    </MudPaper>
}
else if (!TenantContext.TenantId.HasValue) {
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
        <MudAlert Severity="Severity.Error">
            <MudText Typo="Typo.h6" Class="mb-2">Access Denied</MudText>
            <MudText Typo="Typo.body2">
                This page is only accessible from your organization's subdomain.
            </MudText>
        </MudAlert>
    </MudContainer>
}
else if (Model == null) {
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
        <MudAlert Severity="Severity.Warning">
            <MudText Typo="Typo.h6" Class="mb-2">Reserve Study Not Found</MudText>
            <MudText Typo="Typo.body2">
                The requested reserve study could not be found or you do not have permission to edit it.
            </MudText>
            <MudButton Color="Color.Primary" Href="/Dashboard" Class="mt-2">Go to Dashboard</MudButton>
        </MudAlert>
    </MudContainer>
}
else if (!canEdit) {
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
        <MudAlert Severity="Severity.Info">
            <MudText Typo="Typo.h6" Class="mb-2">Request Cannot Be Modified</MudText>
            <MudText Typo="Typo.body2">
                This reserve study request can no longer be edited because the proposal has already been accepted.
                If you need to make changes, please contact @TenantContext.TenantName directly.
            </MudText>
            <MudStack Row="true" Spacing="2" Class="mt-3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@($"/ReserveStudies/{Id}/Details")">View Details</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Href="/Dashboard">Go to Dashboard</MudButton>
            </MudStack>
        </MudAlert>
    </MudContainer>
}
else {
    <MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
        <!-- Tenant Branding Header -->
        <MudPaper Class="pa-6 mb-4" Elevation="2" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Style="color: white; font-size: 48px;" />
                    <div>
                        <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                            Edit Reserve Study Request
                        </MudText>
                        <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.9);">
                            @Model?.Community?.Name
                        </MudText>
                    </div>
                </MudStack>
                <MudChip T="string" Color="Color.Warning" Style="background: rgba(255,255,255,0.3); color: white; font-weight: 600;">
                    @GetStatusDisplay()
                </MudChip>
            </MudStack>
        </MudPaper>

        <!-- Info Alert -->
        <MudAlert Severity="Severity.Info" Class="mb-4" Elevation="0">
            <MudText Typo="Typo.body2">
                <strong>Note:</strong> You can edit this request until the proposal is accepted. 
                After that point, please contact @TenantContext.TenantName for any changes.
            </MudText>
        </MudAlert>

        <MudCard Elevation="4">
            <MudCardContent>
                @if (isHOAUser) {
                    <!-- Tab-based interface for HOA Users -->
                    <MudTabs Elevation="0" 
                             Rounded="true" 
                             ApplyEffectsToContainer="true" 
                             PanelClass="pa-6"
                             ActivePanelIndex="@activeTabIndex"
                             ActivePanelIndexChanged="@OnTabChanged">
                        <MudTabPanel Text="Community Information" Icon="@Icons.Material.Filled.LocationCity">
                            <Step1Edit @ref="step1" Model="Model" StepValidated="OnStepValidated" />
                        </MudTabPanel>
                        <MudTabPanel Text="Property Manager" Icon="@Icons.Material.Filled.Business">
                            <Step2Edit @ref="step2" Model="Model" StepValidated="OnStepValidated" />
                        </MudTabPanel>
                        <MudTabPanel Text="Property Elements" Icon="@Icons.Material.Filled.List">
                            <Step3Edit @ref="step3" Model="Model" StepValidated="OnStepValidated" />
                        </MudTabPanel>
                        <MudTabPanel Text="Service Contacts" Icon="@Icons.Material.Filled.ContactPhone">
                            <StepServiceContacts @ref="stepServiceContacts" Model="Model" StepValidated="OnStepValidated" IsEdit="true" />
                        </MudTabPanel>
                    </MudTabs>
                    
                    <!-- Save/Cancel buttons for tabs -->
                    <MudDivider Class="my-4" />
                    <MudGrid Justify="Justify.SpaceBetween">
                        <MudItem>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                       Disabled="isSubmitting" 
                                       Href="@($"/ReserveStudies/{Id}/Details")">
                                <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" />
                                Cancel
                            </MudButton>
                        </MudItem>
                        <MudItem>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                       OnClick="SaveChanges" Disabled="isSubmitting || !IsFormValid()">
                                @if (isSubmitting) {
                                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    <span>Saving...</span>
                                }
                                else {
                                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                                    <span>Save Changes</span>
                                }
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                } else {
                    <!-- Stepper interface for Staff Users -->
                    <MudStepper @bind-ActiveStep="activeStep" Linear="false" CenterLabels="true"
                                CompletedStepColor="Color.Success" CurrentStepColor="Color.Primary"
                                Class="mb-4" @ref="stepper">
                        <ChildContent>
                            @foreach (var step in steps) {
                                <MudStep Title="@step.Title"
                                         Icon="@(stepValidationState.GetValueOrDefault(step.Index) ? Icons.Material.Filled.CheckCircle : null)"
                                         IconColor="@(stepValidationState.GetValueOrDefault(step.Index) ? Color.Success : Color.Default)">
                                    @step.Content
                                </MudStep>
                            }
                        </ChildContent>
                        <ActionContent>
                            <MudGrid Justify="Justify.SpaceBetween" Class="mt-4">
                                <MudItem>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary"
                                               Disabled="isSubmitting" 
                                               Href="@($"/ReserveStudies/{Id}/Details")">
                                        <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" />
                                        Cancel
                                    </MudButton>
                                </MudItem>
                                <MudItem>
                                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                               OnClick="SaveChanges" Disabled="isSubmitting || !IsFormValid()">
                                        @if (isSubmitting) {
                                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                            <span>Saving...</span>
                                        }
                                        else {
                                            <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                                            <span>Save Changes</span>
                                        }
                                    </MudButton>
                                </MudItem>
                            </MudGrid>
                        </ActionContent>
                    </MudStepper>
                }
            </MudCardContent>
        </MudCard>

        <!-- Help Section -->
        <MudPaper Class="pa-4 mt-4" Elevation="1" Style="background: #f9f9f9; border-radius: 8px;">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Help" Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.body2">
                        <strong>Need assistance?</strong> Contact @TenantContext.TenantName support.
                    </MudText>
                </div>
            </MudStack>
        </MudPaper>
    </MudContainer>
}

@code {
private record StepDefinition(int Index, string Title, RenderFragment Content);

[Parameter] public Guid Id { get; set; }
[CascadingParameter] public Routes? Routes { get; set; }
[CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

private ReserveStudy? Model { get; set; }
private readonly Dictionary<int, bool> stepValidationState = new();

private MudStepper? stepper;
private bool isLoading = true;
private bool isSubmitting;
private bool canEdit;
private int activeStep;
private int activeTabIndex = 0;
private bool isHOAUser = false;

private Step1Edit? step1;
private Step2Edit? step2;
private Step3Edit? step3;
private StepServiceContacts? stepServiceContacts;

private List<StepDefinition> steps = new();

    protected override async Task OnInitializedAsync() {
        try {
            await UserState.InitializeAsync();

            // Verify user is authenticated
            if (!UserState.ClaimsPrincipal.Identity?.IsAuthenticated ?? true) {
                NavigationManager.NavigateTo("/Account/Login?returnUrl=" + Uri.EscapeDataString($"/ReserveStudies/{Id}/Edit"), true);
                return;
            }

            // Verify tenant context
            if (!TenantContext.TenantId.HasValue) {
                Logger.LogWarning("EditRequest: No tenant context available for user {UserId}", GetCurrentUserId(UserState.ClaimsPrincipal));
                isLoading = false;
                return;
            }

            // Determine if user is HOA user (external)
            isHOAUser = UserState.UserRoles?.Any(r => r == "HOAUser" || r == "HOAAuditor") ?? false;

            await LoadReserveStudy();

            if (Model != null) {
                // Check if user owns this request or is staff
                var currentUserId = GetCurrentUserId(UserState.ClaimsPrincipal);
                var isOwner = Model.ApplicationUserId == currentUserId;
                var isStaff = UserState.UserRoles?.Any(r => r == "TenantOwner" || r == "TenantSpecialist" || r == "Admin") ?? false;

                if (!isOwner && !isStaff) {
                    Logger.LogWarning("EditRequest: User {UserId} attempted to edit reserve study {StudyId} without permission", currentUserId, Id);
                    Model = null;
                    isLoading = false;
                    return;
                }

                // Check if the study can be edited based on status
                canEdit = ReserveStudyService.CanUpdateReserveStudy(Model);

                if (canEdit) {
                    InitializeSteps();
                    ValidateAllSteps();
                }
            }
        }
        catch (Exception ex) {
            LogAndDisplayError("Error initializing", ex);
        }
        finally {
            isLoading = false;
        }
    }

    private async Task LoadReserveStudy() {
        try {
            await using var context = await DbFactory.CreateDbContextAsync();

            Model = await context.ReserveStudies
                .Include(rs => rs.Community).ThenInclude(c => c.Addresses)
                .Include(rs => rs.Contact)
                .Include(rs => rs.PropertyManager)
                .Include(rs => rs.ReserveStudyBuildingElements).ThenInclude(be => be.BuildingElement)
                .Include(rs => rs.ReserveStudyCommonElements).ThenInclude(ce => ce.CommonElement)
                .Include(rs => rs.ReserveStudyAdditionalElements).ThenInclude(ae => ae.ServiceContact)
                .AsSplitQuery()
                .FirstOrDefaultAsync(rs => rs.Id == Id && rs.IsActive && rs.TenantId == TenantContext.TenantId!.Value);

            if (Model != null) {
                Logger.LogInformation("Loaded reserve study {StudyId} with status {Status}", Id, Model.Status);
                
                // Give Step3 time to refresh selections after Model is loaded
                await Task.Delay(100);
                step3?.RefreshSelections();
            }
        }
        catch (Exception ex) {
            Logger.LogError(ex, "Error loading reserve study {StudyId}", Id);
            throw;
        }
    }

    private void InitializeSteps() {
        steps = new List<StepDefinition> {
            new(0, "Community Information", @<Step1Edit @ref="step1" Model="Model" StepValidated="OnStepValidated" />),
            new(1, "Property Manager", @<Step2Edit @ref="step2" Model="Model" StepValidated="OnStepValidated" />),
            new(2, "Property Elements", @<Step3Edit @ref="step3" Model="Model" StepValidated="OnStepValidated" />),
            new(3, "Service Contacts", @<StepServiceContacts @ref="stepServiceContacts" Model="Model" StepValidated="OnStepValidated" IsEdit="true" />)
        };
    }

    private void ValidateAllSteps() {
        // Pre-validate all steps since we're in edit mode
        stepValidationState[0] = true; // Community info is required to exist
        stepValidationState[1] = Model?.PropertyManager != null;
        stepValidationState[2] = Model?.ReserveStudyAdditionalElements?.Any() ?? false;
    }

    public ValueTask DisposeAsync() => ValueTask.CompletedTask;

    private bool IsFormValid() => 
        stepValidationState.GetValueOrDefault(0); // At minimum, community info must be valid

    private async Task SaveChanges() {
        if (isSubmitting || Model == null) return;

        if (!TenantContext.TenantId.HasValue) {
            Snackbar.Add("Unable to determine your organization. Please refresh and try again.", Severity.Error);
            return;
        }

        isSubmitting = true;
        try {
            // Update last modified timestamp
            Model.LastModified = DateTime.UtcNow;

            // Call the update service method
            var updated = await ReserveStudyService.UpdateReserveStudyAsync(Model);

            Snackbar.Add("Reserve Study request updated successfully!", Severity.Success);
            NavigationManager.NavigateTo($"/ReserveStudies/{Id}/Details");
        }
        catch (InvalidOperationException ex) {
            Logger.LogWarning(ex, "User attempted to update non-editable reserve study {StudyId}", Id);
            Snackbar.Add(ex.Message, Severity.Warning);
            canEdit = false; // Disable further edits
        }
        catch (UnauthorizedAccessException ex) {
            Logger.LogError(ex, "Unauthorized attempt to update reserve study {StudyId}", Id);
            Snackbar.Add("You do not have permission to update this reserve study.", Severity.Error);
        }
        catch (Exception ex) {
            LogAndDisplayError("Error saving changes", ex);
        }
        finally {
            isSubmitting = false;
        }
    }

    private void LogAndDisplayError(string message, Exception ex) {
        Logger.LogError($"{message}: {ex}");
        Snackbar.Add($"{message}: {ex.Message}", Severity.Error);

        if (ex.InnerException != null) {
            Snackbar.Add($"Additional details: {ex.InnerException.Message}", Severity.Error);
        }
    }

    private void OnStepValidated(bool isValid) {
        // For HOA users with tabs, use active tab index; for staff with stepper, use active step
        var currentIndex = isHOAUser ? activeTabIndex : activeStep;
        stepValidationState[currentIndex] = isValid;
        StateHasChanged();
    }

    private void OnTabChanged(int index) {
        activeTabIndex = index;
        
        // Force Step1 to re-render when Community Information tab is selected
        if (index == 0 && step1 != null) {
            InvokeAsync(StateHasChanged);
        }
    }

    private Guid? GetCurrentUserId(ClaimsPrincipal user) {
        var userIdString = user.FindFirstValue(ClaimTypes.NameIdentifier);
        if (string.IsNullOrEmpty(userIdString) || !Guid.TryParse(userIdString, out Guid userId)) {
            throw new InvalidOperationException("User ID not found or invalid");
        }
        return userId;
    }

    private string GetStatusDisplay() {
        if (Model == null) return "Unknown";

        return Model.Status switch {
            ReserveStudy.WorkflowStatus.RequestCreated => "Draft",
            ReserveStudy.WorkflowStatus.ProposalCreated => "Proposal Created",
            ReserveStudy.WorkflowStatus.ProposalReviewed => "Under Review",
            ReserveStudy.WorkflowStatus.ProposalSent => "Awaiting Response",
            ReserveStudy.WorkflowStatus.ProposalAccepted => "Proposal Accepted",
            _ => Model.Status.ToString()
        };
    }
}
