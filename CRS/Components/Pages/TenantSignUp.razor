@page "/tenant/signup"
@using CRS.Data
@using CRS.Services.MultiTenancy
@using CRS.Services.MultiTenancy.Provisioning // add
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Text.RegularExpressions
@using MudBlazor
@using CRS.Models.Security // added for RoleScope
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject TenantService TenantService
@inject ITenantProvisioningQueue ProvisioningQueue // add
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Company Sign Up</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h5" Class="mb-4">Create your company</MudText>
        <EditForm Model="model" OnValidSubmit="OnSubmitAsync">
            <MudTextField @bind-Value="model.CompanyName" Label="Company name" Required="true" Immediate="true" />
            <MudTextField @bind-Value="model.Subdomain" Label="Desired subdomain" Required="true" HelperText="Letters, numbers, hyphen (e.g., acme)." Immediate="true" />
            <MudTextField @bind-Value="model.AdminEmail" Label="Admin email" Required="true" Immediate="true" />
            <MudTextField @bind-Value="model.AdminPassword" Label="Password" InputType="InputType.Password" Required="true" Immediate="true" />
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" ButtonType="ButtonType.Submit">Sign up</MudButton>
        </EditForm>
        @if (_provisioningInfo != null) {
            <MudAlert Severity="Severity.Info" Class="mt-4">@_provisioningInfo</MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private SignUpModel model = new();
    private string? _provisioningInfo;

    public class SignUpModel {
        public string CompanyName { get; set; } = string.Empty;
        public string Subdomain { get; set; } = string.Empty;
        public string AdminEmail { get; set; } = string.Empty;
        public string AdminPassword { get; set; } = string.Empty;
    }

    private static bool IsValidEmail(string email) =>
        !string.IsNullOrWhiteSpace(email) && email.Contains('@') && email.Contains('.');

    private async Task OnSubmitAsync() {
        if (string.IsNullOrWhiteSpace(model.CompanyName)) { Snackbar.Add("Company name is required.", Severity.Error); return; }
        var sub = (model.Subdomain ?? string.Empty).Trim().ToLowerInvariant();
        if (!Regex.IsMatch(sub, "^[a-z0-9-]{1,63}$")) { Snackbar.Add("Invalid subdomain.", Severity.Error); return; }
        if (!IsValidEmail(model.AdminEmail)) { Snackbar.Add("Valid admin email is required.", Severity.Error); return; }
        if (string.IsNullOrWhiteSpace(model.AdminPassword) || model.AdminPassword.Length < 8) { Snackbar.Add("Password must be at least 8 characters.", Severity.Error); return; }

        await using var db = await DbFactory.CreateDbContextAsync();
        if (await db.Set<CRS.Models.Tenant>().AnyAsync(t => t.Subdomain == sub)) {
            Snackbar.Add($"Subdomain '{sub}' is already taken.", Severity.Error);
            return;
        }

        // Create tenant in Pending state
        var tenant = new CRS.Models.Tenant {
            Name = model.CompanyName.Trim(),
            Subdomain = sub,
            IsActive = true,
            CreatedAt = DateTime.UtcNow,
            ProvisioningStatus = CRS.Models.TenantProvisioningStatus.Pending
        };
        db.Add(tenant);
        await db.SaveChangesAsync();

        // Create admin user for the tenant (user record before provisioning)
        var user = new ApplicationUser {
            Email = model.AdminEmail.Trim(),
            UserName = model.AdminEmail.Trim(),
            EmailConfirmed = true,
            TenantId = tenant.Id
        };
        var create = await UserManager.CreateAsync(user, model.AdminPassword);
        if (!create.Succeeded) {
            Snackbar.Add(string.Join(", ", create.Errors.Select(e => e.Description)), Severity.Error);
            return;
        }

        // Assign scoped TenantOwner role
        var ownerRole = await db.Set<Role>().FirstOrDefaultAsync(r => r.Name == "TenantOwner");
        if (ownerRole == null) {
            ownerRole = new Role { Name = "TenantOwner", Scope = RoleScope.Tenant };
            db.Set<Role>().Add(ownerRole);
            await db.SaveChangesAsync();
        }
        if (!await db.UserRoleAssignments.AnyAsync(a => a.UserId == user.Id && a.RoleId == ownerRole.Id && a.TenantId == tenant.Id)) {
            db.UserRoleAssignments.Add(new CRS.Models.Security.UserRoleAssignment {
                UserId = user.Id,
                RoleId = ownerRole.Id,
                TenantId = tenant.Id
            });
            await db.SaveChangesAsync();
        }

        // Enqueue provisioning (background worker will create/migrate tenant DB)
        await ProvisioningQueue.EnqueueAsync(tenant.Id);
        _provisioningInfo = "Provisioning started. Your tenant database is being prepared. You can log in once status is Active.";

        // Sign in user (will likely hit Pending status until provisioning completes)
        await SignInManager.SignInAsync(user, isPersistent: false);
        Snackbar.Add("Tenant creation accepted. Provisioning in progress.", Severity.Success);
        Nav.NavigateTo("/");
    }
}
