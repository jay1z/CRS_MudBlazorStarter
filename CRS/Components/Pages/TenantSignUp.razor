@page "/tenant/signup"
@attribute [CRS.Components.Layout.HideNav]
@using CRS.Services.Billing
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpClientFactory ClientFactory
@inject ISnackbar Snackbar
@inject NavigationManager Nav

<PageTitle>Start Subscription</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">
    <MudPaper Class="pa-6">
        <MudText Typo="Typo.h5" Class="mb-4">Create your company & start subscription</MudText>
        <EditForm Model="model" OnValidSubmit="HandleValidSubmit">
            <MudTextField @bind-Value="model.CompanyName" Label="Company name" Required="true" Immediate="true" />
            <MudTextField @bind-Value="model.Subdomain" Label="Desired subdomain" Required="true" HelperText="Letters, numbers, hyphen (e.g., acme)." Immediate="true" />
            <MudTextField @bind-Value="model.AdminEmail" Label="Admin email" Required="true" Immediate="true" />
            <MudSelect T="string" @bind-Value="model.Tier" Label="Plan" Required="true">
                @foreach (var opt in PlanOptions) {
                    <MudSelectItem T="string" Value="@opt.Value">@opt.Text</MudSelectItem>
                }
            </MudSelect>
            <MudRadioGroup T="string" @bind-SelectedOption="model.Interval" Class="mt-2">
                <MudRadio T="string" Option="Monthly">Monthly</MudRadio>
                <MudRadio T="string" Option="Yearly">Yearly</MudRadio>
            </MudRadioGroup>
            <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-4" ButtonType="ButtonType.Submit" Disabled="_submitting">Continue to Secure Checkout</MudButton>
        </EditForm>
        @if (!string.IsNullOrEmpty(_error)) {
            <MudAlert Severity="Severity.Error" Class="mt-4">@_error</MudAlert>
        }
        <MudText Typo="Typo.caption" Class="mt-4" Style="color:#666;">After secure payment you will be redirected to a success page where you can finish creating your owner account.</MudText>
    </MudPaper>
</MudContainer>

@code {
    private SignUpModel model = new() { Interval = "Monthly", Tier = "Startup" };
    private bool _submitting = false;
    private string? _error;

    private readonly (string Text, string Value)[] PlanOptions = new[] {
        ("Starter", "Startup"),
        ("Pro", "Pro"),
        ("Enterprise", "Enterprise")
    };

    public class SignUpModel {
        public string CompanyName { get; set; } = string.Empty;
        public string Subdomain { get; set; } = string.Empty;
        public string AdminEmail { get; set; } = string.Empty;
        public string Tier { get; set; } = string.Empty;
        public string Interval { get; set; } = string.Empty; // Monthly or Yearly
    }

    private static bool IsValidEmail(string email) =>
        !string.IsNullOrWhiteSpace(email) && email.Contains('@') && email.Contains('.');

    private async Task HandleValidSubmit(EditContext _) => await OnSubmitAsync();

    private async Task OnSubmitAsync() {
        _error = null;
        if (string.IsNullOrWhiteSpace(model.CompanyName)) { _error = "Company name is required."; return; }
        var sub = (model.Subdomain ?? string.Empty).Trim().ToLowerInvariant();
        if (!System.Text.RegularExpressions.Regex.IsMatch(sub, "^[a-z0-9-]{1,63}$")) { _error = "Invalid subdomain."; return; }
        if (!IsValidEmail(model.AdminEmail)) { _error = "Valid admin email is required."; return; }
        if (string.IsNullOrWhiteSpace(model.Tier)) { _error = "Plan selection required."; return; }
        if (string.IsNullOrWhiteSpace(model.Interval)) model.Interval = "Monthly";

        _submitting = true;
        try {
            var client = ClientFactory.CreateClient();
            var apiUrl = $"{Nav.BaseUri}api/signup/start"; // ensure absolute URL
            var resp = await client.PostAsJsonAsync(apiUrl, new {
                companyName = model.CompanyName.Trim(),
                subdomain = sub,
                adminEmail = model.AdminEmail.Trim(),
                tier = model.Tier,
                interval = model.Interval
            });
            if (!resp.IsSuccessStatusCode) {
                _error = $"Signup failed: {await resp.Content.ReadAsStringAsync()}"; _submitting = false; return;
            }
            var payload = await resp.Content.ReadFromJsonAsync<StartResponse>();
            // payload.SignupToken available if needed for client-side tracking
            if (payload?.CheckoutUrl is string url && !string.IsNullOrWhiteSpace(url)) {
                Nav.NavigateTo(url, forceLoad: true);
            } else {
                _error = "Unexpected response."; _submitting = false;
            }
        } catch (Exception ex) {
            _error = ex.Message; _submitting = false;
        }
    }

    private class StartResponse { public string? CheckoutUrl { get; set; } }
}
