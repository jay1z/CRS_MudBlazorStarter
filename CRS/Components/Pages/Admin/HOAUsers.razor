@page "/Admin/HOAUsers"
@attribute [Authorize(Policy = "RequireTenantStaff")]

@using Horizon.Data
@using Horizon.Models
@using Horizon.Services.Customers
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject Horizon.Services.Tenant.ITenantUserService TenantUserService
@inject Horizon.Services.Tenant.ITenantContext TenantContext
@inject ICustomerService CustomerService

<PageTitle>HOA User Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <!-- Header Section -->
    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" Style="vertical-align: middle;" />
                    HOA User Management
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                    Manage HOA board members and customer access
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Surface" 
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenInviteDialog"
                       Style="color: #FF8C00; font-weight: 600;">
                Invite HOA User
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Stats Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.People" Style="color: #FF8C00; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@hoaUsers.Count</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Total HOA Users</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #E8F5E9; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #28a745; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@hoaUsers.Count(u => u.IsActive)</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Active</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #F3E8FF; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Home" Style="color: #6A3D9A; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@hoaUsers.Count(u => u.Role <= CustomerAccountRole.Member)</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Board Members</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Style="color: #FF8C00; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@hoaUsers.Count(u => u.Role == CustomerAccountRole.Viewer)</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Auditors</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Search Section -->
    <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudTextField @bind-Value="searchValue" 
                          Placeholder="Search by name, email, or organization..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" 
                          Immediate="true"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Style="flex: 1; max-width: 400px;" />
            @if (!string.IsNullOrEmpty(searchValue))
            {
                <MudButton Variant="Variant.Text" 
                           Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="@(() => searchValue = null)">
                    Clear
                </MudButton>
            }
        </MudStack>
    </MudPaper>

    <!-- HOA Users Table -->
    <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <div class="pa-8 text-center">
                <MudText Typo="Typo.h6" Style="color: #666;">Loading HOA users...</MudText>
            </div>
        }
        else if (!filteredUsers.Any())
        {
            <div class="pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Filled.Business" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No HOA users found</MudText>
                <MudText Typo="Typo.body2" Style="color: #999;">
                    @(string.IsNullOrEmpty(searchValue) 
                        ? "Click 'Invite HOA User' to add board members" 
                        : "Try adjusting your search")
                </MudText>
            </div>
        }
        else
        {
            <MudTable T="CustomerAccountUser" 
                      Items="filteredUsers" 
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm"
                      Elevation="0">
                <HeaderContent>
                    <MudTh Style="font-weight: 600;">User</MudTh>
                    <MudTh Style="font-weight: 600;">Email</MudTh>
                    <MudTh Style="font-weight: 600;">Organization</MudTh>
                    <MudTh Style="font-weight: 600;">Role</MudTh>
                    <MudTh Style="font-weight: 600;">Status</MudTh>
                    <MudTh Style="font-weight: 600; text-align: right;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Color="@GetRoleColor(context.Role)" Size="Size.Small">
                                @(context.User?.FirstName?.Substring(0, 1).ToUpper() ?? "?")
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.User?.FullName</MudText>
                                <MudText Typo="Typo.caption" Style="color: #999;">@context.User?.Title</MudText>
                            </MudStack>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Email">
                        <MudText Typo="Typo.body2">@context.User?.Email</MudText>
                    </MudTd>
                    <MudTd DataLabel="Organization">
                        <MudLink Href="@($"/Customers/Details/{context.CustomerAccountId}")" Typo="Typo.body2">
                            @(context.CustomerAccount?.Name ?? "N/A")
                        </MudLink>
                    </MudTd>
                    <MudTd DataLabel="Role">
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="@GetRoleColor(context.Role)"
                                 Variant="Variant.Filled">
                            @GetRoleDisplayName(context.Role)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="@(context.IsActive ? Color.Success : Color.Warning)"
                                 Variant="Variant.Filled">
                            @(context.IsActive ? "Active" : "Inactive")
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: right;">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                                 Size="Size.Small" 
                                 Dense="true"
                                 AnchorOrigin="Origin.BottomRight"
                                 TransformOrigin="Origin.TopRight">
                            <MudMenuItem Icon="@Icons.Material.Filled.VpnKey" 
                                         OnClick="@(() => SendPasswordResetAsync(context))">
                                Send Password Reset
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.SwapHoriz" 
                                         OnClick="@(() => ChangeRoleAsync(context))"
                                         IconColor="Color.Info">
                                Change Role
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.PersonRemove" 
                                         OnClick="@(() => DeactivateUserAsync(context))"
                                         IconColor="Color.Error">
                                Remove from Organization
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<CustomerAccountUser> hoaUsers = new();
    private string? searchValue;
    private bool isLoading = true;

    private IEnumerable<CustomerAccountUser> filteredUsers
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchValue))
                return hoaUsers;

            return hoaUsers.Where(u =>
                (u.User?.UserName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.User?.Email?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.User?.FirstName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.User?.LastName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (u.CustomerAccount?.Name?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadHOAUsers();
    }

    private async Task LoadHOAUsers()
    {
        isLoading = true;
        try
        {
            var tenantId = TenantContext.TenantId;
            if (!tenantId.HasValue)
            {
                Snackbar.Add("Tenant context not available", Severity.Error);
                return;
            }

            await using var db = await DbFactory.CreateDbContextAsync();

            // Get all CustomerAccountUsers for this tenant
            hoaUsers = await db.CustomerAccountUsers
                .Include(cau => cau.User)
                .Include(cau => cau.CustomerAccount)
                .Where(cau => cau.IsActive && 
                             cau.CustomerAccount.TenantId == tenantId.Value &&
                             cau.CustomerAccount.IsActive)
                .OrderBy(cau => cau.CustomerAccount.Name)
                .ThenBy(cau => cau.User.LastName)
                .ThenBy(cau => cau.User.FirstName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading HOA users: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private int GetRoleCount(string roleName)
    {
        var role = roleName switch
        {
            "HOAUser" => CustomerAccountRole.Member,
            "HOAAuditor" => CustomerAccountRole.Viewer,
            _ => CustomerAccountRole.Member
        };
        return hoaUsers.Count(u => u.Role == role || (roleName == "HOAUser" && u.Role <= CustomerAccountRole.Member));
    }

    private Color GetRoleColor(CustomerAccountRole role)
    {
        return role switch
        {
            CustomerAccountRole.Owner => Color.Error,
            CustomerAccountRole.Admin => Color.Warning,
            CustomerAccountRole.Member => Color.Primary,
            CustomerAccountRole.Viewer => Color.Secondary,
            _ => Color.Default
        };
    }

    private static string GetRoleDisplayName(CustomerAccountRole role)
    {
        return role switch
        {
            CustomerAccountRole.Owner => "Owner",
            CustomerAccountRole.Admin => "Admin",
            CustomerAccountRole.Member => "Member",
            CustomerAccountRole.Viewer => "Viewer",
            _ => role.ToString()
        };
    }

    private static Color GetStatusColor(StatusEnum status)
    {
        return status switch
        {
            StatusEnum.Active => Color.Success,
            StatusEnum.Inactive => Color.Warning,
            StatusEnum.LockedOut => Color.Error,
            _ => Color.Default
        };
    }

    private async Task OpenInviteDialog()
    {
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<InviteHOAUserDialog>("Invite HOA User", options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            await LoadHOAUsers();
        }
    }

    private async Task ResendInviteAsync(CustomerAccountUser cau)
    {
        if (cau.User == null) return;

        try
        {
            var resetToken = await UserManager.GeneratePasswordResetTokenAsync(cau.User);
            Snackbar.Add($"Password reset email sent to {cau.User.Email}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending email: {ex.Message}", Severity.Error);
        }
    }

    private async Task SendPasswordResetAsync(CustomerAccountUser cau)
    {
        if (cau.User == null) return;

        try
        {
            var resetToken = await UserManager.GeneratePasswordResetTokenAsync(cau.User);
            Snackbar.Add($"Password reset email sent to {cau.User.Email}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending password reset: {ex.Message}", Severity.Error);
        }
    }

    private async Task ChangeRoleAsync(CustomerAccountUser cau)
    {
        if (cau.CustomerAccount == null) return;

        var currentRole = cau.Role;
        var nextRole = currentRole switch
        {
            CustomerAccountRole.Owner => CustomerAccountRole.Admin,
            CustomerAccountRole.Admin => CustomerAccountRole.Member,
            CustomerAccountRole.Member => CustomerAccountRole.Viewer,
            CustomerAccountRole.Viewer => CustomerAccountRole.Owner,
            _ => CustomerAccountRole.Member
        };

        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Confirm Role Change",
            $"Change {cau.User?.FullName}'s role from {GetRoleDisplayName(currentRole)} to {GetRoleDisplayName(nextRole)}?",
            yesText: "Change", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                var success = await CustomerService.UpdateTeamMemberRoleAsync(cau.CustomerAccountId, cau.UserId, nextRole);
                if (success)
                {
                    Snackbar.Add($"Role changed to {GetRoleDisplayName(nextRole)}", Severity.Success);
                    await LoadHOAUsers();
                }
                else
                {
                    Snackbar.Add("Failed to change role", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error changing role: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeactivateUserAsync(CustomerAccountUser cau)
    {
        if (cau.CustomerAccount == null) return;

        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Remove from Organization",
            $"Remove {cau.User?.FullName} from {cau.CustomerAccount.Name}? They will no longer have access to this organization's reserve studies.",
            yesText: "Remove", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (confirm == true)
        {
            try
            {
                var success = await CustomerService.RemoveTeamMemberAsync(cau.CustomerAccountId, cau.UserId);
                if (success)
                {
                    Snackbar.Add($"User removed from {cau.CustomerAccount.Name}", Severity.Success);
                    await LoadHOAUsers();
                }
                else
                {
                    Snackbar.Add("Failed to remove user", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}
