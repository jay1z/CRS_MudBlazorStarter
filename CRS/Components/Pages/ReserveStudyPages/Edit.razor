@attribute [Authorize(Roles = "Specialist")]
@page "/reservestudies/edit/{Id:int}"
@using CRS.Data
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Edit Reserve Study</PageTitle>

@if (reserveStudy == null)
{
    <MudProgressLinear Color="Color.Info" Indeterminate="true" />
    <MudText Typo="Typo.h4">Loading...</MudText>
}
else
{
    <MudText Typo="Typo.h4">@reserveStudy.Community?.Name</MudText>
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
        <EditForm OnValidSubmit="SaveChanges" EditContext="editContext">
            <MudGrid>
                <!-- Aside Column -->
                <MudItem xs="12" lg="4">
                    <!-- Details Card -->
                    <MudCard Elevation="25" Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">Request ID</MudText>
                            <MudText Typo="Typo.body2">@reserveStudy.HashedId</MudText>
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.h6" Color="Color.Primary">Created</MudText>
                            <MudText Typo="Typo.body2">@reserveStudy.DateCreated?.ToString("MM/dd/yyyy")</MudText>
                        </MudCardContent>
                    </MudCard>

                    <!-- Specialist Card -->
                    <MudCard Elevation="25" Class="mb-4">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Color="Color.Primary">Reserve Specialist</MudText>
                            <MudSelect T="string" @bind-Value="reserveStudy.SpecialistUserId" Label="Reserve Specialist" Variant="Variant.Outlined" Required="false">
                                <MudSelectItem Value="@string.Empty">-- Select Specialist --</MudSelectItem>
                                @foreach (var user in applicationUsers)
                                {
                                    <MudSelectItem Value="@user.Id">@user.Email</MudSelectItem>
                                }
                            </MudSelect>
                        </MudCardContent>
                    </MudCard>

                    <!-- Actions Card -->
                    <MudCard Elevation="25" Class="mb-4">
                        <MudCardContent>
                            @* <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Save Changes</MudButton> *@
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Save Changes</MudButton>
                            <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="Cancel">Cancel</MudButton>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <!-- Main Column -->
                <MudItem xs="12" lg="8">
                    <MudCard Elevation="0">
                        <MudCardContent>
                            <MudTabs>
                                <!-- Information Tab -->
                                <MudTabPanel Text="Information" Icon="@Icons.Material.Filled.Info">
                                    <MudCard Elevation="25">
                                        <MudCardContent Class="py-6">
                                            <MudGrid>
                                                <!-- Contact Information -->
                                                <MudItem xs="12">
                                                    <MudText Typo="Typo.h6" Color="Color.Primary">Contact</MudText>
                                                </MudItem>
                                                <MudItem xs="6">
                                                    <MudTextField @bind-Value="reserveStudy.Contact.FirstName" For="@(() => reserveStudy.Contact.FirstName)" Label="First Name" Variant="Variant.Outlined" />
                                                    <MudTextField @bind-Value="reserveStudy.Contact.LastName" For="@(() => reserveStudy.Contact.LastName)" Label="Last Name" Variant="Variant.Outlined" />
                                                </MudItem>
                                                <MudItem xs="6">
                                                    <MudTextField @bind-Value="reserveStudy.Contact.Phone" For="@(() => reserveStudy.Contact.Phone)" Label="Phone" InputType="InputType.Telephone" Variant="Variant.Outlined" />
                                                    <MudTextField @bind-Value="reserveStudy.Contact.Extension" For="@(() => reserveStudy.Contact.Extension)" Label="Extension" Mask="@(new PatternMask("0000"))" Variant="Variant.Outlined" />
                                                    <MudTextField @bind-Value="reserveStudy.Contact.Email" For="@(() => reserveStudy.Contact.Email)" Label="Email" InputType="InputType.Email" Variant="Variant.Outlined" />
                                                </MudItem>

                                                <!-- Property Manager Information -->
                                                @if (reserveStudy.PropertyManager != null)
                                                {
                                                    <MudItem xs="12" Class="mt-4">
                                                        <MudText Typo="Typo.h6" Color="Color.Primary">Property Manager</MudText>
                                                    </MudItem>
                                                    <MudItem xs="6">
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.CompanyName" For="@(() => reserveStudy.PropertyManager.CompanyName)" Label="Company Name" Variant="Variant.Outlined" />
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.FirstName" For="@(() => reserveStudy.PropertyManager.FirstName)" Label="First Name" Variant="Variant.Outlined" />
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.LastName" For="@(() => reserveStudy.PropertyManager.LastName)" Label="Last Name" Variant="Variant.Outlined" />
                                                    </MudItem>
                                                    <MudItem xs="6">
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.Phone" For="@(() => reserveStudy.PropertyManager.Phone)" Label="Phone" InputType="InputType.Telephone" Variant="Variant.Outlined" />
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.Extension" For="@(() => reserveStudy.PropertyManager.Extension)" Label="Extension" Mask="@(new PatternMask("0000"))" Variant="Variant.Outlined" />
                                                        <MudTextField @bind-Value="reserveStudy.PropertyManager.Email" For="@(() => reserveStudy.PropertyManager.Email)" Label="Email" InputType="InputType.Email" Variant="Variant.Outlined" />
                                                    </MudItem>
                                                }
                                            </MudGrid>
                                        </MudCardContent>
                                    </MudCard>
                                </MudTabPanel>
                                <!-- Elements Tab -->
                                <MudTabPanel Text="Elements" Icon="@Icons.Material.Filled.List">
                                    <MudCard Elevation="25">
                                        <MudCardContent Class="py-6">
                                            <MudTable Items="reserveStudy.ReserveStudyBuildingElements" Dense="true" Hover="true" Elevation="0" FixedHeader="true" FixedFooter="true">
                                                <ColGroup>
                                                    <col style="width:65%;" />
                                                    <col style="width:25%;" />
                                                    <col style="width:10%;" />
                                                </ColGroup>
                                                <HeaderContent>
                                                    <MudTh>Name</MudTh>
                                                    <MudTh>Needs Service</MudTh>
                                                    <MudTh class="text-end">Amount</MudTh>
                                                </HeaderContent>
                                                <RowTemplate Context="beContext">
                                                    <MudTd>@beContext.BuildingElement?.Name</MudTd>
                                                    <MudTd>
                                                        <MudCheckBox T="bool" @bind-Value="beContext.BuildingElement.NeedsService" Color="Color.Success" UncheckedColor="Color.Error" ReadOnly="true" />
                                                    </MudTd>
                                                    <MudTd class="text-end">
                                                        <MudNumericField @bind-Value="beContext.Count" For="@(() => beContext.Count)" Min="0" />
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </MudCardContent>
                                    </MudCard>
                                    <MudCard Elevation="25">
                                        <MudCardContent Class="py-6">
                                            <MudTable Items="reserveStudy.ReserveStudyCommonElements" Dense="true" Hover="true" Elevation="0" FixedHeader="true" FixedFooter="true">
                                                <ColGroup>
                                                    <col style="width:65%;" />
                                                    <col style="width:25%;" />
                                                    <col style="width:10%;" />
                                                </ColGroup>
                                                <HeaderContent>
                                                    <MudTh>Name</MudTh>
                                                    <MudTh>Needs Service</MudTh>
                                                    <MudTh class="text-end">Amount</MudTh>
                                                </HeaderContent>
                                                <RowTemplate Context="ceContext">
                                                    <MudTd>@ceContext.CommonElement?.Name</MudTd>
                                                    <MudTd>
                                                        <MudCheckBox T="bool" @bind-Value="ceContext.CommonElement.NeedsService" Color="Color.Success" UncheckedColor="Color.Error" ReadOnly="true" />
                                                    </MudTd>
                                                    <MudTd class="text-end">
                                                        <MudNumericField @bind-Value="ceContext.Count" For="@(() => ceContext.Count)" Min="0" />
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </MudCardContent>
                                    </MudCard>
                                    <MudCard Elevation="25">
                                        <MudCardContent Class="py-6">
                                            <MudTable Items="reserveStudy.ReserveStudyAdditionalElements" Dense="true" Hover="true" Elevation="0" FixedHeader="true" FixedFooter="true">
                                                <ColGroup>
                                                    <col style="width:65%;" />
                                                    <col style="width:25%;" />
                                                    <col style="width:10%;" />
                                                </ColGroup>
                                                <HeaderContent>
                                                    <MudTh>Name</MudTh>
                                                    <MudTh>Needs Service</MudTh>
                                                    <MudTh class="text-end">Amount</MudTh>
                                                </HeaderContent>
                                                <RowTemplate Context="aeContext">
                                                    <MudTd>@aeContext.Name</MudTd>
                                                    <MudTd>
                                                        <MudCheckBox T="bool" @bind-Value="aeContext.NeedsService" Color="Color.Success" UncheckedColor="Color.Error" ReadOnly="true" />
                                                    </MudTd>
                                                    <MudTd class="text-end">
                                                        <MudNumericField @bind-Value="aeContext.Count" For="@(() => aeContext.Count)" Min="0" />
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </MudCardContent>
                                    </MudCard>
                                </MudTabPanel>
                                <!-- Service Contacts Tab -->
                                <MudTabPanel Text="Service Contacts" Icon="@Icons.Material.Filled.ContactPhone">
                                    <MudExpansionPanels>
                                        @foreach (var element in reserveStudy.ReserveStudyBuildingElements.Where(e => e.BuildingElement.NeedsService))
                                        {
                                            <MudExpansionPanel Text="@element.BuildingElement?.Name">
                                                <ChildContent>
                                                    <MudGrid>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.CompanyName" For="@(() => element.ServiceContact.CompanyName)" Label="Company Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.FirstName" For="@(() => element.ServiceContact.FirstName)" Label="First Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.LastName" For="@(() => element.ServiceContact.LastName)" Label="Last Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Phone" For="@(() => element.ServiceContact.Phone)" Label="Phone" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Extension" For="@(() => element.ServiceContact.Extension)" Label="Extension" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.Email" For="@(() => element.ServiceContact.Email)" Label="Email" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                    </MudGrid>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        }
                                        @foreach (var element in reserveStudy.ReserveStudyCommonElements.Where(e => e.CommonElement.NeedsService))
                                        {
                                            <MudExpansionPanel Text="@element.CommonElement?.Name">
                                                <ChildContent>
                                                    <MudGrid>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.CompanyName" For="@(() => element.ServiceContact.CompanyName)" Label="Company Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.FirstName" For="@(() => element.ServiceContact.FirstName)" Label="First Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.LastName" For="@(() => element.ServiceContact.LastName)" Label="Last Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Phone" For="@(() => element.ServiceContact.Phone)" Label="Phone" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Extension" For="@(() => element.ServiceContact.Extension)" Label="Extension" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.Email" For="@(() => element.ServiceContact.Email)" Label="Email" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                    </MudGrid>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        }
                                        @foreach (var element in reserveStudy.ReserveStudyAdditionalElements.Where(e => e.NeedsService))
                                        {
                                            <MudExpansionPanel Text="@element.Name">
                                                <ChildContent>
                                                    <MudGrid>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.CompanyName" For="@(() => element.ServiceContact.CompanyName)" Label="Company Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.FirstName" For="@(() => element.ServiceContact.FirstName)" Label="First Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.LastName" For="@(() => element.ServiceContact.LastName)" Label="Last Name" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Phone" For="@(() => element.ServiceContact.Phone)" Label="Phone" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="6">
                                                            <MudTextField @bind-Value="element.ServiceContact.Extension" For="@(() => element.ServiceContact.Extension)" Label="Extension" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="element.ServiceContact.Email" For="@(() => element.ServiceContact.Email)" Label="Email" Variant="Variant.Outlined" />
                                                        </MudItem>
                                                    </MudGrid>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        }
                                    </MudExpansionPanels>
                                </MudTabPanel>
                            </MudTabs>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudContainer>
}

@code {
    [Parameter]
    public int Id { get; set; }
    private ApplicationDbContext context;
    private EditContext? editContext;
    private List<ApplicationUser> applicationUsers = new();

    private ReserveStudy? reserveStudy;
    private ValidationMessageStore? messageStore;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            context = DbFactory.CreateDbContext();

            reserveStudy = await context.ReserveStudies
                .Include(rs => rs.Community)
                .Include(rs => rs.Contact)
                .Include(rs => rs.PropertyManager)
                .Include(rs => rs.Specialist)

                .Include(rs => rs.ReserveStudyBuildingElements)
                    .ThenInclude(be => be.BuildingElement)
                .Include(rs => rs.ReserveStudyBuildingElements)
                    .ThenInclude(be => be.ElementMeasurementOptions)
                .Include(rs => rs.ReserveStudyBuildingElements)
                    .ThenInclude(be => be.ElementUsefulLifeOptions)
                .Include(rs => rs.ReserveStudyBuildingElements)
                    .ThenInclude(be => be.ElementRemainingLifeOptions)
                .Include(rs => rs.ReserveStudyBuildingElements)
                    .ThenInclude(be => be.ServiceContact)

                .Include(rs => rs.ReserveStudyCommonElements)
                    .ThenInclude(be => be.CommonElement)
                .Include(rs => rs.ReserveStudyCommonElements)
                    .ThenInclude(be => be.ElementMeasurementOptions)
                .Include(rs => rs.ReserveStudyCommonElements)
                    .ThenInclude(be => be.ElementUsefulLifeOptions)
                .Include(rs => rs.ReserveStudyCommonElements)
                    .ThenInclude(be => be.ElementRemainingLifeOptions)
                .Include(rs => rs.ReserveStudyCommonElements)
                    .ThenInclude(be => be.ServiceContact)

                .Include(rs => rs.ReserveStudyAdditionalElements)
                    .ThenInclude(be => be.ElementMeasurementOptions)
                .Include(rs => rs.ReserveStudyAdditionalElements)
                    .ThenInclude(be => be.ElementUsefulLifeOptions)
                .Include(rs => rs.ReserveStudyAdditionalElements)
                    .ThenInclude(be => be.ElementRemainingLifeOptions)
                .Include(rs => rs.ReserveStudyAdditionalElements)
                    .ThenInclude(be => be.ServiceContact)

                .FirstOrDefaultAsync(rs => rs.Id == Id);

            if (reserveStudy == null)
            {
                NavigationManager.NavigateTo("/reservestudies/notfound");
            }
            else
            {
                editContext = new(reserveStudy);
                // editContext.OnFieldChanged += HandleFieldChanged;
                editContext.OnValidationRequested += HandleValidationRequested;
                messageStore = new(editContext);
                applicationUsers = await context.Users.ToListAsync();

                foreach (var element in reserveStudy.ReserveStudyAdditionalElements)
                {
                    element.ElementMeasurementOptions ??= context.ElementMeasurementOptions.FirstOrDefault();
                    element.ElementUsefulLifeOptions ??= context.ElementUsefulLifeOptions.FirstOrDefault();
                    element.ElementRemainingLifeOptions ??= context.ElementRemainingLifeOptions.FirstOrDefault();

                    element.ElementMeasurementOptionsList = await context.ElementMeasurementOptions.ToListAsync();
                    element.ElementUsefulLifeOptionsList = await context.ElementUsefulLifeOptions.ToListAsync();
                    element.ElementRemainingLifeOptionsList = await context.ElementRemainingLifeOptions.ToListAsync();

                    //element.ServiceContact ??= new ServiceContact();
                }
                foreach (var element in reserveStudy.ReserveStudyBuildingElements)
                {
                    element.ElementMeasurementOptions ??= context.ElementMeasurementOptions.FirstOrDefault();
                    element.ElementUsefulLifeOptions ??= context.ElementUsefulLifeOptions.FirstOrDefault();
                    element.ElementRemainingLifeOptions ??= context.ElementRemainingLifeOptions.FirstOrDefault();

                    element.ElementMeasurementOptionsList = await context.ElementMeasurementOptions.ToListAsync();
                    element.ElementUsefulLifeOptionsList = await context.ElementUsefulLifeOptions.ToListAsync();
                    element.ElementRemainingLifeOptionsList = await context.ElementRemainingLifeOptions.ToListAsync();

                    //element.ServiceContact ??= new ServiceContact();
                }
                foreach (var element in reserveStudy.ReserveStudyCommonElements)
                {
                    element.ElementMeasurementOptions ??= context.ElementMeasurementOptions.FirstOrDefault();
                    element.ElementUsefulLifeOptions ??= context.ElementUsefulLifeOptions.FirstOrDefault();
                    element.ElementRemainingLifeOptions ??= context.ElementRemainingLifeOptions.FirstOrDefault();

                    element.ElementMeasurementOptionsList = await context.ElementMeasurementOptions.ToListAsync();
                    element.ElementUsefulLifeOptionsList = await context.ElementUsefulLifeOptions.ToListAsync();
                    element.ElementRemainingLifeOptionsList = await context.ElementRemainingLifeOptions.ToListAsync();

                    //element.ServiceContact ??= new ServiceContact();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reserve study: {ex.Message}", Severity.Error);
        }
    }

    // private void HandleFieldChanged(object? sender, FieldChangedEventArgs e)
    // {
    //     //Snackbar.Add($"{e.FieldIdentifier.Model.ToString()}:{e.FieldIdentifier.FieldName}", Severity.Success);
    //     switch (e.FieldIdentifier.Model)
    //     {
    //         case ReserveStudy:
    //             context.Entry(reserveStudy).State = EntityState.Modified;
    //             break;
    //         case Contact:
    //             context.Entry(reserveStudy.Contact).State = EntityState.Modified;
    //             break;
    //         case PropertyManager:
    //             context.Entry(reserveStudy.PropertyManager).State = EntityState.Modified;
    //             break;
    //         case ReserveStudyAdditionalElement additionalElement:
    //             context.Entry(additionalElement).State = EntityState.Modified;
    //             // if (additionalElement.ServiceContact != null)
    //             // {
    //             //     context.Entry(additionalElement.ServiceContact).State = EntityState.Modified;
    //             // }
    //             break;
    //         case ReserveStudyBuildingElement buildingElement:
    //             context.Entry(buildingElement).State = EntityState.Modified;
    //             // if (buildingElement.ServiceContact != null)
    //             // {
    //             //     context.Entry(buildingElement.ServiceContact).State = EntityState.Modified;
    //             // }
    //             break;
    //         case ReserveStudyCommonElement commonElement:
    //             context.Entry(commonElement).State = EntityState.Modified;
    //             // if (commonElement.ServiceContact != null)
    //             // {
    //             //     context.Entry(commonElement.ServiceContact).State = EntityState.Modified;
    //             // }
    //             break;
    //         case ServiceContact serviceContact:
    //             context.Entry(serviceContact).State = EntityState.Modified;
    //             break;
    //     }
    // }
    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        messageStore?.Clear();
    }
    private async Task SaveChanges()
    {
        try
        {
            await context.SaveChangesAsync();

            Snackbar.Add("Changes saved successfully!", Severity.Success);
            NavigationManager.NavigateTo($"/reservestudies/details/{reserveStudy.Id}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving changes: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo($"/reservestudies/details/{Id}");
    }

    public void Dispose()
    {
        if (editContext is not null)
        {
            editContext.OnValidationRequested -= HandleValidationRequested;
        }
    }
}
