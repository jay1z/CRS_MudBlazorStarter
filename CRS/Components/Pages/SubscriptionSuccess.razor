@page "/billing/success"
@attribute [Microsoft.AspNetCore.Authorization.AllowAnonymous]
@using CRS.Data
@using CRS.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Nav
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject CRS.Services.Tenant.ITenantContext TenantContext
@inject IConfiguration Config
@inject ILogger<SubscriptionSuccess> Logger

@code {
    [SupplyParameterFromQuery] public int? TenantId { get; set; }
    [SupplyParameterFromQuery] public Guid? Token { get; set; }
    [SupplyParameterFromQuery] public bool RequestContainsDeferred { get; set; }
    [SupplyParameterFromQuery(Name="session_id")] public string? SessionId { get; set; }
    bool _checking = true;
    bool _active;
    bool _ownerExists;
    string? _pendingOwnerEmail;
    int? _resolvedTenantId;
    string? _resolvedSubdomain;
    Guid? _resolvedSignupToken;
    string? _error;

    protected override async Task OnInitializedAsync() {
        try {
            await using var db = await DbFactory.CreateDbContextAsync();

            CRS.Models.Tenant? tenant = null;

            if (RequestContainsDeferred && !string.IsNullOrWhiteSpace(SessionId)) {
                // Deferred signup: look up tenant by Stripe session ID
                tenant = await db.Tenants.AsNoTracking()
                    .FirstOrDefaultAsync(t => t.LastStripeCheckoutSessionId == SessionId);
            }

            // Also try by TenantId (passed in URL) or by TenantContext (resolved from subdomain)
            if (tenant == null) {
                var tid = TenantId ?? TenantContext.TenantId;
                if (tid is int id)
                    tenant = await db.Tenants.AsNoTracking().FirstOrDefaultAsync(t => t.Id == id);
            }

            if (tenant != null) {
                _resolvedTenantId = tenant.Id;
                _resolvedSubdomain = tenant.Subdomain;
                _resolvedSignupToken = tenant.SignupToken;
                _active = tenant.IsActive;
                _pendingOwnerEmail = tenant.PendingOwnerEmail;

                // Check if owner account already exists
                var ownerRoleId = await db.Roles2.AsNoTracking()
                    .Where(r => r.Name == "TenantOwner")
                    .Select(r => r.Id)
                    .FirstOrDefaultAsync();
                if (ownerRoleId != default) {
                    _ownerExists = await db.UserRoleAssignments.AsNoTracking()
                        .AnyAsync(a => a.TenantId == tenant.Id && a.RoleId == ownerRoleId);
                }
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "Error checking subscription status on billing success page");
            _error = "Unable to verify subscription status. Please try refreshing the page.";
        }

        _checking = false;
    }
}

<PageTitle>Subscription Success</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudPaper Elevation="3" Class="pa-8" Style="border-radius: 16px; text-align: center;">
        @if (_checking) {
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Class="mt-4">Verifying your subscription...</MudText>
        } else if (!string.IsNullOrEmpty(_error)) {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #10b981; font-size: 80px;" />
            <MudText Typo="Typo.h4" Class="mt-4" Style="font-weight: 700; color: #10b981;">Payment Received</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #666;">Your payment has been received. Your subscription is being activated.</MudText>
            <MudAlert Severity="Severity.Warning" Class="mt-4">@_error</MudAlert>
            <MudDivider Class="my-6" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/Account/Login">Go to Login</MudButton>
        } else if (_active && _ownerExists) {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #10b981; font-size: 80px;" />
            <MudText Typo="Typo.h4" Class="mt-4" Style="font-weight: 700; color: #10b981;">Subscription Active!</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #666;">Your subscription is active and ready to use.</MudText>
            <MudDivider Class="my-6" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/dashboard">Go to Dashboard</MudButton>
        } else if (_active && !_ownerExists) {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #10b981; font-size: 80px;" />
            <MudText Typo="Typo.h4" Class="mt-4" Style="font-weight: 700; color: #10b981;">Payment Successful!</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #666;">Your subscription is active. Create your administrator account to get started.</MudText>
            <MudDivider Class="my-6" />
            @if (_resolvedTenantId.HasValue && _resolvedSignupToken.HasValue) {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large"
                           Href="@($"/signup/owner?tenantId={_resolvedTenantId.Value}&token={_resolvedSignupToken.Value}")">
                    Create Your Account
                </MudButton>
            } else {
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/Account/Login">Go to Login</MudButton>
            }
        } else {
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #10b981; font-size: 80px;" />
            <MudText Typo="Typo.h4" Class="mt-4" Style="font-weight: 700; color: #10b981;">Payment Received</MudText>
            <MudText Typo="Typo.body1" Class="mt-2" Style="color: #666;">Your payment has been received. Your subscription is being activated.</MudText>
            <MudText Typo="Typo.body2" Class="mt-1" Style="color: #999;">This may take a few moments. You can refresh this page or proceed to login.</MudText>
            <MudDivider Class="my-6" />
            <MudStack Row="true" Justify="Justify.Center" Spacing="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/Account/Login">Go to Login</MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" Href="@($"/billing/success?RequestContainsDeferred={RequestContainsDeferred}&session_id={SessionId}")">Refresh</MudButton>
            </MudStack>
        }
    </MudPaper>
</MudContainer>
