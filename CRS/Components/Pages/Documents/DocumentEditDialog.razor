@using Horizon.Models
@using Horizon.Services.Interfaces

@inject IDocumentService DocumentService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" />
            <MudText Typo="Typo.h6">Edit Document</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="fileName" 
                          Label="Display Name" 
                          Variant="Variant.Outlined"
                          Required="true" />
            
            <MudSelect T="DocumentType" 
                       @bind-Value="documentType" 
                       Label="Document Type"
                       Variant="Variant.Outlined">
                @foreach (DocumentType type in Enum.GetValues<DocumentType>())
                {
                    <MudSelectItem T="DocumentType" Value="@type">
                        @GetTypeDisplayName(type)
                    </MudSelectItem>
                }
            </MudSelect>
            
            <MudTextField @bind-Value="description" 
                          Label="Description" 
                          Variant="Variant.Outlined"
                          Lines="3" />
            
            <MudCheckBox T="bool" @bind-Value="isPublic" 
                         Label="Share with client (visible to HOA users)" 
                         Color="Color.Success" />
            
            <MudDivider />
            
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Style="color: #666;">Original Filename</MudText>
                <MudText Typo="Typo.body2">@Document.OriginalFileName</MudText>
            </MudStack>
            
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Style="color: #666;">File Size</MudText>
                <MudText Typo="Typo.body2">@FormatFileSize(Document.FileSizeBytes)</MudText>
            </MudStack>
            
            <MudStack Spacing="1">
                <MudText Typo="Typo.caption" Style="color: #666;">Uploaded</MudText>
                <MudText Typo="Typo.body2">
                    @Document.DateCreated?.ToString("MMMM dd, yyyy h:mm tt") by @Document.UploadedBy?.FullName
                </MudText>
            </MudStack>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="SaveChanges"
                   Disabled="@(string.IsNullOrWhiteSpace(fileName) || isSaving)">
            @if (isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save Changes
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public Document Document { get; set; } = null!;

    private string fileName = "";
    private string description = "";
    private DocumentType documentType;
    private bool isPublic;
    private bool isSaving;

    protected override void OnInitialized()
    {
        fileName = Document.FileName;
        description = Document.Description ?? "";
        documentType = Document.Type;
        isPublic = Document.IsPublic;
    }

    private async Task SaveChanges()
    {
        if (string.IsNullOrWhiteSpace(fileName)) return;

        isSaving = true;
        try
        {
            Document.FileName = fileName;
            Document.Description = description;
            Document.Type = documentType;
            Document.IsPublic = isPublic;

            await DocumentService.UpdateAsync(Document);

            Snackbar.Add("Document updated successfully", Severity.Success);
            MudDialog.Close(DialogResult.Ok(Document));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSaving = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private string GetTypeDisplayName(DocumentType type) => type switch
    {
        DocumentType.Other => "Other",
        DocumentType.Report => "Report",
        DocumentType.Invoice => "Invoice",
        DocumentType.Photo => "Photo",
        DocumentType.Contract => "Contract",
        DocumentType.FinancialStatement => "Financial Statement",
        DocumentType.ProposalDocument => "Proposal",
        DocumentType.SiteVisitNotes => "Site Visit Notes",
        DocumentType.Insurance => "Insurance",
        DocumentType.Warranty => "Warranty",
        DocumentType.MaintenanceRecord => "Maintenance Record",
        _ => type.ToString()
    };

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024):F1} MB";
    }
}
