@page "/Customers/Details/{CustomerId:guid}"
@using CRS.Models
@using CRS.Services.Customers
@using CRS.Data
@using CRS.Components.Pages.Admin
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@attribute [Authorize(Policy = "RequireTenantStaff")]

@inject ICustomerService CustomerService
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@(customer?.Name ?? "Customer") - ALX Reserve Cloud</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-6">
    @if (isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (customer == null)
    {
        <MudAlert Severity="Severity.Error">Customer not found</MudAlert>
    }
    else
    {
        <MudStack Spacing="4">
            <!-- Header -->
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                <MudStack Spacing="1">
                    <MudBreadcrumbs Items="_breadcrumbs" Class="pa-0" />
                    <MudText Typo="Typo.h4" Style="font-weight: 700;">@customer.Name</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(customer.Type)" Variant="Variant.Outlined">
                        @GetTypeName(customer.Type)
                    </MudChip>
                </MudStack>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.Edit"
                               Href="@($"/Customers?edit={customer.Id}")">
                        Edit
                    </MudButton>
                </MudStack>
            </MudStack>

            <MudGrid Spacing="3">
                <!-- Contact Info -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; height: 100%;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Class="mr-2" Style="vertical-align: middle;" />
                            Contact Information
                        </MudText>
                        
                        @if (!string.IsNullOrEmpty(customer.ContactName))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Style="color: #999;" />
                                <MudText Typo="Typo.body2">@customer.ContactName</MudText>
                            </MudStack>
                        }
                        
                        @if (!string.IsNullOrEmpty(customer.Email))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Style="color: #999;" />
                                <MudLink Href="@($"mailto:{customer.Email}")" Typo="Typo.body2">@customer.Email</MudLink>
                            </MudStack>
                        }
                        
                        @if (!string.IsNullOrEmpty(customer.Phone))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Style="color: #999;" />
                                <MudLink Href="@($"tel:{customer.Phone}")" Typo="Typo.body2">@customer.Phone</MudLink>
                            </MudStack>
                        }
                        
                        @if (!string.IsNullOrEmpty(customer.Website))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Style="color: #999;" />
                                <MudLink Href="@customer.Website" Target="_blank" Typo="Typo.body2">@customer.Website</MudLink>
                            </MudStack>
                        }
                        
                        @if (string.IsNullOrEmpty(customer.ContactName) && string.IsNullOrEmpty(customer.Email) && 
                             string.IsNullOrEmpty(customer.Phone) && string.IsNullOrEmpty(customer.Website))
                        {
                            <MudText Typo="Typo.body2" Style="color: #999;">No contact information</MudText>
                        }
                    </MudPaper>
                </MudItem>

                <!-- Address -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; height: 100%;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.LocationOn" Class="mr-2" Style="vertical-align: middle;" />
                            Address
                        </MudText>
                        
                        @if (!string.IsNullOrEmpty(customer.AddressLine1))
                        {
                            <MudText Typo="Typo.body2">@customer.AddressLine1</MudText>
                            @if (!string.IsNullOrEmpty(customer.AddressLine2))
                            {
                                <MudText Typo="Typo.body2">@customer.AddressLine2</MudText>
                            }
                            <MudText Typo="Typo.body2">
                                @customer.City@(string.IsNullOrEmpty(customer.State) ? "" : $", {customer.State}") @customer.PostalCode
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Style="color: #999;">No address on file</MudText>
                        }
                    </MudPaper>
                </MudItem>

                <!-- Billing -->
                <MudItem xs="12" md="4">
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; height: 100%;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" Style="vertical-align: middle;" />
                            Billing
                        </MudText>
                        
                        @if (!string.IsNullOrEmpty(customer.TaxId))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudText Typo="Typo.caption" Style="color: #999; min-width: 80px;">Tax ID:</MudText>
                                <MudText Typo="Typo.body2">@customer.TaxId</MudText>
                            </MudStack>
                        }
                        
                        @if (!string.IsNullOrEmpty(customer.PaymentTerms))
                        {
                            <MudStack Row="true" Spacing="2" Class="mb-2">
                                <MudText Typo="Typo.caption" Style="color: #999; min-width: 80px;">Terms:</MudText>
                                <MudText Typo="Typo.body2">@customer.PaymentTerms</MudText>
                            </MudStack>
                        }
                        
                        <MudDivider Class="my-2" />
                        
                        <MudStack Row="true" Spacing="2">
                            <MudText Typo="Typo.caption" Style="color: #999; min-width: 80px;">Revenue:</MudText>
                            <MudText Typo="Typo.body2" Style="font-weight: 600; color: #10b981;">@totalRevenue.ToString("C")</MudText>
                        </MudStack>
                    </MudPaper>
                </MudItem>
            </MudGrid>

            <!-- Communities -->
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.HomeWork" Class="mr-2" Style="vertical-align: middle;" />
                        Properties (@communities.Count)
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Add"
                               Href="/Communities/Create">
                        Add Property
                    </MudButton>
                </MudStack>
                
                @if (!communities.Any())
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                        No properties associated with this customer yet.
                    </MudAlert>
                }
                else
                {
                    <MudTable Items="@communities" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Property Name</MudTh>
                            <MudTh>Location</MudTh>
                            <MudTh>Units</MudTh>
                            <MudTh Style="width: 100px;">Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Property Name">
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">@context.Name</MudText>
                            </MudTd>
                            <MudTd DataLabel="Location">
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    @(context.PhysicalAddress?.City ?? "N/A"), @(context.PhysicalAddress?.State ?? "")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Units">
                                <MudText Typo="Typo.body2">@(context.NumberOfUnits?.ToString() ?? "-")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                               Size="Size.Small"
                                               Href="@($"/Communities/Details/{context.Id}")"
                                               Title="View Property" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>

            <!-- Team Members -->
            <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <MudText Typo="Typo.h6" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.Group" Class="mr-2" Style="vertical-align: middle;" />
                        Team Members (@teamMembers.Count)
                    </MudText>
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="OpenInviteDialog">
                        Invite User
                    </MudButton>
                </MudStack>

                @if (!teamMembers.Any() && !pendingInvitations.Any())
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                        No team members yet. Invite users to give them access to this customer's reserve studies.
                    </MudAlert>
                }
                else
                {
                    @if (teamMembers.Any())
                    {
                        <MudTable Items="@teamMembers" Hover="true" Dense="true" Elevation="0" Class="mb-3">
                            <HeaderContent>
                                <MudTh>Member</MudTh>
                                <MudTh>Role</MudTh>
                                <MudTh>Joined</MudTh>
                                <MudTh Style="width: 80px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Member">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudAvatar Color="@GetRoleAvatarColor(context.Role)" Size="Size.Small">
                                            @(context.User?.FirstName?.Substring(0, 1).ToUpper() ?? "?")
                                        </MudAvatar>
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                                @(context.User != null ? $"{context.User.FirstName} {context.User.LastName}" : "Unknown")
                                            </MudText>
                                            <MudText Typo="Typo.caption" Style="color: #999;">@context.User?.Email</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Role">
                                    <MudChip T="string" Size="Size.Small" Color="@GetRoleChipColor(context.Role)" Variant="Variant.Filled">
                                        @context.Role
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Joined">
                                    <MudText Typo="Typo.body2" Style="color: #666;">
                                        @context.JoinedAt.ToString("MMM d, yyyy")
                                    </MudText>
                                </MudTd>
                                <MudTd>
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => ChangeRoleAsync(context))">
                                            Change Role
                                        </MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.PersonRemove" IconColor="Color.Error" 
                                                     OnClick="@(() => RemoveMemberAsync(context))">
                                            Remove
                                        </MudMenuItem>
                                    </MudMenu>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }

                    @if (pendingInvitations.Any())
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2" Style="color: #666;">
                            <MudIcon Icon="@Icons.Material.Filled.Pending" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            Pending Invitations (@pendingInvitations.Count)
                        </MudText>
                        <MudTable Items="@pendingInvitations" Hover="true" Dense="true" Elevation="0">
                            <HeaderContent>
                                <MudTh>Email</MudTh>
                                <MudTh>Role</MudTh>
                                <MudTh>Expires</MudTh>
                                <MudTh Style="width: 80px;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Email">
                                    <MudText Typo="Typo.body2">@context.Email</MudText>
                                </MudTd>
                                <MudTd DataLabel="Role">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
                                        @context.Role
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Expires">
                                    <MudText Typo="Typo.body2" Style="color: #999;">
                                        @context.ExpiresAt.ToString("MMM d, yyyy")
                                    </MudText>
                                </MudTd>
                                <MudTd>
                                    <MudStack Row="true" Spacing="1">
                                        <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" 
                                                       Title="Resend invitation"
                                                       OnClick="@(() => ResendInvitationAsync(context))" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" 
                                                       Color="Color.Error"
                                                       Title="Revoke invitation"
                                                       OnClick="@(() => RevokeInvitationAsync(context))" />
                                    </MudStack>
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                }
            </MudPaper>

            <!-- Notes -->
            @if (!string.IsNullOrEmpty(customer.Notes))
            {
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                        <MudIcon Icon="@Icons.Material.Filled.Notes" Class="mr-2" Style="vertical-align: middle;" />
                        Internal Notes
                    </MudText>
                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@customer.Notes</MudText>
                </MudPaper>
            }
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter] public Guid CustomerId { get; set; }

    private CustomerAccount? customer;
    private List<Community> communities = [];
    private List<CustomerAccountUser> teamMembers = [];
    private List<CustomerAccountInvitation> pendingInvitations = [];
    private decimal totalRevenue = 0;
    private bool isLoading = true;

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Customers", "/Customers"),
        new BreadcrumbItem("Details", null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomer();
    }

    private async Task LoadCustomer()
    {
        isLoading = true;

        try
        {
            customer = await CustomerService.GetByIdAsync(CustomerId);

            if (customer != null)
            {
                _breadcrumbs = new()
                {
                    new BreadcrumbItem("Customers", "/Customers"),
                    new BreadcrumbItem(customer.Name, null, disabled: true)
                };

                await using var db = await DbFactory.CreateDbContextAsync();

                // Get directly linked communities (via CustomerAccountId)
                var directCommunityIds = await db.Communities
                    .Where(c => c.CustomerAccountId == customer.Id && c.IsActive)
                    .Select(c => c.Id)
                    .ToListAsync();

                // Also get communities linked via reserve studies (legacy association)
                var studyCommunityIds = new List<Guid>();
                if (customer.UserId.HasValue)
                {
                    studyCommunityIds = await db.ReserveStudies
                        .Where(rs => rs.CommunityId.HasValue &&
                                    (rs.RequestedByUserId == customer.UserId || rs.ApplicationUserId == customer.UserId))
                        .Select(rs => rs.CommunityId!.Value)
                        .Distinct()
                        .ToListAsync();
                }

                // Combine both sources
                var allCommunityIds = directCommunityIds
                    .Union(studyCommunityIds)
                    .Distinct()
                    .ToList();

                communities = await db.Communities
                    .Include(c => c.PhysicalAddress)
                    .Where(c => allCommunityIds.Contains(c.Id) && c.IsActive)
                    .OrderBy(c => c.Name)
                    .ToListAsync();

                // Calculate total revenue
                if (allCommunityIds.Any())
                {
                    totalRevenue = await db.Invoices
                        .Where(i => i.ReserveStudy != null && 
                                   i.ReserveStudy.CommunityId.HasValue && allCommunityIds.Contains(i.ReserveStudy.CommunityId.Value) &&
                                   i.Status == InvoiceStatus.Paid)
                        .SumAsync(i => i.TotalAmount);
                }

                // Load team members
                teamMembers = await CustomerService.GetTeamMembersAsync(CustomerId);

                // Load pending invitations
                pendingInvitations = await CustomerService.GetPendingInvitationsAsync(CustomerId);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading customer: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OpenInviteDialog()
    {
        var parameters = new DialogParameters<InviteHOAUserDialog>
        {
            { x => x.PreselectedCustomerId, CustomerId }
        };

        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<InviteHOAUserDialog>("Invite User", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false })
        {
            // Reload invitations
            pendingInvitations = await CustomerService.GetPendingInvitationsAsync(CustomerId);
            StateHasChanged();
        }
    }

    private async Task ChangeRoleAsync(CustomerAccountUser member)
    {
        var roles = Enum.GetValues<CustomerAccountRole>();
        var currentRole = member.Role;

        // Simple role cycle for now - could be a dialog later
        var nextRole = currentRole switch
        {
            CustomerAccountRole.Owner => CustomerAccountRole.Admin,
            CustomerAccountRole.Admin => CustomerAccountRole.Member,
            CustomerAccountRole.Member => CustomerAccountRole.Viewer,
            CustomerAccountRole.Viewer => CustomerAccountRole.Owner,
            _ => CustomerAccountRole.Member
        };

        bool? confirm = await DialogService.ShowMessageBox(
            "Change Role",
            $"Change {member.User?.FirstName}'s role from {currentRole} to {nextRole}?",
            yesText: "Change", cancelText: "Cancel");

        if (confirm == true)
        {
            var success = await CustomerService.UpdateTeamMemberRoleAsync(CustomerId, member.UserId, nextRole);
                if (success)
                {
                    Snackbar.Add($"Role changed to {nextRole}", Severity.Success);
                    teamMembers = await CustomerService.GetTeamMembersAsync(CustomerId);
            }
            else
            {
                Snackbar.Add("Failed to change role", Severity.Error);
            }
        }
    }

    private async Task RemoveMemberAsync(CustomerAccountUser member)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Remove Team Member",
            $"Remove {member.User?.FirstName} {member.User?.LastName} from this organization? They will lose access to all associated reserve studies.",
            yesText: "Remove", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (confirm == true)
        {
            var success = await CustomerService.RemoveTeamMemberAsync(CustomerId, member.UserId);
                if (success)
                {
                    Snackbar.Add("Team member removed", Severity.Success);
                    teamMembers = await CustomerService.GetTeamMembersAsync(CustomerId);
            }
            else
            {
                Snackbar.Add("Failed to remove team member", Severity.Error);
            }
        }
    }

    private async Task ResendInvitationAsync(CustomerAccountInvitation invitation)
    {
        try
        {
            // Get current user for re-creating invitation
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim == null || !Guid.TryParse(userIdClaim.Value, out var currentUserId))
            {
                Snackbar.Add("Unable to determine current user", Severity.Error);
                return;
            }

            // Create a new invitation (updates existing)
            var newInvitation = await CustomerService.CreateInvitationAsync(
                CustomerId, invitation.Email, invitation.Role, currentUserId);

            await CustomerService.SendInvitationEmailAsync(newInvitation);

            Snackbar.Add($"Invitation resent to {invitation.Email}", Severity.Success);
            pendingInvitations = await CustomerService.GetPendingInvitationsAsync(CustomerId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error resending invitation: {ex.Message}", Severity.Error);
        }
    }

    private async Task RevokeInvitationAsync(CustomerAccountInvitation invitation)
    {
        bool? confirm = await DialogService.ShowMessageBox(
            "Revoke Invitation",
            $"Revoke the invitation for {invitation.Email}?",
            yesText: "Revoke", cancelText: "Cancel");

        if (confirm == true)
        {
            var success = await CustomerService.RevokeInvitationAsync(invitation.Id);
            if (success)
            {
                Snackbar.Add("Invitation revoked", Severity.Success);
                pendingInvitations = await CustomerService.GetPendingInvitationsAsync(CustomerId);
            }
            else
            {
                Snackbar.Add("Failed to revoke invitation", Severity.Error);
            }
        }
    }

    private static Color GetTypeColor(CustomerType type) => type switch
    {
        CustomerType.HOABoard => Color.Primary,
        CustomerType.ManagementCompany => Color.Info,
        CustomerType.PropertyOwner => Color.Success,
        CustomerType.Developer => Color.Warning,
        _ => Color.Default
    };

    private static string GetTypeName(CustomerType type) => type switch
    {
        CustomerType.HOABoard => "HOA Board",
        CustomerType.ManagementCompany => "Management Company",
        CustomerType.PropertyOwner => "Property Owner",
        CustomerType.Developer => "Developer",
        CustomerType.Other => "Other",
        _ => type.ToString()
    };

    private static Color GetRoleAvatarColor(CustomerAccountRole role) => role switch
    {
        CustomerAccountRole.Owner => Color.Error,
        CustomerAccountRole.Admin => Color.Warning,
        CustomerAccountRole.Member => Color.Primary,
        CustomerAccountRole.Viewer => Color.Info,
        _ => Color.Default
    };

    private static Color GetRoleChipColor(CustomerAccountRole role) => role switch
    {
        CustomerAccountRole.Owner => Color.Error,
        CustomerAccountRole.Admin => Color.Warning,
        CustomerAccountRole.Member => Color.Primary,
        CustomerAccountRole.Viewer => Color.Info,
        _ => Color.Default
    };
}
