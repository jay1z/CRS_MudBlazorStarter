@page "/Roles"
@using CRS.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole<Guid>> RoleManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Roles Management</PageTitle>
<MudLink Href="https://learn.microsoft.com/en-us/aspnet/core/security/authorization/roles?view=aspnetcore-9.0">Roles</MudLink>

<MudContainer>
    <MudCard Elevation="0">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">User Roles Management</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton Icon="@Icons.Material.Filled.GroupAdd" Color="Color.Default" OnClick="OpenAddRoleDialogAsync" />
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudTable Items="roles" Hover="true" Striped="true">
                <ColGroup>
                    <col/>
                    <col style="width:150px;" />
                </ColGroup>
                <HeaderContent>
                    <MudTh>Role Name</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Name</MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="() => EditRole(context)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteRole(context)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
    <MudCard Elevation="0">
        <MudCardHeader>
            <MudText Typo="Typo.h5">Users</MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudTable T="ApplicationUser" Items="users" Hover="true" Striped="true">
                <HeaderContent>
                    <MudTh>User Name</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Roles</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.UserName</MudTd>
                    <MudTd>@context.Email</MudTd>
                    <MudTd>
                        @foreach (string role in context.Roles)
                        {
                            <MudChip T="string">@role</MudChip>
                        }
                    </MudTd>
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="() => OpenAddRoleToUserDialog(context)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Remove" OnClick="() => OpenRemoveRoleFromUserDialog(context)" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private string userId;
    private string roleName;
    private string message;
    private List<IdentityRole<Guid>> roles = new();
    private List<ApplicationUser> users = new();
    private bool isAddRoleDialogVisible;
    private ApplicationUser selectedUser;
    private string selectedRoleName;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
        await LoadUsers();
    }

    private async Task LoadRoles()
    {
        roles = await RoleManager.Roles.ToListAsync();
    }

    private async Task LoadUsers()
    {
        users = await UserManager.Users.ToListAsync();
        foreach (var user in users)
        {
            user.Roles = await UserManager.GetRolesAsync(user);
        }
    }

    private async Task AddUserToRole()
    {
        var user = await UserManager.FindByIdAsync(userId);
        if (user != null)
        {
            var result = await UserManager.AddToRoleAsync(user, roleName);
            if (result.Succeeded)
            {
                // Sync custom role table and assignment
                await SyncCustomRoleAssignmentAsync(user, roleName, add: true);
                message = "User added to role successfully!";
                await LoadUsers(); // Refresh the user list
            }
            else
            {
                message = "Error adding user to role: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
        else
        {
            message = "User not found.";
        }
    }

    private async Task RemoveUserFromRole(ApplicationUser user, string role)
    {
        var result = await UserManager.RemoveFromRoleAsync(user, role);
        if (result.Succeeded)
        {
            await SyncCustomRoleAssignmentAsync(user, role, add: false);
            message = "User removed from role successfully!";
            await LoadUsers(); // Refresh the user list
        }
        else
        {
            message = "Error removing user from role: " + string.Join(", ", result.Errors.Select(e => e.Description));
        }
    }

    private Task OpenAddRoleDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Large };

        return DialogService.ShowAsync<AddRolesDialog>("Simple Dialog", options);
    }

    private void EditRole(IdentityRole<Guid> role)
    {
        // Logic to edit role
        Snackbar.Add("EditRole", Severity.Success);
    }

    private void DeleteRole(IdentityRole<Guid> role)
    {
        roles.Remove(role);
    }

    private void OpenAddRoleToUserDialog(ApplicationUser user)
    {
        selectedUser = user;
        isAddRoleDialogVisible = true;
    }

    private async Task AddRoleToUser()
    {
        if (selectedUser != null && !string.IsNullOrEmpty(selectedRoleName))
        {
            var result = await UserManager.AddToRoleAsync(selectedUser, selectedRoleName);
            if (result.Succeeded)
            {
                await SyncCustomRoleAssignmentAsync(selectedUser, selectedRoleName, add: true);
                message = "Role added to user successfully!";
                await LoadUsers(); // Refresh the user list
                isAddRoleDialogVisible = false;
            }
            else
            {
                message = "Error adding role to user: " + string.Join(", ", result.Errors.Select(e => e.Description));
            }
        }
    }

    private void OpenRemoveRoleFromUserDialog(ApplicationUser user)
    {
        // Logic to open Remove Role from User dialog
        Snackbar.Add($"OpenRemoveRoleFromUserDialog for {user.UserName}", Severity.Success);
    }

    private async Task SyncCustomRoleAssignmentAsync(ApplicationUser user, string roleName, bool add) {
        try {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Find or create custom role in Roles2
            var customRole = await db.Roles2.FirstOrDefaultAsync(r => r.Name == roleName);
            if (customRole == null && add) {
                customRole = new CRS.Models.Security.Role { Name = roleName, Scope = CRS.Models.Security.RoleScope.Platform };
                db.Roles2.Add(customRole);
                await db.SaveChangesAsync();
            }
            if (customRole == null) return;

            // Ensure user exists/attached in this context
            var existingUser = await db.Users.FirstOrDefaultAsync(u => u.Id == user.Id);
            if (existingUser == null) {
                db.Users.Attach(new ApplicationUser { Id = user.Id, UserName = user.UserName, Email = user.Email, TenantId = user.TenantId });
            }

            if (add) {
                bool exists = await db.UserRoleAssignments.AnyAsync(a => a.UserId == user.Id && a.RoleId == customRole.Id && a.TenantId == (user.TenantId == 0 ? null : user.TenantId));
                if (!exists) {
                    db.UserRoleAssignments.Add(new CRS.Models.Security.UserRoleAssignment { UserId = user.Id, RoleId = customRole.Id, TenantId = user.TenantId == 0 ? null : user.TenantId });
                    await db.SaveChangesAsync();
                }
            } else {
                var assignments = await db.UserRoleAssignments.Where(a => a.UserId == user.Id && a.RoleId == customRole.Id).ToListAsync();
                if (assignments.Any()) {
                    db.UserRoleAssignments.RemoveRange(assignments);
                    await db.SaveChangesAsync();
                }
            }
        } catch (Exception ex) {
            Snackbar.Add($"Sync failed: {ex.Message}", Severity.Error);
        }
    }
}
