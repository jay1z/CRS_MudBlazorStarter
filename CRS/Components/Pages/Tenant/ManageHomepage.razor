@page "/Tenant/Homepage"
@using CRS.Models
@using CRS.Services
@using CRS.Services.Tenant
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components
@using MudBlazor
@inject TenantHomepageService HomepageService
@inject ITenantContext TenantContext
@inject ISnackbar Snackbar

<AuthorizeView Roles="Admin">
    <Authorized>
        <MudContainer Class="mt-6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h5">Manage Homepage</MudText>
                <MudText Typo="Typo.subtitle2">Edit draft and publish when ready.</MudText>

                <MudTextField Label="Meta Title" @bind-Value="model.MetaTitle" />
                <MudTextField Label="Meta Description" @bind-Value="model.MetaDescription" />

                <MudTextField T="string"
                              Label="Draft HTML"
                              @bind-Value="model.DraftHtml"
                              Variant="Variant.Outlined"
                              Lines="15"
                              Placeholder="Enter your homepage HTML content here"
                              Class="mt-4" />

                <MudStack Row="true" Class="mt-3" Spacing="2">
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveDraft">Save Draft</MudButton>
                    <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="Publish">Publish</MudButton>
                </MudStack>
            </MudPaper>
        </MudContainer>
    </Authorized>
    <NotAuthorized>
        <MudContainer Class="mt-6">
            <MudPaper Class="pa-4">
                <MudText Typo="Typo.h6">Access denied</MudText>
                <MudText>You must be an admin to manage the homepage.</MudText>
            </MudPaper>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

@code {
    private TenantHomepage model = new();

    protected override async Task OnInitializedAsync() {
        await LoadAsync();
    }

    private async Task LoadAsync() {
        try {
            var existing = await HomepageService.GetForCurrentTenantAsync();
            if (existing != null) model = existing;
        } catch (Exception ex) {
            Snackbar.Add($"Error loading homepage: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveDraft() {
        try {
            // Pass RowVersion as originalRowVersion and provide modifiedBy
            var saved = await HomepageService.SaveDraftAsync(model, model.RowVersion, "admin");
            model = saved;
            Snackbar.Add("Draft saved", Severity.Success);
        } catch (Exception ex) {
            Snackbar.Add($"Error saving draft: {ex.Message}", Severity.Error);
        }
    }

    private async Task Publish() {
        try {
            var published = await HomepageService.PublishAsync(model.RowVersion);
            if (published != null) {
                model = published;
                Snackbar.Add("Published", Severity.Success);
            } else {
                Snackbar.Add("Nothing to publish", Severity.Warning);
            }
        } catch (Exception ex) {
            Snackbar.Add($"Error publishing homepage: {ex.Message}", Severity.Error);
        }
    }
}
