@attribute [AllowAnonymous]
@layout EmptyLayout
@page "/Account/Login"
@page "/login"
@implements IDisposable

@using System.ComponentModel.DataAnnotations
@using System.ComponentModel
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Identity
@using CRS.Data
@using CRS.Services.Tenant
@using CRS.Services.License
@using CRS.Services.MultiTenancy
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<Login> Logger
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ITenantContext TenantContext
@inject ILicenseValidationService LicenseValidator
@inject CRS.Services.MultiTenancy.TenantService TenantService
@inject IConfiguration Config
@inject CRS.Services.Storage.ILogoStorageService LogoStorage
@inject CRS.Services.Layout.ILayoutService LayoutService

<PageTitle>Log in</PageTitle>

@if (TenantContext.IsPlatformHost && string.IsNullOrWhiteSpace(TenantContext.Subdomain)) {
    <!-- Platform host without subdomain - show message -->
    <div Class="d-flex flex-column justify-center align-center pa-6" Style="height: 100vh; width: 100vw;">
        <MudPaper Class="pa-8" Elevation="4" Style="max-width: 600px; text-align: center;">
            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" Style="font-size: 64px;" Class="mb-4" />
            <MudText Typo="Typo.h4" Class="fw-bold mb-4">Welcome to ALX Reserve Cloud</MudText>
            <MudText Typo="Typo.body1" Class="mb-4" Style="color: #666;">
                To log in, please visit your organization's dedicated login page at:
            </MudText>
            <MudPaper Class="pa-3 mb-4" Elevation="0" Style="background: #f5f5f5; border-radius: 8px;">
                <MudText Typo="Typo.body2" Style="font-family: monospace; color: #FF8C00;">
                    <strong>yourcompany</strong>.alxreservecloud.com
                </MudText>
            </MudPaper>
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.body2" Class="mb-4" Style="color: #666;">
                Don't have an account yet?
            </MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Large" Href="/tenant/signup" StartIcon="@Icons.Material.Filled.RocketLaunch">
                Start Free Trial
            </MudButton>
            <MudText Typo="Typo.caption" Class="mt-4" Style="color: #999;">
                <MudLink Href="/" Style="color: #FF8C00;">← Back to home</MudLink>
            </MudText>
        </MudPaper>
    </div>
} else {
    <!-- Tenant-specific login form -->
    @* <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="d-flex justify-center align-center" Style="min-height:100vh;">
        <MudPaper Class="w-100 pa-6 d-flex flex-column flex-md-row rounded-lg" Elevation="3"> *@

    @* Left: Login form *@
    <div class="d-flex flex-column flex-md-row" style="height: 80vh; width: 100vw;">
        <div class="d-flex flex-column justify-center align-center pa-6" style="width: 100%; max-width: 600px;">
            <MudGrid>
                <MudItem md="12">
                    @if (!string.IsNullOrWhiteSpace(tenantLogoUrl)) {
                        <MudImage Src="@tenantLogoUrl" Alt="@logoAltText" Class="mx-auto mb-4" Style="object-fit: contain;" />
                    } else {
                        <MudImage Src="images/logo.png" Alt="Logo" Width="240" Height="240" Class="mx-auto mb-4" />
                    }
                </MudItem>
                <MudItem md="12">
                    <StatusMessage Message="@errorMessage" />
                    <EditForm Model="Input" method="post" OnValidSubmit="LoginUser" FormName="login">
                        <DataAnnotationsValidator />
                        <MudText GutterBottom="true" Typo="Typo.body1">Use a local account to log in.</MudText>
                        <MudGrid>
                            <MudItem md="12">
                                <MudStaticTextField For="@(() => Input.Email)" @bind-Value="Input.Email" Label="Email" Placeholder="name@example.com" UserAttributes="@(new() { { "autocomplete", "username" }, { "aria-required", "true" } })" />
                            </MudItem>
                            <MudItem md="12">
                                <MudStaticTextField For="@(() => Input.Password)" @bind-Value="Input.Password" Label="Password" InputType="InputType.Password" Placeholder="password" UserAttributes="@(new() { { "autocomplete", "current-password" }, { "aria-required", "true" } })" />
                            </MudItem>
                            @* 
                                @if (!IsTenantFixed) {
                                    <MudItem md="12">
                                        <MudStaticTextField For="@(() => Input.TenantSlug)" @bind-Value="Input.TenantSlug" Label="Tenant" Placeholder="tenant subdomain (e.g. hoa1)" UserAttributes="@(new() { { "aria-required", "true" } })" />
                                    </MudItem>
                                } else {
                                    <MudItem md="12"><MudText Typo="Typo.body2">Tenant: <strong>@FixedTenantSlug</strong></MudText></MudItem>
                                }
                            *@
                            <MudItem md="12">
                                <MudStaticCheckBox For="@(() => Input.RememberMe)" @bind-Value="Input.RememberMe">Remember me</MudStaticCheckBox>
                            </MudItem>
                            <MudItem md="12">
                                <MudStaticButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" FormAction="FormAction.Submit">Log in</MudStaticButton>
                            </MudItem>
                        </MudGrid>
                    </EditForm>
                    <MudGrid Class="mt-4">
                        <MudItem md="12">
                            <MudLink Href="Account/ForgotPassword">Forgot your password?</MudLink><br />
                            <MudLink Href="Account/ResendEmailConfirmation">Resend email confirmation</MudLink>
                        </MudItem>
                    </MudGrid>

                    <!-- Link to platform signup for wrong tenant -->
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.body2" Class="text-center" Style="color: #666;">
                        Looking to start your own account?
                    </MudText>
                    <MudText Typo="Typo.body2" Class="text-center mt-2">
                        <MudLink Href="@GetPlatformSignupUrl()" Style="color: #FF8C00;">
                            <MudIcon Icon="@Icons.Material.Filled.RocketLaunch" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            Start a Free Trial
                        </MudLink>
                    </MudText>
                </MudItem>
                @* <MudItem md="6">
                        <MudText GutterBottom="true" Typo="Typo.body1">Use another service to log in.</MudText>
                        <ExternalLoginPicker />
                    </MudItem> *@
            </MudGrid>
        </div>

        @* Right: Image - fills full height *@
        <div Class="d-none d-md-flex flex-grow-1" Style="overflow: hidden; padding: 0; margin: 0;">
            <MudImage Src="images/login_2.png" ObjectFit="ObjectFit.Cover" Alt="Login" Style="width: 100%; height: 100%; display: block;" />
        </div>
    </div>

    @* </MudPaper>
    </MudContainer> *@

}
@code {
    private string? errorMessage;
    private string? tenantLogoUrl;
    private string logoAltText = "Logo";

    [CascadingParameter] private HttpContext HttpContext { get; set; } = default!;
    [SupplyParameterFromForm] private InputModel Input { get; set; } = new();
    [SupplyParameterFromQuery] private string? ReturnUrl { get; set; }

    private bool IsTenantFixed => !string.IsNullOrWhiteSpace(TenantContext.Subdomain);
    private string? FixedTenantSlug => TenantContext.Subdomain;

    protected override async Task OnInitializedAsync() {
        // If user is already authenticated, redirect to dashboard
        if (HttpContext.User?.Identity?.IsAuthenticated == true) {
            RedirectManager.RedirectTo("/Dashboard");
            return;
        }

        // Hide app bar if on subdomain (tenant-specific login)
        if (!string.IsNullOrWhiteSpace(TenantContext.Subdomain)) {
            LayoutService.SetHideNav(true);
        }

        if (HttpMethods.IsGet(HttpContext.Request.Method)) {
            await HttpContext.SignOutAsync(IdentityConstants.ExternalScheme);
        }
        if (IsTenantFixed) {
            Input.TenantSlug = FixedTenantSlug;
            await LoadTenantLogoAsync();
        }

        // Load test credentials from user secrets (Development only)
        #if DEBUG
        var testPassword = Config["TestCredentials:Password"];
        if (!string.IsNullOrEmpty(testPassword)) {
            Input.Password = testPassword;
        }
        var testEmail = Config["TestCredentials:Email"];
        if (!string.IsNullOrEmpty(testEmail)) {
            Input.Email = testEmail;
        }
        #endif
    }

    private async Task LoadTenantLogoAsync() {
        if (TenantContext.TenantId.HasValue) {
            try {
                tenantLogoUrl = await LogoStorage.GetLogoUrlAsync(TenantContext.TenantId.Value);
                logoAltText = $"{TenantContext.TenantName ?? "Company"} Logo";
            } catch (Exception ex) {
                Logger.LogWarning(ex, "Error loading tenant logo for tenant {TenantId}", TenantContext.TenantId);
            }
        }
    }

    public async Task LoginUser() {
        errorMessage = null;
        if (!IsTenantFixed && string.IsNullOrWhiteSpace(Input.TenantSlug)) { errorMessage = "Tenant is required."; return; }
        var tenantSlug = IsTenantFixed ? FixedTenantSlug : Input.TenantSlug?.Trim().ToLowerInvariant();

        CRS.Models.Tenant? tenant = null;
        if (!string.IsNullOrWhiteSpace(tenantSlug)) {
            try { tenant = await TenantService.FindBySubdomainAsync(tenantSlug); } catch { }
        }

        var result = await SignInManager.PasswordSignInAsync(Input.Email, Input.Password, Input.RememberMe, lockoutOnFailure: false);
        if (!result.Succeeded) {
            if (result.RequiresTwoFactor) { RedirectManager.RedirectTo("Account/LoginWith2fa", new() { ["returnUrl"] = ReturnUrl, ["rememberMe"] = Input.RememberMe }); return; }
            if (result.IsLockedOut) { RedirectManager.RedirectTo("Account/Lockout"); return; }
            errorMessage = "Error: Invalid login attempt."; return;
        }

        // Check if user exists and get their tenant
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user == null) {
            await SignInManager.SignOutAsync();
            errorMessage = "Error: Invalid login attempt.";
            return;
        }

        // TENANT MISMATCH WARNING: Check if user is trying to log in to wrong tenant
        if (tenant != null && user.TenantId != tenant.Id) {
            await SignInManager.SignOutAsync();

            // Get the user's correct tenant information
            try {
                var userTenant = await TenantService.FindByIdAsync(user.TenantId);
                if (userTenant != null) {
                    errorMessage = $"Wrong tenant! This account belongs to '{userTenant.Name}'. Please visit: {userTenant.Subdomain}.{Config["App:RootDomain"] ?? DeriveRootDomain()}";
                } else {
                    errorMessage = "Error: This account belongs to a different tenant.";
                }
            } catch {
                errorMessage = "Error: This account belongs to a different tenant.";
            }
            StateHasChanged();
            return;
        }

        // Check tenant is active
        if (tenant != null) {
            var active = await LicenseValidator.IsTenantActiveAsync(tenant.Id);
            if (!active) {
                await SignInManager.SignOutAsync();
                errorMessage = "Error: This tenant is inactive.";
                return;
            }
        }

        // Tenant-aware redirect logic simplified: always land on Dashboard for tenant sites
        if (tenant != null) {
            if (TenantContext.IsPlatformHost) {
                var rootDomain = Config["App:RootDomain"]?.Trim('.') ?? DeriveRootDomain();
                var target = $"https://{tenant.Subdomain}.{rootDomain}/Dashboard";
                NavigationManager.NavigateTo(target, forceLoad: true);
                return;
            } else {
                RedirectManager.RedirectTo("/Dashboard");
                return;
            }
        }

        RedirectManager.RedirectTo(CoerceTenantReturnUrl(ReturnUrl) ?? "/Dashboard");
    }

    private string CoerceTenantReturnUrl(string? returnUrl) {
        if (string.IsNullOrWhiteSpace(returnUrl)) return "/";
        var lowered = returnUrl.ToLowerInvariant();
        if (lowered.StartsWith("/account/login")) return "/";
        if (!Uri.IsWellFormedUriString(returnUrl, UriKind.Relative)) {
            var relative = NavigationManager.ToBaseRelativePath(returnUrl);
            if (string.IsNullOrEmpty(relative)) return "/";
            return relative.StartsWith('/') ? relative : "/" + relative;
        }
        return returnUrl;
    }

    private string DeriveRootDomain() {
        try {
            var host = new Uri(NavigationManager.BaseUri).Host;
            if (host.Equals("localhost", StringComparison.OrdinalIgnoreCase)) return host; // dev
            var parts = host.Split('.');
            if (parts.Length <= 2) return host;
            // take last two labels
            return string.Join('.', parts.Skip(parts.Length - 2));
        } catch { return "localhost"; }
    }

    private string GetPlatformSignupUrl() {
        try {
            var rootDomain = Config["App:RootDomain"];
            if (string.IsNullOrWhiteSpace(rootDomain)) {
                // Derive from current URL
                rootDomain = DeriveRootDomain();
            }

            var baseUri = new Uri(NavigationManager.BaseUri);
            var scheme = baseUri.Scheme;

            // Build platform URL (www.domain.com or just domain.com for localhost)
            if (rootDomain.Contains("localhost", StringComparison.OrdinalIgnoreCase)) {
                return $"{scheme}://{rootDomain}/tenant/signup";
            }
            return $"{scheme}://www.{rootDomain.TrimStart('.')}/tenant/signup";
        } catch {
            return "/tenant/signup";
        }
    }

    private sealed class InputModel {
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, DataType(DataType.Password)] public string Password { get; set; } = "";
        public bool RememberMe { get; set; }
        public string? TenantSlug { get; set; }
    }

    public void Dispose() {
        // Restore nav when leaving login page
        LayoutService.SetHideNav(false);
    }
}
