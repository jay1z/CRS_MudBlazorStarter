@inject Horizon.Services.Tenant.ITenantContext TenantContext
@inject Horizon.Services.Tenant.ITenantHomepageDataService DataService
@inject ILogger<W3TenantKpisSummary> Logger

<MudCard Class="mb-4" Elevation="2">
    <MudCardContent>
        <MudText Typo="Typo.h6">Tenant KPIs</MudText>
        @if (_loading)
        {
            <MudProgressLinear Indeterminate Color="Color.Primary" Class="my-2" />
        }
        else if (_kpis == null)
        {
            <MudText Typo="Typo.caption">No KPI data available.</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Refresh">Refresh</MudButton>
        }
        else
        {
            <MudGrid Class="mt-2">
                <MudItem xs="6" md="3"><MudText Typo="Typo.subtitle2">Properties</MudText><MudText>@_kpis.Properties</MudText></MudItem>
                <MudItem xs="6" md="3"><MudText Typo="Typo.subtitle2">Studies Active</MudText><MudText>@_kpis.StudiesActive</MudText></MudItem>
                <MudItem xs="6" md="3"><MudText Typo="Typo.subtitle2">Reports Recent</MudText><MudText>@_kpis.ReportsRecent</MudText></MudItem>
                <MudItem xs="6" md="3"><MudText Typo="Typo.subtitle2">Customer Accounts</MudText><MudText>@_kpis.CustomerAccounts</MudText></MudItem>
            </MudGrid>
        }
    </MudCardContent>
</MudCard>

@code {
    private Horizon.Components.AppHome.ViewModels.TenantKpisVm? _kpis;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (TenantContext.TenantId.HasValue)
            {
                _kpis = await DataService.GetKpisAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to load tenant KPIs for tenant {TenantId}", TenantContext.TenantId);
        }
        _loading = false;
    }

    private async Task Refresh()
    {
        _loading = true;
        _kpis = null;
        try { if (TenantContext.TenantId.HasValue) _kpis = await DataService.GetKpisAsync(); }
        catch (Exception ex) { Logger.LogWarning(ex, "Refresh KPIs failed for tenant {TenantId}", TenantContext.TenantId); }
        _loading = false;
    }
}