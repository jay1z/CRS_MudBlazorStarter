@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<Horizon.Data.ApplicationDbContext> DbFactory
@inject Horizon.Services.Tenant.ITenantContext TenantContext

<MudPaper Class="pa-4 mb-4" Elevation="1">
    <MudText Typo="Typo.h6">Reports Access</MudText>
    @if (_loading)
    {
        <MudProgressCircular Indeterminate Size="Size.Small" Class="my-2" />
    }
    else if (!_reports.Any())
    {
        <MudText Typo="Typo.caption">No final reports.</MudText>
    }
    else
    {
        <MudTable Items="_reports" Dense="true" Hover="true" Elevation="0">
            <HeaderContent>
                <MudTh>Property</MudTh>
                <MudTh>Completed</MudTh>
                <MudTh>Status</MudTh>
                <MudTh align="right">Actions</MudTh>
            </HeaderContent>
            <RowTemplate Context="r">
                <MudTd>@r.Property</MudTd>
                <MudTd>@r.Completed?.ToString("MM/dd/yyyy")</MudTd>
                <MudTd>@r.Status</MudTd>
                <MudTd align="right">
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled>Download</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudPaper>

@code {
    private bool _loading = true;
    private List<ReportRow> _reports = new();

    protected override async Task OnInitializedAsync()
    {
        if (!TenantContext.TenantId.HasValue) { _loading = false; return; }
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var finalStudies = await db.ReserveStudies
                .AsNoTracking()
                .Include(s => s.Community)
                .Where(s => s.IsComplete)
                .OrderByDescending(s => s.DateModified)
                .Take(50)
                .ToListAsync();
            _reports = finalStudies.Select(s => new ReportRow {
                Property = s.Community?.Name ?? s.Id.ToString(),
                Completed = s.DateModified ?? s.DateCreated,
                Status = s.CurrentStatus.ToString()
            }).ToList();
        }
        catch { }
        _loading = false;
    }

    private sealed class ReportRow
    {
        public string Property { get; set; } = string.Empty;
        public DateTime? Completed { get; set; }
        public string Status { get; set; } = string.Empty;
    }
}