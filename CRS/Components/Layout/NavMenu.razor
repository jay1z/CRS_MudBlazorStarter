@using CRS.Data
@using CRS.Services
@using CRS.Services.Tenant
@using Microsoft.AspNetCore.Identity

@inject UserStateService UserState
@inject ITenantContext TenantContext
@inject NavigationManager NavigationManager

<MudNavMenu>
    <!-- Tenant links: require tenant viewer/staff/owner policies as appropriate -->
    <AuthorizeView Policy="RequireTenantViewer">
        <Authorized>
            <MudNavLink Href="/Dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/messages/inbox" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Email">Messages</MudNavLink>
            <MudNavLink Href="/ReserveStudies" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Assignment">Reserve Studies</MudNavLink>
            <MudNavLink Href="/Communities" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Business">Communities</MudNavLink>
            <MudNavLink Href="/Documents" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Folder">Documents</MudNavLink>
            <MudNavLink Href="/Compliance" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.FactCheck">Compliance</MudNavLink>
            <MudNavLink Href="/support/tickets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SupportAgent">Support</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Policy="RequireTenantOwner">
        <Authorized>
            <MudNavGroup Title="Tenant Admin" Expanded="true">
                <MudNavLink Href="/Admin/Users" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.PeopleAlt">Team Members</MudNavLink>
                <MudNavLink Href="/Admin/HOAUsers" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Business">HOA Users</MudNavLink>
                <MudNavLink Href="/Admin/Settings" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Settings">Tenant Settings</MudNavLink>
                <MudNavLink Href="/Admin/Elements" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Category">Element Management</MudNavLink>
                <MudNavLink Href="/Reports/Publish" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Publish">Publish Reports</MudNavLink>
                <MudNavLink Href="/account/billing" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CreditCard">Billing</MudNavLink>
                <MudNavLink Href="/Customers" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Group">Customers</MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Policy="RequireTenantStaff">
        <Authorized>
            <MudNavGroup Title="Specialist Tools" Expanded="false">
                <MudNavLink Href="/ReserveStudies/Specialist" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.AssignmentTurnedIn">My Work</MudNavLink>
                <MudNavLink Href="/Admin/HOAUsers" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.PersonAdd">Manage HOA Users</MudNavLink>
                <MudNavLink Href="/Calendar" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CalendarMonth">Calendar</MudNavLink>
                <MudNavLink Href="/Contacts" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Contacts">Contacts</MudNavLink>
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <!-- External auditor visibility for Compliance -->
    <AuthorizeView Roles="HOAAuditor">
        <Authorized>
            <MudNavLink Href="/Compliance" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.FactCheck">Compliance</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Policy="RequireTenantViewer">
        <Authorized>
            <MudNavLink Href="/Reports/View" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Visibility">View Reports</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <AuthorizeView Policy="RequireHOAUser">
        <Authorized>
            <MudNavLink Href="/Dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/ReserveStudies/Request" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.RequestQuote">Request Reserve Study</MudNavLink>
            <MudNavLink Href="/Documents" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Folder">Documents</MudNavLink>
            <MudNavLink Href="/Reports/Download" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Download">Download Final Report</MudNavLink>
            <MudNavLink Href="/support/tickets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.SupportAgent">Support</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Platform admin links -->
    <AuthorizeView Policy="RequirePlatformAdmin">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.h6" Class="px-4">Platform Administration</MudText>
            <MudDivider Class="my-2" />

            <MudNavGroup Title="Platform" Expanded="true">
                <MudNavLink Href="/Admin/Tenants" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Apartment">Tenants</MudNavLink>
                <MudNavLink Href="/Admin/Users" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.PeopleAlt">Users & Roles</MudNavLink>
                <MudNavLink Href="/Admin/SuperAdmins" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.VerifiedUser">SuperAdmins</MudNavLink>
                <MudNavLink Href="/Admin/SystemSettings" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.AdminPanelSettings">System Settings</MudNavLink>
                <MudNavLink Href="/Admin/Billing" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CreditCard">Billing</MudNavLink>
                <MudNavLink Href="/Customers" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Group">Customers</MudNavLink>
            </MudNavGroup>

            <MudDivider />
            <MudNavGroup Title="Platform Tools" Expanded="false">
                <MudNavLink Href="/Admin/VisualEditor" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Brush">Visual Editor</MudNavLink>
                <MudNavLink Href="/Admin/GrapesEditor" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Draw">GrapesJS Prototype</MudNavLink>
                <MudNavLink Href="/dbmanager" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Storage">Database Manager</MudNavLink>
                <MudNavLink Href="/Admin/Audit" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.History">Audit Logs</MudNavLink>
            </MudNavGroup>

            <MudDivider />
            <MudNavGroup Title="Support" Expanded="false">
                <MudNavLink Href="/admin/tickets" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Support">All Support Tickets</MudNavLink>
            </MudNavGroup>

            <MudDivider />
            <MudNavGroup Title="Tenant Actions" Expanded="false">
                <MudNavLink Href="/Admin/Impersonate" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.PersonSearch">Impersonate Tenant</MudNavLink>
                @if (TenantContext?.TenantId != null)
                {
                    <MudNavLink Href="/Admin/StopImpersonation" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.HighlightOff" IconColor="Color.Error">Stop Impersonation</MudNavLink>
                }
            </MudNavGroup>
        </Authorized>
    </AuthorizeView>

    <!-- Platform support menu (read-only) -->
    <AuthorizeView Roles="PlatformSupport">
        <Authorized>
            <MudDivider Class="my-2" />
            <MudText Typo="Typo.h6" Class="px-4">Platform Support</MudText>
            <MudDivider Class="my-2" />
            <MudNavLink Href="/Dashboard" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
            <MudNavLink Href="/Communities" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Business">Communities</MudNavLink>
            <MudNavLink Href="/ReserveStudies" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Assignment">Reserve Studies</MudNavLink>
            <MudNavLink Href="/admin/tickets" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Support">Support Tickets</MudNavLink>
            <MudNavLink Href="/Admin/Billing" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.CreditCard">Billing (read-only)</MudNavLink>
        </Authorized>
    </AuthorizeView>

    <!-- Auditor reports access -->
    <AuthorizeView Roles="HOAAuditor">
        <Authorized>
            <MudNavLink Href="/Reports/View" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Visibility">View Reports</MudNavLink>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>
