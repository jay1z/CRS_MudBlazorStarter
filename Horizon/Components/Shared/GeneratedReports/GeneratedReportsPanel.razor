@using Horizon.Models
@using Horizon.Models.Workflow
@using Horizon.Services.Interfaces
@using Horizon.Services
@using Horizon.Services.Storage

@inject IGeneratedReportService ReportService
@inject IReportGenerationService GenerationService
@inject IReportZipService ZipService
@inject IDocumentStorageService DocumentStorage
@inject INarrativeStateService NarrativeStateService
@inject INarrativeService NarrativeService
@inject UserStateService UserState
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IServiceProvider Services

<MudPaper Elevation="0" Class="pa-4">
    <MudStack Spacing="3">
        <!-- Header -->
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2" Style="vertical-align: middle;" />
                Generated Reports
            </MudText>
            <AuthorizeView Policy="RequireTenantStaff">
                <Authorized>
                    <MudStack Row="true" Spacing="2">
                        @if (hasNarrative)
                        {
                            <MudButton Variant="Variant.Outlined"
                                       Color="Color.Default"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Preview"
                                       OnClick="OpenPreviewDialog">
                                Preview Narrative
                            </MudButton>
                        }
                        else
                        {
                            <MudTooltip Text="No narrative has been created yet. Go to the Narrative tab to create one.">
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Preview"
                                           Disabled="true">
                                    Preview Narrative
                                </MudButton>
                            </MudTooltip>
                        }
                        @if (canGenerateReports)
                        {
                                                <MudButton Variant="Variant.Filled" 
                                                           Color="Color.Primary" 
                                                           Size="Size.Small"
                                                           StartIcon="@Icons.Material.Filled.Add"
                                                           OnClick="OpenGenerateDialog"
                                                           Disabled="@isGenerating">
                                                    @if (isGenerating)
                                                    {
                                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                        <span>Generating...</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Generate Report</span>
                                                    }
                                                </MudButton>
                                            }
                                            else
                                            {
                                                <MudTooltip Text="@workflowGateMessage">
                                                    <MudButton Variant="Variant.Filled" 
                                                               Color="Color.Default" 
                                                               Size="Size.Small"
                                                               StartIcon="@Icons.Material.Filled.Lock"
                                                               Disabled="true">
                                                        Generate Report
                                                    </MudButton>
                                                </MudTooltip>
                                            }
                                        </MudStack>
                                    </Authorized>
                                </AuthorizeView>
                            </MudStack>

        <!-- Unsaved Narrative Warning -->
        @if (NarrativeStateService.HasUnsavedChangesForStudy(ReserveStudyId))
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true" Class="mb-2">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                    <MudText Typo="Typo.body2">
                        <strong>Unsaved narrative changes.</strong> Please save your narrative before generating reports to ensure the latest content is included.
                    </MudText>
                </MudStack>
            </MudAlert>
        }

        <!-- Workflow Gate Warning -->
        @if (!canGenerateReports && !isLoading && validationResult != null)
        {
            <MudAlert Severity="@(validationResult.Errors.Any() ? Severity.Error : Severity.Warning)" 
                      Variant="Variant.Outlined" 
                      Dense="false">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@(validationResult.Errors.Any() ? Icons.Material.Filled.Error : Icons.Material.Filled.Warning)" />
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 600;">
                            @workflowGateMessage
                        </MudText>
                    </MudStack>

                    @if (validationResult.Errors.Any())
                    {
                        <MudText Typo="Typo.body2" Style="color: #d32f2f;">
                            <strong>Blocking Issues:</strong>
                        </MudText>
                        <ul style="margin: 0; padding-left: 20px;">
                            @foreach (var error in validationResult.Errors)
                            {
                                <li><MudText Typo="Typo.body2">@error</MudText></li>
                            }
                        </ul>
                    }

                    @if (validationResult.MissingFinancialData.Any())
                    {
                        <MudStack Spacing="1">
                            <MudButton Variant="Variant.Text" 
                                       Size="Size.Small" 
                                       Color="Color.Default"
                                       StartIcon="@(showFinancialData ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                       OnClick="@(() => showFinancialData = !showFinancialData)"
                                       Style="justify-content: flex-start; text-transform: none;">
                                <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small" Class="mr-1" />
                                Missing Financial Data (@validationResult.MissingFinancialData.Count)
                            </MudButton>
                            <MudCollapse Expanded="@showFinancialData">
                                <ul style="margin: 0; padding-left: 40px;">
                                    @foreach (var item in validationResult.MissingFinancialData)
                                    {
                                        <li><MudText Typo="Typo.caption">@item</MudText></li>
                                    }
                                </ul>
                            </MudCollapse>
                        </MudStack>
                    }

                    @if (validationResult.MissingElementData.Any())
                    {
                        <MudStack Spacing="1">
                            <MudButton Variant="Variant.Text" 
                                       Size="Size.Small" 
                                       Color="Color.Default"
                                       StartIcon="@(showElementData ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                       OnClick="@(() => showElementData = !showElementData)"
                                       Style="justify-content: flex-start; text-transform: none;">
                                <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Small" Class="mr-1" />
                                Missing Element Data (@validationResult.MissingElementData.Count of @validationResult.TotalElementCount elements)
                            </MudButton>
                            <MudCollapse Expanded="@showElementData">
                                <MudStack Spacing="2" Class="pl-10">
                                    @{
                                        var elementGroups = GetElementDataGroups();
                                    }
                                    <!-- Summary by issue type (primary grouping) -->
                                    <MudStack Row="true" Spacing="2" Style="flex-wrap: wrap;">
                                        @foreach (var group in elementGroups.IssueGroups)
                                        {
                                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Warning">
                                                @group.Key: @group.Value
                                            </MudChip>
                                        }
                                    </MudStack>
                                    
                                    <!-- Summary by element type (secondary info) -->
                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                        Affects: @string.Join(", ", elementGroups.TypeGroups.Select(g => $"{g.Value} {g.Key}"))
                                    </MudText>
                                    
                                    <!-- Preview items -->
                                    @if (showAllElementData)
                                    {
                                        <ul style="margin: 0; padding-left: 20px; max-height: 200px; overflow-y: auto;">
                                            @foreach (var item in validationResult.MissingElementData)
                                            {
                                                <li><MudText Typo="Typo.caption">@item</MudText></li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <ul style="margin: 0; padding-left: 20px;">
                                            @foreach (var item in validationResult.MissingElementData.Take(5))
                                            {
                                                <li><MudText Typo="Typo.caption">@item</MudText></li>
                                            }
                                        </ul>
                                        @if (validationResult.MissingElementData.Count > 5)
                                        {
                                            <MudLink Typo="Typo.caption" 
                                                     Color="Color.Primary" 
                                                     OnClick="@(() => showAllElementData = true)"
                                                     Style="cursor: pointer;">
                                                ...and @(validationResult.MissingElementData.Count - 5) more
                                            </MudLink>
                                        }
                                    }
                                </MudStack>
                            </MudCollapse>
                        </MudStack>
                    }
                    else if (validationResult.TotalElementCount == 0)
                    {
                        <!-- No elements at all - show as a distinct warning -->
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="pl-2">
                            <MudIcon Icon="@Icons.Material.Filled.Apartment" Size="Size.Small" Color="Color.Error" />
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Filled" Color="Color.Error">
                                No Elements: 0
                            </MudChip>
                            <MudText Typo="Typo.caption" Style="color: #666;">
                                Add building, common, or additional elements to proceed
                            </MudText>
                        </MudStack>
                    }

                    @if (validationResult.MissingServiceContacts.Any())
                    {
                        <MudStack Spacing="1">
                            <MudButton Variant="Variant.Text" 
                                       Size="Size.Small" 
                                       Color="Color.Default"
                                       StartIcon="@(showServiceContacts ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                       OnClick="@(() => showServiceContacts = !showServiceContacts)"
                                       Style="justify-content: flex-start; text-transform: none;">
                                <MudIcon Icon="@Icons.Material.Filled.ContactPhone" Size="Size.Small" Class="mr-1" />
                                Missing Service Contacts (@validationResult.MissingServiceContacts.Count)
                            </MudButton>
                            <MudCollapse Expanded="@showServiceContacts">
                                <ul style="margin: 0; padding-left: 40px;">
                                    @foreach (var item in validationResult.MissingServiceContacts)
                                    {
                                        <li><MudText Typo="Typo.caption">@item</MudText></li>
                                    }
                                </ul>
                            </MudCollapse>
                        </MudStack>
                    }
                </MudStack>
            </MudAlert>
        }
        else if (!canGenerateReports && !isLoading)
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" />
                    <MudText Typo="Typo.body2">
                        @workflowGateMessage
                    </MudText>
                </MudStack>
            </MudAlert>
        }

        <!-- Stats Row -->
        @if (reports.Any())
        {
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="flex-wrap: wrap;">
                <MudStack Row="true" Spacing="3" Style="flex-wrap: wrap;">
                    <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined">
                        @reports.Count Total
                    </MudChip>
                    <MudChip T="string" Color="Color.Success" Variant="Variant.Outlined">
                        @reports.Count(r => r.Status == ReportStatus.Published) Published
                    </MudChip>
                    @{
                        var pendingReviewCount = reports.Count(r => r.Status == ReportStatus.PendingReview);
                    }
                    @if (pendingReviewCount > 0)
                    {
                        <AuthorizeView Policy="RequireTenantOwner">
                            <Authorized>
                                <MudChip T="string" Color="Color.Info" Variant="Variant.Filled">
                                    <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Small" Class="mr-1" />
                                    @pendingReviewCount Pending Review
                                </MudChip>
                            </Authorized>
                        </AuthorizeView>
                    }
                    <MudChip T="string" Color="Color.Warning" Variant="Variant.Outlined">
                        @reports.Count(r => r.Status == ReportStatus.Draft) Drafts
                    </MudChip>
                    @{
                        // Only count reports needing revision that don't have a newer version
                        var revisionCount = reports.Count(r => r.Status == ReportStatus.RevisionRequired && !HasNewerReportVersion(r));
                    }
                    @if (revisionCount > 0)
                    {
                        <MudChip T="string" Color="Color.Error" Variant="Variant.Outlined">
                            @revisionCount Needs Revision
                        </MudChip>
                    }
                </MudStack>

                @if (reports.Count > 1)
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.FolderZip"
                               OnClick="DownloadAllAsZip"
                               Disabled="@isDownloadingZip">
                        @if (isDownloadingZip)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Creating ZIP...</span>
                        }
                        else
                        {
                            <span>Download All (ZIP)</span>
                        }
                    </MudButton>
                }
            </MudStack>
        }

        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else if (!reports.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                <MudStack AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@Icons.Material.Filled.FileCopy" Style="font-size: 48px; color: #999;" />
                    <MudText Typo="Typo.body1">No reports generated yet</MudText>
                    <MudText Typo="Typo.body2" Style="color: #666;">
                        @if (canGenerateReports)
                        {
                            <span>Click "Generate Report" to create your first funding plan report.</span>
                        }
                        else
                        {
                            <span>Reports can be generated once the study reaches the Funding Plan stage.</span>
                        }
                    </MudText>
                </MudStack>
            </MudAlert>
        }
        else
        {
            <!-- Reports List -->
            <MudStack Spacing="2">
                @foreach (var report in reports.OrderByDescending(r => r.GeneratedAt))
                {
                    <MudCard Elevation="1" Style="@GetReportStyle(report)">
                        <MudCardContent Class="pa-3">
                            <MudStack Spacing="2">
                                <!-- Header Row -->
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Start">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@GetReportIcon(report.Type)" Color="Color.Primary" />
                                        <MudStack Spacing="0">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                                @GetReportTypeDisplayName(report.Type)
                                            </MudText>
                                            <MudText Typo="Typo.caption" Style="color: #666;">
                                                Version @report.Version
                                            </MudText>
                                        </MudStack>
                                    </MudStack>
                                    
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        @{
                                            var isSuperseded = report.Status == ReportStatus.RevisionRequired && HasNewerReportVersion(report);
                                            var displayStatus = isSuperseded ? ReportStatus.Superseded : report.Status;
                                        }
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(displayStatus)" Variant="Variant.Filled">
                                            @GetStatusDisplayName(displayStatus)
                                        </MudChip>

                                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                                            <MudMenuItem Icon="@Icons.Material.Filled.Download"
                                                         OnClick="@(() => DownloadReport(report))">
                                                @(string.IsNullOrEmpty(report.ExcelStorageUrl) ? "Download" : "Download PDF")
                                            </MudMenuItem>
                                            @if (!string.IsNullOrEmpty(report.ExcelStorageUrl))
                                            {
                                                <MudMenuItem Icon="@Icons.Material.Filled.TableChart"
                                                             OnClick="@(() => DownloadExcel(report))">
                                                    Download Excel
                                                </MudMenuItem>
                                            }
                                            @if (!string.IsNullOrEmpty(report.StorageUrl))
                                            {
                                                <MudMenuItem Icon="@Icons.Material.Filled.OpenInNew"
                                                             OnClick="@(() => ViewReport(report))">
                                                    View
                                                </MudMenuItem>
                                            }
                                            <AuthorizeView Policy="RequireTenantStaff">
                                                <Authorized>
                                                    @if (report.Status == ReportStatus.Draft)
                                                    {
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Send"
                                                                     OnClick="@(() => SubmitForReview(report))">
                                                            Submit for Review
                                                        </MudMenuItem>
                                                    }
                                                    @if (report.Status == ReportStatus.Approved)
                                                    {
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Publish"
                                                                     OnClick="@(() => PublishReport(report))">
                                                            Publish
                                                        </MudMenuItem>
                                                    }
                                                    @if (report.Status == ReportStatus.Published)
                                                    {
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Email"
                                                                     OnClick="@(() => SendToClient(report))">
                                                            Send to Client
                                                        </MudMenuItem>
                                                    }
                                                    <MudDivider />
                                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                                                 OnClick="@(() => DeleteReport(report))"
                                                                 IconColor="Color.Error">
                                                        Delete
                                                    </MudMenuItem>
                                                </Authorized>
                                            </AuthorizeView>
                                            @* TenantOwner-only actions for report approval *@
                                            <AuthorizeView Policy="RequireTenantOwner">
                                                <Authorized>
                                                    @if (report.Status == ReportStatus.PendingReview)
                                                    {
                                                        <MudDivider />
                                                        <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle"
                                                                     OnClick="@(() => ApproveReport(report))"
                                                                     IconColor="Color.Success">
                                                            Approve Report
                                                        </MudMenuItem>
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                                                     OnClick="@(() => RequestRevisions(report))"
                                                                     IconColor="Color.Warning">
                                                            Request Revisions
                                                        </MudMenuItem>
                                                    }
                                                </Authorized>
                                            </AuthorizeView>
                                        </MudMenu>
                                    </MudStack>
                                </MudStack>

                                <!-- Details Row -->
                                <MudGrid Spacing="2">
                                    <MudItem xs="12" sm="4">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Generated</MudText>
                                        <MudText Typo="Typo.body2">
                                            @report.GeneratedAt.ToString("MMM dd, yyyy h:mm tt")
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" sm="4">
                                        <MudText Typo="Typo.caption" Style="color: #666;">Generated By</MudText>
                                        <MudText Typo="Typo.body2">
                                            @(report.GeneratedBy?.FullName ?? "System")
                                        </MudText>
                                    </MudItem>
                                    @if (report.DownloadCount > 0)
                                    {
                                        <MudItem xs="12" sm="4">
                                            <MudText Typo="Typo.caption" Style="color: #666;">Downloads</MudText>
                                            <MudText Typo="Typo.body2">
                                                @report.DownloadCount times
                                            </MudText>
                                        </MudItem>
                                    }
                                </MudGrid>

                                <!-- Pending Review Alert - for TenantOwner -->
                                @if (report.Status == ReportStatus.PendingReview)
                                {
                                    <AuthorizeView Policy="RequireTenantOwner">
                                        <Authorized>
                                            <MudAlert Severity="Severity.Warning" Dense="true" Variant="Variant.Outlined" Class="mt-2">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                    <MudText Typo="Typo.body2">
                                                        <MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                                                        This report is awaiting your review and approval.
                                                    </MudText>
                                                    <MudStack Row="true" Spacing="1">
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Small"
                                                                   StartIcon="@Icons.Material.Filled.CheckCircle"
                                                                   OnClick="@(() => ApproveReport(report))">
                                                            Approve
                                                        </MudButton>
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Warning" 
                                                                   Size="Size.Small"
                                                                   StartIcon="@Icons.Material.Filled.Edit"
                                                                   OnClick="@(() => RequestRevisions(report))">
                                                            Request Revisions
                                                        </MudButton>
                                                    </MudStack>
                                                </MudStack>
                                            </MudAlert>
                                        </Authorized>
                                    </AuthorizeView>
                                }

                                <!-- Revision Required Alert -->
                                @if (report.Status == ReportStatus.RevisionRequired)
                                {
                                    var hasNewerVersion = HasNewerReportVersion(report);
                                    <MudAlert Severity="@(hasNewerVersion ? Severity.Normal : Severity.Warning)" 
                                              Dense="false" 
                                              Variant="Variant.Outlined" 
                                              Class="mt-2">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudIcon Icon="@(hasNewerVersion ? Icons.Material.Filled.History : Icons.Material.Filled.Edit)" Size="Size.Small" />
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                                        @(hasNewerVersion ? "Superseded - Revision Created" : "Revisions Requested")
                                                    </MudText>
                                                    @if (report.ReviewedAt.HasValue && report.ReviewedBy != null)
                                                    {
                                                        <MudText Typo="Typo.caption" Style="color: #666;">
                                                            by @report.ReviewedBy.FullName on @report.ReviewedAt.Value.ToString("MMM dd, yyyy")
                                                        </MudText>
                                                    }
                                                </MudStack>
                                                @if (!hasNewerVersion)
                                                {
                                                    <AuthorizeView Policy="RequireTenantStaff">
                                                        <Authorized>
                                                            <MudButton Variant="Variant.Filled" 
                                                                       Color="Color.Primary" 
                                                                       Size="Size.Small"
                                                                       StartIcon="@Icons.Material.Filled.Refresh"
                                                                       OnClick="@(() => ReviseReport(report))">
                                                                Revise Report
                                                            </MudButton>
                                                        </Authorized>
                                                    </AuthorizeView>
                                                }
                                            </MudStack>
                                            @if (!string.IsNullOrEmpty(report.InternalNotes) && !hasNewerVersion)
                                            {
                                                <MudPaper Elevation="0" Class="pa-2" Style="background: #fff8e1; border-radius: 4px;">
                                                    <MudText Typo="Typo.caption" Style="font-weight: 600; color: #f57c00;">Revision Notes:</MudText>
                                                    <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">@report.InternalNotes</MudText>
                                                </MudPaper>
                                            }
                                        </MudStack>
                                    </MudAlert>
                                }

                                <!-- Published Info -->
                                @if (report.Status == ReportStatus.Published && report.PublishedAt.HasValue)
                                {
                                    <MudAlert Severity="Severity.Success" Dense="true" Variant="Variant.Text" Class="mt-2">
                                        Published on @report.PublishedAt.Value.ToString("MMM dd, yyyy")
                                        @if (report.SentToClientAt.HasValue)
                                        {
                                            <span> • Sent to @report.SentToEmail on @report.SentToClientAt.Value.ToString("MMM dd")</span>
                                        }
                                    </MudAlert>
                                }

                                <!-- Review Info -->
                                @if (report.ReviewedAt.HasValue && report.ReviewedBy != null && report.Status == ReportStatus.Approved)
                                {
                                    <MudText Typo="Typo.caption" Style="color: #666;">
                                        Approved by @report.ReviewedBy.FullName on @report.ReviewedAt.Value.ToString("MMM dd, yyyy")
                                    </MudText>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                }
            </MudStack>
        }
    </MudStack>
</MudPaper>

<!-- Generate Report Dialog -->
<MudDialog @bind-Visible="showGenerateDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AddChart" Class="mr-2" />
            Generate Report
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudSelect T="ReportType" @bind-Value="newReportType" Label="Report Type" Variant="Variant.Outlined" Required="true">
                <MudSelectItem T="ReportType" Value="ReportType.FundingPlan">Funding Plan</MudSelectItem>
                <MudSelectItem T="ReportType" Value="ReportType.ExecutiveSummary">Executive Summary</MudSelectItem>
                <MudSelectItem T="ReportType" Value="ReportType.FullReport">Full Narrative Report</MudSelectItem>
                <MudSelectItem T="ReportType" Value="ReportType.Draft">Draft</MudSelectItem>
            </MudSelect>

            @if (newReportType == ReportType.FullReport)
            {
                @if (!hasNarrative)
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true">
                        <MudText Typo="Typo.body2">
                            <strong>No narrative created.</strong> You must create and save a narrative in the Narrative tab before generating a Full Narrative Report.
                        </MudText>
                    </MudAlert>
                }
                else
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                        <MudText Typo="Typo.body2">
                            <strong>Full Narrative Report</strong> generates a complete PDF document using your narrative templates including cover page, executive summary, narrative sections, photos, charts, and appendices.
                        </MudText>
                    </MudAlert>

                    <MudText Typo="Typo.subtitle2">Include Sections</MudText>
                    <MudStack Row="true" Spacing="4">
                        <MudCheckBox T="bool" @bind-Value="includePhotos" Label="Photos" Color="Color.Primary" />
                        <MudCheckBox T="bool" @bind-Value="includeCharts" Label="Charts" Color="Color.Primary" />
                        <MudCheckBox T="bool" @bind-Value="includeTables" Label="Tables" Color="Color.Primary" />
                    </MudStack>
                }
            }
            else
            {
                <MudText Typo="Typo.subtitle2">Output Formats</MudText>
                <MudStack Row="true" Spacing="4">
                    <MudCheckBox T="bool" @bind-Value="generatePdf" Label="PDF" Color="Color.Primary" />
                    <MudCheckBox T="bool" @bind-Value="generateExcel" Label="Excel" Color="Color.Primary" />
                </MudStack>
            }

            <MudTextField @bind-Value="newReportNotes" 
                          Label="Notes (optional)" 
                          Variant="Variant.Outlined"
                          Lines="3" />

            <MudAlert Severity="Severity.Info" Variant="Variant.Text">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.body2">
                        <strong>This will:</strong>
                    </MudText>
                    @if (newReportType == ReportType.FullReport)
                    {
                        <MudText Typo="Typo.body2">• Compose narrative from templates</MudText>
                        <MudText Typo="Typo.body2">• Include photos, tables, and charts</MudText>
                        <MudText Typo="Typo.body2">• Generate a professional PDF document</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2">• Run the funding plan calculator</MudText>
                        <MudText Typo="Typo.body2">• Generate report files (@(generatePdf && generateExcel ? "PDF & Excel" : generatePdf ? "PDF" : "Excel"))</MudText>
                    }
                    <MudText Typo="Typo.body2">• Create a draft report for review</MudText>
                </MudStack>
            </MudAlert>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseGenerateDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="GenerateReport"
                   Disabled="@(IsGenerateButtonDisabled())">
            <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Class="mr-1" />
            Generate
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public Guid ReserveStudyId { get; set; }

    private List<GeneratedReport> reports = new();
    private bool isLoading = true;
    private bool isGenerating = false;
    private bool canGenerateReports = false;
    private bool hasNarrative = false;
    private string workflowGateMessage = "Checking workflow status...";
    private StudyDataValidationResult? validationResult;

    // Collapsible section states
    private bool showFinancialData = false;
    private bool showElementData = false;
    private bool showServiceContacts = false;

    // ZIP download state
    private bool isDownloadingZip = false;

    // Dialog state
    private bool showGenerateDialog = false;
    private ReportType newReportType = ReportType.FundingPlan;
    private string newReportNotes = "";
    private bool generatePdf = true;
    private bool generateExcel = true;
    private bool showAllElementData = false;
    private Guid? revisingReportId = null; // Track which report is being revised

    // Narrative report options
    private bool includePhotos = true;
    private bool includeCharts = true;
    private bool includeTables = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadReports();
        await CheckWorkflowGate();
        await CheckNarrativeExistsAsync();
    }

    private async Task CheckWorkflowGate()
    {
        try
        {
            validationResult = await GenerationService.ValidateStudyDataAsync(ReserveStudyId);
            canGenerateReports = validationResult.IsReady;
            
            if (!canGenerateReports)
            {
                if (validationResult.Errors.Any())
                {
                    workflowGateMessage = "Report generation is blocked due to missing required data.";
                }
                else if (validationResult.Warnings.Any())
                {
                    workflowGateMessage = "Some data is missing but report generation may still proceed.";
                }
                else
                {
                    workflowGateMessage = $"Report generation requires the study to be at '{GenerationService.MinimumRequiredStatus}' stage or later. Complete the site visit and data entry first.";
                }
            }
        }
        catch (Exception ex)
        {
            workflowGateMessage = $"Unable to check workflow status: {ex.Message}";
        }
    }

    private async Task CheckNarrativeExistsAsync()
    {
        try
        {
            var narrative = await NarrativeService.GetByStudyIdAsync(ReserveStudyId);
            hasNarrative = narrative != null;

            // If narrative exists and is in a non-editable state (Approved, Published, etc.),
            // clear any stale dirty state that may have persisted incorrectly
            if (narrative != null && !IsNarrativeEditable(narrative.Status))
            {
                if (NarrativeStateService.HasUnsavedChangesForStudy(ReserveStudyId))
                {
                    NarrativeStateService.MarkClean();
                }
            }
        }
        catch
        {
            hasNarrative = false;
        }
    }

    /// <summary>
    /// Checks if a narrative with the given status can be edited.
    /// </summary>
    private static bool IsNarrativeEditable(NarrativeStatus status)
    {
        return status == NarrativeStatus.Draft || 
               status == NarrativeStatus.InProgress || 
               status == NarrativeStatus.RevisionRequired;
    }

    private async Task LoadReports()
    {
        try
        {
            isLoading = true;
            var result = await ReportService.GetByReserveStudyAsync(ReserveStudyId);
            reports = result.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading reports: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool IsGenerateButtonDisabled()
    {
        // Full Narrative Report requires a saved narrative
        if (newReportType == ReportType.FullReport)
        {
            return !hasNarrative;
        }

        // Other report types require at least one output format
        return !generatePdf && !generateExcel;
    }

    private void OpenGenerateDialog()
    {
        newReportType = ReportType.FundingPlan;
        newReportNotes = "";
        generatePdf = true;
        generateExcel = true;
        includePhotos = true;
        includeCharts = true;
        includeTables = true;
        revisingReportId = null; // Clear any previous revision tracking
        showGenerateDialog = true;
    }

    private async Task OpenPreviewDialog()
    {
        // Check if this study has unsaved narrative changes
        if (NarrativeStateService.HasUnsavedChangesForStudy(ReserveStudyId))
        {
            var saved = await NarrativeStateService.EnsureSavedAsync(ReserveStudyId);
            if (saved)
            {
                Snackbar.Add("Narrative auto-saved before preview", Severity.Info);
            }
            else
            {
                // Editor is not active - user switched tabs without saving
                Snackbar.Add("You have unsaved narrative changes. Please go to the Narrative tab and save before previewing.", Severity.Warning);
                return;
            }
        }

        var parameters = new DialogParameters
        {
            ["ReserveStudyId"] = ReserveStudyId
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraLarge,
            FullWidth = true
        };

        await DialogService.ShowAsync<NarrativePreviewDialog>("Narrative Preview", parameters, options);
    }

    private void CloseGenerateDialog()
    {
        showGenerateDialog = false;
        revisingReportId = null; // Clear the revision tracking
    }

    private async Task GenerateReport()
    {
        if (!canGenerateReports)
        {
            Snackbar.Add(workflowGateMessage, Severity.Warning);
            return;
        }

        // Check if this study has unsaved narrative changes
        if (NarrativeStateService.HasUnsavedChangesForStudy(ReserveStudyId))
        {
            var saved = await NarrativeStateService.EnsureSavedAsync(ReserveStudyId);
            if (!saved)
            {
                // Editor is not active - user switched tabs without saving
                Snackbar.Add("You have unsaved narrative changes. Please go to the Narrative tab and save before generating.", Severity.Error);
                return;
            }
            Snackbar.Add("Narrative auto-saved before report generation", Severity.Info);
        }

        try
        {
            isGenerating = true;
            CloseGenerateDialog();
            StateHasChanged();

            await UserState.InitializeAsync();
            var userId = UserState.CurrentUser?.Id ?? Guid.Empty;

            ReportGenerationResult result;

            // Use different generation path for Full Narrative Report
            if (newReportType == ReportType.FullReport)
            {
                var narrativeOptions = new NarrativeReportOptions
                {
                    IncludePhotos = includePhotos,
                    IncludeCharts = includeCharts,
                    IncludeCalculationTables = includeTables,
                    Notes = newReportNotes
                };

                result = await GenerationService.GenerateNarrativeReportAsync(ReserveStudyId, userId, narrativeOptions);
            }
            else
            {
                var options = new ReportGenerationOptions
                {
                    ReportType = newReportType,
                    Notes = newReportNotes,
                    GeneratePdf = generatePdf,
                    GenerateExcel = generateExcel,
                    SupersedesReportId = revisingReportId // Link to report being revised
                };

                result = await GenerationService.GenerateReportAsync(ReserveStudyId, userId, options);
            }

            if (result.IsSuccess)
            {
                Snackbar.Add("Report generated successfully!", Severity.Success);

                // Show warnings if any
                foreach (var warning in result.Warnings)
                {
                    Snackbar.Add(warning, Severity.Warning);
                }

                await LoadReports();
            }
            else
            {
                Snackbar.Add($"Error: {result.ErrorMessage}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating report: {ex.Message}", Severity.Error);
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task SubmitForReview(GeneratedReport report)
    {
        try
        {
            await ReportService.SubmitForReviewAsync(report.Id);
            report.Status = ReportStatus.PendingReview;
            Snackbar.Add("Report submitted for review", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task ApproveReport(GeneratedReport report)
    {
        try
        {
            await UserState.InitializeAsync();
            var userId = UserState.CurrentUser?.Id ?? Guid.Empty;
            await ReportService.ApproveAsync(report.Id, userId);
            report.Status = ReportStatus.Approved;
            report.ReviewedAt = DateTime.UtcNow;
            Snackbar.Add("Report approved successfully", Severity.Success);
            await LoadReports();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task RequestRevisions(GeneratedReport report)
    {
        var parameters = new DialogParameters
        {
            ["ReportTitle"] = GetReportTypeDisplayName(report.Type)
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<RequestRevisionsDialog>("Request Revisions", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string revisionNotes)
        {
            try
            {
                await UserState.InitializeAsync();
                var userId = UserState.CurrentUser?.Id ?? Guid.Empty;
                await ReportService.RequestRevisionsAsync(report.Id, userId, revisionNotes);
                report.Status = ReportStatus.RevisionRequired;
                report.InternalNotes = revisionNotes;
                Snackbar.Add("Revisions requested - the specialist has been notified", Severity.Success);
                await LoadReports();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private Task ReviseReport(GeneratedReport report)
    {
        // Open the generate dialog pre-filled with the same report type
        // The specialist can adjust parameters and regenerate
        newReportType = report.Type;
        newReportNotes = $"Revision of report v{report.Version}. Original notes: {report.InternalNotes}";
        generatePdf = true;
        generateExcel = true;
        revisingReportId = report.Id; // Track which report is being revised
        showGenerateDialog = true;

        return Task.CompletedTask;
    }

    private async Task PublishReport(GeneratedReport report)
    {
        try
        {
            await UserState.InitializeAsync();
            var userId = UserState.CurrentUser?.Id ?? Guid.Empty;
            await ReportService.PublishAsync(report.Id, userId);
            report.Status = ReportStatus.Published;
            report.PublishedAt = DateTime.UtcNow;
            Snackbar.Add("Report published successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task SendToClient(GeneratedReport report)
    {
        // Get report details for the dialog
        var study = await GetStudyDetailsAsync();
        var communityName = study?.Community?.Name;
        var defaultEmail = study?.Contact?.Email;

        var parameters = new DialogParameters
        {
            ["ReserveStudyId"] = ReserveStudyId,
            ["ReportTitle"] = GetReportTypeDisplayName(report.Type),
            ["ReportVersion"] = report.Version,
            ["CommunityName"] = communityName,
            ["DefaultRecipientEmail"] = defaultEmail,
            ["FileSizeBytes"] = report.FileSizeBytes
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true 
        };

        var dialog = await DialogService.ShowAsync<SendReportToClientDialog>("Send Report", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is SendReportToClientDialog.SendReportResult sendResult)
        {
            try
            {
                await UserState.InitializeAsync();
                var userId = UserState.CurrentUser?.Id ?? Guid.Empty;
                var baseUrl = NavigationManager.BaseUri;

                var success = await ReportService.SendToClientAsync(
                    report.Id,
                    sendResult.RecipientEmail,
                    sendResult.Subject,
                    sendResult.PersonalMessage,
                    sendResult.CcEmail,
                    sendResult.IncludeDownloadLink,
                    sendResult.AttachReport,
                    userId,
                    baseUrl);

                if (success)
                {
                    report.SentToClientAt = DateTime.UtcNow;
                    report.SentToEmail = sendResult.RecipientEmail;
                    Snackbar.Add($"Report sent to {sendResult.RecipientEmail}", Severity.Success);
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("Failed to send report. Please try again.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error sending report: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task<ReserveStudy?> GetStudyDetailsAsync()
    {
        try
        {
            await using var scope = Services.CreateAsyncScope();
            var studyService = scope.ServiceProvider.GetRequiredService<IReserveStudyService>();
            return await studyService.GetReserveStudyByIdAsync(ReserveStudyId);
        }
        catch
        {
            return null;
        }
    }

    private async Task DownloadAllAsZip()
    {
        if (reports.Count < 2)
        {
            Snackbar.Add("Select at least 2 reports to create a ZIP file", Severity.Warning);
            return;
        }

        try
        {
            isDownloadingZip = true;
            StateHasChanged();

            // Get all non-superseded report IDs
            var reportIds = reports
                .Where(r => r.Status != ReportStatus.Superseded && !string.IsNullOrEmpty(r.StorageUrl))
                .Select(r => r.Id)
                .ToList();

            if (reportIds.Count == 0)
            {
                Snackbar.Add("No downloadable reports found", Severity.Warning);
                return;
            }

            var result = await ZipService.CreateZipAsync(reportIds);

            // Trigger browser download via JS interop
            var base64 = Convert.ToBase64String(result.ZipBytes);
            await JSRuntime.InvokeVoidAsync("downloadFileFromBase64", result.FileName, base64, "application/zip");

            Snackbar.Add($"Downloaded {result.ReportCount} reports as ZIP", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating ZIP: {ex.Message}", Severity.Error);
        }
        finally
        {
            isDownloadingZip = false;
            StateHasChanged();
        }
    }

    private void DownloadReport(GeneratedReport report)
    {
        if (string.IsNullOrEmpty(report.StorageUrl))
        {
            Snackbar.Add("Report file not available for download", Severity.Warning);
            return;
        }

        try
        {
            var url = DocumentStorage.GetSasUrl(report.StorageUrl, TimeSpan.FromHours(1));
            NavigationManager.NavigateTo(url, forceLoad: true);

            // Increment download count
            _ = ReportService.RecordDownloadAsync(report.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading report: {ex.Message}", Severity.Error);
        }
    }

    private void DownloadExcel(GeneratedReport report)
    {
        if (string.IsNullOrEmpty(report.ExcelStorageUrl))
        {
            Snackbar.Add("Excel file not available for download", Severity.Warning);
            return;
        }

        try
        {
            var url = DocumentStorage.GetSasUrl(report.ExcelStorageUrl, TimeSpan.FromHours(1));
            NavigationManager.NavigateTo(url, forceLoad: true);

            // Increment download count
            _ = ReportService.RecordDownloadAsync(report.Id);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error downloading Excel: {ex.Message}", Severity.Error);
        }
    }

    private void ViewReport(GeneratedReport report)
    {
        if (string.IsNullOrEmpty(report.StorageUrl))
        {
            Snackbar.Add("Report file not available", Severity.Warning);
            return;
        }

        try
        {
            var url = DocumentStorage.GetSasUrl(report.StorageUrl, TimeSpan.FromHours(1));
            NavigationManager.NavigateTo(url, forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error viewing report: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteReport(GeneratedReport report)
    {
        var confirmed = await DialogService.ShowMessageBoxAsync(
            "Delete Report",
            $"Are you sure you want to delete this {GetReportTypeDisplayName(report.Type)} (v{report.Version})?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await ReportService.DeleteAsync(report.Id);
                reports.Remove(report);
                Snackbar.Add("Report deleted", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private string GetReportStyle(GeneratedReport report)
    {
        return report.Status switch
        {
            ReportStatus.Published => "border-left: 4px solid #66BB6A; border-radius: 8px;",
            ReportStatus.Approved => "border-left: 4px solid #42A5F5; border-radius: 8px;",
            ReportStatus.PendingReview or ReportStatus.InReview => "border-left: 4px solid #FFA726; border-radius: 8px;",
            ReportStatus.RevisionRequired => "border-left: 4px solid #EF5350; border-radius: 8px;",
            _ => "border-radius: 8px;"
        };
    }

    private string GetReportIcon(ReportType type) => type switch
    {
        ReportType.Draft => Icons.Material.Filled.EditNote,
        ReportType.Final => Icons.Material.Filled.CheckCircle,
        ReportType.ExecutiveSummary => Icons.Material.Filled.Summarize,
        ReportType.FundingPlan => Icons.Material.Filled.AccountBalance,
        ReportType.ComponentInventory => Icons.Material.Filled.Inventory,
        ReportType.FullReport => Icons.Material.Filled.Book,
        ReportType.UpdateReport => Icons.Material.Filled.Update,
        ReportType.Addendum => Icons.Material.Filled.Attachment,
        ReportType.CorrectionNotice => Icons.Material.Filled.Warning,
        _ => Icons.Material.Filled.Description
    };

    private Color GetStatusColor(ReportStatus status) => status switch
    {
        ReportStatus.Published => Color.Success,
        ReportStatus.Approved => Color.Info,
        ReportStatus.PendingReview or ReportStatus.InReview => Color.Warning,
        ReportStatus.RevisionRequired => Color.Error,
        ReportStatus.Superseded or ReportStatus.Archived => Color.Default,
        _ => Color.Default
    };

    private string GetReportTypeDisplayName(ReportType type) => type switch
    {
        ReportType.Draft => "Draft Report",
        ReportType.Final => "Final Report",
        ReportType.ExecutiveSummary => "Executive Summary",
        ReportType.FundingPlan => "Funding Plan",
        ReportType.ComponentInventory => "Component Inventory",
        ReportType.FullReport => "Full Report",
        ReportType.UpdateReport => "Update Report",
        ReportType.Addendum => "Addendum",
        ReportType.CorrectionNotice => "Correction Notice",
        _ => type.ToString()
    };

    private string GetStatusDisplayName(ReportStatus status) => status switch
    {
        ReportStatus.Draft => "Draft",
        ReportStatus.PendingReview => "Pending Review",
        ReportStatus.InReview => "In Review",
        ReportStatus.RevisionRequired => "Revision Required",
        ReportStatus.Approved => "Approved",
        ReportStatus.Published => "Published",
        ReportStatus.Superseded => "Superseded",
        ReportStatus.Archived => "Archived",
        _ => status.ToString()
    };

    /// <summary>
    /// Checks if there's a newer report of the same type created after this one.
    /// Used to determine if the "Revise Report" button should be shown.
    /// </summary>
    private bool HasNewerReportVersion(GeneratedReport report)
    {
        return reports.Any(r => 
            r.Id != report.Id && 
            r.Type == report.Type && 
            r.GeneratedAt > report.GeneratedAt &&
            r.Status != ReportStatus.Superseded &&
            r.Status != ReportStatus.Archived);
    }

    private record ElementDataGroups(
        Dictionary<string, int> TypeGroups, 
        Dictionary<string, int> IssueGroups);

    private ElementDataGroups GetElementDataGroups()
    {
        var typeGroups = new Dictionary<string, int>();
        var issueGroups = new Dictionary<string, int>();

        if (validationResult?.MissingElementData == null)
            return new ElementDataGroups(typeGroups, issueGroups);

        foreach (var item in validationResult.MissingElementData)
        {
            // Parse format: "ElementName (Type): Missing Issue"
            var colonIndex = item.LastIndexOf(':');
            if (colonIndex > 0)
            {
                var namePart = item[..colonIndex].Trim();
                var issuePart = item[(colonIndex + 1)..].Trim().Replace("Missing ", "");

                // Extract type from parentheses
                var openParen = namePart.LastIndexOf('(');
                var closeParen = namePart.LastIndexOf(')');
                if (openParen > 0 && closeParen > openParen)
                {
                    var type = namePart[(openParen + 1)..closeParen];
                    typeGroups[type] = typeGroups.GetValueOrDefault(type) + 1;
                }

                issueGroups[issuePart] = issueGroups.GetValueOrDefault(issuePart) + 1;
            }
        }

        return new ElementDataGroups(typeGroups, issueGroups);
    }
}
