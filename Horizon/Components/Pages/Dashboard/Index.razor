@page "/Dashboard"
@attribute [Authorize]
@using MudBlazor
@using Horizon.Services.Interfaces
@using Horizon.Services.Tenant
@using Horizon.Services.Workflow
@using Horizon.Models
@using Horizon.Models.Workflow
@using Horizon.Components.AppHome.ViewModels
@using Horizon.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@inject ISystemSettingsService SystemSettingsService
@inject ITenantUserRoleService RoleService
@inject ITenantContext TenantContext
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IReserveStudyService ReserveStudyService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IInvoiceService InvoiceService
@inject NavigationManager NavigationManager
@inject ThemeService ThemeService

<PageTitle>Dashboard - @TenantName</PageTitle>

@if (!_isInitialized)
{
    <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8 mb-8">
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Class="mb-6" Style="border-radius: 16px;" />
        <MudGrid Spacing="3" Class="mb-6">
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Style="border-radius: 12px;" />
            </MudItem>
        </MudGrid>
        <MudGrid Spacing="3">
            <MudItem xs="12" md="7">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" Style="border-radius: 16px;" />
            </MudItem>
            <MudItem xs="12" md="5">
                <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" Style="border-radius: 16px;" />
            </MudItem>
        </MudGrid>
    </MudContainer>
}
else
{
<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8 mb-8">

    @* Role-based welcome banner *@
    @if (RoleService.IsHOAUser || RoleService.IsHOAAuditor)
    {
        <!-- HOA User View - Simplified -->
        <MudPaper Elevation="0" Class="pa-6 mb-6" Style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-radius: 16px;">
            <MudStack Spacing="2">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    Welcome to Your Portal ðŸ‘‹
                </MudText>
                <MudText Typo="Typo.body1" Style="color: rgba(255,255,255,0.95);">
                    View your reserve studies, reports, and documents
                </MudText>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <!-- Staff/Admin View - Full featured -->
        <MudPaper Elevation="3" Class="pa-6 mb-6" Style="@BannerGradient">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h5" Style="color: white; font-weight: 500; letter-spacing: 0.5px;">
                    Welcome back@(GetUserGreeting())
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.8);">
                    @GetRoleDescription()
                </MudText>
            </MudStack>
        </MudPaper>
    }

    <!-- GLOBAL NOTIFICATIONS BANNER -->
    @if (globalBanner != null && !bannerDismissed)
    {
        <MudAlert Severity="@GetMudSeverity(globalBanner.Severity)" 
                  Variant="Variant.Filled" 
                  Elevation="3" 
                  Dense="false" 
                  Class="mb-6" 
                  Style="border-radius: 12px;"
                  CloseIcon="@Icons.Material.Filled.Close" 
                  CloseIconClicked="@(() => HideBanner())">
            <MudStack Spacing="1">
                <MudText Typo="Typo.body1" Style="font-weight: 600;">@globalBanner.Message</MudText>
                @if (globalBanner.EndDate.HasValue)
                {
                    <MudText Typo="Typo.caption">
                        Active until @globalBanner.EndDate.Value.ToLocalTime().ToString("g")
                    </MudText>
                }
            </MudStack>
        </MudAlert>
    }

    <!-- PENDING AMENDMENTS INDICATOR (for HOA users) -->
    @if (RoleService.IsHOAUser || RoleService.IsHOAAuditor)
    {
        <Horizon.Components.Shared.AmendmentPendingIndicator />
    }

    @* Conditional rendering based on role *@
    @if (RoleService.IsHOAUser || RoleService.IsHOAAuditor)
    {
        @* HOA User Dashboard - Simplified view *@
        <MudGrid Spacing="3" Class="mb-6">
            <!-- My Studies -->
            <MudItem xs="6" sm="4">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #6366f1;">
                    <MudStack Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Assessment" Style="color: #6366f1;" />
                        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">@hoaUserStudies.Count</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">My Studies</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Available Reports -->
            <MudItem xs="6" sm="4">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #10b981;">
                    <MudStack Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Description" Style="color: #10b981;" />
                        <MudText Typo="Typo.h4" Style="font-weight: 700; color: #1f2937;">@hoaUserStudies.Count(s => s.IsComplete)</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Reports Ready</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Invoice Balance -->
            <MudItem xs="12" sm="4">
                <MudPaper Class="pa-4 kpi-clickable" Elevation="2" Style="@($"border-radius: 12px; border-left: 4px solid {(HoaTotalBalance > 0 ? "#f59e0b" : "#10b981")};")" @onclick="@(() => NavigationManager.NavigateTo("/MyInvoices"))">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Style="@($"color: {(HoaTotalBalance > 0 ? "#f59e0b" : "#10b981")};")" />
                            @if (HoaTotalBalance > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Filled" Style="font-size: 0.65rem;">Due</MudChip>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="color: #9ca3af;" />
                            }
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="@($"font-weight: 700; color: {(HoaTotalBalance > 0 ? "#f59e0b" : "#1f2937")};")">@HoaTotalBalance.ToString("C0")</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">@(HoaTotalBalance > 0 ? "Balance Due" : "All Paid")</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- HOA: My Studies & Documents -->
        <MudGrid Spacing="4">
            <MudItem xs="12" lg="8">
                <MudPaper Class="pa-6" Elevation="2" Style="border-radius: 12px;">
                    <MudStack Spacing="1" Class="mb-4">
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Folder" Class="mr-2" Style="vertical-align: middle;" />
                            My Reserve Studies
                        </MudText>
                        <MudText Typo="Typo.body2" Style="color: #666;">
                            Access your community's reserve study reports and documents
                        </MudText>
                    </MudStack>

                    @if (isLoadingStudies)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
                    }
                    else if (!hoaUserStudies.Any())
                    {
                        <MudPaper Elevation="0" Class="pa-8" Style="border: 2px dashed #e0e0e0; border-radius: 12px; text-align: center; background: #fafafa;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="3">
                                <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Style="font-size: 64px; color: #ccc;" />
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">No studies available yet</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Your reserve studies will appear here once they're published
                                </MudText>
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Href="/ReserveStudies/Request"
                                           Style="text-transform: none;">
                                    Request a Reserve Study
                                </MudButton>
                            </MudStack>
                        </MudPaper>
                    }
                    else
                    {
                        <MudTable Items="@hoaUserStudies" Dense="true" Hover="true" Elevation="0" Style="border-radius: 8px;">
                            <HeaderContent>
                                <MudTh Style="font-weight: 600;">Community</MudTh>
                                <MudTh Style="font-weight: 600;">Status</MudTh>
                                <MudTh Style="font-weight: 600;">Created</MudTh>
                                <MudTh Style="font-weight: 600; text-align: right;">Actions</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd DataLabel="Community">
                                    <MudStack Spacing="0">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Community?.Name</MudText>
                                            @if (pendingAmendmentStudyIds.Contains(context.Id))
                                            {
                                                <MudChip T="string" 
                                                         Size="Size.Small" 
                                                         Color="Color.Warning" 
                                                         Variant="Variant.Outlined"
                                                         Icon="@Icons.Material.Filled.Warning"
                                                         Style="font-size: 0.7rem;">
                                                    Action Required
                                                </MudChip>
                                            }
                                        </MudStack>
                                        <MudText Typo="Typo.caption" Style="color: #999;">
                                            @(context.Community?.PhysicalAddress?.City ?? ""), @(context.Community?.PhysicalAddress?.State ?? "")
                                        </MudText>
                                    </MudStack>
                                </MudTd>
                                <MudTd DataLabel="Status">
                                    <MudChip T="string" 
                                             Size="Size.Small" 
                                             Color="@GetStudyStatusColor(context)"
                                             Variant="Variant.Filled">
                                        @GetStudyStatusText(context)
                                    </MudChip>
                                </MudTd>
                                <MudTd DataLabel="Created">
                                    <MudText Typo="Typo.body2" Style="color: #666;">
                                        @(context.DateCreated?.ToString("MMM dd, yyyy") ?? "N/A")
                                    </MudText>
                                </MudTd>
                                <MudTd DataLabel="Actions" Style="text-align: right;">
                                    @if (pendingAmendmentStudyIds.Contains(context.Id))
                                    {
                                        @* Amendment pending - show only the review action *@
                                        <MudButton Variant="Variant.Filled" 
                                                   Color="Color.Warning" 
                                                   Size="Size.Small"
                                                   Href="@($"/ReserveStudies/Amendment/{context.Id}")"
                                                   StartIcon="@Icons.Material.Filled.RateReview">
                                            Review Amendment
                                        </MudButton>
                                    }
                                    else
                                    {
                                        @* Normal actions *@
                                        <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="1">
                                            <MudButton Variant="Variant.Text" 
                                                       Color="Color.Primary" 
                                                       Size="Size.Small"
                                                       Href="@($"/ReserveStudies/Details/{context.Id}")"
                                                       StartIcon="@Icons.Material.Filled.Visibility">
                                                View
                                            </MudButton>
                                            @if (CanEditStudy(context))
                                            {
                                                <MudButton Variant="Variant.Text" 
                                                           Color="Color.Info" 
                                                           Size="Size.Small"
                                                           Href="@($"/ReserveStudies/Edit/{context.Id}")"
                                                           StartIcon="@Icons.Material.Filled.Edit">
                                                    Edit
                                                </MudButton>
                                            }
                                        </MudStack>
                                    }
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" lg="4">
                <MudStack Spacing="4">
                    <!-- My Invoices -->
                    <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                <MudIcon Icon="@Icons.Material.Filled.Receipt" Style="color: #f59e0b;" Class="mr-2" />
                                My Invoices
                            </MudText>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       Href="/MyInvoices"
                                       Style="text-transform: none;">
                                View All
                            </MudButton>
                        </MudStack>

                        @if (isLoadingInvoices)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-2" />
                        }
                        else if (!hoaUserInvoices.Any())
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                <MudText Typo="Typo.body2">No invoices yet</MudText>
                            </MudAlert>
                        }
                        else
                        {
                            var unpaidInvoices = hoaUserInvoices.Where(i => i.Status != InvoiceStatus.Paid).Take(3).ToList();
                            @if (unpaidInvoices.Any())
                            {
                                <MudStack Spacing="2">
                                    @foreach (var invoice in unpaidInvoices)
                                    {
                                        <MudPaper Elevation="0" Class="pa-3" Style="border: 1px solid #e0e0e0; border-radius: 8px;">
                                            <MudStack Spacing="1">
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 600;">@invoice.InvoiceNumber</MudText>
                                                    <MudChip T="string" Size="Size.Small" Color="@GetInvoiceStatusColor(invoice.Status)" Variant="Variant.Filled" Style="font-size: 0.65rem;">
                                                        @invoice.Status
                                                    </MudChip>
                                                </MudStack>
                                                <MudText Typo="Typo.caption" Style="color: #666;">
                                                    @(invoice.ReserveStudy?.Community?.Name ?? "N/A") â€¢ Due @invoice.DueDate.ToString("MMM d")
                                                </MudText>
                                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                    <MudText Typo="Typo.body2" Style="font-weight: 700; color: #f59e0b;">
                                                        @invoice.BalanceDue.ToString("C")
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(invoice.AccessToken))
                                                    {
                                                        <MudButton Variant="Variant.Filled" 
                                                                   Color="Color.Success" 
                                                                   Size="Size.Small"
                                                                   Href="@($"/invoice/{invoice.AccessToken}")"
                                                                   StartIcon="@Icons.Material.Filled.CreditCard"
                                                                   Style="text-transform: none; font-size: 0.75rem;">
                                                            Pay Now
                                                        </MudButton>
                                                    }
                                                    else
                                                    {
                                                        <MudButton Variant="Variant.Outlined" 
                                                                   Color="Color.Primary" 
                                                                   Size="Size.Small"
                                                                   Href="/MyInvoices"
                                                                   Style="text-transform: none; font-size: 0.75rem;">
                                                            View
                                                        </MudButton>
                                                    }
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true" Icon="@Icons.Material.Filled.CheckCircle">
                                    <MudText Typo="Typo.body2">All invoices paid!</MudText>
                                </MudAlert>
                            }
                        }
                    </MudPaper>

                    <!-- Quick Links -->
                    <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Link" Style="color: #6A3D9A;" Class="mr-2" />
                            Quick Links
                        </MudText>
                        <MudStack Spacing="2">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       FullWidth="true"
                                       Href="/MyInvoices"
                                       StartIcon="@Icons.Material.Filled.Receipt"
                                       Style="text-transform: none; justify-content: flex-start; padding: 12px;">
                                View All Invoices
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       FullWidth="true"
                                       Href="/Reports/Download"
                                       StartIcon="@Icons.Material.Filled.Download"
                                       Style="text-transform: none; justify-content: flex-start; padding: 12px;">
                                Download Latest Report
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       FullWidth="true"
                                       Href="/Support"
                                       StartIcon="@Icons.Material.Filled.QuestionAnswer"
                                       Style="text-transform: none; justify-content: flex-start; padding: 12px;">
                                Ask a Question
                            </MudButton>
                        </MudStack>
                    </MudPaper>

                    <!-- Support -->
                    <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                        <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Help" Style="color: #FF8C00;" Class="mr-2" />
                            Need Help?
                        </MudText>
                        <MudText Typo="Typo.body2" Class="mb-3" Style="color: #666;">
                            Have questions about your reserve study? We're here to help!
                        </MudText>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   FullWidth="true"
                                   Href="/Support"
                                   StartIcon="@Icons.Material.Filled.Email">
                            Contact Support
                        </MudButton>
                    </MudPaper>
                </MudStack>
            </MudItem>
        </MudGrid>
    }
    else
    {
        @* Staff/Admin/Specialist Dashboard - Full view *@

        <!-- KPI CARDS - Clean professional design -->
        <MudGrid Class="mb-6" Spacing="3">
            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #6366f1;">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.HomeWork" Style="color: #6366f1;" />
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@KpiProperties</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Properties</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #8b5cf6;">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Style="color: #8b5cf6;" />
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@KpiActiveStudies</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Active Studies</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4 kpi-clickable" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #10b981;" @onclick="@(() => NavigationManager.NavigateTo("/Customers"))">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.PeopleAlt" Style="color: #10b981;" />
                            <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="color: #9ca3af;" />
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@KpiCustomerAccounts</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Customers</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4 kpi-clickable" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #f59e0b;" @onclick="@(() => NavigationManager.NavigateTo("/Invoices"))">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Receipt" Style="color: #f59e0b;" />
                            <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="color: #9ca3af;" />
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="font-weight: 700; color: #1f2937;">@InvoiceOutstanding.ToString("C0")</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Outstanding</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4 kpi-clickable" Elevation="2" Style="@($"border-radius: 12px; border-left: 4px solid {(InvoiceOverdueCount > 0 ? "#ef4444" : "#10b981")};")" @onclick="@(() => NavigationManager.NavigateTo("/Reports/Aging"))">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@(InvoiceOverdueCount > 0 ? Icons.Material.Filled.Warning : Icons.Material.Filled.CheckCircle)" Style="@($"color: {(InvoiceOverdueCount > 0 ? "#ef4444" : "#10b981")};")" />
                            @if (InvoiceOverdueCount > 0)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled" Style="font-size: 0.65rem;">@InvoiceOverdueCount</MudChip>
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="color: #9ca3af;" />
                            }
                        </MudStack>
                        <MudText Typo="Typo.h5" Style="@($"font-weight: 700; color: {(InvoiceOverdueCount > 0 ? "#ef4444" : "#1f2937")};")">@InvoiceOverdue.ToString("C0")</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">@(InvoiceOverdueCount > 0 ? "Overdue" : "No Overdue")</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <MudItem xs="6" sm="4" md="2">
                <MudPaper Class="pa-4 kpi-clickable" Elevation="2" Style="border-radius: 12px; border-left: 4px solid #3b82f6;" @onclick="@(() => NavigationManager.NavigateTo("/Reports/Revenue"))">
                    <MudStack Spacing="1">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Style="color: #3b82f6;" />
                            <MudIcon Icon="@Icons.Material.Filled.OpenInNew" Size="Size.Small" Style="color: #9ca3af;" />
                        </MudStack>
                        <MudText Typo="Typo.h6" Style="font-weight: 600; color: #1f2937;">Revenue</MudText>
                        <MudText Typo="Typo.caption" Style="color: #6b7280;">Dashboard</MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
                </MudGrid>

            <!-- OVERDUE ALERT BANNER -->
        @if (InvoiceOverdueCount > 0)
        {
            <MudAlert Severity="Severity.Warning" 
                      Variant="Variant.Filled" 
                      Class="mb-6" 
                      Style="border-radius: 12px;"
                      Icon="@Icons.Material.Filled.Warning">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
                    <MudText>
                        <strong>@InvoiceOverdueCount invoice(s)</strong> are overdue totaling <strong>@InvoiceOverdue.ToString("C")</strong>. 
                        Consider sending reminders or reviewing the A/R aging report.
                    </MudText>
                    <MudButton Variant="Variant.Text" 
                               Style="color: white;" 
                               EndIcon="@Icons.Material.Filled.ArrowForward"
                               OnClick="@(() => NavigationManager.NavigateTo("/Reports/Aging"))">
                        View Details
                    </MudButton>
                </MudStack>
            </MudAlert>
        }

        <!-- DASHBOARD MAIN SECTION - Stacked Left, Chart Right -->
        <MudGrid Class="mb-6" Spacing="3">
            <!-- LEFT COLUMN - Stacked sections -->
            <MudItem xs="12" md="5">
                <MudStack Spacing="3">
                    <!-- Study Pipeline -->
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                <MudIcon Icon="@Icons.Material.Filled.Speed" Class="mr-2" Style="vertical-align: middle; color: #6366f1;" />
                                Study Pipeline
                            </MudText>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       EndIcon="@Icons.Material.Filled.ArrowForward"
                                       Style="text-transform: none;">
                                View All
                            </MudButton>
                        </MudStack>
                        <MudStack Row="true" Spacing="2" Justify="Justify.SpaceBetween">
                            <MudPaper Class="pa-3 flex-grow-1" Elevation="0" Style="border: 1px solid #fcd34d; border-radius: 8px; background: #fefce8; text-align: center;">
                                <MudText Typo="Typo.h4" Style="font-weight: 700; color: #ca8a04;">@PipelineScreening</MudText>
                                <MudText Typo="Typo.caption" Style="color: #a16207;">Screening</MudText>
                            </MudPaper>
                            <MudPaper Class="pa-3 flex-grow-1" Elevation="0" Style="border: 1px solid #c4b5fd; border-radius: 8px; background: #f5f3ff; text-align: center;">
                                <MudText Typo="Typo.h4" Style="font-weight: 700; color: #7c3aed;">@PipelineEnrollment</MudText>
                                <MudText Typo="Typo.caption" Style="color: #6d28d9;">Enrollment</MudText>
                            </MudPaper>
                            <MudPaper Class="pa-3 flex-grow-1" Elevation="0" Style="border: 1px solid #86efac; border-radius: 8px; background: #f0fdf4; text-align: center;">
                                <MudText Typo="Typo.h4" Style="font-weight: 700; color: #16a34a;">@PipelineComplete</MudText>
                                <MudText Typo="Typo.caption" Style="color: #15803d;">Complete</MudText>
                            </MudPaper>
                        </MudStack>
                    </MudPaper>

                    <!-- Quick Actions -->
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                        <MudText Typo="Typo.subtitle2" Class="mb-3" Style="font-weight: 600; color: #374151;">
                            <MudIcon Icon="@Icons.Material.Filled.Bolt" Style="color: #f59e0b; vertical-align: middle;" Class="mr-1" Size="Size.Small" />
                            Quick Actions
                        </MudText>
                        <MudStack Row="true" Spacing="2" Class="flex-wrap">
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Href="/ReserveStudies"
                                       Style="text-transform: none;">
                                New Study
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.Receipt"
                                       Href="/Invoices"
                                       Style="text-transform: none;">
                                Invoices
                            </MudButton>
                            @if (RoleService.IsTenantOwner || RoleService.IsPlatformAdmin)
                            {
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.Settings"
                                           Href="/Settings/Invoices"
                                           Style="text-transform: none;">
                                    Settings
                                </MudButton>
                            }
                        </MudStack>
                    </MudPaper>

                    <!-- Recent Payments -->
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 600; color: #374151;">
                                <MudIcon Icon="@Icons.Material.Filled.Payments" Style="color: #10b981; vertical-align: middle;" Class="mr-1" Size="Size.Small" />
                                Recent Payments
                            </MudText>
                            <MudButton Variant="Variant.Text" 
                                       Color="Color.Primary" 
                                       Size="Size.Small"
                                       Href="/Reports/Revenue"
                                       Style="text-transform: none; font-size: 0.75rem;">
                                View All
                            </MudButton>
                        </MudStack>
                        @if (!RecentPayments.Any())
                        {
                            <MudText Typo="Typo.body2" Style="color: #9ca3af;">No payments in the last 30 days</MudText>
                        }
                        else
                        {
                            <MudList T="string" Dense="true" Class="py-0">
                                @foreach (var payment in RecentPayments.Take(3))
                                {
                                    <MudListItem Class="px-0">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@payment.Amount.ToString("C")</MudText>
                                                <MudText Typo="Typo.caption" Style="color: #666;">@payment.PaymentDate.ToString("MMM d")</MudText>
                                            </MudStack>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined" Style="font-size: 0.65rem;">Paid</MudChip>
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudPaper>

                    <!-- Resources -->
                    <MudPaper Class="pa-4" Elevation="2" Style="border-radius: 12px;">
                        <MudText Typo="Typo.subtitle2" Class="mb-2" Style="font-weight: 600; color: #374151;">
                            <MudIcon Icon="@Icons.Material.Filled.Help" Style="color: #6366f1; vertical-align: middle;" Class="mr-1" Size="Size.Small" />
                            Resources
                        </MudText>
                        <MudStack Spacing="1">
                            <MudLink Href="https://alxreservecloud.com/docs" Target="_blank" Typo="Typo.body2" Style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" Class="mr-2" Color="Color.Primary" />
                                Getting Started
                            </MudLink>
                            <MudLink Href="https://alxreservecloud.com/tutorials" Target="_blank" Typo="Typo.body2" Style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.VideoLibrary" Size="Size.Small" Class="mr-2" Color="Color.Primary" />
                                Video Tutorials
                            </MudLink>
                            <MudLink Href="https://alxreservecloud.com/support" Target="_blank" Typo="Typo.body2" Style="display: flex; align-items: center;">
                                <MudIcon Icon="@Icons.Material.Filled.Support" Size="Size.Small" Class="mr-2" Color="Color.Primary" />
                                Contact Support
                            </MudLink>
                        </MudStack>
                    </MudPaper>
                </MudStack>
            </MudItem>

            <!-- RIGHT COLUMN - Tall Chart -->
            <MudItem xs="12" md="7">
                <MudPaper Class="pa-5" Elevation="2" Style="border-radius: 12px; height: 100%;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.ShowChart" Style="color: #3b82f6; vertical-align: middle;" Class="mr-2" />
                            6-Month Trends
                        </MudText>
                        <MudButton Variant="Variant.Text" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   Href="/Reports/Revenue"
                                   Style="text-transform: none;">
                            View Details
                        </MudButton>
                    </MudStack>
                    <MudChart ChartType="ChartType.Line" 
                              ChartSeries="@_trendChartSeries" 
                              XAxisLabels="@_trendChartLabels"
                              Width="100%" 
                              Height="350px"
                              ChartOptions="@_trendChartOptions" />
                    <MudStack Row="true" Justify="Justify.Center" Spacing="6" Class="mt-4">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <div style="width: 14px; height: 14px; background: #594ae2; border-radius: 3px;"></div>
                            <MudText Typo="Typo.body1">Revenue ($K)</MudText>
                        </MudStack>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <div style="width: 14px; height: 14px; background: #2eca6a; border-radius: 3px;"></div>
                            <MudText Typo="Typo.body1">Studies Completed</MudText>
                        </MudStack>
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>

    <!-- PROPERTIES & ACTIVITY -->
    <MudGrid Spacing="4">
        <!-- PROPERTIES TABLE - Enhanced -->
        <MudItem xs="12" lg="7">
            <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h5" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" Style="vertical-align: middle;" />
                            Recent Properties
                        </MudText>
                        <MudText Typo="Typo.body2" Style="color: #666;">
                            Your latest property additions
                        </MudText>
                    </MudStack>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Primary" 
                               Size="Size.Small"
                               StartIcon="@Icons.Material.Filled.Add"
                               Style="text-transform: none;">
                        Add Property
                    </MudButton>
                </MudStack>

                @if (!Properties.Any())
                {
                    <MudPaper Elevation="0" Class="pa-8" Style="border: 2px dashed #e0e0e0; border-radius: 12px; text-align: center; background: #fafafa;">
                        <MudStack AlignItems="AlignItems.Center" Spacing="3">
                            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #F3E8FF 0%, #FFF5E6 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <MudIcon Icon="@Icons.Material.Filled.HomeWork" Style="font-size: 40px; color: #6A3D9A;" />
                            </div>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6" Style="font-weight: 600;">No properties yet</MudText>
                                <MudText Typo="Typo.body2" Style="color: #666;">
                                    Get started by adding your first property
                                </MudText>
                            </MudStack>
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Style="text-transform: none;">
                                Add Your First Property
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                }
                else
                {
                    <MudTable Dense="true" 
                              Hover="true" 
                              Items="Properties"
                              Elevation="0"
                              Style="border-radius: 8px;">
                        <HeaderContent>
                            <MudTh Style="font-weight: 600;">Name</MudTh>
                            <MudTh Style="font-weight: 600;">Location</MudTh>
                            <MudTh Style="font-weight: 600;">Status</MudTh>
                            <MudTh Style="font-weight: 600;"></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Name">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small">
                                        @context.Name.Substring(0, 1)
                                    </MudAvatar>
                                    <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.Name</MudText>
                                </MudStack>
                            </MudTd>
                            <MudTd DataLabel="Location">
                                <MudText Typo="Typo.body2" Style="color: #666;">@context.Location</MudText>
                            </MudTd>
                            <MudTd DataLabel="Status">
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                    @context.Status
                                </MudChip>
                            </MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudPaper>
        </MudItem>

        <!-- ACTIVITY & SUPPORT -->
        <MudItem xs="12" lg="5">
            <MudStack Spacing="4">
                <!-- Activity Feed -->
                <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                    <MudStack Spacing="1" Class="mb-4">
                        <MudText Typo="Typo.h6" Style="font-weight: 600;">
                            <MudIcon Icon="@Icons.Material.Filled.Notifications" Style="color: #FF8C00; vertical-align: middle;" Class="mr-2" />
                            Recent Activity
                        </MudText>
                        <MudText Typo="Typo.body2" Style="color: #666;">
                            Latest updates and changes
                        </MudText>
                    </MudStack>

                    @if (!Activity.Any())
                    {
                        <MudPaper Elevation="0" Class="pa-6" Style="border: 2px dashed #e0e0e0; border-radius: 12px; text-align: center; background: #fafafa;">
                            <MudStack AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.Timeline" Style="font-size: 40px; color: #ccc;" />
                                <MudText Typo="Typo.body2" Style="color: #999;">
                                    No activity yet
                                </MudText>
                                <MudText Typo="Typo.caption" Style="color: #999;">
                                    Activity will appear here as you work
                                </MudText>
                            </MudStack>
                        </MudPaper>
                    }
                    else
                    {
                        <MudTimeline TimelineOrientation="TimelineOrientation.Vertical" TimelinePosition="TimelinePosition.Start">
                            @foreach (var item in Activity)
                            {
                                <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">@item.Description</MudText>
                                        <MudText Typo="Typo.caption" Style="color: #999;">
                                            @item.Timestamp.ToString("g")
                                        </MudText>
                                    </MudStack>
                                </MudTimelineItem>
                            }
                        </MudTimeline>
                    }
                </MudPaper>

                <!-- Support Tickets -->
                <MudPaper Class="pa-6" Elevation="3" Style="border-radius: 16px;">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudStack Spacing="1">
                            <MudText Typo="Typo.h6" Style="font-weight: 600;">
                                <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Style="color: #6A3D9A; vertical-align: middle;" Class="mr-2" />
                                Support
                            </MudText>
                        </MudStack>
                        <MudButton Variant="Variant.Outlined"
                                   Color="Color.Primary"
                                   Size="Size.Small"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   Style="text-transform: none;">
                            New Ticket
                        </MudButton>
                    </MudStack>

                    @if (!Tickets.Any())
                    {
                        <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true">
                            <MudText Typo="Typo.body2">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Style="vertical-align: middle;" Class="mr-1" />
                                No open support tickets
                            </MudText>
                        </MudAlert>
                    }
                    else
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var ticket in Tickets)
                            {
                                <MudListItem>
                                    <MudStack Spacing="1">
                                        <MudText Typo="Typo.body2" Style="font-weight: 500;">
                                            #@ticket.Number - @ticket.Subject
                                        </MudText>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">@ticket.Status</MudChip>
                                            <MudText Typo="Typo.caption" Style="color: #999;">
                                                @ticket.Created.ToString("g")
                                            </MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudListItem>
                                <MudDivider />
                            }
                        </MudList>
                    }
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>
    }
</MudContainer>
}

<style>
    /* Clickable KPI cards get hover effects */
    .kpi-clickable {
        cursor: pointer;
        position: relative;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .kpi-clickable:hover {
        transform: translateY(-6px);
        box-shadow: 0 16px 40px rgba(0,0,0,0.2) !important;
    }

    .kpi-clickable::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 0 0 16px 16px;
    }
</style>

@code {
private string TenantName => TenantContext.TenantName ?? "ALX Reserve Cloud";
private GlobalBannerInfo? globalBanner;
private bool bannerDismissed = false;
private bool _isInitialized = false;

// Brand colors from tenant settings
private string primaryColor = "#667eea";
private string secondaryColor = "#764ba2";
private string BannerGradient => $"background: linear-gradient(135deg, {primaryColor} 0%, {secondaryColor} 100%); border-radius: 12px;";

    // KPI Metrics
    private int KpiProperties { get; set; } = 0;
    private int KpiActiveStudies { get; set; } = 0;
    private int KpiReports { get; set; } = 0;
    private int KpiCustomerAccounts { get; set; } = 0;

    // Invoice Metrics (Admin/Specialist)
    private decimal InvoiceOutstanding { get; set; } = 0;
    private decimal InvoiceOverdue { get; set; } = 0;
    private int InvoiceOverdueCount { get; set; } = 0;
    private List<PaymentRecord> RecentPayments { get; set; } = new();

    // HOA Invoice Data
    private List<Invoice> hoaUserInvoices { get; set; } = new();
    private decimal HoaTotalBalance { get; set; } = 0;
    private bool isLoadingInvoices = false;

    // Pipeline metrics
    private int PipelineScreening { get; set; } = 0;
    private int PipelineEnrollment { get; set; } = 0;
    private int PipelineComplete { get; set; } = 0;

    // Trend chart data (placeholder - replace with real historical data)
    private string[] _trendChartLabels = { "Jan", "Feb", "Mar", "Apr", "May", "Jun" };
    private List<ChartSeries<double>> _trendChartSeries = new()
    {
        new ChartSeries<double> { Name = "Revenue ($K)", Data = new double[] { 12.5, 15.2, 18.4, 16.8, 22.1, 24.5 } },
        new ChartSeries<double> { Name = "Studies", Data = new double[] { 3, 5, 4, 7, 6, 8 } }
    };
    private LineChartOptions _trendChartOptions = new()
    {
        YAxisTicks = 5,
        LineStrokeWidth = 2.5
    };

    private List<PropertyRow> Properties { get; set; } = new();
    private List<ActivityItem> Activity { get; set; } = new();
    private List<TicketItem> Tickets { get; set; } = new();
    private List<ReserveStudy> hoaUserStudies { get; set; } = new();
    private HashSet<Guid> pendingAmendmentStudyIds { get; set; } = new();
    private bool isLoadingStudies = false;
    private Guid? currentUserId = null;
    private string? currentUserName = null;

protected override async Task OnInitializedAsync()
{
    // Initialize role service
    await RoleService.InitializeAsync();

    // Load global banner from system settings
    globalBanner = await SystemSettingsService.GetGlobalBannerInfoAsync();

    // Load tenant brand colors from Branding & Theme settings
    try
    {
        if (!string.IsNullOrWhiteSpace(TenantContext.BrandingJson) &&
            ThemeService.TryParseBranding(TenantContext.BrandingJson, out var branding, out _))
        {
            if (!string.IsNullOrWhiteSpace(branding.Primary))
                primaryColor = branding.Primary;
            if (!string.IsNullOrWhiteSpace(branding.Secondary))
                secondaryColor = branding.Secondary;
        }
    }
    catch
    {
        // Use default colors if branding can't be loaded
    }

    // Get current user ID and name for personalization
    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
    var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier);
    if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
    {
        currentUserId = userId;

        // Get user's first name using factory to avoid DbContext concurrency issues
        await using var userContext = await DbFactory.CreateDbContextAsync();
        var user = await userContext.Users.AsNoTracking()
            .Where(u => u.Id == userId)
            .Select(u => new { u.FirstName })
            .FirstOrDefaultAsync();
        if (user != null && !string.IsNullOrWhiteSpace(user.FirstName))
        {
            currentUserName = user.FirstName;
        }
    }

    // Load real code from services based on role and tenant context
    await LoadDashboardDataAsync();

    // Load HOA user studies and invoices if applicable
    if ((RoleService.IsHOAUser || RoleService.IsHOAAuditor) && currentUserId.HasValue)
    {
        await LoadHOAUserStudiesAsync();
        await LoadHOAUserInvoicesAsync();
    }
    else if (RoleService.IsTenantOwner || RoleService.IsTenantSpecialist || RoleService.IsPlatformAdmin)
    {
        // Load invoice data for staff/admin
        await LoadInvoiceDataAsync();
    }

    _isInitialized = true;
}

private async Task LoadDashboardDataAsync()
{
    try
    {
        // Only load data if we have a valid tenant context
        if (!TenantContext.TenantId.HasValue)
        {
            return;
        }

        var tenantId = TenantContext.TenantId.Value;

        // Use TenantHomepageDataService if available, otherwise fall back to direct queries
        var kpis = await LoadKpiDataAsync(tenantId);
        if (kpis != null)
        {
            KpiProperties = kpis.Properties;
            KpiActiveStudies = kpis.StudiesActive;
            KpiReports = kpis.ReportsRecent;
            KpiCustomerAccounts = kpis.CustomerAccounts;
        }

        // Load pipeline data
        await LoadPipelineDataAsync(tenantId);
    }
    catch (Exception)
    {
        // Silently fail - dashboard will show zeros
    }
}

private async Task<TenantKpisVm?> LoadKpiDataAsync(int tenantId)
{
    // Count properties (communities) for this tenant
    await using var context = await DbFactory.CreateDbContextAsync();
        
    var properties = await context.Communities
        .CountAsync(c => c.TenantId == tenantId);
        
    // Count active reserve studies for this tenant
    var studiesActive = await context.ReserveStudies
        .Include(rs => rs.Community)
        .CountAsync(rs => rs.Community != null && 
                         rs.Community.TenantId == tenantId && 
                         rs.IsActive && 
                         !rs.IsComplete);
        
    // Count completed reports in the last 6 months for this tenant
    var reportsRecent = await context.ReserveStudies
        .Include(rs => rs.Community)
        .CountAsync(rs => rs.Community != null && 
                         rs.Community.TenantId == tenantId && 
                         rs.IsComplete && 
                         rs.DateCreated.HasValue &&
                         rs.DateCreated.Value > DateTime.UtcNow.AddMonths(-6));

    // Count customer accounts for this tenant
    var customerAccounts = await context.CustomerAccounts
        .CountAsync(ca => ca.TenantId == tenantId && ca.IsActive);

    return new TenantKpisVm 
    { 
        Properties = properties, 
        StudiesActive = studiesActive, 
        ReportsRecent = reportsRecent, 
        CustomerAccounts = customerAccounts 
    };
}

private async Task LoadPipelineDataAsync(int tenantId)
{
    await using var context = await DbFactory.CreateDbContextAsync();
        
    // Count studies by status for this tenant
    // Screening = early stage statuses (RequestCreated through ProposalSent)
    PipelineScreening = await context.ReserveStudies
        .Include(rs => rs.Community)
        .CountAsync(rs => rs.Community != null && 
                         rs.Community.TenantId == tenantId && 
                         rs.IsActive && 
                         !rs.IsComplete &&
                         (int)rs.CurrentStatus <= 5); // RequestCreated through ProposalSent
        
    // Enrollment = mid-stage statuses (ProposalAccepted through SiteVisitDataEntered)
    PipelineEnrollment = await context.ReserveStudies
        .Include(rs => rs.Community)
        .CountAsync(rs => rs.Community != null && 
                         rs.Community.TenantId == tenantId && 
                         rs.IsActive && 
                         !rs.IsComplete &&
                         (int)rs.CurrentStatus >= 6 && (int)rs.CurrentStatus <= 16);
        
        // Complete = final stage (completed studies)
        PipelineComplete = await context.ReserveStudies
            .Include(rs => rs.Community)
            .CountAsync(rs => rs.Community != null && 
                             rs.Community.TenantId == tenantId && 
                             rs.IsActive && 
                             rs.IsComplete);
    }

    private async Task LoadInvoiceDataAsync()
    {
        try
        {
            if (!TenantContext.TenantId.HasValue) return;

            await using var context = await DbFactory.CreateDbContextAsync();
            var tenantId = TenantContext.TenantId.Value;

            // Get unpaid invoices for outstanding amount
            var unpaidInvoices = await context.Invoices
                .Where(i => i.TenantId == tenantId && 
                           i.DateDeleted == null &&
                           i.Status != InvoiceStatus.Paid && 
                           i.Status != InvoiceStatus.Voided &&
                           i.Status != InvoiceStatus.Draft)
                .ToListAsync();

            InvoiceOutstanding = unpaidInvoices.Sum(i => i.BalanceDue);

            // Get overdue invoices
            var overdueInvoices = unpaidInvoices.Where(i => i.Status == InvoiceStatus.Overdue).ToList();
            InvoiceOverdue = overdueInvoices.Sum(i => i.BalanceDue);
            InvoiceOverdueCount = overdueInvoices.Count;

            // Get recent payments (last 30 days)
            RecentPayments = await context.PaymentRecords
                .Include(p => p.Invoice)
                .Where(p => p.Invoice != null && 
                           p.Invoice.TenantId == tenantId &&
                           p.PaymentDate >= DateTime.UtcNow.AddDays(-30))
                .OrderByDescending(p => p.PaymentDate)
                .Take(5)
                .ToListAsync();
        }
        catch (Exception)
        {
            // Silently fail - dashboard will show zeros
        }
    }

    private async Task LoadHOAUserInvoicesAsync()
    {
        try
        {
            isLoadingInvoices = true;

            if (!currentUserId.HasValue || !TenantContext.TenantId.HasValue) return;

            await using var context = await DbFactory.CreateDbContextAsync();

            // Get all reserve studies for this HOA user
            var userStudyIds = await context.ReserveStudies
                .Where(rs => rs.ApplicationUserId == currentUserId.Value && 
                            rs.IsActive &&
                            rs.TenantId == TenantContext.TenantId.Value)
                .Select(rs => rs.Id)
                .ToListAsync();

            // Get invoices for those studies (exclude drafts and voided)
            hoaUserInvoices = await context.Invoices
                .Include(i => i.ReserveStudy)
                    .ThenInclude(rs => rs!.Community)
                .Where(i => userStudyIds.Contains(i.ReserveStudyId) &&
                           i.DateDeleted == null &&
                           i.Status != InvoiceStatus.Draft &&
                           i.Status != InvoiceStatus.Voided)
                .OrderByDescending(i => i.InvoiceDate)
                .ToListAsync();

            HoaTotalBalance = hoaUserInvoices
                .Where(i => i.Status != InvoiceStatus.Paid)
                .Sum(i => i.BalanceDue);
        }
        catch (Exception)
        {
            hoaUserInvoices = new List<Invoice>();
            HoaTotalBalance = 0;
        }
        finally
        {
            isLoadingInvoices = false;
        }
    }

    private string GetUserGreeting()
    {
        // Return user's name if available
        if (!string.IsNullOrWhiteSpace(currentUserName))
            return $", {currentUserName}";
            
        return string.Empty;
    }

    private string GetRoleDescription()
    {
        if (RoleService.IsPlatformAdmin) 
            return "Manage all tenants and system settings";
        if (RoleService.IsTenantOwner) 
            return "Here's your organization's performance overview";
        if (RoleService.IsTenantSpecialist) 
            return "Here's what's happening with your reserve studies today";
        if (RoleService.IsTenantViewer) 
            return "View your organization's reports and analytics";
        return "Welcome to your dashboard";
    }

    private Severity GetMudSeverity(BannerSeverity severity)
    {
        return severity switch
        {
            BannerSeverity.Success => Severity.Success,
            BannerSeverity.Warning => Severity.Warning,
            BannerSeverity.Error => Severity.Error,
            _ => Severity.Info
        };
    }

    private Color GetStatusColor(string status)
    {
        return status.ToLower() switch
        {
            "active" => Color.Success,
            "pending" => Color.Warning,
            "inactive" => Color.Default,
            "complete" => Color.Info,
            _ => Color.Default
        };
    }

    private Color GetInvoiceStatusColor(InvoiceStatus status)
    {
        return status switch
        {
            InvoiceStatus.Draft => Color.Default,
            InvoiceStatus.Finalized => Color.Info,
            InvoiceStatus.Sent => Color.Primary,
            InvoiceStatus.Viewed => Color.Primary,
            InvoiceStatus.PartiallyPaid => Color.Warning,
            InvoiceStatus.Paid => Color.Success,
            InvoiceStatus.Overdue => Color.Error,
            InvoiceStatus.Voided => Color.Default,
            _ => Color.Default
        };
    }

    private void HideBanner()
    {
        globalBanner = null;
        bannerDismissed = true;
    }

    private async Task LoadHOAUserStudiesAsync()
    {
        try
        {
            isLoadingStudies = true;
            
            if (!currentUserId.HasValue || !TenantContext.TenantId.HasValue)
            {
                return;
            }

            await using var context = await DbFactory.CreateDbContextAsync();
            
            // Get reserve studies owned by this HOA user (as creator OR as the requested customer)
            hoaUserStudies = await context.ReserveStudies
                .AsNoTracking()
                .Include(rs => rs.Community)
                    .ThenInclude(c => c.PhysicalAddress)
                .Include(rs => rs.StudyRequest)
                .Where(rs => (rs.ApplicationUserId == currentUserId.Value || rs.RequestedByUserId == currentUserId.Value) && 
                            rs.IsActive &&
                            rs.TenantId == TenantContext.TenantId.Value)
                .OrderByDescending(rs => rs.DateCreated)
                .ToListAsync();

            // Get study IDs that have amendments approved by admin and awaiting HOA acceptance
            // Only show "Review Amendment" when the study is in AmendmentApproved status (admin has approved)
            var studyIds = hoaUserStudies.Select(s => s.Id).ToList();
            pendingAmendmentStudyIds = hoaUserStudies
                .Where(s => s.StudyRequest?.CurrentStatus == Horizon.Models.Workflow.StudyStatus.AmendmentApproved)
                .Select(s => s.Id)
                .ToHashSet();
        }
        catch (Exception)
        {
            // Silently fail - dashboard will show empty list
            hoaUserStudies = new List<ReserveStudy>();
            pendingAmendmentStudyIds = new HashSet<Guid>();
        }
        finally
        {
            isLoadingStudies = false;
        }
    }

    private bool CanEditStudy(ReserveStudy study)
    {
        if (study == null) return false;
        
        // The owner (creator or requested user) can edit
        if (study.ApplicationUserId != currentUserId && study.RequestedByUserId != currentUserId) return false;
        
        // Use the service method to check if study is in editable state
        return ReserveStudyService.CanUpdateReserveStudy(study);
    }

    private string GetStudyStatusText(ReserveStudy study)
    {
        if (study == null) return "Unknown";

        if (study.IsComplete) return "Complete";

        return study.CurrentStatus switch
        {
            StudyStatus.RequestCreated => "New Request",
            StudyStatus.RequestApproved => "Request Approved",
            StudyStatus.ProposalCreated => "Proposal Created",
            StudyStatus.ProposalReviewed => "Under Review",
            StudyStatus.ProposalUpdated => "Proposal Updated",
            StudyStatus.ProposalApproved => "Proposal Approved",
            StudyStatus.ProposalSent => "Proposal Sent",
            StudyStatus.ProposalAccepted => "Accepted",
            StudyStatus.ServiceContactsRequested => "Contacts Requested",
            StudyStatus.FinancialInfoRequested => "Financial Info Requested",
            StudyStatus.FinancialInfoInProgress => "Financial Info In Progress",
            StudyStatus.FinancialInfoSubmitted => "Financial Info Submitted",
            StudyStatus.SiteVisitPending => "Site Visit Pending",
            StudyStatus.SiteVisitScheduled => "Visit Scheduled",
            StudyStatus.SiteVisitCompleted => "Visit Complete",
            StudyStatus.AmendmentPending => "In Progress", // Admin is reviewing - HOA doesn't need to act yet
            StudyStatus.AmendmentApproved => "Amendment Review Required", // Admin approved - HOA needs to review
            StudyStatus.ReportComplete => "Report Ready",
            StudyStatus.RequestCompleted => "Complete",
            StudyStatus.RequestCancelled => "Cancelled",
            StudyStatus.RequestArchived => "Archived",
            _ => "In Progress"
        };
    }

    private Color GetStudyStatusColor(ReserveStudy study)
    {
        if (study == null) return Color.Default;
        
        if (study.IsComplete) return Color.Success;
        
        return study.CurrentStatus switch
        {
            StudyStatus.RequestCreated => Color.Warning,
            StudyStatus.RequestApproved => Color.Warning,
            StudyStatus.ProposalCreated => Color.Info,
            StudyStatus.ProposalReviewed => Color.Info,
            StudyStatus.ProposalUpdated => Color.Info,
            StudyStatus.ProposalApproved => Color.Info,
            StudyStatus.ProposalSent => Color.Primary,
            StudyStatus.ProposalAccepted => Color.Success,
            StudyStatus.ServiceContactsRequested => Color.Tertiary,
            StudyStatus.FinancialInfoRequested => Color.Tertiary,
            StudyStatus.FinancialInfoInProgress => Color.Tertiary,
            StudyStatus.FinancialInfoSubmitted => Color.Tertiary,
            StudyStatus.SiteVisitPending => Color.Primary,
            StudyStatus.SiteVisitScheduled => Color.Primary,
            StudyStatus.SiteVisitCompleted => Color.Primary,
            StudyStatus.AmendmentPending => Color.Warning,
            StudyStatus.ReportComplete => Color.Success,
            StudyStatus.RequestCompleted => Color.Success,
            StudyStatus.RequestCancelled => Color.Error,
            StudyStatus.RequestArchived => Color.Default,
            _ => Color.Primary
        };
    }

    public class PropertyRow
    {
        public string Name { get; set; } = default!;
        public string Location { get; set; } = default!;
        public string Status { get; set; } = default!;
    }

    public class ActivityItem
    {
        public string Description { get; set; } = default!;
        public DateTime Timestamp { get; set; }
    }

    public class TicketItem
    {
        public string Number { get; set; } = default!;
        public string Subject { get; set; } = default!;
        public string Status { get; set; } = default!;
        public DateTime Created { get; set; }
    }
}
