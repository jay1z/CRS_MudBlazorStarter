@page "/Admin/Users"
@attribute [Authorize(Policy = "RequireTenantOwner")]
@using Horizon.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject RoleManager<IdentityRole<Guid>> RoleManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using Horizon.Services.Tenant
@inject ITenantUserService TenantUserService
@inject ITenantContext TenantContext

<PageTitle>Team Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6">
    <!-- Header Section -->
    <MudPaper Elevation="0" Class="pa-6 mb-4" Style="background: linear-gradient(135deg, #6A3D9A 0%, #FF8C00 100%); border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
            <MudStack Spacing="1">
                <MudText Typo="Typo.h4" Style="color: white; font-weight: 600;">
                    <MudIcon Icon="@Icons.Material.Filled.Groups" Class="mr-2" Style="vertical-align: middle;" />
                    Team Management
                </MudText>
                <MudText Typo="Typo.body2" Style="color: rgba(255,255,255,0.9);">
                    Manage specialists, viewers, and team member access
                </MudText>
            </MudStack>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Surface" 
                       Size="Size.Large"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenCreateUserDialog"
                       Style="color: #FF8C00; font-weight: 600;">
                Add Team Member
            </MudButton>
        </MudStack>
    </MudPaper>

    <!-- Stats Cards -->
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.People" Style="color: #FF8C00; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@users.Count</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Total Users</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #F3E8FF; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Engineering" Style="color: #6A3D9A; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetRoleCount("TenantSpecialist")</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Specialists</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #FFF5E6; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.Visibility" Style="color: #FF8C00; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@GetRoleCount("TenantViewer")</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Viewers</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="border-radius: 12px;">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                        <div style="width: 48px; height: 48px; background: #E8F5E9; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Style="color: #28a745; font-size: 28px;" />
                        </div>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h4" Style="font-weight: 600;">@users.Count(u => u.Status == StatusEnum.Active)</MudText>
                            <MudText Typo="Typo.body2" Style="color: #666;">Active</MudText>
                        </MudStack>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Search and Filter Section -->
    <MudPaper Elevation="2" Class="pa-4 mb-4" Style="border-radius: 12px;">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudTextField @bind-Value="searchValue" 
                          Placeholder="Search by name or email..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" 
                          Immediate="true"
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Style="flex: 1; max-width: 400px;" />
            <MudSelect @bind-Value="roleFilter" 
                       Label="Filter by Role" 
                       Variant="Variant.Outlined"
                       Margin="Margin.Dense"
                       Style="min-width: 200px;">
                <MudSelectItem Value="@((string?)null)">All Roles</MudSelectItem>
                <MudSelectItem Value="@("TenantSpecialist")">Specialists</MudSelectItem>
                <MudSelectItem Value="@("TenantViewer")">Viewers</MudSelectItem>
                <MudSelectItem Value="@("TenantOwner")">Owners</MudSelectItem>
            </MudSelect>
            @if (!string.IsNullOrEmpty(searchValue) || roleFilter != null)
            {
                <MudButton Variant="Variant.Text" 
                           Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="ClearFilters">
                    Clear
                </MudButton>
            }
        </MudStack>
    </MudPaper>

    <!-- Users Table -->
    <MudPaper Elevation="2" Style="border-radius: 12px; overflow: hidden;">
        @if (isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            <div class="pa-8 text-center">
                <MudText Typo="Typo.h6" Style="color: #666;">Loading team members...</MudText>
            </div>
        }
        else if (!filteredUsers.Any())
        {
            <div class="pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Filled.PersonOff" Style="font-size: 64px; color: #ccc; margin-bottom: 16px;" />
                <MudText Typo="Typo.h6" Style="color: #666; margin-bottom: 8px;">No team members found</MudText>
                <MudText Typo="Typo.body2" Style="color: #999;">
                    @(string.IsNullOrEmpty(searchValue) && roleFilter == null 
                        ? "Click 'Add Team Member' to get started" 
                        : "Try adjusting your filters")
                </MudText>
            </div>
        }
        else
        {
            <MudTable T="ApplicationUser" 
                      Items="filteredUsers" 
                      Hover="true" 
                      Breakpoint="Breakpoint.Sm"
                      Elevation="0">
                <HeaderContent>
                    <MudTh Style="font-weight: 600;">User</MudTh>
                    <MudTh Style="font-weight: 600;">Email</MudTh>
                    <MudTh Style="font-weight: 600;">Role</MudTh>
                    <MudTh Style="font-weight: 600;">Status</MudTh>
                    <MudTh Style="font-weight: 600; text-align: right;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="User">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudAvatar Color="Color.Primary" Size="Size.Small">
                                @context.Initials
                            </MudAvatar>
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2" Style="font-weight: 500;">@context.FullName</MudText>
                                <MudText Typo="Typo.caption" Style="color: #999;">@context.Title</MudText>
                            </MudStack>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Email">
                        <MudText Typo="Typo.body2">@context.Email</MudText>
                    </MudTd>
                    <MudTd DataLabel="Role">
                        @foreach (var role in (context.Roles ?? Array.Empty<string>()))
                        {
                            <MudChip T="string" 
                                     Size="Size.Small" 
                                     Color="@GetRoleColor(role)"
                                     Variant="Variant.Filled"
                                     Class="mr-1">
                                @GetRoleDisplayName(role)
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" 
                                 Size="Size.Small" 
                                 Color="@GetStatusColor(context.Status)"
                                 Variant="Variant.Filled">
                            @context.Status
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: right;">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                                 Size="Size.Small" 
                                 Dense="true"
                                 AnchorOrigin="Origin.BottomRight"
                                 TransformOrigin="Origin.TopRight">
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                         OnClick="@(() => OpenEditUserDialog(context))">
                                Edit User
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.GroupAdd" 
                                         OnClick="@(() => OpenAddRoleToUserDialog(context))">
                                Manage Roles
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Email" 
                                         OnClick="@(() => ResendInviteAsync(context))">
                                Resend Invite
                            </MudMenuItem>
                            @if (context.Roles?.Any() == true)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.GroupRemove" 
                                             OnClick="@(() => RemovePrimaryRoleAsync(context))"
                                             IconColor="Color.Warning">
                                    Remove Role
                                </MudMenuItem>
                            }
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" 
                                         OnClick="@(() => ConfirmDeleteUser(context))"
                                         IconColor="Color.Error">
                                Deactivate User
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ApplicationUser> users = new();
    private string? searchValue;
    private string? roleFilter;
    private bool isLoading = true;

    private IEnumerable<ApplicationUser> filteredUsers
    {
        get
        {
            var filtered = users.AsEnumerable();

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(searchValue))
            {
                filtered = filtered.Where(u =>
                    (u.UserName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (u.Email?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (u.FirstName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (u.LastName?.Contains(searchValue, StringComparison.OrdinalIgnoreCase) ?? false));
            }

            // Apply role filter
            if (!string.IsNullOrWhiteSpace(roleFilter))
            {
                filtered = filtered.Where(u => u.Roles?.Contains(roleFilter) ?? false);
            }

            return filtered;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            var tenantId = TenantContext.TenantId;
            await using var db = await DbFactory.CreateDbContextAsync();
            var query = UserManager.Users.AsQueryable();
            if (tenantId.HasValue)
            {
                query = query.Where(u => u.TenantId == tenantId.Value);
            }
            var allUsers = await query.OrderBy(u => u.LastName).ThenBy(u => u.FirstName).ToListAsync();

            // Only include staff users (those with TenantOwner, TenantSpecialist, or TenantViewer roles)
            // HOA customers are managed on the HOAUsers page
            var staffRoles = new[] { "TenantOwner", "TenantSpecialist", "TenantViewer" };
            users = new List<ApplicationUser>();
            foreach (var user in allUsers)
            {
                user.Roles = await UserManager.GetRolesAsync(user);
                // Only include users that have at least one staff role
                if (user.Roles.Any(r => staffRoles.Contains(r)))
                {
                    users.Add(user);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ClearFilters()
    {
        searchValue = null;
        roleFilter = null;
    }

    private int GetRoleCount(string roleName)
    {
        return users.Count(u => u.Roles?.Contains(roleName) ?? false);
    }

    private Color GetRoleColor(string role)
    {
        return role switch
        {
            "TenantOwner" => Color.Error,
            "TenantSpecialist" => Color.Primary,
            "TenantViewer" => Color.Info,
            _ => Color.Default
        };
    }

    private string GetRoleDisplayName(string role)
    {
        return role switch
        {
            "TenantOwner" => "Owner",
            "TenantSpecialist" => "Specialist",
            "TenantViewer" => "Viewer",
            _ => role
        };
    }

    private Color GetStatusColor(StatusEnum status)
    {
        return status switch
        {
            StatusEnum.Active => Color.Success,
            StatusEnum.Inactive => Color.Warning,
            StatusEnum.LockedOut => Color.Error,
            _ => Color.Default
        };
    }

    private async Task OpenCreateUserDialog()
    {
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<CreateUserDialog>("Add Team Member", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsers();
        }
    }

    private async Task OpenEditUserDialog(ApplicationUser user)
    {
        var parameters = new DialogParameters<EditUserDialog> { { x => x.User, user } };
        var options = new DialogOptions 
        { 
            CloseOnEscapeKey = true, 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<EditUserDialog>("Edit User", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsers();
        }
    }

    private async Task ResendInviteAsync(ApplicationUser user)
    {
        try
        {
            // Generate new confirmation and reset tokens
            var confirmationToken = await UserManager.GenerateEmailConfirmationTokenAsync(user);
            var resetToken = await UserManager.GeneratePasswordResetTokenAsync(user);
            
            Snackbar.Add($"Invitation email sent to {user.Email}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending invitation: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemovePrimaryRoleAsync(ApplicationUser user)
    {
        if (user.Roles == null || user.Roles.Count == 0)
        {
            Snackbar.Add("User has no roles.", Severity.Info);
            return;
        }

        var role = user.Roles.First();
        
        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Confirm Role Removal",
            $"Are you sure you want to remove the '{role}' role from {user.FullName}?",
            yesText: "Remove", cancelText: "Cancel");

        if (confirm == true)
        {
            var result = await UserManager.RemoveFromRoleAsync(user, role);
            if (result.Succeeded)
            {
                Snackbar.Add($"Removed role {role} from {user.Email}", Severity.Success);
                await LoadUsers();
            }
            else
            {
                Snackbar.Add($"Failed removing role: {string.Join(',', result.Errors.Select(e => e.Description))}", Severity.Error);
            }
        }
    }

    private async Task ConfirmDeleteUser(ApplicationUser user)
    {
        bool? confirm = await DialogService.ShowMessageBoxAsync(
            "Confirm Deactivation",
            $"Are you sure you want to deactivate {user.FullName}? They will no longer be able to access the system.",
            yesText: "Deactivate", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (confirm == true)
        {
            await DeactivateUserAsync(user);
        }
    }

    private async Task DeactivateUserAsync(ApplicationUser user)
    {
        try
        {
            user.Status = StatusEnum.Inactive;
            var result = await UserManager.UpdateAsync(user);
            
            if (result.Succeeded)
            {
                Snackbar.Add($"User {user.Email} has been deactivated", Severity.Success);
                await LoadUsers();
            }
            else
            {
                Snackbar.Add($"Failed to deactivate user: {string.Join(',', result.Errors.Select(e => e.Description))}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deactivating user: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenAddRoleToUserDialog(ApplicationUser user)
    {
        var parameters = new DialogParameters<Horizon.Components.Pages.Users.AddUserToRoleDialog> { { x => x.User, user } };
        var options = new DialogOptions { CloseOnEscapeKey = true, CloseButton = true, MaxWidth = MaxWidth.Medium };
        var dialog = await DialogService.ShowAsync<Horizon.Components.Pages.Users.AddUserToRoleDialog>("Manage Roles", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadUsers();
        }
    }
}

